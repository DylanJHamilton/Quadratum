{%- comment -%}
  Quadratum â€” Main Product (Compact)
  File: sections/main-product-compact.liquid

  SELF-CONTAINED WORKING PDP SECTION
  ----------------------------------
  - DOES NOT call missing snippets (no 'price', no 'product-information-content')
  - Renders: media gallery + title + price + variant picker + quantity + add to cart + description
  - Optional sticky add-to-cart is included as a simple bar (no custom web component required)

  NOTE:
  - This is the fastest "it works now" build.
  - If/when you add the shared engine snippets back into the theme, we can swap to wrapper architecture.
{%- endcomment -%}

{%- liquid
  assign p = product | default: closest.product
  if p == blank
    break
  endif

  assign current_variant = p.selected_or_first_available_variant
  if current_variant == blank
    assign current_variant = p.variants.first
  endif

  assign s = section.settings

  assign has_media = false
  if p.media.size > 0
    assign has_media = true
  endif

  assign on_sale = false
  if current_variant.compare_at_price and current_variant.compare_at_price > current_variant.price
    assign on_sale = true
  endif
-%}

<script type="application/ld+json">
  {{ p | structured_data }}
</script>

<section
  id="MainProductCompact-{{ section.id }}"
  class="main-product-compact color-{{ s.color_scheme }}"
  style="
    padding-top: {{ s.padding_top }}px;
    padding-bottom: {{ s.padding_bottom }}px;
    --qtm-gap: {{ s.gap }}px;
  "
  data-section-id="{{ section.id }}"
  data-product-id="{{ p.id }}"
>
  <div class="{% if s.content_width == 'content-full-width' %}full-width{% else %}page-width{% endif %}">
    <div
      class="
        main-product-compact__grid
        {% if has_media == false %}main-product-compact__grid--no-media{% endif %}
        {% if s.desktop_media_position == 'right' %}main-product-compact__grid--media-right{% else %}main-product-compact__grid--media-left{% endif %}
        {% if s.equal_columns %}main-product-compact__grid--half{% endif %}
        {% if s.equal_columns and s.limit_details_width %}main-product-compact__grid--limit-details{% endif %}
      "
    >
      {%- capture media_col -%}
        {%- if has_media -%}
          <div class="main-product-compact__media" aria-label="Product media">
            <div class="main-product-compact__media-list">
              {%- for media in p.media -%}
                <div class="main-product-compact__media-item" data-media-id="{{ media.id }}">
                  {%- case media.media_type -%}
                    {%- when 'image' -%}
                      {{
                        media
                        | image_url: width: 1800
                        | image_tag:
                          loading: 'lazy',
                          class: 'main-product-compact__media-img'
                      }}
                    {%- when 'video' -%}
                      {{ media | video_tag: controls: true, class: 'main-product-compact__media-video' }}
                    {%- when 'external_video' -%}
                      {{ media | external_video_tag }}
                    {%- when 'model' -%}
                      {{ media | model_viewer_tag }}
                  {%- endcase -%}
                </div>
              {%- endfor -%}
            </div>
          </div>
        {%- endif -%}
      {%- endcapture -%}

      {%- capture details_col -%}
        <div class="main-product-compact__details" id="ProductInformation-{{ section.id }}">
          <h1 class="main-product-compact__title">{{ p.title }}</h1>

          <div class="main-product-compact__price" id="QtmPrice">
            {%- if on_sale -%}
              <span class="main-product-compact__price-sale">{{ current_variant.price | money }}</span>
              <span class="main-product-compact__price-compare compare-at-price">
                <s>{{ current_variant.compare_at_price | money }}</s>
              </span>
            {%- else -%}
              <span class="main-product-compact__price-regular">{{ current_variant.price | money }}</span>
            {%- endif -%}
          </div>

          {%- unless p.has_only_default_variant -%}
            <div class="main-product-compact__variants" data-variant-pickers>
              {%- for option in p.options_with_values -%}
                <div class="main-product-compact__variant">
                  <label class="main-product-compact__variant-label" for="Option-{{ section.id }}-{{ forloop.index0 }}">
                    {{ option.name }}
                  </label>
                  <select
                    id="Option-{{ section.id }}-{{ forloop.index0 }}"
                    class="main-product-compact__variant-select"
                    name="options[{{ option.name | escape }}]"
                    data-option-index="{{ forloop.index0 }}"
                  >
                    {%- for value in option.values -%}
                      <option value="{{ value | escape }}" {% if option.selected_value == value %}selected{% endif %}>
                        {{ value }}
                      </option>
                    {%- endfor -%}
                  </select>
                </div>
              {%- endfor -%}
            </div>
          {%- endunless -%}

          <form
            method="post"
            action="/cart/add"
            enctype="multipart/form-data"
            class="main-product-compact__form"
            id="ProductForm-{{ section.id }}"
          >
            <input type="hidden" name="id" id="VariantId-{{ section.id }}" value="{{ current_variant.id }}">

            <div class="main-product-compact__qty">
              <label for="Quantity-{{ section.id }}">Quantity</label>
              <input
                id="Quantity-{{ section.id }}"
                type="number"
                name="quantity"
                value="{{ current_variant.quantity_rule.min | default: 1 }}"
                min="{{ current_variant.quantity_rule.min | default: 1 }}"
                {% if current_variant.quantity_rule.max %}max="{{ current_variant.quantity_rule.max }}"{% endif %}
                step="{{ current_variant.quantity_rule.increment | default: 1 }}"
              >
            </div>

            <button
              type="submit"
              class="button button--primary main-product-compact__atc"
              id="QtmAtc"
              {% unless current_variant.available %}disabled{% endunless %}
            >
              {%- if current_variant.available -%}
                Add to cart
              {%- else -%}
                Sold out
              {%- endif -%}
            </button>
          </form>

          {%- if p.description != blank -%}
            <div class="main-product-compact__description rte">
              {{ p.description }}
            </div>
          {%- endif -%}
        </div>
      {%- endcapture -%}

      {%- if s.desktop_media_position == 'right' -%}
        {{ details_col }}
        {{ media_col }}
      {%- else -%}
        {{ media_col }}
        {{ details_col }}
      {%- endif -%}
    </div>
  </div>

  {%- if s.enable_sticky_add_to_cart -%}
    {%- liquid
      assign sticky_image = current_variant.featured_image | default: p.featured_image
    -%}
    <div class="main-product-compact__sticky" data-sticky>
      <div class="main-product-compact__sticky-inner">
        {%- if sticky_image -%}
          <div class="main-product-compact__sticky-img">
            {{
              sticky_image
              | image_url: width: 96
              | image_tag: loading: 'lazy', alt: p.title, class: 'main-product-compact__sticky-img-el'
            }}
          </div>
        {%- endif -%}

        <div class="main-product-compact__sticky-info">
          <div class="main-product-compact__sticky-title">{{ p.title }}</div>
          {%- unless p.has_only_default_variant -%}
            <div class="main-product-compact__sticky-variant" id="StickyVariantTitle-{{ section.id }}">
              {{ current_variant.title }}
            </div>
          {%- endunless -%}
        </div>

        <div class="main-product-compact__sticky-price" id="StickyPrice-{{ section.id }}">
          {{ current_variant.price | money }}
        </div>

        <button
          type="button"
          class="button main-product-compact__sticky-btn"
          data-sticky-atc
          {% unless current_variant.available %}disabled{% endunless %}
        >
          Add to cart
        </button>
      </div>
    </div>
  {%- endif -%}
</section>

<style>
  .main-product-compact__grid{
    display:grid;
    gap:var(--qtm-gap);
    align-items:start;
  }

  /* Base: two columns when media exists */
  @media (min-width: 750px){
    .main-product-compact__grid:not(.main-product-compact__grid--no-media){
      grid-template-columns: 1fr min(50vw, var(--sidebar-width, 520px));
    }
    .main-product-compact__grid--media-right:not(.main-product-compact__grid--no-media){
      grid-template-columns: min(50vw, var(--sidebar-width, 520px)) 1fr;
    }

    .main-product-compact__grid--half:not(.main-product-compact__grid--no-media){
      grid-template-columns: 1fr 1fr;
    }
    .main-product-compact__grid--limit-details .main-product-compact__details{
      max-width: var(--sidebar-width, 520px);
    }
  }

  /* No media: center details */
  .main-product-compact__grid--no-media{
    grid-template-columns: 1fr;
  }

  .main-product-compact__media-list{
    display:flex;
    flex-direction:column;
    gap: calc(var(--qtm-gap) * 0.75);
  }

  .main-product-compact__media-img,
  .main-product-compact__media-video{
    width:100%;
    height:auto;
    display:block;
    border-radius: var(--style-border-radius, 12px);
  }

  .main-product-compact__title{
    margin:0 0 12px;
    line-height:1.1;
  }

  .main-product-compact__price{
    display:flex;
    gap:10px;
    align-items:baseline;
    margin: 0 0 16px;
    font-weight:600;
  }

  .main-product-compact__price-compare{
    opacity:.65;
    font-weight:500;
  }

  .main-product-compact__variants{
    display:flex;
    flex-direction:column;
    gap:12px;
    margin: 0 0 16px;
  }

  .main-product-compact__variant-label{
    display:block;
    margin: 0 0 6px;
    font-size: .9em;
    opacity:.8;
  }

  .main-product-compact__variant-select{
    width:100%;
    min-height: 44px;
  }

  .main-product-compact__form{
    display:flex;
    flex-direction:column;
    gap:12px;
    margin: 0 0 18px;
  }

  .main-product-compact__qty input{
    width: 120px;
    min-height: 44px;
  }

  .main-product-compact__sticky{
    position: fixed;
    left:0;
    right:0;
    bottom:0;
    z-index: 40;
    padding: 12px;
    background: rgba(255,255,255,.92);
    backdrop-filter: blur(12px);
    border-top: 1px solid rgba(0,0,0,.08);
    display:none;
  }

  .main-product-compact__sticky-inner{
    max-width: 1100px;
    margin: 0 auto;
    display:flex;
    align-items:center;
    gap:12px;
  }

  .main-product-compact__sticky-img{
    width: 52px;
    height: 52px;
    overflow:hidden;
    border-radius: 10px;
    flex: 0 0 auto;
    background: rgba(0,0,0,.04);
  }
  .main-product-compact__sticky-img-el{
    width:100%;
    height:100%;
    object-fit:cover;
    display:block;
  }

  .main-product-compact__sticky-info{
    flex: 1 1 auto;
    min-width: 0;
  }
  .main-product-compact__sticky-title{
    font-weight: 600;
    white-space: nowrap;
    overflow:hidden;
    text-overflow: ellipsis;
  }
  .main-product-compact__sticky-variant{
    font-size: .85em;
    opacity:.7;
    white-space: nowrap;
    overflow:hidden;
    text-overflow: ellipsis;
  }

  .main-product-compact__sticky-price{
    font-weight: 700;
  }

  .main-product-compact__sticky-btn{
    min-height: 44px;
  }

  @media (max-width: 749px){
    .main-product-compact__sticky{ display:block; }
  }
</style>

<script>
  (function () {
    var root = document.getElementById('MainProductCompact-{{ section.id }}');
    if (!root) return;

    var form = root.querySelector('#ProductForm-{{ section.id }}');
    var variantIdInput = root.querySelector('#VariantId-{{ section.id }}');
    var priceEl = root.querySelector('#QtmPrice');
    var stickyPrice = root.querySelector('#StickyPrice-{{ section.id }}');
    var stickyVariantTitle = root.querySelector('#StickyVariantTitle-{{ section.id }}');
    var stickyBtn = root.querySelector('[data-sticky-atc]');
    var optionSelects = root.querySelectorAll('[data-variant-pickers] select');

    var variants = {{ p.variants | json }};

    function findVariant() {
      if (!optionSelects.length) return variants[0];
      var selected = Array.prototype.map.call(optionSelects, function (sel) { return sel.value; });
      for (var i = 0; i < variants.length; i++) {
        var v = variants[i];
        if (!v) continue;
        var ok = true;
        for (var j = 0; j < selected.length; j++) {
          if (v.options[j] !== selected[j]) { ok = false; break; }
        }
        if (ok) return v;
      }
      return variants[0];
    }

    function formatMoney(cents) {
      // Basic fallback formatting; your theme may replace with Shopify.formatMoney globally.
      if (window.Shopify && typeof window.Shopify.formatMoney === 'function') {
        return window.Shopify.formatMoney(cents, {{ shop.money_format | json }});
      }
      return (cents / 100).toFixed(2);
    }

    function updateUI(v) {
      if (!v) return;
      if (variantIdInput) variantIdInput.value = v.id;

      if (priceEl) {
        var html = '';
        if (v.compare_at_price && v.compare_at_price > v.price) {
          html = '<span class="main-product-compact__price-sale">' + formatMoney(v.price) + '</span>' +
                 '<span class="main-product-compact__price-compare compare-at-price"><s>' + formatMoney(v.compare_at_price) + '</s></span>';
        } else {
          html = '<span class="main-product-compact__price-regular">' + formatMoney(v.price) + '</span>';
        }
        priceEl.innerHTML = html;
      }

      if (stickyPrice) stickyPrice.textContent = formatMoney(v.price);
      if (stickyVariantTitle) stickyVariantTitle.textContent = v.title || '';

      var atc = root.querySelector('.main-product-compact__atc');
      if (atc) atc.disabled = !v.available;
      if (stickyBtn) stickyBtn.disabled = !v.available;
    }

    function onChange() {
      updateUI(findVariant());
    }

    optionSelects.forEach(function (sel) { sel.addEventListener('change', onChange); });

    if (stickyBtn && form) {
      stickyBtn.addEventListener('click', function () {
        form.requestSubmit ? form.requestSubmit() : form.submit();
      });
    }

    updateUI(findVariant());
  })();
</script>

{% schema %}
{
  "name": "Main Product - Compact",
  "blocks": [
    { "type": "@app" }
  ],
  "disabled_on": { "groups": ["header", "footer"] },
  "settings": [
    { "type": "header", "content": "Layout" },
    {
      "type": "select",
      "id": "content_width",
      "label": "Content width",
      "default": "content-center-aligned",
      "options": [
        { "value": "content-center-aligned", "label": "Centered" },
        { "value": "content-full-width", "label": "Full width" }
      ]
    },
    {
      "type": "select",
      "id": "desktop_media_position",
      "label": "Desktop media position",
      "default": "left",
      "options": [
        { "value": "left", "label": "Left" },
        { "value": "right", "label": "Right" }
      ]
    },
    { "type": "checkbox", "id": "equal_columns", "label": "Equal width columns", "default": true },
    {
      "type": "checkbox",
      "id": "limit_details_width",
      "label": "Limit details width",
      "default": true,
      "visible_if": "{{ section.settings.equal_columns }}"
    },
    {
      "type": "range",
      "id": "gap",
      "label": "Column gap",
      "min": 0,
      "max": 48,
      "step": 4,
      "unit": "px",
      "default": 12
    },
    { "type": "checkbox", "id": "enable_sticky_add_to_cart", "label": "Enable sticky add to cart", "default": true },
    { "type": "color_scheme", "id": "color_scheme", "label": "Color scheme", "default": "scheme-1" },
    { "type": "header", "content": "Spacing" },
    { "type": "range", "id": "padding_top", "label": "Padding top", "min": 0, "max": 120, "step": 4, "default": 0 },
    { "type": "range", "id": "padding_bottom", "label": "Padding bottom", "min": 0, "max": 120, "step": 4, "default": 0 }
  ],
  "presets": [
    { "name": "Main Product - Compact", "category": "Products" }
  ]
}
{% endschema %}
