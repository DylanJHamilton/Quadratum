<script type="application/ld+json">
  {{ closest.product | structured_data }}
</script>

{% capture media_gallery %}
  {%- content_for 'block',
    type: '_product-media-gallery',
    id: 'media-gallery',
    closest.product: closest.product
  -%}
{% endcapture %}

{% capture product_details %}
  {% content_for 'block',
    type: '_product-details',
    id: 'product-details',
    closest.product: closest.product
  %}
{% endcapture %}

{% capture additional_blocks %}
  {% content_for 'blocks' %}
{% endcapture %}

{% if section.settings.enable_sticky_add_to_cart %}
  {% liquid
    assign current_variant = product.selected_or_first_available_variant
    assign initial_quantity = current_variant.quantity_rule.min | default: 1
    assign image_to_show = current_variant.featured_image | default: product.featured_image

    assign has_single_option = false
    if product.has_only_default_variant != true and product.options.size == 1
      assign has_single_option = true
    endif

    assign has_image = false
    if image_to_show != blank
      assign has_image = true
    endif

    assign image_alt = product.title | escape
    if image_to_show != blank and image_to_show.alt != blank
      assign image_alt = image_to_show.alt | escape
    endif
  %}

  <sticky-add-to-cart
    class="sticky-add-to-cart"
    data-variant-available="{{ current_variant.available }}"
    data-product-id="{{ product.id }}"
    data-current-variant-id="{{ current_variant.id }}"
    data-initial-quantity="{{ initial_quantity }}"
    data-default-variant-title="{{ 'products.product.default_title' | t }}"
  >
    <div
      class="sticky-add-to-cart__bar"
      data-stuck="false"
      ref="stickyBar"
      role="region"
      aria-label="{{ 'products.product.sticky_add_to_cart' | t }}"
    >
      {% if image_to_show %}
        <div class="sticky-add-to-cart__image">
          {{
            image_to_show
            | image_url: width: 120
            | image_tag: loading: 'lazy', alt: image_alt, class: 'sticky-add-to-cart__image-img', srcset: null, sizes: null
          }}
        </div>
      {% endif %}

      <div
        class="sticky-add-to-cart__info"
        data-has-image="{{ has_image }}"
        data-singleton="{{ product.has_only_default_variant }}"
        data-single-option="{{ has_single_option }}"
      >
        <h3 class="sticky-add-to-cart__title">
          {{ product.title | escape }}
        </h3>

        <div
          class="sticky-add-to-cart__variant"
          {% if product.has_only_default_variant %}
            style="display: none;"
          {% endif %}
        >
          {% unless product.has_only_default_variant %}
            {{ current_variant.title | escape }}
          {% endunless %}
        </div>
      </div>

      <div class="sticky-add-to-cart__price">
        {{ current_variant.price | money }}
      </div>

      <button
        type="button"
        class="sticky-add-to-cart__button button"
        {% unless current_variant.available %}disabled{% endunless %}
      >
        {%- if current_variant.available -%}
          {{ 'products.product.add_to_cart' | t }}
        {%- else -%}
          {{ 'products.product.sold_out' | t }}
        {%- endif -%}
      </button>
    </div>
  </sticky-add-to-cart>
{% endif %}

{% liquid
  assign s = section.settings

  if s.desktop_media_position == 'left'
    assign render_order = 'media,product-details'
  else
    assign render_order = 'product-details,media'
  endif

  assign product_has_media = true
  if closest.product.media.size == 0
    assign product_has_media = false
  endif

  assign product_grid_class = 'product-information__grid'

  if product_has_media == false
    assign product_grid_class = product_grid_class | append: ' product-information--media-none'
  elsif s.desktop_media_position == 'right'
    assign product_grid_class = product_grid_class | append: ' product-information--media-right'
  else
    assign product_grid_class = product_grid_class | append: ' product-information--media-left'
  endif

  if s.equal_columns
    assign product_grid_class = product_grid_class | append: ' product-information__grid--half'
    if s.limit_details_width
      assign product_grid_class = product_grid_class | append: ' product-information__grid--limit-details'
    endif
  endif

  case s.content_width
    when 'content-center-aligned'
      assign content_width = 'page-width'
    when 'content-full-width'
      assign content_width = 'full-width'
  endcase
%}

<div
  class="product-information section section--{{ content_width }}"
  style="
    padding-block-start: {{ s.padding-block-start }}px;
    padding-block-end: {{ s.padding-block-end }}px;
    --gap: {{ s.gap }}px;
  "
>
  <div class="{{ product_grid_class }}">
    {% assign render_order_array = render_order | split: ',' %}

    {% capture media %}
      <div class="product-information__media">
        {{ media_gallery }}
      </div>
    {% endcapture %}

    {% for block in render_order_array %}
      {% if block == 'media' and product_has_media %}
        {{ media }}
      {% elsif block == 'product-details' %}
        {{ product_details }}
      {% endif %}
    {% endfor %}
  </div>

  {{ additional_blocks }}
</div>

{% schema %}
{
  "name": "Main Product - Compact",
  "blocks": [
    { "type": "@app" }
  ],
  "disabled_on": {
    "groups": ["header", "footer"]
  },
  "settings": [
    {
      "type": "select",
      "id": "content_width",
      "label": "Content width",
      "options": [
        { "value": "content-center-aligned", "label": "Centered" },
        { "value": "content-full-width", "label": "Full width" }
      ],
      "default": "content-center-aligned"
    },
    {
      "type": "select",
      "id": "desktop_media_position",
      "label": "Desktop media position",
      "options": [
        { "value": "left", "label": "Left" },
        { "value": "right", "label": "Right" }
      ],
      "default": "left"
    },
    {
      "type": "checkbox",
      "id": "equal_columns",
      "label": "Equal width columns",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "limit_details_width",
      "label": "Limit details width",
      "default": true,
      "visible_if": "{{ section.settings.equal_columns }}"
    },
    {
      "type": "range",
      "id": "gap",
      "label": "Column gap",
      "min": 0,
      "max": 48,
      "step": 4,
      "unit": "px",
      "default": 12
    },
    {
      "type": "checkbox",
      "id": "enable_sticky_add_to_cart",
      "label": "Enable sticky add to cart",
      "default": true
    },
    {
      "type": "range",
      "id": "padding-block-start",
      "label": "Padding top",
      "min": 0,
      "max": 100,
      "step": 1,
      "unit": "px",
      "default": 0
    },
    {
      "type": "range",
      "id": "padding-block-end",
      "label": "Padding bottom",
      "min": 0,
      "max": 100,
      "step": 1,
      "unit": "px",
      "default": 0
    }
  ],
  "presets": [
    {
      "name": "Main Product - Compact",
      "category": "Products"
    }
  ]
}
{% endschema %}
