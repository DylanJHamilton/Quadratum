{%- comment -%}
  SECTION: product-cross-sell.liquid
  Related / complementary products near bottom of PDP.
  Buttons are FORCE-ENABLED via snippet parameters.
{%- endcomment -%}

{%- liquid
  assign s = section.settings
  assign p = product
  if p == blank
    break
  endif

  assign mode = s.mode | default: 'dynamic'
  assign layout = s.layout | default: 'grid'
  assign max_products = s.max_products | default: 4

  assign cols_desktop = s.columns_desktop | default: 4
  assign cols_tablet  = s.columns_tablet  | default: 2
  assign cols_mobile  = s.columns_mobile | default: '1' | plus: 0

  assign current_id = p.id
  assign c = s.collection
-%}

<section id="product-cross-sell" class="q-product-cross-sell">

  <div class="q-product-cross-sell__inner">

    {%- if s.title != blank -%}
      <h2 class="q-product-cross-sell__title">{{ s.title }}</h2>
    {%- endif -%}

    {%- if s.subheading != blank -%}
      <div class="q-product-cross-sell__subheading rte">
        {{ s.subheading }}
      </div>
    {%- endif -%}

    <div
      class="q-product-cross-sell__products q-product-cross-sell__products--{{ layout }}"
      style="--q-cols-desktop:{{ cols_desktop }}; --q-cols-tablet:{{ cols_tablet }}; --q-cols-mobile:{{ cols_mobile }};"
    >

    {%- liquid
      assign rendered = 0
      assign seen_ids = ''
    -%}

    {%- if mode == 'collection' and c != blank -%}
      {%- for cp in c.products -%}
        {%- if cp.id != current_id and cp.available -%}
          {%- assign token = '|' | append: cp.id | append: '|' -%}
          {%- unless seen_ids contains token -%}
            {%- assign seen_ids = seen_ids | append: token -%}

            <div class="q-pcs__item">
              {% render 'product-card',
                product: cp,
                enable_quick_add: true,
                enable_quick_view: false,
                show_action_row: true,
                button_full_width: true,
                primary_cta_label: s.button_label_text
              %}
            </div>

            {%- assign rendered = rendered | plus: 1 -%}
            {%- if rendered >= max_products -%}{%- break -%}{%- endif -%}
          {%- endunless -%}
        {%- endif -%}
      {%- endfor -%}

    {%- elsif mode == 'manual' -%}
      {%- for block in section.blocks -%}
        {%- assign bp = block.settings.product -%}
        {%- if bp != blank and bp.id != current_id and bp.available -%}
          {%- assign token = '|' | append: bp.id | append: '|' -%}
          {%- unless seen_ids contains token -%}
            {%- assign seen_ids = seen_ids | append: token -%}

            <div class="q-pcs__item">
              {% render 'product-card',
                product: bp,
                enable_quick_add: true,
                enable_quick_view: false,
                show_action_row: true,
                button_full_width: true,
                primary_cta_label: s.button_label_text
              %}
            </div>

            {%- assign rendered = rendered | plus: 1 -%}
            {%- if rendered >= max_products -%}{%- break -%}{%- endif -%}
          {%- endunless -%}
        {%- endif -%}
      {%- endfor -%}

    {%- elsif mode == 'dynamic' -%}

      {%- for cp in recommendations.products limit: max_products -%}
        {%- if cp.id != current_id and cp.available -%}
          <div class="q-pcs__item">
            {% render 'product-card',
              product: cp,
              enable_quick_add: true,
              enable_quick_view: false,
              show_action_row: true,
              button_full_width: true,
              primary_cta_label: s.button_label_text
            %}
          </div>
        {%- endif -%}
      {%- endfor -%}

    {%- endif -%}

    </div>

  </div>

  <style>
    #product-cross-sell {
      --q-feed-gap: {{ s.grid_gap | default: 16 }}px;
    }

    .q-product-cross-sell__inner {
      max-width: var(--page-width, 1200px);
      margin: 0 auto;
      padding: 2rem 1rem;
    }

    .q-product-cross-sell__products {
      display: grid;
      gap: var(--q-feed-gap);
      grid-template-columns: repeat(var(--q-cols-desktop, 4), 1fr);
    }

    @media (max-width: 989px) {
      .q-product-cross-sell__products {
        grid-template-columns: repeat(var(--q-cols-tablet, 2), 1fr);
      }
    }

    @media (max-width: 749px) {
      .q-product-cross-sell__products {
        grid-template-columns: repeat(var(--q-cols-mobile, 1), 1fr);
      }
    }
  </style>

</section>

{% schema %}
{
  "name": "Product Cross Sell",
  "settings": [
    { "type": "text", "id": "title", "default": "You may also like", "label": "Title" },
    { "type": "richtext", "id": "subheading", "label": "Subheading" },

    {
      "type": "select",
      "id": "mode",
      "label": "Mode",
      "default": "dynamic",
      "options": [
        { "value": "manual", "label": "Manual" },
        { "value": "collection", "label": "Collection" },
        { "value": "dynamic", "label": "Dynamic" }
      ]
    },

    { "type": "collection", "id": "collection", "label": "Collection" },

    { "type": "range", "id": "max_products", "label": "Max products", "min": 2, "max": 12, "step": 1, "default": 4 },

    { "type": "range", "id": "columns_desktop", "label": "Columns (desktop)", "min": 2, "max": 6, "step": 1, "default": 4 },
    { "type": "range", "id": "columns_tablet", "label": "Columns (tablet)", "min": 1, "max": 4, "step": 1, "default": 2 },

    {
      "type": "select",
      "id": "columns_mobile",
      "label": "Columns (mobile)",
      "default": "1",
      "options": [
        { "value": "1", "label": "1" },
        { "value": "2", "label": "2" }
      ]
    },

    { "type": "range", "id": "grid_gap", "label": "Gap (px)", "min": 8, "max": 40, "step": 1, "default": 16 },

    { "type": "text", "id": "button_label_text", "label": "Button label", "default": "Add to cart" }
  ],
  "blocks": [
    {
      "type": "product_reference",
      "name": "Product",
      "settings": [
        { "type": "product", "id": "product", "label": "Product" }
      ]
    }
  ],
  "presets": [
    { "name": "Product Cross Sell" }
  ]
}
{% endschema %}
