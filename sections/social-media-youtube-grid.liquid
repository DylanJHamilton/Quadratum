{%- liquid
  assign s = section.settings
  assign cols_d = s.columns_desktop | default: 3
  assign cols_m = s.columns_mobile | default: 1
  assign gap = s.card_gap | default: 20
  assign ratio = s.video_ratio | default: '16:9'
  assign ratio_class = ratio | replace: ':', '-'

  assign modal_ratio = '16 / 9'
  case ratio
    when '1:1'
      assign modal_ratio = '1 / 1'
    when '9:16'
      assign modal_ratio = '9 / 16'
    when '4:5'
      assign modal_ratio = '4 / 5'
    else
      assign modal_ratio = '16 / 9'
  endcase
-%}

{%- if s.enable_section -%}
<section
  id="social-media-youtube-grid-{{ section.id }}"
  class="q-section q-social-youtube-grid"
  aria-label="{{ s.aria_label | escape }}"
>
  <div class="q-social-youtube-grid__inner">
    {%- assign align = s.align | default: 'center' -%}

    <header class="q-social-youtube-grid__header q-align-{{ align }}">
      {%- if s.kicker != blank -%}
        <p class="q-social-youtube-grid__kicker">{{ s.kicker | escape }}</p>
      {%- endif -%}

      {%- if s.heading != blank -%}
        <h2 class="q-social-youtube-grid__heading">{{ s.heading | escape }}</h2>
      {%- endif -%}

      {%- if s.body != blank -%}
        <div class="q-social-youtube-grid__body">
          {{ s.body }}
        </div>
      {%- endif -%}
    </header>

    {%- assign data_source_mode = s.data_source_mode | default: 'manual' -%}

    {%- if data_source_mode == 'manual' -%}
      {%- if section.blocks.size > 0 -%}
        <div
          class="q-video-grid q-video-grid--ratio-{{ ratio_class }}"
          style="--q-video-grid-gap: {{ gap }}px; --q-video-grid-cols-desktop: {{ cols_d }}; --q-video-grid-cols-mobile: {{ cols_m }};"
        >
          {%- for block in section.blocks -%}
            {%- assign b = block.settings -%}
            {%- assign url = b.youtube_url -%}
            {%- assign has_url = false -%}
            {%- if url != blank and url != '#' -%}
              {%- assign has_url = true -%}
            {%- endif -%}

            {%- assign card_style = s.card_style | default: 'surface' -%}
            {%- assign link_aria = b.aria_label | default: 'Watch video on YouTube' -%}
            {%- assign thumb_alt = b.title | default: 'YouTube video thumbnail' -%}

            <article class="q-video-card q-video-card--{{ card_style }}" {{ block.shopify_attributes }}>
              {%- if has_url -%}
                <a
                  class="q-video-card__link"
                  href="{{ url }}"
                  aria-label="{{ link_aria | escape }}"
                  data-q-yt-trigger="{{ section.id }}"
                  data-q-yt-url="{{ url | escape }}"
                  {%- if s.open_in_new_tab -%} data-q-yt-fallback-tab="1"{%- endif -%}
                >
                  <div class="q-video-card__media q-ratio q-ratio--{{ ratio_class }}">
                    {%- if b.thumbnail_override != blank -%}
                      {{ b.thumbnail_override | image_url: width: 960 | image_tag: loading: 'lazy', decoding: 'async', alt: thumb_alt, class: 'q-video-card__thumb' }}
                    {%- else -%}
                      <img
                        class="q-video-card__thumb q-video-card__thumb--auto"
                        src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///ywAAAAAAQABAAACAUwAOw=="
                        loading="lazy"
                        decoding="async"
                        alt="{{ thumb_alt | escape }}"
                        data-q-yt-thumb="1"
                        data-q-yt-url="{{ url | escape }}"
                      >
                    {%- endif -%}

                    <span class="q-video-card__play" aria-hidden="true">
                      <svg viewBox="0 0 24 24" width="22" height="22" focusable="false" aria-hidden="true">
                        <path d="M8 5v14l11-7z"></path>
                      </svg>
                    </span>

                    {%- if s.show_platform_badge -%}
                      <span class="q-video-card__badge" aria-hidden="true" title="YouTube">
                        <svg viewBox="0 0 24 24" width="18" height="18" focusable="false" aria-hidden="true">
                          <path d="M23.5 6.2s-.2-1.7-.9-2.4c-.9-.9-1.9-.9-2.4-1C16.9 2.5 12 2.5 12 2.5h0s-4.9 0-8.2.3c-.4 0-1.4.1-2.4 1C.7 4.5.5 6.2.5 6.2S.2 8.1.2 9.9v1.7c0 1.8.3 3.7.3 3.7s.2 1.7.9 2.4c.9.9 2.1.9 2.6 1 1.9.2 8 .3 8 .3s4.9 0 8.2-.3c.4 0 1.4-.1 2.4-1 .7-.7.9-2.4.9-2.4s.3-1.9.3-3.7V9.9c0-1.8-.3-3.7-.3-3.7zM9.7 14.8V7.9l6.3 3.5-6.3 3.4z"></path>
                        </svg>
                      </span>
                    {%- endif -%}

                    {%- if b.duration_label != blank -%}
                      <span class="q-video-card__duration">{{ b.duration_label | escape }}</span>
                    {%- endif -%}
                  </div>

                  <div class="q-video-card__body">
                    {%- if s.show_tag and b.tag != blank -%}
                      <p class="q-video-card__tag">{{ b.tag | escape }}</p>
                    {%- endif -%}

                    <h3 class="q-video-card__title">{{ b.title | escape }}</h3>

                    {%- if s.show_description and b.description != blank -%}
                      <p class="q-video-card__description">{{ b.description | escape }}</p>
                    {%- endif -%}

                    {%- if s.show_watch_label -%}
                      <span class="q-video-card__watch">Watch on YouTube</span>
                    {%- endif -%}
                  </div>
                </a>
              {%- else -%}
                <div class="q-video-card__placeholder" aria-hidden="true">
                  <div class="q-video-card__media q-ratio q-ratio--{{ ratio_class }}">
                    <span class="q-video-card__play" aria-hidden="true">
                      <svg viewBox="0 0 24 24" width="22" height="22" focusable="false" aria-hidden="true">
                        <path d="M8 5v14l11-7z"></path>
                      </svg>
                    </span>
                  </div>
                  <div class="q-video-card__body">
                    <h3 class="q-video-card__title">{{ b.title | escape }}</h3>
                  </div>
                </div>
              {%- endif -%}
            </article>
          {%- endfor -%}
        </div>
      {%- endif -%}
    {%- else -%}
      {%- if request.design_mode -%}
        <div class="q-video-grid__placeholder">
          <p>Playlist mode is enabled. Connect this section to a Quadratum Link playlist feed.</p>
        </div>
      {%- endif -%}
    {%- endif -%}
  </div>

  <!-- Modal (Hybrid player) -->
  <div
    class="q-yt-modal"
    id="q-yt-modal-{{ section.id }}"
    hidden
    style="--q-yt-modal-aspect: {{ modal_ratio }};"
  >
    <div class="q-yt-modal__overlay" data-q-yt-close="{{ section.id }}"></div>
    <div class="q-yt-modal__dialog" role="dialog" aria-modal="true" aria-label="YouTube video player">
      <button type="button" class="q-yt-modal__close" aria-label="Close" data-q-yt-close="{{ section.id }}">
        <span aria-hidden="true">×</span>
      </button>

      <div class="q-yt-modal__player">
        <div id="q-yt-player-{{ section.id }}"></div>
      </div>

      <p class="q-yt-modal__fallback">
        If this video can’t be embedded, you’ll be sent to YouTube automatically.
        <a class="q-yt-modal__fallback-link" href="https://example.com" target="_blank" rel="noopener noreferrer">
          Watch on YouTube
        </a>
      </p>
    </div>
  </div>

  <script>
    (function () {
      var sectionId = {{ section.id | json }};
      var modal = document.getElementById('q-yt-modal-' + sectionId);
      if (!modal) return;

      var playerHostId = 'q-yt-player-' + sectionId;
      var playerHost = document.getElementById(playerHostId);
      if (!playerHost) return;

      var fallbackLink = modal.querySelector('.q-yt-modal__fallback-link');
      var closeEls = modal.querySelectorAll('[data-q-yt-close="' + sectionId + '"]');
      var triggers = document.querySelectorAll('[data-q-yt-trigger="' + sectionId + '"]');

      var activeUrl = null;
      var activeFallbackNewTab = true;

      function parseYouTubeId(url) {
        try {
          var u = new URL(url);
          var host = (u.hostname || '').replace('www.', '');

          if (host === 'youtu.be') {
            var p = u.pathname.replace('/', '');
            if (p) return p;
          }

          var v = u.searchParams.get('v');
          if (v) return v;

          var path = u.pathname || '';
          // /shorts/VIDEOID
          if (path.indexOf('/shorts/') === 0) {
            return path.split('/shorts/')[1].split('/')[0];
          }
          // /embed/VIDEOID
          if (path.indexOf('/embed/') === 0) {
            return path.split('/embed/')[1].split('/')[0];
          }
        } catch (e) {}
        return null;
      }

      function openFallback(url) {
        try { closeModal(); } catch (e) {}
        if (!url) return;

        if (activeFallbackNewTab) {
          window.open(url, '_blank', 'noopener,noreferrer');
        } else {
          window.location.href = url;
        }
      }

      function openModal() {
        modal.hidden = false;
        document.documentElement.classList.add('q-yt-modal-open');
        // focus close for keyboard users
        var btn = modal.querySelector('.q-yt-modal__close');
        if (btn) btn.focus();
      }

      function closeModal() {
        modal.hidden = true;
        document.documentElement.classList.remove('q-yt-modal-open');
        stopPlayer();
      }

      function stopPlayer() {
        if (window.__qYTPlayer && window.__qYTPlayer[sectionId]) {
          try { window.__qYTPlayer[sectionId].stopVideo(); } catch (e) {}
        }
      }

      // Lazy-load YT Iframe API once
      function loadYouTubeAPI() {
        if (window.__qYTApiPromise) return window.__qYTApiPromise;

        window.__qYTApiPromise = new Promise(function (resolve, reject) {
          if (window.YT && window.YT.Player) {
            resolve(window.YT);
            return;
          }

          var tag = document.createElement('script');
          tag.src = 'https://www.youtube.com/iframe_api';
          tag.async = true;
          tag.onload = function () {};
          tag.onerror = function () { reject(new Error('YT API load failed')); };
          document.head.appendChild(tag);

          var timeout = setTimeout(function () {
            reject(new Error('YT API timeout'));
          }, 8000);

          window.onYouTubeIframeAPIReady = function () {
            clearTimeout(timeout);
            resolve(window.YT);
          };
        });

        return window.__qYTApiPromise;
      }

      function ensurePlayer(videoId, watchUrl) {
        return loadYouTubeAPI().then(function () {
          if (!window.__qYTPlayer) window.__qYTPlayer = {};
          if (window.__qYTPlayer[sectionId]) {
            try {
              window.__qYTPlayer[sectionId].loadVideoById(videoId);
              return;
            } catch (e) {
              try { window.__qYTPlayer[sectionId].destroy(); } catch (e2) {}
              window.__qYTPlayer[sectionId] = null;
            }
          }

          window.__qYTPlayer[sectionId] = new window.YT.Player(playerHostId, {
            videoId: videoId,
            playerVars: {
              autoplay: 1,
              rel: 0,
              modestbranding: 1,
              playsinline: 1
            },
            events: {
              onReady: function (ev) {
                try { ev.target.playVideo(); } catch (e) {}
              },
              onError: function () {
                // Embedding disabled (101/150) and other failures -> fallback
                openFallback(watchUrl);
              }
            }
          });
        }).catch(function () {
          // If API fails, fallback immediately
          openFallback(watchUrl);
        });
      }

      function handleTriggerClick(e) {
        var url = e.currentTarget.getAttribute('data-q-yt-url') || e.currentTarget.getAttribute('href');
        if (!url) return;

        activeUrl = url;
        activeFallbackNewTab = e.currentTarget.getAttribute('data-q-yt-fallback-tab') === '1';

        var id = parseYouTubeId(url);
        if (!id) return; // allow normal navigation if we can't parse

        e.preventDefault();

        if (fallbackLink) {
          fallbackLink.setAttribute('href', url);
          if (activeFallbackNewTab) {
            fallbackLink.setAttribute('target', '_blank');
            fallbackLink.setAttribute('rel', 'noopener noreferrer');
          } else {
            fallbackLink.removeAttribute('target');
            fallbackLink.removeAttribute('rel');
          }
        }

        openModal();
        ensurePlayer(id, url);
      }

      // Close interactions
      closeEls.forEach(function (el) {
        el.addEventListener('click', function () { closeModal(); });
      });

      document.addEventListener('keydown', function (e) {
        if (modal.hidden) return;
        if (e.key === 'Escape') closeModal();
      });

      // Bind triggers
      triggers.forEach(function (t) {
        t.addEventListener('click', handleTriggerClick);
      });

      // Auto thumbnails (no API): i.ytimg.com/vi/ID/hqdefault.jpg
      var autoThumbs = document.querySelectorAll('#social-media-youtube-grid-' + sectionId + ' [data-q-yt-thumb="1"]');
      autoThumbs.forEach(function (img) {
        var url = img.getAttribute('data-q-yt-url');
        var id = parseYouTubeId(url || '');
        if (!id) return;
        img.src = 'https://i.ytimg.com/vi/' + id + '/hqdefault.jpg';
      });
    })();
  </script>

  <style>
    /* scoped, minimal, token-friendly */
    .q-social-youtube-grid__inner {
      max-width: var(--q-container, 1152px);
      margin: 0 auto;
      padding: var(--q-section-pad-y, 48px) var(--q-section-pad-x, 20px);
    }
    .q-social-youtube-grid__header { margin-bottom: 20px; }
    .q-align-left { text-align: left; }
    .q-align-center { text-align: center; }

    .q-social-youtube-grid__kicker {
      margin: 0 0 6px;
      font-size: 0.9rem;
      opacity: 0.75;
    }
    .q-social-youtube-grid__heading {
      margin: 0;
      font-size: 1.8rem;
      line-height: 1.15;
    }
    .q-social-youtube-grid__body {
      margin-top: 10px;
      opacity: 0.9;
    }

    .q-video-grid {
      display: grid;
      gap: var(--q-video-grid-gap, 20px);
      grid-template-columns: repeat(var(--q-video-grid-cols-desktop, 3), minmax(0, 1fr));
    }
    @media (max-width: 767px) {
      .q-video-grid {
        grid-template-columns: repeat(var(--q-video-grid-cols-mobile, 1), minmax(0, 1fr));
      }
    }

    .q-video-card {
      border-radius: var(--q-radius, 16px);
      overflow: hidden;
    }
    .q-video-card--surface {
      background: var(--q-surface, rgba(0,0,0,0.03));
    }
    .q-video-card--bordered {
      border: 1px solid rgba(0,0,0,0.12);
      background: transparent;
    }
    .q-video-card--minimal {
      background: transparent;
    }

    .q-video-card__link,
    .q-video-card__placeholder {
      display: grid;
      grid-template-rows: auto 1fr;
      text-decoration: none;
      color: inherit;
    }

    .q-ratio { position: relative; width: 100%; }
    .q-ratio--16-9 { aspect-ratio: 16 / 9; }
    .q-ratio--9-16 { aspect-ratio: 9 / 16; }
    .q-ratio--4-5  { aspect-ratio: 4 / 5; }
    .q-ratio--1-1  { aspect-ratio: 1 / 1; }

    .q-video-card__media {
      position: relative;
      background: rgba(0,0,0,0.06);
      overflow: hidden;
    }
    .q-video-card__thumb {
      width: 100%;
      height: 100%;
      display: block;
      object-fit: cover;
    }

    .q-video-card__play {
      position: absolute;
      inset: auto auto 12px 12px;
      width: 40px;
      height: 40px;
      border-radius: 999px;
      display: grid;
      place-items: center;
      background: rgba(0,0,0,0.55);
      color: #fff;
    }
    .q-video-card__play svg { fill: currentColor; transform: translateX(1px); }

    .q-video-card__badge {
      position: absolute;
      top: 12px;
      right: 12px;
      width: 34px;
      height: 34px;
      border-radius: 999px;
      display: grid;
      place-items: center;
      background: rgba(0,0,0,0.6);
      color: #fff;
    }
    .q-video-card__badge svg { fill: currentColor; }

    .q-video-card__duration {
      position: absolute;
      bottom: 12px;
      right: 12px;
      font-size: 0.85rem;
      padding: 4px 8px;
      border-radius: 10px;
      background: rgba(0,0,0,0.65);
      color: #fff;
    }

    .q-video-card__body {
      padding: 14px 14px 16px;
      display: grid;
      gap: 8px;
    }
    .q-video-card__tag {
      margin: 0;
      font-size: 0.8rem;
      letter-spacing: 0.02em;
      text-transform: uppercase;
      opacity: 0.7;
    }
    .q-video-card__title {
      margin: 0;
      font-size: 1.05rem;
      line-height: 1.25;
    }
    .q-video-card__description {
      margin: 0;
      opacity: 0.85;
      display: -webkit-box;
      -webkit-line-clamp: 3;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }
    .q-video-card__watch {
      margin-top: 2px;
      font-weight: 600;
      text-decoration: underline;
    }

    .q-video-card__link:focus-visible {
      outline: 2px solid currentColor;
      outline-offset: 3px;
    }

    /* Modal */
    .q-yt-modal[hidden] { display: none; }
    .q-yt-modal {
      position: fixed;
      inset: 0;
      z-index: 9999;
      display: grid;
      place-items: center;
      padding: 18px;
    }
    .q-yt-modal__overlay {
      position: absolute;
      inset: 0;
      background: rgba(0,0,0,0.6);
    }
    .q-yt-modal__dialog {
      position: relative;
      width: min(960px, 100%);
      border-radius: 18px;
      background: #fff;
      color: #111;
      overflow: hidden;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }
    .q-yt-modal__close {
      position: absolute;
      top: 10px;
      right: 10px;
      width: 40px;
      height: 40px;
      border: 0;
      border-radius: 999px;
      background: rgba(0,0,0,0.65);
      color: #fff;
      cursor: pointer;
      z-index: 2;
    }
    .q-yt-modal__close:focus-visible {
      outline: 2px solid #fff;
      outline-offset: 2px;
    }
    .q-yt-modal__player {
      width: 100%;
      aspect-ratio: var(--q-yt-modal-aspect, 16 / 9);
      background: #000;
    }
    .q-yt-modal__player iframe {
      width: 100%;
      height: 100%;
      border: 0;
      display: block;
    }
    .q-yt-modal__fallback {
      margin: 0;
      padding: 12px 16px 16px;
      font-size: 0.95rem;
      opacity: 0.9;
    }
    .q-yt-modal__fallback-link {
      font-weight: 700;
      text-decoration: underline;
    }

    .q-yt-modal-open { overflow: hidden; }
  </style>
</section>
{%- endif -%}

{% schema %}
{
  "name": "Social Media - YT Grid",
  "tag": "section",
  "class": "q-section q-social-youtube-grid",
  "settings": [
    {
      "type": "checkbox",
      "id": "enable_section",
      "label": "Enable section",
      "default": true
    },
    {
      "type": "text",
      "id": "kicker",
      "label": "Kicker",
      "default": "Watch & learn"
    },
    {
      "type": "text",
      "id": "heading",
      "label": "Heading",
      "default": "From our YouTube channel"
    },
    {
      "type": "textarea",
      "id": "body",
      "label": "Body text",
      "default": "Highlight tutorials, reviews, and stories from your YouTube channel."
    },
    {
      "type": "select",
      "id": "align",
      "label": "Text alignment",
      "default": "center",
      "options": [
        { "value": "left", "label": "Left" },
        { "value": "center", "label": "Center" }
      ]
    },
    {
      "type": "header",
      "content": "Layout"
    },
    {
      "type": "range",
      "id": "columns_desktop",
      "label": "Columns on desktop",
      "min": 2,
      "max": 4,
      "step": 1,
      "default": 3
    },
    {
      "type": "range",
      "id": "columns_mobile",
      "label": "Columns on mobile",
      "min": 1,
      "max": 3,
      "step": 1,
      "default": 1
    },
    {
      "type": "range",
      "id": "card_gap",
      "label": "Gap between cards (px)",
      "min": 8,
      "max": 40,
      "step": 2,
      "default": 20
    },
    {
      "type": "select",
      "id": "card_style",
      "label": "Card style",
      "default": "surface",
      "options": [
        { "value": "surface", "label": "Soft surface" },
        { "value": "bordered", "label": "Bordered" },
        { "value": "minimal", "label": "Minimal (no background)" }
      ]
    },
    {
      "type": "select",
      "id": "video_ratio",
      "label": "Video aspect ratio",
      "default": "16:9",
      "options": [
        { "value": "16:9", "label": "16:9 (YouTube default)" },
        { "value": "1:1", "label": "Square (1:1)" },
        { "value": "9:16", "label": "Vertical (9:16)" },
        { "value": "4:5", "label": "Portrait (4:5)" }
      ]
    },
    {
      "type": "header",
      "content": "Labels & CTA"
    },
    {
      "type": "checkbox",
      "id": "show_tag",
      "label": "Show tag (Tutorial, Review, etc.)",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "show_description",
      "label": "Show description",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "show_platform_badge",
      "label": "Show YouTube badge on thumbnail",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "show_watch_label",
      "label": "Show \"Watch on YouTube\" label",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "open_in_new_tab",
      "label": "Open videos in new tab",
      "default": true
    },
    {
      "type": "header",
      "content": "Data source (Quadratum Link ready)"
    },
    {
      "type": "select",
      "id": "data_source_mode",
      "label": "Data source",
      "default": "manual",
      "options": [
        { "value": "manual", "label": "Manual videos (theme editor)" },
        { "value": "playlist", "label": "Playlist feed (Quadratum Link, future)" }
      ]
    },
    {
      "type": "text",
      "id": "playlist_handle",
      "label": "Playlist handle (for Quadratum Link)",
      "default": "youtube_playlist_default"
    },
    {
      "type": "text",
      "id": "aria_label",
      "label": "ARIA label for section",
      "default": "YouTube video gallery"
    }
  ],
  "blocks": [
    {
      "type": "youtube_video",
      "name": "YouTube video",
      "settings": [
        {
          "type": "text",
          "id": "title",
          "label": "Title",
          "default": "How to get the most from your purchase"
        },
        {
          "type": "text",
          "id": "tag",
          "label": "Tag (Tutorial, Review, etc.)",
          "default": "Tutorial"
        },
        {
          "type": "url",
          "id": "youtube_url",
          "label": "YouTube URL",
        },
        {
          "type": "textarea",
          "id": "description",
          "label": "Short description",
          "default": "Add an optional short description for this video."
        },
        {
          "type": "text",
          "id": "duration_label",
          "label": "Duration label (optional)",
          "default": "Optional"
        },
        {
          "type": "image_picker",
          "id": "thumbnail_override",
          "label": "Custom thumbnail (optional)"
        },
        {
          "type": "text",
          "id": "aria_label",
          "label": "ARIA label for video link",
          "default": "Watch video on YouTube"
        }
      ]
    }
  ],
  "max_blocks": 12,
  "presets": [
    {
      "name": "Social Media - YouTube Grid",
      "category": "Social Media",
      "blocks": [
        { "type": "youtube_video" },
        { "type": "youtube_video" },
        { "type": "youtube_video" }
      ]
    }
  ]
}
{% endschema %}
