{%- comment -%}
  Quadratum â€” Main Product (Compact)
  File: sections/main-product-compact.liquid

  GOAL
  - Block-driven PDP like Tinker/Dawn (editor blocks available + reorderable)
  - Featured image only (no media gallery engine dependency)
  - No color scheme setting
  - Self-contained: no reliance on snippets that may not exist in this codebase

  Notes:
  - Uses only section.blocks and standard product form
{%- endcomment -%}

{%- liquid
  assign p = product | default: closest.product
  if p == blank
    break
  endif

  assign s = section.settings
  assign v = p.selected_or_first_available_variant
  if v == blank
    assign v = p.variants.first
  endif

  assign on_sale = false
  if v.compare_at_price and v.compare_at_price > v.price
    assign on_sale = true
  endif

  assign content_width_class = 'page-width'
  if s.content_width == 'content-full-width'
    assign content_width_class = 'full-width'
  endif
-%}

<script type="application/ld+json">
  {{ p | structured_data }}
</script>

<section
  id="MainProductCompact-{{ section.id }}"
  class="qtm-compact section section--{{ content_width_class }}"
  style="
    padding-top: {{ s.padding_top }}px;
    padding-bottom: {{ s.padding_bottom }}px;
    --qtm-gap: {{ s.gap }}px;
  "
  data-section-id="{{ section.id }}"
  data-product-id="{{ p.id }}"
>
  <div class="{{ content_width_class }}">
    <div class="qtm-compact__grid {% if s.desktop_media_position == 'right' %}qtm-compact__grid--media-right{% endif %}">

      {%- capture media_col -%}
        <div class="qtm-compact__media" aria-label="Product image">
          {%- if p.featured_image -%}
            {{
              p.featured_image
              | image_url: width: 2000
              | image_tag:
                loading: 'eager',
                class: 'qtm-compact__img',
                alt: p.featured_image.alt | default: p.title | escape
            }}
          {%- else -%}
            <div class="qtm-compact__placeholder"></div>
          {%- endif -%}
        </div>
      {%- endcapture -%}

      <div class="qtm-compact__details">
        <div class="qtm-compact__stack">
          {%- form 'product', p, id: 'ProductForm-' | append: section.id, class: 'qtm-compact__form', novalidate: 'novalidate' -%}
            <input type="hidden" name="id" value="{{ v.id }}">

            {%- for block in section.blocks -%}
              {%- case block.type -%}

                {%- when 'title' -%}
                  <h1 class="qtm-compact__title" {{ block.shopify_attributes }}>
                    {{ p.title | escape }}
                  </h1>

                {%- when 'price' -%}
                  <div class="qtm-compact__price" {{ block.shopify_attributes }}>
                    {%- if on_sale -%}
                      <span class="qtm-compact__price-sale">{{ v.price | money }}</span>
                      <span class="qtm-compact__price-compare"><s>{{ v.compare_at_price | money }}</s></span>
                    {%- else -%}
                      <span class="qtm-compact__price-regular">{{ v.price | money }}</span>
                    {%- endif -%}
                  </div>

                {%- when 'variant_picker' -%}
                  {%- unless p.has_only_default_variant -%}
                    <div class="qtm-compact__variants" {{ block.shopify_attributes }}>
                      {%- for option in p.options_with_values -%}
                        <div class="qtm-compact__option">
                          <label class="qtm-compact__label" for="Option-{{ section.id }}-{{ forloop.index0 }}">
                            {{ option.name }}
                          </label>
                          <select
                            id="Option-{{ section.id }}-{{ forloop.index0 }}"
                            class="qtm-compact__select"
                            name="options[{{ option.name | escape }}]"
                          >
                            {%- for value in option.values -%}
                              <option value="{{ value | escape }}" {% if option.selected_value == value %}selected{% endif %}>
                                {{ value }}
                              </option>
                            {%- endfor -%}
                          </select>
                        </div>
                      {%- endfor -%}
                      <p class="qtm-compact__note">Variant selection updates on submit in this Phase 1 build.</p>
                    </div>
                  {%- endunless -%}

                {%- when 'quantity' -%}
                  <div class="qtm-compact__qty" {{ block.shopify_attributes }}>
                    <label class="qtm-compact__label" for="Quantity-{{ section.id }}">Quantity</label>
                    <input
                      id="Quantity-{{ section.id }}"
                      class="qtm-compact__qty-input"
                      type="number"
                      name="quantity"
                      value="{{ v.quantity_rule.min | default: 1 }}"
                      min="{{ v.quantity_rule.min | default: 1 }}"
                      step="{{ v.quantity_rule.increment | default: 1 }}"
                      {% if v.quantity_rule.max %}max="{{ v.quantity_rule.max }}"{% endif %}
                    >
                  </div>

                {%- when 'buy_buttons' -%}
                  <div class="qtm-compact__buy" {{ block.shopify_attributes }}>
                    <button
                      type="submit"
                      class="qtm-compact__atc button"
                      {% unless v.available %}disabled{% endunless %}
                    >
                      {%- if v.available -%}Add to cart{%- else -%}Sold out{%- endif -%}
                    </button>
                  </div>

                {%- when 'description' -%}
                  {%- if p.description != blank -%}
                    <div class="qtm-compact__desc rte" {{ block.shopify_attributes }}>
                      {{ p.description }}
                    </div>
                  {%- endif -%}

                {%- when 'accordion' -%}
                  <details class="qtm-compact__accordion" {{ block.shopify_attributes }}>
                    <summary class="qtm-compact__accordion-summary">
                      {{ block.settings.heading | escape }}
                    </summary>
                    <div class="qtm-compact__accordion-body rte">
                      {{ block.settings.content }}
                    </div>
                  </details>

                {%- when 'spacer' -%}
                  <div class="qtm-compact__spacer" style="height: {{ block.settings.height }}px;" {{ block.shopify_attributes }}></div>

              {%- endcase -%}
            {%- endfor -%}

          {%- endform -%}
        </div>
      </div>

      {%- if s.desktop_media_position == 'right' -%}
        {{ media_col }}
      {%- else -%}
        {{ media_col }}
      {%- endif -%}

    </div>
  </div>
</section>

<style>
  .qtm-compact__grid{
    display:grid;
    gap: var(--qtm-gap);
    align-items:start;
  }
  @media (min-width: 750px){
    .qtm-compact__grid{
      grid-template-columns: 1.1fr 0.9fr;
    }
    .qtm-compact__grid--media-right{
      grid-template-columns: 0.9fr 1.1fr;
    }
    .qtm-compact__grid--media-right .qtm-compact__media{ order: 2; }
    .qtm-compact__grid--media-right .qtm-compact__details{ order: 1; }
  }

  .qtm-compact__img{
    width:100%;
    height:auto;
    display:block;
    border-radius: 14px;
  }
  .qtm-compact__placeholder{
    width:100%;
    aspect-ratio: 1 / 1;
    background: rgba(0,0,0,.06);
    border-radius: 14px;
  }

  .qtm-compact__stack{ display:flex; flex-direction:column; gap: 14px; }
  .qtm-compact__title{ margin:0; line-height:1.06; font-size: clamp(28px, 3.2vw, 44px); }
  .qtm-compact__price{ display:flex; gap: 10px; align-items:baseline; font-weight: 700; font-size: 18px; }
  .qtm-compact__price-compare{ opacity:.6; font-weight: 600; }
  .qtm-compact__variants{ display:flex; flex-direction:column; gap: 12px; }
  .qtm-compact__option{ display:flex; flex-direction:column; gap: 6px; }
  .qtm-compact__label{ font-size: 13px; opacity:.75; }
  .qtm-compact__select, .qtm-compact__qty-input{
    min-height: 44px;
    border-radius: 12px;
    border: 1px solid rgba(0,0,0,.12);
    padding: 10px 12px;
    width: 100%;
  }
  .qtm-compact__qty{ display:flex; flex-direction:column; gap: 6px; max-width: 180px; }
  .qtm-compact__atc{
    min-height: 48px;
    border-radius: 14px;
    width: 100%;
  }
  .qtm-compact__desc{ opacity:.95; line-height: 1.6; }
  .qtm-compact__accordion{
    border: 1px solid rgba(0,0,0,.10);
    border-radius: 14px;
    padding: 10px 12px;
  }
  .qtm-compact__accordion-summary{
    cursor:pointer;
    font-weight: 700;
    list-style: none;
  }
  .qtm-compact__accordion-summary::-webkit-details-marker{ display:none; }
  .qtm-compact__accordion-body{ padding-top: 10px; }
  .qtm-compact__note{ margin:0; font-size: 12px; opacity:.6; }
</style>

{% schema %}
{
  "name": "Main Product - Compact",
  "settings": [
    {
      "type": "select",
      "id": "content_width",
      "label": "Content width",
      "default": "content-center-aligned",
      "options": [
        { "value": "content-center-aligned", "label": "Centered" },
        { "value": "content-full-width", "label": "Full width" }
      ]
    },
    {
      "type": "select",
      "id": "desktop_media_position",
      "label": "Desktop media position",
      "default": "left",
      "options": [
        { "value": "left", "label": "Left" },
        { "value": "right", "label": "Right" }
      ]
    },
    {
      "type": "range",
      "id": "gap",
      "label": "Gap",
      "min": 0,
      "max": 60,
      "step": 4,
      "default": 16
    },
    {
      "type": "range",
      "id": "padding_top",
      "label": "Padding top",
      "min": 0,
      "max": 120,
      "step": 4,
      "default": 24
    },
    {
      "type": "range",
      "id": "padding_bottom",
      "label": "Padding bottom",
      "min": 0,
      "max": 120,
      "step": 4,
      "default": 24
    }
  ],
  "blocks": [
    { "type": "title", "name": "Title", "limit": 1 },
    { "type": "price", "name": "Price", "limit": 1 },
    { "type": "variant_picker", "name": "Variant picker", "limit": 1 },
    { "type": "quantity", "name": "Quantity", "limit": 1 },
    { "type": "buy_buttons", "name": "Buy buttons", "limit": 1 },
    { "type": "description", "name": "Description", "limit": 1 },
    {
      "type": "accordion",
      "name": "Accordion",
      "settings": [
        { "type": "text", "id": "heading", "label": "Heading", "default": "Details" },
        { "type": "richtext", "id": "content", "label": "Content", "default": "<p>Add your content here.</p>" }
      ]
    },
    {
      "type": "spacer",
      "name": "Spacer",
      "settings": [
        { "type": "range", "id": "height", "label": "Height", "min": 4, "max": 80, "step": 4, "default": 16 }
      ]
    }
  ],
  "presets": [
    {
      "name": "Main Product - Compact",
      "category": "Products",
      "blocks": [
        { "type": "title" },
        { "type": "price" },
        { "type": "variant_picker" },
        { "type": "quantity" },
        { "type": "buy_buttons" },
        { "type": "description" }
      ]
    }
  ]
}
{% endschema %}
