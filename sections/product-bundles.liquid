{%- comment -%}
QUADRATUM — PRODUCT BUNDLES (PRODUCTION STABLE)
Uses product handles (bulletproof)
Add multiple products to cart via AJAX
Independent PDP companion section
{%- endcomment -%}

{%- liquid
assign s = section.settings
-%}

<style>
.product-bundles{margin:40px 0}
.pb-wrap{max-width:1200px;margin:auto}
.pb-grid{display:grid;gap:24px}
.pb-card{border:1px solid rgba(0,0,0,.12);padding:20px;border-radius:12px;background:#fff}
.pb-items{display:flex;gap:16px;flex-wrap:wrap;margin:15px 0}
.pb-item{display:flex;align-items:center;gap:10px}
.pb-item img{width:60px;height:60px;object-fit:cover;border-radius:6px}
.pb-total{font-weight:600;margin:12px 0}
.pb-add{margin-top:10px}
</style>

<section class="product-bundles">
<div class="pb-wrap">

{% if s.title != blank %}
<h2>{{ s.title }}</h2>
{% endif %}

<div class="pb-grid">

{% for block in section.blocks %}
{% if block.type != 'bundle' %}{% continue %}{% endif %}

{% liquid
assign raw = block.settings.product_handles | downcase | replace: ' ', ''
assign handles = raw | split: ','
assign valid_products = '' | split: ','
assign ids = '' | split: ','
assign total = 0

for h in handles
  assign pr = all_products[h]
  if pr == blank
    continue
  endif

  assign valid_products = valid_products | push: pr

  assign v = pr.selected_or_first_available_variant
  if v == blank
    assign v = pr.variants.first
  endif

  if v != blank
    assign ids = ids | push: v.id
    assign total = total | plus: v.price
  endif
endfor
%}

{% if valid_products.size >= 2 %}

<div class="pb-card" {{ block.shopify_attributes }}>
<h3>{{ block.settings.title | default: 'Bundle' }}</h3>

<div class="pb-items">
{% for pr in valid_products %}
{% assign v = pr.selected_or_first_available_variant %}
{% if v == blank %}{% assign v = pr.variants.first %}{% endif %}

<div class="pb-item">
{% if pr.featured_image %}
<img src="{{ pr.featured_image | image_url: width:120 }}">
{% endif %}
<div>
<div>{{ pr.title }}</div>
<div>{{ v.price | money }}</div>
</div>
</div>

{% endfor %}
</div>

<div class="pb-total">
Total: {{ total | money }}
</div>

<button
class="pb-add button"
data-bundle-add
data-ids="{{ ids | join: ',' }}"
>
{{ s.button_label }}
</button>

<div class="pb-error" style="color:red;margin-top:8px;display:none;"></div>

</div>
{% endif %}

{% endfor %}
</div>
</div>
</section>

<script>
document.addEventListener('click', async e=>{
const btn=e.target.closest('[data-bundle-add]');
if(!btn) return;

const ids=btn.dataset.ids.split(',');
btn.disabled=true;
btn.innerText='Adding...';

const items=ids.map(id=>({id:parseInt(id),quantity:1}));

try{
await fetch('/cart/add.js',{
method:'POST',
headers:{'Content-Type':'application/json'},
body:JSON.stringify({items})
});

btn.innerText='Added ✓';

setTimeout(()=>{
btn.innerText='Add bundle';
btn.disabled=false;
},1500);

document.dispatchEvent(new CustomEvent('cart:refresh'));

}catch(err){
btn.disabled=false;
btn.innerText='Add bundle';
const er=btn.parentNode.querySelector('.pb-error');
if(er){
er.style.display='block';
er.innerText='Could not add bundle';
}
}
});
</script>

{% schema %}
{
"name":"Product Bundles (Stable)",
"settings":[
{ "type":"text","id":"title","label":"Section title","default":"Frequently bought together" },
{ "type":"text","id":"button_label","label":"Button label","default":"Add bundle" }
],
"blocks":[
{
"type":"bundle",
"name":"Bundle",
"settings":[
{ "type":"text","id":"title","label":"Bundle title" },
{ "type":"textarea","id":"product_handles","label":"Product handles (comma separated)", "info":"example: hoodie-black,hat-pro,socks-elite" }
]
}
],
"presets":[{"name":"Product Bundles"}]
}
{% endschema %}
