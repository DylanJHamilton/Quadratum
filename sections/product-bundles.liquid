{%- comment -%}
  Quadratum â€” Product Bundles (PDP companion)
  File: sections/product-bundles.liquid

  PRODUCTION-SAFE RULES:
  - Self-contained PDP companion (no dependency on main-product-* sections)
  - No empty wrappers on storefront; editor shows placeholder when empty
  - Manual mode supports product pickers that may arrive as:
      - product object (variants present)
      - reference object (handle/url)
      - handle string
      - url-like string
  - Metafield mode supports:
      - product_list: single bundle (up to 6)
      - metaobject_list: multiple bundles (up to max_bundles)
  - Cart add handled by section JS via /cart/add.js (no assumptions)
{%- endcomment -%}

{%- liquid
  assign s = section.settings
  assign p = product
  if p == blank
    assign p = nil
  endif
-%}

{{ 'section-product-bundles.css' | asset_url | stylesheet_tag }}
<script src="{{ 'section-product-bundles.js' | asset_url }}" defer></script>

{%- capture section_aria -%}
  {%- if s.title != blank -%}{{ s.title | strip_html | escape }}{%- else -%}Product bundles{%- endif -%}
{%- endcapture -%}

{%- capture pb_cards -%}

  {%- comment -%} =========================
    MANUAL MODE
  ========================== {%- endcomment -%}
  {%- if s.source == 'manual' -%}
    {%- for block in section.blocks -%}
      {%- if block.type != 'bundle' -%}{% continue %}{%- endif -%}

      {%- liquid
        assign picks = '' | split: ','
        assign picks = picks | push: block.settings.product_1
        assign picks = picks | push: block.settings.product_2
        assign picks = picks | push: block.settings.product_3
        assign picks = picks | push: block.settings.product_4
        assign picks = picks | push: block.settings.product_5
        assign picks = picks | push: block.settings.product_6

        assign seen = '|'
        assign products = '' | split: ','

        for pick in picks
          if pick == blank
            continue
          endif

          assign pr = blank

          comment
            Resolver order:
            1) Product-like object (variants / selected variant exists)
            2) Object with handle -> all_products[handle]
            3) Object with url -> extract handle from /products/<handle>
            4) String -> try as handle, then try parsing as url
          endcomment

          if pick.variants != blank or pick.selected_or_first_available_variant != blank
            assign pr = pick
          elsif pick.handle != blank
            assign pr = all_products[pick.handle]
          elsif pick.url != blank
            assign h = pick.url | split: '/products/' | last | split: '?' | first | split: '#' | first
            if h != blank
              assign pr = all_products[h]
            endif
          else
            assign str = pick | append: ''
            if str != blank
              assign pr = all_products[str]
              if pr == blank
                assign h2 = str | split: '/products/' | last | split: '?' | first | split: '#' | first
                if h2 != blank
                  assign pr = all_products[h2]
                endif
              endif
            endif
          endif

          if pr == blank
            continue
          endif

          assign pid = pr.id | append: ''
          assign tok = '|' | append: pid | append: '|'
          if seen contains tok
            continue
          endif

          assign seen = seen | append: pid | append: '|'
          assign products = products | push: pr
        endfor
      -%}

      {%- if products.size >= 2 -%}
        {%- render 'pb-bundle-card',
          section_id: section.id,
          block: block,
          bundle_title: block.settings.bundle_title,
          bundle_description: block.settings.bundle_description,
          products: products,
          settings: s
        -%}
      {%- endif -%}
    {%- endfor -%}
  {%- endif -%}

  {%- comment -%} =========================
    METAFIELD MODE
  ========================== {%- endcomment -%}
  {%- if s.source == 'metafield' and p != nil -%}
    {%- liquid
      assign ns = s.metafield_namespace | default: 'custom'
      assign key = s.metafield_key | default: 'bundles'
      assign mf = p.metafields[ns][key]
    -%}

    {%- if mf != blank and mf.value != blank -%}

      {%- comment -%} Pattern A: product_list -> one bundle (up to 6) {%- endcomment -%}
      {%- if s.metafield_type == 'product_list' -%}
        {%- liquid
          assign list = mf.value
          assign seen = '|'
          assign products = '' | split: ','

          for pr in list
            if pr == blank
              continue
            endif
            assign pid = pr.id | append: ''
            assign tok = '|' | append: pid | append: '|'
            if seen contains tok
              continue
            endif
            assign seen = seen | append: pid | append: '|'
            assign products = products | push: pr
            if products.size >= 6
              break
            endif
          endfor
        -%}

        {%- if products.size >= 2 -%}
          {%- render 'pb-bundle-card',
            section_id: section.id,
            block: nil,
            bundle_title: s.title,
            bundle_description: blank,
            products: products,
            settings: s
          -%}
        {%- endif -%}
      {%- endif -%}

      {%- comment -%} Pattern B: metaobject_list -> multiple bundles {%- endcomment -%}
      {%- if s.metafield_type == 'metaobject_list' -%}
        {%- liquid
          assign mos = mf.value
          assign max_b = s.max_bundles | default: 3
          assign count = 0
        -%}

        {%- for mo in mos -%}
          {%- if mo == blank -%}{% continue %}{%- endif -%}

          {%- liquid
            assign count = count | plus: 1
            if count > max_b
              break
            endif

            assign mo_title = blank
            if mo.title != blank and mo.title.value != blank
              assign mo_title = mo.title.value
            elsif mo.title != blank
              assign mo_title = mo.title
            endif

            assign mo_desc = blank
            if mo.description != blank and mo.description.value != blank
              assign mo_desc = mo.description.value
            elsif mo.description != blank
              assign mo_desc = mo.description
            endif

            assign mo_products = blank
            if mo.products != blank and mo.products.value != blank
              assign mo_products = mo.products.value
            elsif mo.products != blank
              assign mo_products = mo.products
            endif

            assign mo_savings_label = blank
            if mo.savings_label != blank and mo.savings_label.value != blank
              assign mo_savings_label = mo.savings_label.value
            elsif mo.savings_label != blank
              assign mo_savings_label = mo.savings_label
            endif

            assign seen = '|'
            assign products = '' | split: ','

            if mo_products != blank
              for pr in mo_products
                if pr == blank
                  continue
                endif
                assign pid = pr.id | append: ''
                assign tok = '|' | append: pid | append: '|'
                if seen contains tok
                  continue
                endif
                assign seen = seen | append: pid | append: '|'
                assign products = products | push: pr
                if products.size >= 6
                  break
                endif
              endfor
            endif
          -%}

          {%- if products.size >= 2 -%}
            {%- render 'pb-bundle-card',
              section_id: section.id,
              block: nil,
              bundle_title: mo_title,
              bundle_description: mo_desc,
              products: products,
              settings: s,
              savings_label_override: mo_savings_label
            -%}
          {%- endif -%}
        {%- endfor -%}
      {%- endif -%}

    {%- endif -%}
  {%- endif -%}

{%- endcapture -%}

{%- assign pb_cards_stripped = pb_cards | strip -%}

{%- comment -%}
  Render rule:
  - If we have cards => render section
  - If no cards:
      - In Theme Editor => render placeholder so you can SEE/EDIT it
      - On storefront => render nothing (no empty wrapper)
{%- endcomment -%}
{%- if pb_cards_stripped != blank or request.design_mode -%}
  <section
    class="product-bundles color-{{ s.color_scheme }}"
    data-section-id="{{ section.id }}"
    data-add-mode="{{ s.add_mode }}"
    aria-label="{{ section_aria | strip }}"
  >
    <div class="pb__inner" style="--pb-pt: {{ s.padding_top }}px; --pb-pb: {{ s.padding_bottom }}px;">
      {%- if s.title != blank or s.subheading != blank -%}
        <header class="pb__header">
          {%- if s.title != blank -%}
            <h2 class="pb__title">{{ s.title | escape }}</h2>
          {%- endif -%}
          {%- if s.subheading != blank -%}
            <div class="pb__subheading rte">{{ s.subheading }}</div>
          {%- endif -%}
        </header>
      {%- endif -%}

      {%- if pb_cards_stripped != blank -%}
        <div class="pb__grid pb__grid--{{ s.layout }}">
          {{ pb_cards }}
        </div>
      {%- else -%}
        <div class="pb__placeholder" style="padding:16px;border:1px dashed rgba(0,0,0,.35);border-radius:12px;">
          <strong>Product bundles:</strong> No bundles resolved yet.
          <div style="margin-top:6px;opacity:.85;">
            Source is <code>{{ s.source }}</code>. In manual mode, ensure at least 2 products are picked in the bundle block.
          </div>
        </div>
      {%- endif -%}
    </div>
  </section>
{%- endif -%}

{% schema %}
{
  "name": "Product bundles",
  "tag": "section",
  "class": "section product-bundles-section",
  "settings": [
    { "type": "header", "content": "Content" },
    { "type": "text", "id": "title", "label": "Title", "default": "Frequently bought together" },
    { "type": "richtext", "id": "subheading", "label": "Subheading" },

    { "type": "header", "content": "Source" },
    {
      "type": "select",
      "id": "source",
      "label": "Source",
      "default": "manual",
      "options": [
        { "value": "metafield", "label": "Metafield" },
        { "value": "manual", "label": "Manual" }
      ]
    },
    { "type": "text", "id": "metafield_namespace", "label": "Metafield namespace", "default": "custom" },
    { "type": "text", "id": "metafield_key", "label": "Metafield key", "default": "bundles" },
    {
      "type": "select",
      "id": "metafield_type",
      "label": "Metafield type",
      "default": "product_list",
      "options": [
        { "value": "product_list", "label": "Product list" },
        { "value": "metaobject_list", "label": "Metaobject list" }
      ]
    },

    { "type": "header", "content": "Layout" },
    {
      "type": "select",
      "id": "layout",
      "label": "Layout",
      "default": "single_column",
      "options": [
        { "value": "single_column", "label": "Single column" },
        { "value": "two_column", "label": "Two column" },
        { "value": "carousel", "label": "Carousel" }
      ]
    },
    { "type": "range", "id": "max_bundles", "label": "Max bundles (metafield mode)", "min": 1, "max": 6, "step": 1, "default": 3 },

    { "type": "checkbox", "id": "show_savings", "label": "Show savings", "default": true },
    { "type": "text", "id": "savings_label", "label": "Savings label", "default": "Save when purchased together" },
    { "type": "checkbox", "id": "show_individual_prices", "label": "Show individual prices", "default": true },
    { "type": "checkbox", "id": "show_bundle_total", "label": "Show bundle total", "default": true },

    { "type": "header", "content": "Behavior / cart add" },
    {
      "type": "select",
      "id": "add_mode",
      "label": "Add mode",
      "default": "ajax",
      "options": [
        { "value": "ajax", "label": "AJAX" },
        { "value": "redirect_to_cart", "label": "Redirect to cart" }
      ]
    },
    { "type": "text", "id": "button_label", "label": "Button label", "default": "Add bundle" },
    { "type": "checkbox", "id": "disable_if_unavailable", "label": "Disable if any item unavailable", "default": true },
    { "type": "checkbox", "id": "respect_quantity", "label": "Respect quantity (v1: each item = 1)", "default": false },

    { "type": "header", "content": "Styling" },
    {
      "type": "select",
      "id": "color_scheme",
      "label": "Color scheme",
      "default": "background-1",
      "options": [
        { "value": "background-1", "label": "Background 1" },
        { "value": "background-2", "label": "Background 2" },
        { "value": "inverse", "label": "Inverse" }
      ]
    },
    { "type": "range", "id": "card_radius", "label": "Card radius", "min": 0, "max": 28, "step": 2, "default": 16 },
    { "type": "checkbox", "id": "card_border", "label": "Card border", "default": true },
    { "type": "range", "id": "padding_top", "label": "Padding top", "min": 0, "max": 96, "step": 4, "default": 24 },
    { "type": "range", "id": "padding_bottom", "label": "Padding bottom", "min": 0, "max": 96, "step": 4, "default": 24 }
  ],
  "blocks": [
    {
      "type": "bundle",
      "name": "Bundle",
      "settings": [
        { "type": "text", "id": "bundle_title", "label": "Bundle title" },
        { "type": "richtext", "id": "bundle_description", "label": "Bundle description" },

        { "type": "product", "id": "product_1", "label": "Product 1" },
        { "type": "product", "id": "product_2", "label": "Product 2" },
        { "type": "product", "id": "product_3", "label": "Product 3" },
        { "type": "product", "id": "product_4", "label": "Product 4" },
        { "type": "product", "id": "product_5", "label": "Product 5" },
        { "type": "product", "id": "product_6", "label": "Product 6" },

        { "type": "checkbox", "id": "show_savings_override", "label": "Override savings visibility", "default": false },
        { "type": "text", "id": "savings_label_override", "label": "Savings label override" }
      ]
    }
  ],
  "presets": [
    { "name": "Product bundles", "blocks": [{ "type": "bundle" }] }
  ]
}
{% endschema %}
