{%- comment -%}
  Quadratum — Interactive · Search (Predictive)
  File: sections/interactive-content-helper-predictive-search.liquid

  Modes (designer-selectable):
  - cards   : product-card grid for products + rows for others (premium/catalog feel)
  - rows    : simple list rows (fast + clean)
  - compact : tight rows (title + optional meta, minimal padding)
  - media   : rows with thumbnails (products/articles/pages) + price for products

  Key behaviors:
  - Progressive enhancement: form submits to /search without JS
  - Predictive: uses /search/suggest section rendering; returns PANEL-ONLY HTML during predictive requests
  - No looping: predictive response NEVER prints the outer section / input UI, only panel content

  Notes:
  - Hardcode SECTION_HANDLE to the section file handle.
  - Canonical predictive detection: predictive_search.performed
{%- endcomment -%}

{%- liquid
  assign SECTION_HANDLE = 'interactive-content-helper-predictive-search'
  assign sid = section.id

  assign scope = section.settings.search_scope | default: 'all'
  assign panel_layout = section.settings.panel_layout | default: 'cards'

  assign max_suggestions = section.settings.max_suggestions | default: 8
  assign min_chars = section.settings.min_chars | default: 2
  assign debounce_ms = section.settings.debounce_ms | default: 200

  assign limit_products = section.settings.limit_products | default: 8
  assign limit_collections = section.settings.limit_collections | default: 6
  assign limit_articles = section.settings.limit_articles | default: 6
  assign limit_pages = section.settings.limit_pages | default: 6

  assign open_on_focus = section.settings.open_on_focus
  if open_on_focus == nil
    assign open_on_focus = true
  endif

  assign close_on_escape = section.settings.close_on_escape
  if close_on_escape == nil
    assign close_on_escape = true
  endif

  assign show_popular = section.settings.show_popular_queries
  if show_popular == nil
    assign show_popular = true
  endif

  assign show_recent = section.settings.show_recent_searches
  if show_recent == nil
    assign show_recent = false
  endif

  assign restrict_collection = section.settings.restrict_to_collection

  assign placeholder = section.settings.placeholder_text | default: 'Search products, articles, and more…'
  assign input_label = section.settings.input_label | default: 'Search'
  assign submit_label = section.settings.submit_label | default: 'Search'
  assign no_results_text = section.settings.no_results_text | default: 'No results found for'
  assign view_all_label = section.settings.view_all_results_label | default: 'View all results'

  assign use_custom_colors = section.settings.use_custom_colors

  assign is_predictive = false
  if predictive_search.performed
    assign is_predictive = true
  endif

  assign qps_scope = request.params.qps_scope | default: scope
  assign qps_rc = request.params.qps_rc | default: ''
-%}

{%- if is_predictive -%}
  {%- comment -%}
    =========================================================
    PANEL-ONLY RESPONSE (NO SECTION WRAPPER)
    =========================================================
  {%- endcomment -%}

  {%- liquid
    assign term = predictive_search.terms | default: ''
    assign products = predictive_search.resources.products
    assign collections = predictive_search.resources.collections
    assign articles = predictive_search.resources.articles
    assign pages = predictive_search.resources.pages

    assign show_products = false
    assign show_collections = false
    assign show_articles = false
    assign show_pages = false

    if qps_scope == 'all' or qps_scope == 'products_only'
      assign show_products = true
    endif
    if qps_scope == 'all'
      assign show_collections = true
    endif
    if qps_scope == 'all' or qps_scope == 'articles_only'
      assign show_articles = true
    endif
    if qps_scope == 'all' or qps_scope == 'pages_only'
      assign show_pages = true
    endif

    assign any_results = false
    if any_results == false and show_products and products != blank and products.size > 0
      assign any_results = true
    endif
    if any_results == false and show_collections and collections != blank and collections.size > 0
      assign any_results = true
    endif
    if any_results == false and show_articles and articles != blank and articles.size > 0
      assign any_results = true
    endif
    if any_results == false and show_pages and pages != blank and pages.size > 0
      assign any_results = true
    endif

    assign rc_handle = qps_rc | strip
  -%}

  <div class="q-ps__panel-scroller" data-qps-render="panel" data-qps-layout="{{ panel_layout | escape }}">
    {%- if any_results -%}

      {%- if show_products and products != blank and products.size > 0 -%}
        {%- liquid
          assign rendered_products = 0
        -%}
        <div class="q-ps__group" role="group" aria-label="Products">
          <div class="q-ps__group-title">Products</div>

          {%- if panel_layout == 'cards' -%}
            <div class="q-ps__products q-ps__products--cards" data-qps-items>
              {%- for p in products -%}
                {%- if rendered_products >= limit_products -%}{%- break -%}{%- endif -%}

                {%- if rc_handle != blank -%}
                  {%- assign in_rc = false -%}
                  {%- if p.collections != blank and p.collections.size > 0 -%}
                    {%- for c in p.collections -%}
                      {%- if c.handle == rc_handle -%}
                        {%- assign in_rc = true -%}
                        {%- break -%}
                      {%- endif -%}
                    {%- endfor -%}
                  {%- endif -%}
                  {%- unless in_rc -%}{%- continue -%}{%- endunless -%}
                {%- endif -%}

                {%- render 'product-card',
                  product: p,
                  card_preset: 'catalog',
                  media_mode: 'single',
                  enable_quick_add: false,
                  enable_quick_view: false,
                  show_action_row: false,
                  show_badges: true
                -%}

                {%- assign rendered_products = rendered_products | plus: 1 -%}
              {%- endfor -%}

              {%- if rendered_products == 0 -%}
                <div class="q-ps__empty-inline">{{ no_results_text }} “{{ term | escape }}”.</div>
              {%- endif -%}
            </div>

          {%- else -%}
            <div class="q-ps__rows q-ps__rows--{{ panel_layout }}" data-qps-items>
              {%- for p in products -%}
                {%- if rendered_products >= limit_products -%}{%- break -%}{%- endif -%}

                {%- if rc_handle != blank -%}
                  {%- assign in_rc = false -%}
                  {%- if p.collections != blank and p.collections.size > 0 -%}
                    {%- for c in p.collections -%}
                      {%- if c.handle == rc_handle -%}
                        {%- assign in_rc = true -%}
                        {%- break -%}
                      {%- endif -%}
                    {%- endfor -%}
                  {%- endif -%}
                  {%- unless in_rc -%}{%- continue -%}{%- endunless -%}
                {%- endif -%}

                <a class="q-ps__row q-ps__row--product" href="{{ p.url }}" data-qps-item role="option" tabindex="-1">
                  {%- if panel_layout == 'media' -%}
                    <span class="q-ps__thumb">
                      {%- if p.featured_media != blank -%}
                        <img
                          src="{{ p.featured_media | image_url: width: 120 }}"
                          alt="{{ p.featured_media.alt | default: p.title | escape }}"
                          loading="lazy"
                          width="60"
                          height="60"
                        >
                      {%- else -%}
                        <span class="q-ps__thumb-ph" aria-hidden="true"></span>
                      {%- endif -%}
                    </span>
                  {%- endif -%}

                  <span class="q-ps__row-main">
                    <span class="q-ps__row-title">{{ p.title | escape }}</span>
                    {%- if panel_layout != 'rows' -%}
                      <span class="q-ps__row-meta">
                        {%- if p.price != blank -%}{{ p.price | money }}{%- endif -%}
                      </span>
                    {%- endif -%}
                  </span>
                </a>

                {%- assign rendered_products = rendered_products | plus: 1 -%}
              {%- endfor -%}

              {%- if rendered_products == 0 -%}
                <div class="q-ps__empty-inline">{{ no_results_text }} “{{ term | escape }}”.</div>
              {%- endif -%}
            </div>
          {%- endif -%}
        </div>
      {%- endif -%}

      {%- if show_collections and collections != blank and collections.size > 0 -%}
        <div class="q-ps__group" role="group" aria-label="Collections">
          <div class="q-ps__group-title">Collections</div>
          <div class="q-ps__rows q-ps__rows--{{ panel_layout }}" data-qps-items>
            {%- liquid assign rendered_collections = 0 -%}
            {%- for c in collections -%}
              {%- if rendered_collections >= limit_collections -%}{%- break -%}{%- endif -%}
              <a class="q-ps__row" href="{{ c.url }}" data-qps-item role="option" tabindex="-1">
                <span class="q-ps__row-main">
                  <span class="q-ps__row-title">{{ c.title | escape }}</span>
                </span>
              </a>
              {%- assign rendered_collections = rendered_collections | plus: 1 -%}
            {%- endfor -%}
          </div>
        </div>
      {%- endif -%}

      {%- if show_articles and articles != blank and articles.size > 0 -%}
        <div class="q-ps__group" role="group" aria-label="Articles">
          <div class="q-ps__group-title">Articles</div>
          <div class="q-ps__rows q-ps__rows--{{ panel_layout }}" data-qps-items>
            {%- liquid assign rendered_articles = 0 -%}
            {%- for a in articles -%}
              {%- if rendered_articles >= limit_articles -%}{%- break -%}{%- endif -%}

              <a class="q-ps__row q-ps__row--article" href="{{ a.url }}" data-qps-item role="option" tabindex="-1">
                {%- if panel_layout == 'media' -%}
                  <span class="q-ps__thumb">
                    {%- if a.image != blank -%}
                      <img
                        src="{{ a.image | image_url: width: 120 }}"
                        alt="{{ a.image.alt | default: a.title | escape }}"
                        loading="lazy"
                        width="60"
                        height="60"
                      >
                    {%- else -%}
                      <span class="q-ps__thumb-ph" aria-hidden="true"></span>
                    {%- endif -%}
                  </span>
                {%- endif -%}
                <span class="q-ps__row-main">
                  <span class="q-ps__row-title">{{ a.title | escape }}</span>
                </span>
              </a>

              {%- assign rendered_articles = rendered_articles | plus: 1 -%}
            {%- endfor -%}
          </div>
        </div>
      {%- endif -%}

      {%- if show_pages and pages != blank and pages.size > 0 -%}
        <div class="q-ps__group" role="group" aria-label="Pages">
          <div class="q-ps__group-title">Pages</div>
          <div class="q-ps__rows q-ps__rows--{{ panel_layout }}" data-qps-items>
            {%- liquid assign rendered_pages = 0 -%}
            {%- for pg in pages -%}
              {%- if rendered_pages >= limit_pages -%}{%- break -%}{%- endif -%}
              <a class="q-ps__row q-ps__row--page" href="{{ pg.url }}" data-qps-item role="option" tabindex="-1">
                <span class="q-ps__row-main">
                  <span class="q-ps__row-title">{{ pg.title | escape }}</span>
                </span>
              </a>
              {%- assign rendered_pages = rendered_pages | plus: 1 -%}
            {%- endfor -%}
          </div>
        </div>
      {%- endif -%}

      <div class="q-ps__footer">
        <a class="q-ps__viewall" href="/search?q={{ term | url_encode }}">
          {{ view_all_label | escape }}
        </a>
      </div>

    {%- else -%}
      <div class="q-ps__empty" role="status" aria-live="polite">
        <div class="q-ps__empty-title">{{ no_results_text }} “{{ term | escape }}”.</div>
        <div class="q-ps__footer">
          <a class="q-ps__viewall" href="/search?q={{ term | url_encode }}">
            {{ view_all_label | escape }}
          </a>
        </div>
      </div>
    {%- endif -%}
  </div>

{%- else -%}

  {%- liquid
    assign popular_lines = section.settings.popular_queries | default: "Best sellers\nNew arrivals\nSale" | strip
    assign popular_arr = popular_lines | newline_to_br | split: '<br />'
    assign has_popular = false
    if show_popular and popular_arr != blank and popular_arr.size > 0
      assign has_popular = true
    endif

    assign fallback_type = ''
    if scope == 'products_only'
      assign fallback_type = 'product'
    elsif scope == 'articles_only'
      assign fallback_type = 'article'
    elsif scope == 'pages_only'
      assign fallback_type = 'page'
    endif

    assign restrict_handle = ''
    if restrict_collection != blank
      assign restrict_handle = restrict_collection.handle
    endif
  -%}

  <section
    id="q-ps-{{ sid }}"
    class="q-ps"
    data-section-id="{{ sid }}"
    data-section-handle="{{ SECTION_HANDLE }}"
    data-scope="{{ scope }}"
    data-layout="{{ panel_layout }}"
    data-max="{{ max_suggestions }}"
    data-min-chars="{{ min_chars }}"
    data-debounce="{{ debounce_ms }}"
    data-open-on-focus="{% if open_on_focus %}true{% else %}false{% endif %}"
    data-close-on-escape="{% if close_on_escape %}true{% else %}false{% endif %}"
    data-show-popular="{% if show_popular %}true{% else %}false{% endif %}"
    data-show-recent="{% if show_recent %}true{% else %}false{% endif %}"
    data-restrict-collection="{{ restrict_handle }}"
    data-limit-products="{{ limit_products }}"
    data-limit-collections="{{ limit_collections }}"
    data-limit-articles="{{ limit_articles }}"
    data-limit-pages="{{ limit_pages }}"
    role="region"
    aria-label="{{ input_label | escape }}"
  >
    <div class="q-ps__outer">
      <div class="q-ps__frame">
        {%- if section.settings.heading != blank or section.settings.subheading != blank -%}
          <header class="q-ps__header">
            {%- if section.settings.heading != blank -%}
              <h2 class="q-ps__heading">{{ section.settings.heading | escape }}</h2>
            {%- endif -%}
            {%- if section.settings.subheading != blank -%}
              <div class="q-ps__sub rte">{{ section.settings.subheading }}</div>
            {%- endif -%}
          </header>
        {%- endif -%}

        <form class="q-ps__form" action="/search" method="get" role="search">
          <label class="q-ps__label" for="qps-input-{{ sid }}">{{ input_label | escape }}</label>

          <div class="q-ps__control" role="combobox" aria-haspopup="listbox" aria-owns="qps-panel-{{ sid }}" aria-expanded="false">
            <input
              id="qps-input-{{ sid }}"
              class="q-ps__input"
              type="search"
              name="q"
              placeholder="{{ placeholder | escape }}"
              autocomplete="off"
              autocapitalize="off"
              spellcheck="false"
              data-qps-input
              aria-controls="qps-panel-{{ sid }}"
              aria-expanded="false"
              aria-autocomplete="list"
            />

            {%- if fallback_type != blank -%}
              <input type="hidden" name="type" value="{{ fallback_type }}">
            {%- endif -%}

            <button class="q-ps__submit" type="submit" data-qps-submit>
              {{ submit_label | escape }}
            </button>
          </div>

          {%- if has_popular -%}
            <div class="q-ps__chips" data-qps-chips aria-label="Popular searches">
              {%- for line in popular_arr -%}
                {%- assign t = line | strip -%}
                {%- if t == blank -%}{%- continue -%}{%- endif -%}
                <button type="button" class="q-ps__chip" data-qps-chip data-term="{{ t | escape }}">
                  {{ t | escape }}
                </button>
              {%- endfor -%}
            </div>
          {%- endif -%}

          {%- if show_recent -%}
            <div class="q-ps__recent" data-qps-recent hidden>
              <div class="q-ps__group-title">Recent</div>
              <div class="q-ps__chips" data-qps-recent-chips></div>
            </div>
          {%- endif -%}
        </form>

        <div
          id="qps-panel-{{ sid }}"
          class="q-ps__panel"
          data-qps-panel
          hidden
          role="listbox"
          aria-label="Search suggestions"
        >
          <div class="q-ps__panel-inner" data-qps-panel-inner></div>
        </div>

        <noscript>
          <p class="q-ps__noscript">
            JavaScript is disabled. You can still search using the button above.
          </p>
        </noscript>
      </div>
    </div>

    <style>
      #shopify-section-{{ sid }} .q-ps{
        --qps-max: {{ section.settings.max_width }}%;
        --qps-pad-y: {{ section.settings.pad_y }}px;
        --qps-pad-x: {{ section.settings.pad_x }}px;
        --qps-gap: {{ section.settings.gap }}px;

        --qps-radius: {{ section.settings.radius }}px;
        --qps-panel-max-h: {{ section.settings.panel_max_h }}vh;
        --qps-thumb: {{ section.settings.thumb_size }}px;

        --qps-input-fs: {{ section.settings.input_fs }}px;
        --qps-group-fs: {{ section.settings.group_heading_fs }}px;
        --qps-result-fs: {{ section.settings.result_title_fs }}px;
        --qps-meta-fs: {{ section.settings.result_meta_fs }}px;

        {%- if use_custom_colors -%}
          --qps-bg: {{ section.settings.bg }};
          --qps-text: {{ section.settings.text }};
          --qps-muted: {{ section.settings.muted }};
          --qps-accent: {{ section.settings.accent }};
          --qps-surface: {{ section.settings.surface }};
          --qps-border: {{ section.settings.border }};
        {%- else -%}
          --qps-bg: transparent;
          --qps-text: currentColor;
          --qps-muted: rgba(0,0,0,.65);
          --qps-accent: currentColor;
          --qps-surface: rgba(0,0,0,.04);
          --qps-border: rgba(0,0,0,.12);
        {%- endif -%}

        {%- case section.settings.shadow_strength -%}
          {%- when 'medium' -%}
            --qps-shadow: 0 14px 36px rgba(0,0,0,.14);
          {%- when 'soft' -%}
            --qps-shadow: 0 10px 26px rgba(0,0,0,.10);
          {%- else -%}
            --qps-shadow: none;
        {%- endcase -%}
      }

      #shopify-section-{{ sid }} .q-ps__outer{
        background: var(--qps-bg);
        color: var(--qps-text);
        padding: var(--qps-pad-y) var(--qps-pad-x);
      }

      #shopify-section-{{ sid }} .q-ps__frame{
        max-width: var(--qps-max);
        margin: 0 auto;
        display: grid;
        gap: var(--qps-gap);
        position: relative;
      }

      #shopify-section-{{ sid }} .q-ps__header{ display: grid; gap: 10px; }
      #shopify-section-{{ sid }} .q-ps__heading{ margin: 0; letter-spacing: -0.01em; line-height: 1.1; }
      #shopify-section-{{ sid }} .q-ps__sub{ color: var(--qps-muted); }

      #shopify-section-{{ sid }} .q-ps__label{
        position: absolute !important;
        width: 1px; height: 1px;
        padding: 0; margin: -1px;
        overflow: hidden; clip: rect(0,0,0,0);
        white-space: nowrap; border: 0;
      }

      #shopify-section-{{ sid }} .q-ps__control{
        display: grid;
        grid-template-columns: 1fr auto;
        gap: 10px;
        align-items: stretch;
      }

      #shopify-section-{{ sid }} .q-ps__input{
        width: 100%;
        min-height: 48px;
        font-size: var(--qps-input-fs);
        padding: 12px 14px;
        border-radius: var(--qps-radius);
        border: 1px solid var(--qps-border);
        background: color-mix(in srgb, var(--qps-bg) 35%, white);
        color: var(--qps-text);
      }
      #shopify-section-{{ sid }} .q-ps__input::placeholder{ color: color-mix(in srgb, var(--qps-muted) 85%, transparent); }
      #shopify-section-{{ sid }} .q-ps__input:focus-visible{
        outline: 2px solid color-mix(in srgb, var(--qps-accent) 35%, transparent);
        outline-offset: 2px;
      }

      #shopify-section-{{ sid }} .q-ps__submit{
        min-height: 48px;
        padding: 12px 16px;
        border-radius: var(--qps-radius);
        border: 1px solid color-mix(in srgb, var(--qps-border) 60%, var(--qps-accent));
        background: var(--qps-accent);
        color: #fff;
        cursor: pointer;
        font: inherit;
        white-space: nowrap;
      }

      #shopify-section-{{ sid }} .q-ps__chips{ display: flex; flex-wrap: wrap; gap: 10px; margin-top: 10px; }
      #shopify-section-{{ sid }} .q-ps__chip{
        appearance: none;
        border: 1px solid var(--qps-border);
        background: color-mix(in srgb, var(--qps-bg) 65%, var(--qps-surface));
        color: var(--qps-text);
        border-radius: 999px;
        padding: 8px 12px;
        cursor: pointer;
        font: inherit;
      }
      #shopify-section-{{ sid }} .q-ps__chip.is-active{
        border-color: color-mix(in srgb, var(--qps-border) 45%, var(--qps-accent));
        box-shadow: 0 0 0 2px color-mix(in srgb, var(--qps-accent) 14%, transparent);
      }

      #shopify-section-{{ sid }} .q-ps__panel{
        position: absolute;
        top: calc(100% + 10px);
        left: 0;
        right: 0;
        z-index: 60;
      }

      #shopify-section-{{ sid }} .q-ps__panel-inner{
        background: color-mix(in srgb, var(--qps-bg) 25%, white);
        border: 1px solid var(--qps-border);
        border-radius: var(--qps-radius);
        box-shadow: var(--qps-shadow);
        overflow: hidden;
      }

      #shopify-section-{{ sid }} .q-ps__panel-scroller{
        max-height: var(--qps-panel-max-h);
        overflow: auto;
        padding: 14px;
        display: grid;
        gap: 14px;
      }

      #shopify-section-{{ sid }} .q-ps__group{ display: grid; gap: 10px; }
      #shopify-section-{{ sid }} .q-ps__group-title{
        font-size: var(--qps-group-fs);
        letter-spacing: 0.08em;
        text-transform: uppercase;
        color: var(--qps-muted);
      }

      #shopify-section-{{ sid }} .q-ps__products--cards{
        display: grid;
        grid-template-columns: repeat( auto-fill, minmax(210px, 1fr) );
        gap: 12px;
      }

      #shopify-section-{{ sid }} .q-ps__rows{
        display: grid;
        gap: 6px;
      }

      /* Row base */
      #shopify-section-{{ sid }} .q-ps__row{
        display: grid;
        grid-template-columns: 1fr;
        gap: 10px;
        padding: 10px 12px;
        border-radius: 12px;
        border: 1px solid transparent;
        text-decoration: none;
        color: var(--qps-text);
        background: color-mix(in srgb, var(--qps-bg) 70%, transparent);
      }

      /* Media layout adds thumb column */
      #shopify-section-{{ sid }} .q-ps__rows--media .q-ps__row,
      #shopify-section-{{ sid }} .q-ps__rows--media a.q-ps__row{
        grid-template-columns: auto 1fr;
        align-items: center;
      }

      /* Compact tightens padding + font */
      #shopify-section-{{ sid }} .q-ps__rows--compact .q-ps__row{
        padding: 8px 10px;
      }
      #shopify-section-{{ sid }} .q-ps__rows--compact .q-ps__row-title{
        font-size: calc(var(--qps-result-fs) - 1px);
      }

      /* Rows mode: larger hit area but no extra meta emphasis */
      #shopify-section-{{ sid }} .q-ps__rows--rows .q-ps__row{
        padding: 10px 12px;
      }

      #shopify-section-{{ sid }} .q-ps__row:hover{
        border-color: color-mix(in srgb, var(--qps-border) 55%, var(--qps-accent));
        background: color-mix(in srgb, var(--qps-bg) 55%, var(--qps-surface));
      }

      #shopify-section-{{ sid }} .q-ps__row.is-active{
        border-color: color-mix(in srgb, var(--qps-border) 45%, var(--qps-accent));
        box-shadow: 0 0 0 2px color-mix(in srgb, var(--qps-accent) 12%, transparent);
      }

      #shopify-section-{{ sid }} .q-ps__row-main{
        display: grid;
        gap: 2px;
        min-width: 0;
      }

      #shopify-section-{{ sid }} .q-ps__row-title{
        font-size: var(--qps-result-fs);
        font-weight: 600;
        line-height: 1.2;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
      }

      #shopify-section-{{ sid }} .q-ps__row-meta{
        font-size: var(--qps-meta-fs);
        color: var(--qps-muted);
        line-height: 1.2;
      }

      #shopify-section-{{ sid }} .q-ps__thumb{
        width: var(--qps-thumb);
        height: var(--qps-thumb);
        border-radius: 12px;
        overflow: hidden;
        background: color-mix(in srgb, var(--qps-bg) 70%, var(--qps-surface));
        border: 1px solid color-mix(in srgb, var(--qps-border) 85%, transparent);
        display: inline-flex;
        align-items: center;
        justify-content: center;
      }
      #shopify-section-{{ sid }} .q-ps__thumb img{
        width: 100%;
        height: 100%;
        object-fit: cover;
        display: block;
      }
      #shopify-section-{{ sid }} .q-ps__thumb-ph{
        width: 100%;
        height: 100%;
        display: block;
      }

      #shopify-section-{{ sid }} .q-ps__footer{ padding-top: 4px; display: flex; justify-content: flex-end; }

      #shopify-section-{{ sid }} .q-ps__viewall{
        display: inline-flex;
        align-items: center;
        justify-content: center;
        padding: 10px 12px;
        border-radius: 999px;
        border: 1px solid var(--qps-border);
        text-decoration: none;
        color: var(--qps-text);
        background: color-mix(in srgb, var(--qps-bg) 60%, var(--qps-surface));
      }

      #shopify-section-{{ sid }} .q-ps__empty{
        padding: 14px;
        border: 1px dashed var(--qps-border);
        border-radius: 14px;
        background: color-mix(in srgb, var(--qps-bg) 65%, var(--qps-surface));
      }
      #shopify-section-{{ sid }} .q-ps__empty-title{ font-weight: 700; margin-bottom: 8px; }
      #shopify-section-{{ sid }} .q-ps__empty-inline{
        padding: 10px 12px;
        color: var(--qps-muted);
        border: 1px dashed var(--qps-border);
        border-radius: 12px;
      }

      #shopify-section-{{ sid }} .q-ps__noscript{
        margin: 0;
        color: var(--qps-muted);
        font-size: 0.95em;
      }

      @media (max-width: 720px){
        #shopify-section-{{ sid }} .q-ps__control{ grid-template-columns: 1fr; }
        #shopify-section-{{ sid }} .q-ps__products--cards{ grid-template-columns: repeat( auto-fill, minmax(170px, 1fr) ); }
      }
    </style>

    <script>
      (function(){
        var root = document.getElementById('q-ps-{{ sid }}');
        if(!root) return;

        var input = root.querySelector('[data-qps-input]');
        var panel = root.querySelector('[data-qps-panel]');
        var panelInner = root.querySelector('[data-qps-panel-inner]');
        var chipsWrap = root.querySelector('[data-qps-chips]');
        var recentWrap = root.querySelector('[data-qps-recent]');
        var recentChips = root.querySelector('[data-qps-recent-chips]');

        var scope = root.getAttribute('data-scope') || 'all';
        var layout = root.getAttribute('data-layout') || 'cards';

        var max = parseInt(root.getAttribute('data-max') || '8', 10);
        var minChars = parseInt(root.getAttribute('data-min-chars') || '2', 10);
        var debounceMs = parseInt(root.getAttribute('data-debounce') || '200', 10);

        var limitProducts = parseInt(root.getAttribute('data-limit-products') || '8', 10);
        var limitCollections = parseInt(root.getAttribute('data-limit-collections') || '6', 10);
        var limitArticles = parseInt(root.getAttribute('data-limit-articles') || '6', 10);
        var limitPages = parseInt(root.getAttribute('data-limit-pages') || '6', 10);

        var openOnFocus = (root.getAttribute('data-open-on-focus') === 'true');
        var closeOnEscape = (root.getAttribute('data-close-on-escape') === 'true');
        var showPopular = (root.getAttribute('data-show-popular') === 'true');
        var showRecent = (root.getAttribute('data-show-recent') === 'true');

        var sectionHandle = root.getAttribute('data-section-handle') || '{{ SECTION_HANDLE }}';
        var rcHandle = root.getAttribute('data-restrict-collection') || '';

        var timer = null;
        var aborter = null;

        var activeIndex = -1;
        var activeEls = [];

        var RECENT_KEY = 'qps_recent_terms_v1';
        var RECENT_MAX = 6;

        function safeEncode(s){ return encodeURIComponent(s || ''); }

        function setExpanded(isOpen){
          input.setAttribute('aria-expanded', isOpen ? 'true' : 'false');
          var combobox = root.querySelector('.q-ps__control');
          if(combobox) combobox.setAttribute('aria-expanded', isOpen ? 'true' : 'false');
          panel.hidden = !isOpen;
          if(!isOpen){
            activeIndex = -1;
            activeEls = [];
            clearActiveStates();
          }
        }
        function openPanel(){ setExpanded(true); }
        function closePanel(){ setExpanded(false); }

        function clearActiveStates(){
          if(chipsWrap){
            chipsWrap.querySelectorAll('.q-ps__chip.is-active').forEach(function(b){ b.classList.remove('is-active'); });
          }
          if(panelInner){
            panelInner.querySelectorAll('.is-active').forEach(function(el){ el.classList.remove('is-active'); });
          }
        }

        function outsideClickHandler(e){
          if(!root.contains(e.target)) closePanel();
        }

        function buildTypes(scope){
          if(scope === 'products_only') return ['product'];
          if(scope === 'articles_only') return ['article'];
          if(scope === 'pages_only') return ['page'];
          return ['product','collection','article','page'];
        }

        function resourcesLimitForRequest(){
        // When searching ONLY products, request ONLY what we need (+small buffer)
        if(scope === 'products_only'){
            return Math.min(20, Math.max(1, limitProducts) + 0);
        }

        // When searching a single non-product scope
        if(scope === 'articles_only'){
            return Math.min(20, Math.max(0, limitArticles));
        }
        if(scope === 'pages_only'){
            return Math.min(20, Math.max(0, limitPages));
        }

        // "all" scope: request enough to satisfy all group caps (no max_suggestions coupling)
        var m = 0;
        m += Math.max(0, limitProducts);
        m += Math.max(0, limitCollections);
        m += Math.max(0, limitArticles);
        m += Math.max(0, limitPages);

        // safety clamp (Shopify can return fewer anyway)
        return Math.min(20, Math.max(4, m));
        }


        function buildFetchUrl(q){
          var base = '/search/suggest';
          var types = buildTypes(scope);
          var typeParams = types.map(function(t){
            return 'resources[type]=' + safeEncode(t);
          }).join('&');

          return base
            + '?q=' + safeEncode(q)
            + '&section_id=' + safeEncode(sectionHandle)
            + '&qps_scope=' + safeEncode(scope)
            + '&qps_rc=' + safeEncode(rcHandle)
            + '&qps_layout=' + safeEncode(layout)
            + '&' + typeParams
            + '&resources[limit]=' + safeEncode(String(resourcesLimitForRequest()));
        }

        function injectPanel(html){
          panelInner.innerHTML = html || '';
          rebuildNav();
          openPanel();
        }

        function fetchPredictive(q){
          if(aborter) aborter.abort();
          aborter = new AbortController();
          return fetch(buildFetchUrl(q), { method:'GET', credentials:'same-origin', signal: aborter.signal })
            .then(function(res){ if(!res.ok) throw new Error('Predictive failed'); return res.text(); });
        }

        function debouncedRun(q){
          window.clearTimeout(timer);
          timer = window.setTimeout(function(){
            if(q.length < minChars){
              closePanel();
              return;
            }
            fetchPredictive(q).then(injectPanel).catch(function(){ closePanel(); });
          }, debounceMs);
        }

        function saveRecent(term){
          if(!showRecent) return;
          term = (term || '').trim();
          if(!term) return;
          try{
            var raw = localStorage.getItem(RECENT_KEY);
            var arr = raw ? JSON.parse(raw) : [];
            if(!Array.isArray(arr)) arr = [];
            arr = arr.filter(function(x){ return (x || '').toLowerCase() !== term.toLowerCase(); });
            arr.unshift(term);
            arr = arr.slice(0, RECENT_MAX);
            localStorage.setItem(RECENT_KEY, JSON.stringify(arr));
          }catch(e){}
        }

        function loadRecent(){
          if(!showRecent || !recentWrap || !recentChips) return;
          try{
            var raw = localStorage.getItem(RECENT_KEY);
            var arr = raw ? JSON.parse(raw) : [];
            if(!Array.isArray(arr)) arr = [];
            recentChips.innerHTML = '';
            if(arr.length === 0){ recentWrap.hidden = true; return; }
            arr.forEach(function(term){
              var b = document.createElement('button');
              b.type = 'button';
              b.className = 'q-ps__chip';
              b.textContent = term;
              b.addEventListener('click', function(){
                input.value = term;
                input.focus();
                debouncedRun(term);
              });
              recentChips.appendChild(b);
            });
            recentWrap.hidden = false;
          }catch(e){ recentWrap.hidden = true; }
        }

        function onChipClick(term){
          input.value = term;
          input.focus();
          debouncedRun(term);
        }

        function rebuildNav(){
          activeIndex = -1;
          activeEls = [];

          if(chipsWrap){
            chipsWrap.querySelectorAll('button.q-ps__chip').forEach(function(btn){
              activeEls.push(btn);
            });
          }
          if(recentWrap && !recentWrap.hidden && recentChips){
            recentChips.querySelectorAll('button.q-ps__chip').forEach(function(btn){
              activeEls.push(btn);
            });
          }

          panelInner.querySelectorAll('a[href]').forEach(function(a){
            a.setAttribute('tabindex','-1');
            activeEls.push(a);
          });
        }

        function setActive(i){
          clearActiveStates();
          if(activeEls.length === 0) { activeIndex = -1; return; }
          if(i < 0) i = activeEls.length - 1;
          if(i >= activeEls.length) i = 0;
          activeIndex = i;

          var el = activeEls[activeIndex];
          if(!el) return;
          el.classList.add('is-active');
          try{ el.scrollIntoView({ block:'nearest' }); }catch(e){}
        }

        function activateCurrent(){
          if(activeIndex < 0 || activeIndex >= activeEls.length) return false;
          var el = activeEls[activeIndex];
          if(!el) return false;
          el.click();
          return true;
        }

        input.addEventListener('input', function(){
          debouncedRun((input.value || '').trim());
        });

        input.addEventListener('focus', function(){
          loadRecent();
          var q = (input.value || '').trim();
          if(openOnFocus && q.length >= minChars) debouncedRun(q);
        });

        input.addEventListener('keydown', function(e){
          if(e.key === 'Escape' && closeOnEscape){
            closePanel();
            return;
          }
          if(e.key === 'ArrowDown'){
            if(panel.hidden) openPanel();
            rebuildNav();
            setActive(activeIndex + 1);
            e.preventDefault();
            return;
          }
          if(e.key === 'ArrowUp'){
            if(panel.hidden) openPanel();
            rebuildNav();
            setActive(activeIndex - 1);
            e.preventDefault();
            return;
          }
          if(e.key === 'Enter'){
            saveRecent((input.value || '').trim());
            if(!panel.hidden){
              rebuildNav();
              if(activateCurrent()){
                e.preventDefault();
                closePanel();
                return;
              }
            }
          }
        });

        if(chipsWrap){
          chipsWrap.querySelectorAll('[data-qps-chip]').forEach(function(btn){
            btn.addEventListener('click', function(){
              onChipClick(btn.getAttribute('data-term') || '');
            });
          });
        }

        panel.addEventListener('click', function(e){
          var a = e.target.closest('a');
          if(a){
            saveRecent((input.value || '').trim());
            closePanel();
          }
        });

        document.addEventListener('click', outsideClickHandler);

        document.addEventListener('shopify:section:unload', function(ev){
          if(!ev || !ev.detail) return;
          if(ev.detail.sectionId === '{{ sid }}'){
            document.removeEventListener('click', outsideClickHandler);
            if(aborter) aborter.abort();
            window.clearTimeout(timer);
          }
        });
      })();
    </script>
  </section>

{%- endif -%}

{% schema %}
{
  "name": "Interactive PreSearch",
  "tag": "section",
  "class": "q-predictive-search",
  "settings": [
    { "type": "text", "id": "heading", "label": "Heading", "default": "Search" },
    { "type": "richtext", "id": "subheading", "label": "Subheading", "default": "<p>Search products, collections, articles, and pages.</p>" },

    { "type": "header", "content": "Scope" },
    {
      "type": "select",
      "id": "search_scope",
      "label": "Search scope",
      "default": "all",
      "options": [
        { "value": "all", "label": "All" },
        { "value": "products_only", "label": "Products only" },
        { "value": "articles_only", "label": "Articles only" },
        { "value": "pages_only", "label": "Pages only" }
      ]
    },
    { "type": "collection", "id": "restrict_to_collection", "label": "Restrict product results to collection (optional)" },

    { "type": "header", "content": "Panel layout" },
    {
      "type": "select",
      "id": "panel_layout",
      "label": "Results layout",
      "default": "cards",
      "options": [
        { "value": "cards", "label": "Cards (products grid)" },
        { "value": "rows", "label": "Rows" },
        { "value": "compact", "label": "Compact" },
        { "value": "media", "label": "Media (thumbnails)" }
      ]
    },

    { "type": "header", "content": "Copy" },
    { "type": "text", "id": "placeholder_text", "label": "Placeholder", "default": "Search products, articles, and more…" },
    { "type": "text", "id": "input_label", "label": "Input label (accessibility)", "default": "Search" },
    { "type": "text", "id": "submit_label", "label": "Submit label", "default": "Search" },
    { "type": "text", "id": "no_results_text", "label": "No results text", "default": "No results found for" },
    { "type": "text", "id": "view_all_results_label", "label": "View all results label", "default": "View all results" },

    { "type": "header", "content": "Suggestions" },
    { "type": "range", "id": "max_suggestions", "label": "Max suggestions (request baseline)", "min": 4, "max": 16, "step": 1, "default": 8 },
    { "type": "range", "id": "min_chars", "label": "Min characters", "min": 1, "max": 6, "step": 1, "default": 2 },
    { "type": "range", "id": "debounce_ms", "label": "Debounce (ms)", "min": 120, "max": 500, "step": 10, "default": 200 },
    { "type": "checkbox", "id": "open_on_focus", "label": "Open on focus (when query is long enough)", "default": true },
    { "type": "checkbox", "id": "close_on_escape", "label": "Close on Escape", "default": true },

    { "type": "header", "content": "Per-group limits (display)" },
    { "type": "range", "id": "limit_products", "label": "Products shown", "min": 1, "max": 12, "step": 1, "default": 8 },
    { "type": "range", "id": "limit_collections", "label": "Collections shown", "min": 0, "max": 12, "step": 1, "default": 6 },
    { "type": "range", "id": "limit_articles", "label": "Articles shown", "min": 0, "max": 12, "step": 1, "default": 6 },
    { "type": "range", "id": "limit_pages", "label": "Pages shown", "min": 0, "max": 12, "step": 1, "default": 6 },

    { "type": "checkbox", "id": "show_popular_queries", "label": "Show popular queries", "default": true },
    {
      "type": "textarea",
      "id": "popular_queries",
      "label": "Popular queries (one per line)",
      "default": "Best sellers\nNew arrivals\nSale"
    },
    { "type": "checkbox", "id": "show_recent_searches", "label": "Show recent searches (localStorage)", "default": false },

    { "type": "header", "content": "Layout" },
    { "type": "range", "id": "max_width", "label": "Max width", "min": 50, "max": 100, "step": 1, "default": 100, "unit": "%" },
    { "type": "range", "id": "pad_y", "label": "Vertical padding", "min": 0, "max": 100, "step": 1, "default": 56, "unit": "px" },
    { "type": "range", "id": "pad_x", "label": "Horizontal padding", "min": 0, "max": 80, "step": 1, "default": 18, "unit": "px" },
    { "type": "range", "id": "gap", "label": "Gap", "min": 8, "max": 60, "step": 1, "default": 22, "unit": "px" },
    { "type": "range", "id": "panel_max_h", "label": "Panel max height", "min": 30, "max": 90, "step": 1, "default": 62, "unit": "vh" },
    { "type": "range", "id": "thumb_size", "label": "Thumbnail size (media layout)", "min": 40, "max": 84, "step": 2, "default": 60, "unit": "px" },

    { "type": "header", "content": "Colors (scoped)" },
    { "type": "checkbox", "id": "use_custom_colors", "label": "Use custom colors", "default": true },
    { "type": "color", "id": "bg", "label": "Background", "default": "#ffffff" },
    { "type": "color", "id": "text", "label": "Text", "default": "#111111" },
    { "type": "color", "id": "muted", "label": "Muted", "default": "#6b7280" },
    { "type": "color", "id": "accent", "label": "Accent", "default": "#111111" },
    { "type": "color", "id": "surface", "label": "Surface", "default": "#f6f7f9" },
    { "type": "color", "id": "border", "label": "Border", "default": "#e5e7eb" },

    { "type": "header", "content": "Frame" },
    { "type": "range", "id": "radius", "label": "Radius", "min": 0, "max": 32, "step": 1, "default": 16, "unit": "px" },
    {
      "type": "select",
      "id": "shadow_strength",
      "label": "Shadow strength",
      "default": "soft",
      "options": [
        { "value": "none", "label": "None" },
        { "value": "soft", "label": "Soft" },
        { "value": "medium", "label": "Medium" }
      ]
    },

    { "type": "header", "content": "Typography" },
    { "type": "range", "id": "input_fs", "label": "Input text size", "min": 12, "max": 22, "step": 1, "default": 16, "unit": "px" },
    { "type": "range", "id": "group_heading_fs", "label": "Group heading size", "min": 10, "max": 16, "step": 1, "default": 12, "unit": "px" },
    { "type": "range", "id": "result_title_fs", "label": "Result title size", "min": 12, "max": 20, "step": 1, "default": 14, "unit": "px" },
    { "type": "range", "id": "result_meta_fs", "label": "Result meta size", "min": 10, "max": 16, "step": 1, "default": 12, "unit": "px" }
  ],
  "presets": [
    { "name": "Interactive Content Helper - Predictive Search", "category": "Interactive Content Helpers" }
  ]
}
{% endschema %}
