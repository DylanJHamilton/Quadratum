{%- comment -%}
  Quadratum — Interactive · Cards Engine (Single-file, Designer-First)
  File: sections/interactive-content-cards-engine.liquid

  Layout modes:
  - grid
  - row (scroll rail)
  - stacked_timeline

  Variants:
  - icon_card
  - image_box
  - flip_box (progressive; stacked fallback by default)
  - stacked_card

  Added designer upgrades:
  - design_preset: classic | glass | bold | minimal
  - card_pad (separate from gap)
  - media_ratio: auto | 1:1 | 4:3 | 16:9
  - hover_style: lift | glow | none
  - content_align: left | center

  Compiler-safe:
  - No boolean expressions inside {{ }}
  - Guards optional objects (images/urls)
  - Range steps <= 101
{%- endcomment -%}

{%- liquid
  assign cards = section.blocks | where: 'type', 'card'
  assign card_count = cards.size
  if card_count == 0
    break
  endif

  assign section_id = section.id

  assign layout_mode = section.settings.layout_mode
  assign card_variant = section.settings.card_variant
  assign design_preset = section.settings.design_preset
  assign hover_style = section.settings.hover_style
  assign content_align = section.settings.content_align
  assign media_ratio = section.settings.media_ratio

  assign show_header = section.settings.show_header
  assign heading = section.settings.heading
  assign subheading = section.settings.subheading

  assign equal_height = section.settings.equal_height_cards
  assign click_behavior = section.settings.card_click_behavior
  assign row_hint = section.settings.row_scroll_hint

  assign flip_trigger = section.settings.flip_trigger
  assign flip_mobile_fallback = section.settings.flip_mobile_fallback

  assign timeline_show_line = section.settings.timeline_show_line
  assign timeline_marker_style = section.settings.timeline_marker_style
  assign timeline_align = section.settings.timeline_align

  assign columns_desktop = section.settings.columns_desktop
  assign columns_tablet = section.settings.columns_tablet
  assign columns_mobile = section.settings.columns_mobile

  assign max_width = section.settings.max_width
  assign pad_y = section.settings.pad_y
  assign pad_x = section.settings.pad_x
  assign gap = section.settings.gap
  assign card_pad = section.settings.card_pad

  assign use_custom_colors = section.settings.use_custom_colors
  assign c_bg = section.settings.color_bg
  assign c_text = section.settings.color_text
  assign c_muted = section.settings.color_muted
  assign c_accent = section.settings.color_accent
  assign c_surface = section.settings.color_surface
  assign c_border = section.settings.color_border

  assign radius = section.settings.card_radius
  assign shadow = section.settings.card_shadow

  assign title_fs = section.settings.title_fs
  assign title_fw = section.settings.title_fw
  assign subtitle_fs = section.settings.subtitle_fs
  assign body_fs = section.settings.body_fs
  assign badge_fs = section.settings.badge_fs
  assign cta_fs = section.settings.cta_fs
  assign cta_fw = section.settings.cta_fw

  assign ratio_value = 'auto'
  if media_ratio == '1_1'
    assign ratio_value = '1/1'
  elsif media_ratio == '4_3'
    assign ratio_value = '4/3'
  elsif media_ratio == '16_9'
    assign ratio_value = '16/9'
  endif
-%}

{%- capture style_vars -%}
  --q-ce-maxw: {{ max_width }}px;
  --q-ce-pad-y: {{ pad_y }}px;
  --q-ce-pad-x: {{ pad_x }}px;
  --q-ce-gap: {{ gap }}px;

  --q-ce-card-pad: {{ card_pad }}px;

  --q-ce-radius: {{ radius }}px;
  --q-ce-shadow: {{ shadow }};

  --q-ce-title-fs: {{ title_fs }}px;
  --q-ce-title-fw: {{ title_fw }};
  --q-ce-subtitle-fs: {{ subtitle_fs }}px;
  --q-ce-body-fs: {{ body_fs }}px;
  --q-ce-badge-fs: {{ badge_fs }}px;
  --q-ce-cta-fs: {{ cta_fs }}px;
  --q-ce-cta-fw: {{ cta_fw }};

  --q-ce-media-ratio: {{ ratio_value }};

  {%- if use_custom_colors -%}
    --q-ce-bg: {{ c_bg }};
    --q-ce-text: {{ c_text }};
    --q-ce-muted: {{ c_muted }};
    --q-ce-accent: {{ c_accent }};
    --q-ce-surface: {{ c_surface }};
    --q-ce-border: {{ c_border }};
  {%- endif -%}
{%- endcapture -%}

<style>
/* Quadratum — Interactive · Cards Engine (inline, scoped to section id) */
#q-ce-{{ section_id }}{
  --q-ce-bg: var(--q-bg, transparent);
  --q-ce-text: var(--q-text, #111);
  --q-ce-muted: var(--q-muted, #5b5b5b);
  --q-ce-accent: var(--q-accent, currentColor);
  --q-ce-surface: var(--q-surface, #fff);
  --q-ce-border: var(--q-border, #e8e8e8);

  /* preset knobs (defaults overridden by preset classes below) */
  --q-ce-surface-alpha: 1;
  --q-ce-border-alpha: 1;
  --q-ce-shadow-mult: 1;
  --q-ce-hover-lift: -2px;
  --q-ce-hover-glow: 0;

  background: var(--q-ce-bg);
  color: var(--q-ce-text);
}

/* Presets */
#q-ce-{{ section_id }}.q-ce--preset-classic{
  --q-ce-surface-alpha: 1;
  --q-ce-border-alpha: 1;
  --q-ce-shadow-mult: 1;
}
#q-ce-{{ section_id }}.q-ce--preset-minimal{
  --q-ce-surface-alpha: 1;
  --q-ce-border-alpha: 0.7;
  --q-ce-shadow-mult: 0;
}
#q-ce-{{ section_id }}.q-ce--preset-bold{
  --q-ce-surface-alpha: 1;
  --q-ce-border-alpha: 1;
  --q-ce-shadow-mult: 1.35;
  --q-ce-hover-glow: 1;
}
#q-ce-{{ section_id }}.q-ce--preset-glass{
  --q-ce-surface-alpha: 0.72;
  --q-ce-border-alpha: 0.65;
  --q-ce-shadow-mult: 1.1;
}

/* Hover styles */
#q-ce-{{ section_id }}.q-ce--hover-none{
  --q-ce-hover-lift: 0px;
  --q-ce-hover-glow: 0;
}
#q-ce-{{ section_id }}.q-ce--hover-glow{
  --q-ce-hover-lift: 0px;
  --q-ce-hover-glow: 1;
}
#q-ce-{{ section_id }}.q-ce--hover-lift{
  --q-ce-hover-lift: -2px;
}

#q-ce-{{ section_id }} .q-ce__outer{ padding: var(--q-ce-pad-y) var(--q-ce-pad-x); }
#q-ce-{{ section_id }} .q-ce__inner{ max-width: var(--q-ce-maxw); margin: 0 auto; }
#q-ce-{{ section_id }} .q-ce__header{ margin-bottom: calc(var(--q-ce-gap) * 1.1); }
#q-ce-{{ section_id }} .q-ce__heading{ margin: 0 0 10px; line-height: 1.15; }
#q-ce-{{ section_id }} .q-ce__subheading{ color: var(--q-ce-muted); max-width: 72ch; }

/* Grid / Row rail */
#q-ce-{{ section_id }} .q-ce__rail{ display:grid; gap: var(--q-ce-gap); }
#q-ce-{{ section_id }}.q-ce--layout-grid .q-ce__rail{
  grid-template-columns: repeat(var(--q-ce-cols-d), minmax(0,1fr));
}
@media (max-width: 990px){
  #q-ce-{{ section_id }}.q-ce--layout-grid .q-ce__rail{
    grid-template-columns: repeat(var(--q-ce-cols-t), minmax(0,1fr));
  }
}
@media (max-width: 749px){
  #q-ce-{{ section_id }}.q-ce--layout-grid .q-ce__rail{
    grid-template-columns: repeat(var(--q-ce-cols-m), minmax(0,1fr));
  }
}

/* Row scroll rail */
#q-ce-{{ section_id }}.q-ce--layout-row .q-ce__rail{
  grid-auto-flow: column;
  grid-auto-columns: calc((100% - (var(--q-ce-gap) * (var(--q-ce-cols-d) - 1))) / var(--q-ce-cols-d));
  grid-template-columns: unset;
  overflow-x: auto;
  padding-bottom: 6px;
  scroll-snap-type: x mandatory;
  -webkit-overflow-scrolling: touch;
}
#q-ce-{{ section_id }}.q-ce--layout-row .q-ce__cell{ scroll-snap-align: start; }
@media (max-width: 990px){
  #q-ce-{{ section_id }}.q-ce--layout-row .q-ce__rail{
    grid-auto-columns: calc((100% - (var(--q-ce-gap) * (var(--q-ce-cols-t) - 1))) / var(--q-ce-cols-t));
  }
}
@media (max-width: 749px){
  #q-ce-{{ section_id }}.q-ce--layout-row .q-ce__rail{ grid-auto-columns: 86%; }
}

/* Row hint */
#q-ce-{{ section_id }} .q-ce__rowhint{ margin-top: 10px; display:flex; justify-content:flex-end; }
#q-ce-{{ section_id }} .q-ce__rowhint-text{
  font-size:12px; color: var(--q-ce-muted);
  border:1px solid color-mix(in srgb, var(--q-ce-border), transparent calc((1 - var(--q-ce-border-alpha)) * 100%));
  padding:6px 10px; border-radius:999px;
  background: color-mix(in srgb, var(--q-ce-surface), transparent 10%);
}

/* Card base */
#q-ce-{{ section_id }} .q-ce__card,
#q-ce-{{ section_id }} .q-ce__card:visited{
  color: inherit; text-decoration:none; position:relative; display:block;
  border-radius: var(--q-ce-radius); outline:none;
}

/* Surface: apply preset alpha + border alpha */
#q-ce-{{ section_id }} .q-ce__surface{
  position:relative; height:100%;
  background: color-mix(in srgb, var(--q-ce-surface), transparent calc((1 - var(--q-ce-surface-alpha)) * 100%));
  border: 1px solid color-mix(in srgb, var(--q-ce-border), transparent calc((1 - var(--q-ce-border-alpha)) * 100%));
  border-radius: var(--q-ce-radius);
  padding: var(--q-ce-card-pad);

  box-shadow:
    0 1px 0 rgba(0,0,0,0.02),
    0 calc(var(--q-ce-shadow) * 6px * var(--q-ce-shadow-mult)) calc(var(--q-ce-shadow) * 18px * var(--q-ce-shadow-mult)) rgba(0,0,0,0.08);

  transition: transform 180ms ease, border-color 180ms ease, box-shadow 180ms ease, filter 180ms ease;
}

/* Hover / focus */
#q-ce-{{ section_id }} .q-ce__card:hover .q-ce__surface,
#q-ce-{{ section_id }} .q-ce__card:focus-within .q-ce__surface{
  transform: translateY(var(--q-ce-hover-lift));
  border-color: color-mix(in srgb, var(--q-ce-border), var(--q-ce-text) 12%);
  box-shadow:
    0 1px 0 rgba(0,0,0,0.02),
    0 calc(var(--q-ce-shadow) * 8px * var(--q-ce-shadow-mult)) calc(var(--q-ce-shadow) * 22px * var(--q-ce-shadow-mult)) rgba(0,0,0,0.10);
  filter: drop-shadow(0 0 calc(var(--q-ce-hover-glow) * 14px) color-mix(in srgb, var(--q-ce-accent), transparent 70%));
}

/* Equal height */
#q-ce-{{ section_id }}.q-ce--equal .q-ce__cell,
#q-ce-{{ section_id }}.q-ce--equal .q-ce__card,
#q-ce-{{ section_id }}.q-ce--equal .q-ce__surface{ height:100%; }

/* Alignment */
#q-ce-{{ section_id }}.q-ce--align-center .q-ce__content{ text-align:center; }
#q-ce-{{ section_id }}.q-ce--align-center .q-ce__icon,
#q-ce-{{ section_id }}.q-ce--align-center .q-ce__placeholder{ margin-left:auto; margin-right:auto; }
#q-ce-{{ section_id }}.q-ce--align-center .q-ce__cta{ justify-content:center; }

/* Badge / media / icon */
#q-ce-{{ section_id }} .q-ce__badge{
  display:inline-flex; align-items:center;
  font-size: var(--q-ce-badge-fs);
  border: 1px solid color-mix(in srgb, var(--q-ce-border), transparent calc((1 - var(--q-ce-border-alpha)) * 100%));
  padding:4px 10px; border-radius:999px;
  margin-bottom:10px;
  background: color-mix(in srgb, var(--q-ce-surface), transparent 12%);
  color: var(--q-ce-muted);
}

/* Media ratio control */
#q-ce-{{ section_id }} .q-ce__media{
  margin-bottom:12px;
  border-radius: calc(var(--q-ce-radius) - 4px);
  overflow:hidden;
  border: 1px solid color-mix(in srgb, var(--q-ce-border), transparent calc((1 - var(--q-ce-border-alpha)) * 100%));
}
#q-ce-{{ section_id }} .q-ce__media.q-ce__media--ratio{
  aspect-ratio: var(--q-ce-media-ratio);
}
#q-ce-{{ section_id }} .q-ce__img{
  width:100%;
  height:100%;
  object-fit: cover;
  display:block;
}

#q-ce-{{ section_id }} .q-ce__icon{
  width:44px; height:44px; border-radius:14px;
  display:grid; place-items:center;
  margin-bottom:12px;
  border: 1px solid color-mix(in srgb, var(--q-ce-border), transparent calc((1 - var(--q-ce-border-alpha)) * 100%));
  background: color-mix(in srgb, var(--q-ce-surface), transparent 10%);
  font-size:20px;
}
#q-ce-{{ section_id }} .q-ce__placeholder{
  width:44px; height:44px; border-radius:14px;
  margin-bottom:12px;
  border: 1px dashed color-mix(in srgb, var(--q-ce-border), transparent 20%);
  background: transparent;
}

/* Typography */
#q-ce-{{ section_id }} .q-ce__title{
  margin:0 0 6px;
  font-size: var(--q-ce-title-fs);
  font-weight: var(--q-ce-title-fw);
  line-height:1.2;
}
#q-ce-{{ section_id }} .q-ce__subtitle{
  margin:0 0 10px;
  font-size: var(--q-ce-subtitle-fs);
  color: var(--q-ce-muted);
}
#q-ce-{{ section_id }} .q-ce__body{ font-size: var(--q-ce-body-fs); color: var(--q-ce-text); }

/* CTA */
#q-ce-{{ section_id }} .q-ce__cta{
  margin-top:12px;
  display:inline-flex; gap:8px; align-items:center;
  font-size: var(--q-ce-cta-fs);
  font-weight: var(--q-ce-cta-fw);
  color: var(--q-ce-accent);
  text-decoration:none;
}
#q-ce-{{ section_id }} .q-ce__cta:hover,
#q-ce-{{ section_id }} .q-ce__cta:focus-visible{
  text-decoration: underline;
  text-underline-offset: 3px;
}
#q-ce-{{ section_id }} .q-ce__arrow{ transition: transform 180ms ease; }
#q-ce-{{ section_id }} .q-ce__card:hover .q-ce__arrow{ transform: translateX(2px); }

/* Flip toggle overlay */
#q-ce-{{ section_id }} .q-ce__card--flip .q-ce__flipbtn{
  position:absolute; inset:0; z-index:5;
  border:0; background:transparent; cursor:pointer;
  border-radius: var(--q-ce-radius);
}
#q-ce-{{ section_id }} .q-ce__card--flip .q-ce__flipbtn:focus-visible{
  outline: 2px solid color-mix(in srgb, var(--q-ce-accent), transparent 10%);
  outline-offset: 2px;
}

/* Back stacked */
#q-ce-{{ section_id }} .q-ce__back--stack{
  margin-top:14px; padding-top:14px;
  border-top: 1px solid color-mix(in srgb, var(--q-ce-border), transparent calc((1 - var(--q-ce-border-alpha)) * 100%));
}
#q-ce-{{ section_id }} .q-ce__backtitle{ font-weight:600; margin-bottom:6px; }
#q-ce-{{ section_id }} .q-ce__backbody{ color: var(--q-ce-muted); }

/* "Enable flip" mode (3D) */
#q-ce-{{ section_id }}[data-flip-fallback="enable_flip"] .q-ce__card--flip .q-ce__surface{ transform-style: preserve-3d; }
#q-ce-{{ section_id }}[data-flip-fallback="enable_flip"] .q-ce__card--flip .q-ce__front,
#q-ce-{{ section_id }}[data-flip-fallback="enable_flip"] .q-ce__card--flip .q-ce__back--flip{ backface-visibility: hidden; }
#q-ce-{{ section_id }}[data-flip-fallback="enable_flip"] .q-ce__card--flip .q-ce__back--flip{
  position:absolute; inset:0;
  padding: var(--q-ce-card-pad);
  border-radius: var(--q-ce-radius);
  transform: rotateY(180deg);
  background: color-mix(in srgb, var(--q-ce-surface), transparent calc((1 - var(--q-ce-surface-alpha)) * 100%));
}
#q-ce-{{ section_id }}[data-flip-fallback="enable_flip"] .q-ce__card--flip .q-ce__surface{ transition: transform 220ms ease; }
#q-ce-{{ section_id }}[data-flip-fallback="enable_flip"] .q-ce__card--flip.is-flipped .q-ce__surface{ transform: rotateY(180deg); }
@media (hover:hover) and (pointer:fine){
  #q-ce-{{ section_id }}[data-flip-fallback="enable_flip"][data-flip-trigger="hover"] .q-ce__card--flip:hover .q-ce__surface,
  #q-ce-{{ section_id }}[data-flip-fallback="enable_flip"][data-flip-trigger="hover"] .q-ce__card--flip:focus-within .q-ce__surface{
    transform: rotateY(180deg);
  }
}

/* Timeline */
#q-ce-{{ section_id }} .q-ce__timeline{ display:grid; gap: var(--q-ce-gap); position:relative; }
#q-ce-{{ section_id }} .q-ce__timeline--left .q-ce__titem{
  display:grid; grid-template-columns:32px 1fr; gap:14px; align-items:start;
}
#q-ce-{{ section_id }} .q-ce__timeline--center .q-ce__titem{
  display:grid; grid-template-columns:1fr; gap:10px;
}
#q-ce-{{ section_id }} .q-ce__tmarker{ position:relative; display:grid; place-items:center; min-height:32px; }
#q-ce-{{ section_id }} .q-ce__tmark--dot{ width:10px; height:10px; border-radius:999px; background: var(--q-ce-accent); }
#q-ce-{{ section_id }} .q-ce__tmark--num,
#q-ce-{{ section_id }} .q-ce__tmark--icon{
  width:28px; height:28px; border-radius:999px; display:grid; place-items:center;
  border: 1px solid color-mix(in srgb, var(--q-ce-border), transparent calc((1 - var(--q-ce-border-alpha)) * 100%));
  background: color-mix(in srgb, var(--q-ce-surface), transparent calc((1 - var(--q-ce-surface-alpha)) * 100%));
  color: var(--q-ce-accent);
  font-weight:600; font-size:12px;
}
#q-ce-{{ section_id }} .q-ce__timeline--line.q-ce__timeline--left::before{
  content:""; position:absolute; left:16px; top:0; bottom:0; width:2px;
  background: color-mix(in srgb, var(--q-ce-border), transparent calc((1 - var(--q-ce-border-alpha)) * 100%));
}
#q-ce-{{ section_id }} .q-ce__tphase{
  grid-column: 2 / -1;
  margin-top:6px; font-size:12px; color: var(--q-ce-muted);
}
</style>

<section
  class="q-ce
    q-ce--layout-{{ layout_mode }}
    q-ce--variant-{{ card_variant }}
    q-ce--preset-{{ design_preset }}
    q-ce--hover-{{ hover_style }}
    q-ce--align-{{ content_align }}
    {% if equal_height %} q-ce--equal{% endif %}"
  id="q-ce-{{ section_id }}"
  style="{{ style_vars | strip | strip_newlines }}"
  data-section-id="{{ section_id }}"
  data-layout="{{ layout_mode }}"
  data-variant="{{ card_variant }}"
  data-flip-trigger="{{ flip_trigger }}"
  data-flip-fallback="{{ flip_mobile_fallback }}"
>
  <div class="q-ce__outer">
    <div class="q-ce__inner">
      {%- if show_header -%}
        <header class="q-ce__header">
          {%- if heading != blank -%}
            <h2 class="q-ce__heading">{{ heading }}</h2>
          {%- endif -%}
          {%- if subheading != blank -%}
            <div class="q-ce__subheading rte">{{ subheading }}</div>
          {%- endif -%}
        </header>
      {%- endif -%}

      {%- if layout_mode == 'stacked_timeline' -%}
        <div class="q-ce__timeline q-ce__timeline--{{ timeline_align }}{% if timeline_show_line %} q-ce__timeline--line{% endif %}">
          {%- for block in cards -%}
            {%- liquid
              assign b_title = block.settings.title
              assign b_subtitle = block.settings.subtitle
              assign b_body = block.settings.body
              assign b_badge = block.settings.badge
              assign b_icon = block.settings.icon
              assign b_image = block.settings.image
              assign b_cta_label = block.settings.cta_label
              assign b_cta_url = block.settings.cta_url

              assign b_step = block.settings.step_number
              assign b_phase = block.settings.phase_label

              assign back_title = block.settings.back_title
              assign back_body = block.settings.back_body
              assign back_cta_label = block.settings.back_cta_label
              assign back_cta_url = block.settings.back_cta_url

              assign has_link = false
              if b_cta_url != blank
                assign has_link = true
              endif

              assign whole_card = false
              if click_behavior == 'whole_card_if_link' and has_link
                assign whole_card = true
              endif

              assign back_has_content = false
              if back_title != blank
                assign back_has_content = true
              endif
              if back_body != blank
                assign back_has_content = true
              endif

              assign enable_flip = false
              if card_variant == 'flip_box' and back_has_content
                assign enable_flip = true
              endif

              assign has_image = false
              if b_image != blank
                assign has_image = true
              endif

              assign has_icon = false
              if b_icon != blank
                assign has_icon = true
              endif

              assign has_badge = false
              if b_badge != blank
                assign has_badge = true
              endif

              assign has_cta = false
              if b_cta_url != blank and b_cta_label != blank
                assign has_cta = true
              endif

              assign use_ratio = false
              if ratio_value != 'auto'
                assign use_ratio = true
              endif
            -%}

            <article class="q-ce__titem" {{ block.shopify_attributes }}>
              <div class="q-ce__tmarker" aria-hidden="true">
                {%- if timeline_marker_style == 'number' and b_step != blank -%}
                  <span class="q-ce__tmark q-ce__tmark--num">{{ b_step }}</span>
                {%- elsif timeline_marker_style == 'icon' and has_icon -%}
                  <span class="q-ce__tmark q-ce__tmark--icon">{{ b_icon }}</span>
                {%- else -%}
                  <span class="q-ce__tmark q-ce__tmark--dot"></span>
                {%- endif -%}
              </div>

              <div class="q-ce__cardwrap">
                {%- if whole_card -%}
                  <a class="q-ce__card{% if enable_flip %} q-ce__card--flip{% endif %}" href="{{ b_cta_url }}">
                {%- else -%}
                  <div class="q-ce__card{% if enable_flip %} q-ce__card--flip{% endif %}">
                {%- endif -%}

                  {%- if enable_flip and flip_trigger == 'click' -%}
                    <button
                      class="q-ce__flipbtn"
                      type="button"
                      aria-expanded="false"
                      aria-controls="q-ce-flip-{{ block.id }}"
                    >
                      <span class="visually-hidden">Toggle details</span>
                    </button>
                  {%- endif -%}

                  <div class="q-ce__surface" id="q-ce-flip-{{ block.id }}">
                    <div class="q-ce__front">
                      {%- if has_badge -%}
                        <div class="q-ce__badge">{{ b_badge }}</div>
                      {%- endif -%}

                      {%- if card_variant == 'image_box' -%}
                        {%- if has_image -%}
                          <div class="q-ce__media{% if use_ratio %} q-ce__media--ratio{% endif %}">
                            {{ b_image | image_url: width: 1600 | image_tag: loading: 'lazy', class: 'q-ce__img', alt: b_title }}
                          </div>
                        {%- elsif has_icon -%}
                          <div class="q-ce__icon" aria-hidden="true">{{ b_icon }}</div>
                        {%- else -%}
                          <div class="q-ce__placeholder" aria-hidden="true"></div>
                        {%- endif -%}
                      {%- elsif card_variant == 'icon_card' -%}
                        {%- if has_icon -%}
                          <div class="q-ce__icon" aria-hidden="true">{{ b_icon }}</div>
                        {%- else -%}
                          <div class="q-ce__placeholder" aria-hidden="true"></div>
                        {%- endif -%}
                      {%- else -%}
                        {%- if has_image -%}
                          <div class="q-ce__media{% if use_ratio %} q-ce__media--ratio{% endif %}">
                            {{ b_image | image_url: width: 1600 | image_tag: loading: 'lazy', class: 'q-ce__img', alt: b_title }}
                          </div>
                        {%- elsif has_icon -%}
                          <div class="q-ce__icon" aria-hidden="true">{{ b_icon }}</div>
                        {%- endif -%}
                      {%- endif -%}

                      <div class="q-ce__content">
                        <h3 class="q-ce__title">{{ b_title }}</h3>
                        {%- if b_subtitle != blank -%}
                          <div class="q-ce__subtitle">{{ b_subtitle }}</div>
                        {%- endif -%}
                        <div class="q-ce__body rte">{{ b_body }}</div>

                        {%- if has_cta -%}
                          {%- if whole_card -%}
                            <span class="q-ce__cta q-ce__cta--text">
                              {{ b_cta_label }} <span class="q-ce__arrow" aria-hidden="true">→</span>
                            </span>
                          {%- else -%}
                            <a class="q-ce__cta" href="{{ b_cta_url }}">
                              {{ b_cta_label }} <span class="q-ce__arrow" aria-hidden="true">→</span>
                            </a>
                          {%- endif -%}
                        {%- endif -%}
                      </div>
                    </div>

                    {%- if enable_flip -%}
                      {%- if flip_mobile_fallback == 'stack_back_content' -%}
                        <div class="q-ce__back q-ce__back--stack">
                          {%- if back_title != blank -%}
                            <div class="q-ce__backtitle">{{ back_title }}</div>
                          {%- endif -%}
                          {%- if back_body != blank -%}
                            <div class="q-ce__backbody rte">{{ back_body }}</div>
                          {%- endif -%}
                          {%- if back_cta_url != blank and back_cta_label != blank -%}
                            <a class="q-ce__cta q-ce__cta--sub" href="{{ back_cta_url }}">
                              {{ back_cta_label }} <span class="q-ce__arrow" aria-hidden="true">→</span>
                            </a>
                          {%- endif -%}
                        </div>
                      {%- else -%}
                        <div class="q-ce__back q-ce__back--flip">
                          <div class="q-ce__backinner">
                            {%- if back_title != blank -%}
                              <div class="q-ce__backtitle">{{ back_title }}</div>
                            {%- endif -%}
                            {%- if back_body != blank -%}
                              <div class="q-ce__backbody rte">{{ back_body }}</div>
                            {%- endif -%}
                            {%- if back_cta_url != blank and back_cta_label != blank -%}
                              <a class="q-ce__cta q-ce__cta--sub" href="{{ back_cta_url }}">
                                {{ back_cta_label }} <span class="q-ce__arrow" aria-hidden="true">→</span>
                              </a>
                            {%- endif -%}
                          </div>
                        </div>
                      {%- endif -%}
                    {%- endif -%}
                  </div>

                {%- if whole_card -%}
                  </a>
                {%- else -%}
                  </div>
                {%- endif -%}
              </div>

              {%- if b_phase != blank -%}
                <div class="q-ce__tphase">{{ b_phase }}</div>
              {%- endif -%}
            </article>
          {%- endfor -%}
        </div>

      {%- else -%}
        <div
          class="q-ce__rail"
          style="--q-ce-cols-d: {{ columns_desktop }}; --q-ce-cols-t: {{ columns_tablet }}; --q-ce-cols-m: {{ columns_mobile }};"
        >
          {%- for block in cards -%}
            {%- liquid
              assign b_title = block.settings.title
              assign b_subtitle = block.settings.subtitle
              assign b_body = block.settings.body
              assign b_badge = block.settings.badge
              assign b_icon = block.settings.icon
              assign b_image = block.settings.image
              assign b_cta_label = block.settings.cta_label
              assign b_cta_url = block.settings.cta_url

              assign back_title = block.settings.back_title
              assign back_body = block.settings.back_body
              assign back_cta_label = block.settings.back_cta_label
              assign back_cta_url = block.settings.back_cta_url

              assign has_link = false
              if b_cta_url != blank
                assign has_link = true
              endif

              assign whole_card = false
              if click_behavior == 'whole_card_if_link' and has_link
                assign whole_card = true
              endif

              assign back_has_content = false
              if back_title != blank
                assign back_has_content = true
              endif
              if back_body != blank
                assign back_has_content = true
              endif

              assign enable_flip = false
              if card_variant == 'flip_box' and back_has_content
                assign enable_flip = true
              endif

              assign has_image = false
              if b_image != blank
                assign has_image = true
              endif

              assign has_icon = false
              if b_icon != blank
                assign has_icon = true
              endif

              assign has_badge = false
              if b_badge != blank
                assign has_badge = true
              endif

              assign has_cta = false
              if b_cta_url != blank and b_cta_label != blank
                assign has_cta = true
              endif

              assign use_ratio = false
              if ratio_value != 'auto'
                assign use_ratio = true
              endif
            -%}

            <div class="q-ce__cell" {{ block.shopify_attributes }}>
              {%- if whole_card -%}
                <a class="q-ce__card{% if enable_flip %} q-ce__card--flip{% endif %}" href="{{ b_cta_url }}">
              {%- else -%}
                <div class="q-ce__card{% if enable_flip %} q-ce__card--flip{% endif %}">
              {%- endif -%}

                {%- if enable_flip and flip_trigger == 'click' -%}
                  <button
                    class="q-ce__flipbtn"
                    type="button"
                    aria-expanded="false"
                    aria-controls="q-ce-flip-{{ block.id }}"
                  >
                    <span class="visually-hidden">Toggle details</span>
                  </button>
                {%- endif -%}

                <div class="q-ce__surface" id="q-ce-flip-{{ block.id }}">
                  <div class="q-ce__front">
                    {%- if has_badge -%}
                      <div class="q-ce__badge">{{ b_badge }}</div>
                    {%- endif -%}

                    {%- if card_variant == 'image_box' -%}
                      {%- if has_image -%}
                        <div class="q-ce__media{% if use_ratio %} q-ce__media--ratio{% endif %}">
                          {{ b_image | image_url: width: 1600 | image_tag: loading: 'lazy', class: 'q-ce__img', alt: b_title }}
                        </div>
                      {%- elsif has_icon -%}
                        <div class="q-ce__icon" aria-hidden="true">{{ b_icon }}</div>
                      {%- else -%}
                        <div class="q-ce__placeholder" aria-hidden="true"></div>
                      {%- endif -%}
                    {%- elsif card_variant == 'icon_card' -%}
                      {%- if has_icon -%}
                        <div class="q-ce__icon" aria-hidden="true">{{ b_icon }}</div>
                      {%- else -%}
                        <div class="q-ce__placeholder" aria-hidden="true"></div>
                      {%- endif -%}
                    {%- else -%}
                      {%- if has_image -%}
                        <div class="q-ce__media{% if use_ratio %} q-ce__media--ratio{% endif %}">
                          {{ b_image | image_url: width: 1600 | image_tag: loading: 'lazy', class: 'q-ce__img', alt: b_title }}
                        </div>
                      {%- elsif has_icon -%}
                        <div class="q-ce__icon" aria-hidden="true">{{ b_icon }}</div>
                      {%- endif -%}
                    {%- endif -%}

                    <div class="q-ce__content">
                      <h3 class="q-ce__title">{{ b_title }}</h3>
                      {%- if b_subtitle != blank -%}
                        <div class="q-ce__subtitle">{{ b_subtitle }}</div>
                      {%- endif -%}
                      <div class="q-ce__body rte">{{ b_body }}</div>

                      {%- if has_cta -%}
                        {%- if whole_card -%}
                          <span class="q-ce__cta q-ce__cta--text">
                            {{ b_cta_label }} <span class="q-ce__arrow" aria-hidden="true">→</span>
                          </span>
                        {%- else -%}
                          <a class="q-ce__cta" href="{{ b_cta_url }}">
                            {{ b_cta_label }} <span class="q-ce__arrow" aria-hidden="true">→</span>
                          </a>
                        {%- endif -%}
                      {%- endif -%}
                    </div>
                  </div>

                  {%- if enable_flip -%}
                    {%- if flip_mobile_fallback == 'stack_back_content' -%}
                      <div class="q-ce__back q-ce__back--stack">
                        {%- if back_title != blank -%}
                          <div class="q-ce__backtitle">{{ back_title }}</div>
                        {%- endif -%}
                        {%- if back_body != blank -%}
                          <div class="q-ce__backbody rte">{{ back_body }}</div>
                        {%- endif -%}
                        {%- if back_cta_url != blank and back_cta_label != blank -%}
                          <a class="q-ce__cta q-ce__cta--sub" href="{{ back_cta_url }}">
                            {{ back_cta_label }} <span class="q-ce__arrow" aria-hidden="true">→</span>
                          </a>
                        {%- endif -%}
                      </div>
                    {%- else -%}
                      <div class="q-ce__back q-ce__back--flip">
                        <div class="q-ce__backinner">
                          {%- if back_title != blank -%}
                            <div class="q-ce__backtitle">{{ back_title }}</div>
                          {%- endif -%}
                          {%- if back_body != blank -%}
                            <div class="q-ce__backbody rte">{{ back_body }}</div>
                          {%- endif -%}
                          {%- if back_cta_url != blank and back_cta_label != blank -%}
                            <a class="q-ce__cta q-ce__cta--sub" href="{{ back_cta_url }}">
                              {{ back_cta_label }} <span class="q-ce__arrow" aria-hidden="true">→</span>
                            </a>
                          {%- endif -%}
                        </div>
                      </div>
                    {%- endif -%}
                  {%- endif -%}
                </div>

              {%- if whole_card -%}
                </a>
              {%- else -%}
                </div>
              {%- endif -%}
            </div>
          {%- endfor -%}
        </div>

        {%- if layout_mode == 'row' and row_hint -%}
          <div class="q-ce__rowhint" aria-hidden="true">
            <span class="q-ce__rowhint-text">Swipe</span>
          </div>
        {%- endif -%}
      {%- endif -%}
    </div>
  </div>
</section>

<script>
/* Quadratum — Interactive · Cards Engine (inline minimal JS) */
(function(){
  function init(root){
    if(!root) return;
    var variant = root.getAttribute('data-variant');
    if(variant !== 'flip_box') return;

    var fallback = root.getAttribute('data-flip-fallback');
    var trigger = root.getAttribute('data-flip-trigger');

    if(fallback !== 'enable_flip' && trigger !== 'click') return;

    var cards = root.querySelectorAll('.q-ce__card--flip');
    cards.forEach(function(card){
      var btn = card.querySelector('.q-ce__flipbtn');
      if(!btn) return;

      btn.addEventListener('click', function(e){
        e.preventDefault();
        e.stopPropagation();
        var flipped = card.classList.toggle('is-flipped');
        btn.setAttribute('aria-expanded', flipped ? 'true' : 'false');
      });
    });
  }

  document.addEventListener('DOMContentLoaded', function(){
    init(document.getElementById('q-ce-{{ section_id }}'));
  });

  document.addEventListener('shopify:section:load', function(evt){
    if(!evt || !evt.target) return;
    var el = evt.target.querySelector('#q-ce-{{ section_id }}');
    if(!el) el = evt.target.querySelector('.q-ce');
    init(el);
  });
})();
</script>

{% schema %}
{
  "name": "Interactive Cards Engine",
  "tag": "section",
  "class": "section",
  "settings": [
    { "type": "header", "content": "Header" },
    { "type": "checkbox", "id": "show_header", "label": "Show header", "default": true },
    { "type": "text", "id": "heading", "label": "Heading", "default": "Why teams choose us" },
    { "type": "richtext", "id": "subheading", "label": "Subheading", "default": "<p>Use this engine for features, services, steps, or portfolio tiles — with premium defaults.</p>" },

    { "type": "header", "content": "Design" },
    {
      "type": "select",
      "id": "design_preset",
      "label": "Design preset",
      "default": "classic",
      "options": [
        { "value": "classic", "label": "Classic" },
        { "value": "glass", "label": "Glass" },
        { "value": "bold", "label": "Bold" },
        { "value": "minimal", "label": "Minimal" }
      ]
    },
    {
      "type": "select",
      "id": "hover_style",
      "label": "Hover style",
      "default": "lift",
      "options": [
        { "value": "lift", "label": "Lift" },
        { "value": "glow", "label": "Glow" },
        { "value": "none", "label": "None" }
      ]
    },
    {
      "type": "select",
      "id": "content_align",
      "label": "Content alignment",
      "default": "left",
      "options": [
        { "value": "left", "label": "Left" },
        { "value": "center", "label": "Center" }
      ]
    },
    {
      "type": "select",
      "id": "media_ratio",
      "label": "Media aspect ratio (image cards)",
      "default": "4_3",
      "options": [
        { "value": "auto", "label": "Auto" },
        { "value": "1_1", "label": "Square (1:1)" },
        { "value": "4_3", "label": "Standard (4:3)" },
        { "value": "16_9", "label": "Wide (16:9)" }
      ]
    },

    { "type": "header", "content": "Layout" },
    {
      "type": "select",
      "id": "layout_mode",
      "label": "Layout mode",
      "default": "grid",
      "options": [
        { "value": "grid", "label": "Grid" },
        { "value": "row", "label": "Row (scroll rail)" },
        { "value": "stacked_timeline", "label": "Stacked timeline" }
      ]
    },
    {
      "type": "select",
      "id": "card_variant",
      "label": "Card variant",
      "default": "icon_card",
      "options": [
        { "value": "icon_card", "label": "Icon card" },
        { "value": "image_box", "label": "Image box" },
        { "value": "flip_box", "label": "Flip box" },
        { "value": "stacked_card", "label": "Stacked card" }
      ]
    },

    { "type": "header", "content": "Columns (grid/row)" },
    { "type": "range", "id": "columns_desktop", "label": "Columns (desktop)", "min": 1, "max": 6, "step": 1, "default": 3 },
    { "type": "range", "id": "columns_tablet", "label": "Columns (tablet)", "min": 1, "max": 3, "step": 1, "default": 2 },
    { "type": "range", "id": "columns_mobile", "label": "Columns (mobile)", "min": 1, "max": 3, "step": 1, "default": 1 },

    { "type": "header", "content": "Behavior" },
    { "type": "checkbox", "id": "equal_height_cards", "label": "Equal height cards", "default": true },
    {
      "type": "select",
      "id": "card_click_behavior",
      "label": "Card click behavior",
      "default": "cta_only",
      "options": [
        { "value": "cta_only", "label": "CTA only" },
        { "value": "whole_card_if_link", "label": "Whole card if CTA link exists (no nested links)" }
      ]
    },
    { "type": "checkbox", "id": "row_scroll_hint", "label": "Show row scroll hint (row layout)", "default": true },

    { "type": "header", "content": "Flip (flip_box)" },
    {
      "type": "select",
      "id": "flip_trigger",
      "label": "Flip trigger",
      "default": "hover",
      "options": [
        { "value": "hover", "label": "Hover (desktop)" },
        { "value": "click", "label": "Click (accessible toggle)" }
      ]
    },
    {
      "type": "select",
      "id": "flip_mobile_fallback",
      "label": "Mobile fallback",
      "default": "stack_back_content",
      "options": [
        { "value": "stack_back_content", "label": "Stack back content below (no 3D flip)" },
        { "value": "enable_flip", "label": "Enable flip UI (JS toggle)" }
      ]
    },

    { "type": "header", "content": "Timeline (stacked_timeline)" },
    { "type": "checkbox", "id": "timeline_show_line", "label": "Show connector line", "default": true },
    {
      "type": "select",
      "id": "timeline_marker_style",
      "label": "Marker style",
      "default": "dot",
      "options": [
        { "value": "dot", "label": "Dot" },
        { "value": "number", "label": "Number (uses Step number)" },
        { "value": "icon", "label": "Icon (uses Icon field)" }
      ]
    },
    {
      "type": "select",
      "id": "timeline_align",
      "label": "Timeline alignment",
      "default": "left",
      "options": [
        { "value": "left", "label": "Left" },
        { "value": "center", "label": "Center" }
      ]
    },

    { "type": "header", "content": "Spacing" },
    { "type": "range", "id": "max_width", "label": "Max width (px)", "min": 720, "max": 1600, "step": 20, "default": 1200 },
    { "type": "range", "id": "pad_y", "label": "Vertical padding (px)", "min": 0, "max": 160, "step": 4, "default": 48 },
    { "type": "range", "id": "pad_x", "label": "Horizontal padding (px)", "min": 0, "max": 120, "step": 4, "default": 24 },
    { "type": "range", "id": "gap", "label": "Gap (px)", "min": 8, "max": 48, "step": 2, "default": 18 },
    { "type": "range", "id": "card_pad", "label": "Card padding (px)", "min": 12, "max": 44, "step": 2, "default": 18 },

    { "type": "header", "content": "Card styling" },
    { "type": "range", "id": "card_radius", "label": "Radius (px)", "min": 0, "max": 32, "step": 2, "default": 16 },
    { "type": "range", "id": "card_shadow", "label": "Shadow strength (0–5)", "min": 0, "max": 5, "step": 1, "default": 2 },

    { "type": "header", "content": "Typography" },
    { "type": "range", "id": "title_fs", "label": "Title size (px)", "min": 14, "max": 34, "step": 1, "default": 18 },
    {
      "type": "select",
      "id": "title_fw",
      "label": "Title weight",
      "default": "600",
      "options": [
        { "value": "400", "label": "400" },
        { "value": "500", "label": "500" },
        { "value": "600", "label": "600" },
        { "value": "700", "label": "700" }
      ]
    },
    { "type": "range", "id": "subtitle_fs", "label": "Subtitle size (px)", "min": 12, "max": 22, "step": 1, "default": 14 },
    { "type": "range", "id": "body_fs", "label": "Body size (px)", "min": 12, "max": 20, "step": 1, "default": 14 },
    { "type": "range", "id": "badge_fs", "label": "Badge size (px)", "min": 10, "max": 16, "step": 1, "default": 12 },
    { "type": "range", "id": "cta_fs", "label": "CTA size (px)", "min": 12, "max": 20, "step": 1, "default": 14 },
    {
      "type": "select",
      "id": "cta_fw",
      "label": "CTA weight",
      "default": "600",
      "options": [
        { "value": "500", "label": "500" },
        { "value": "600", "label": "600" },
        { "value": "700", "label": "700" }
      ]
    },

    { "type": "header", "content": "Colors (scoped)" },
    { "type": "checkbox", "id": "use_custom_colors", "label": "Use custom colors", "default": false },
    { "type": "color", "id": "color_bg", "label": "Section background", "default": "#ffffff" },
    { "type": "color", "id": "color_text", "label": "Text", "default": "#111111" },
    { "type": "color", "id": "color_muted", "label": "Muted text", "default": "#5b5b5b" },
    { "type": "color", "id": "color_accent", "label": "Accent", "default": "#111111" },
    { "type": "color", "id": "color_surface", "label": "Card surface", "default": "#ffffff" },
    { "type": "color", "id": "color_border", "label": "Card border", "default": "#e8e8e8" }
  ],
  "blocks": [
    {
      "type": "card",
      "name": "Card",
      "settings": [
        { "type": "text", "id": "title", "label": "Title", "default": "Fast installation" },
        { "type": "text", "id": "subtitle", "label": "Subtitle", "default": "Built for busy teams" },
        { "type": "richtext", "id": "body", "label": "Body", "default": "<p>Ship clean pages faster with a reusable card engine that stays consistent across layouts.</p>" },
        { "type": "text", "id": "icon", "label": "Icon (emoji or token name)", "default": "⚡" },
        { "type": "image_picker", "id": "image", "label": "Image" },
        { "type": "text", "id": "badge", "label": "Badge", "default": "Popular" },
        { "type": "text", "id": "cta_label", "label": "CTA label", "default": "Learn more" },
        { "type": "url", "id": "cta_url", "label": "CTA URL" },

        { "type": "header", "content": "Flip (optional)" },
        { "type": "text", "id": "back_title", "label": "Back title", "default": "More details" },
        { "type": "richtext", "id": "back_body", "label": "Back body", "default": "<p>Add a short explanation, a second CTA, or extra context without bloating the front card.</p>" },
        { "type": "text", "id": "back_cta_label", "label": "Back CTA label", "default": "View details" },
        { "type": "url", "id": "back_cta_url", "label": "Back CTA URL" },

        { "type": "header", "content": "Timeline extras" },
        { "type": "text", "id": "step_number", "label": "Step number", "default": "1" },
        { "type": "text", "id": "phase_label", "label": "Phase label", "default": "Discovery" }
      ]
    }
  ],
  "presets": [
    { "name": "Interactive · Cards Engine", "category": "Interactive" }
  ]
}
{% endschema %}
