{%- liquid
  assign s = section.settings
  assign ratio_class = s.aspect_ratio | replace: ':', '-'
  assign is_manual = false
  if s.data_source_mode == 'manual'
    assign is_manual = true
  endif

  assign lazy_enabled = true
  if settings.images_lazyload == false
    assign lazy_enabled = false
  endif

  assign placeholder_caption = 'Caption (optional)'
  assign placeholder_overlay = 'View'
-%}

{%- if s.enable_section or request.design_mode -%}
<section
  id="social-media-instagram-grid-{{ section.id }}"
  class="q-section q-social-grid q-social-grid--instagram q-social-grid--card-{{ s.card_style }} q-social-grid--overlay-{{ s.hover_overlay_mode }}"
  aria-label="{{ s.aria_label | escape }}"
  data-source="{{ s.data_source_mode | escape }}"
  data-feed-handle="{{ s.feed_handle | escape }}"
  style="--qsg-cols-d: {{ s.max_columns_desktop }}; --qsg-cols-m: {{ s.max_columns_mobile }}; --qsg-gap: {{ s.gap }}px; --qsg-caption-lines: {{ s.caption_max_lines }};"
>
  <div class="q-social-grid__container">
    {%- if s.kicker != blank or s.heading != blank or s.body != blank -%}
      <div class="q-section-header q-stack q-stack--gap-sm q-text-{{ s.align }}">
        {%- if s.kicker != blank -%}
          <p class="q-social-grid__kicker">{{ s.kicker | escape }}</p>
        {%- endif -%}
        {%- if s.heading != blank -%}
          <h2 class="q-social-grid__heading">{{ s.heading | escape }}</h2>
        {%- endif -%}
        {%- if s.body != blank -%}
          <div class="q-social-grid__body">{{ s.body | escape | newline_to_br }}</div>
        {%- endif -%}
      </div>
    {%- endif -%}

    {%- if is_manual -%}
      {%- if section.blocks.size > 0 -%}
        <div class="q-social-grid__grid" role="list">
          {%- for block in section.blocks -%}
            {%- if block.type == 'ig_tile' -%}
              {%- liquid
                assign b = block.settings
                assign img = b.image
                assign url = b.link_url
                assign has_link = true
                if url == blank or url == '#'
                  assign has_link = false
                endif

                assign caption = b.caption
                assign show_caption = false
                if s.show_captions and caption != blank and caption != placeholder_caption
                  assign show_caption = true
                endif

                assign overlay_text = b.overlay_label
                assign show_overlay_text = false
                if overlay_text != blank and overlay_text != placeholder_overlay
                  assign show_overlay_text = true
                endif

                assign alt_text = b.alt_text
                if alt_text == blank
                  assign alt_text = 'Instagram gallery image'
                endif

                assign loading_mode = 'lazy'
                if lazy_enabled == false
                  assign loading_mode = 'eager'
                endif
              -%}

              {%- if img != blank -%}
                <div class="q-social-grid__item" role="listitem" {{ block.shopify_attributes }}>
                  {%- if has_link -%}
                    <a
                      class="q-social-grid__tile"
                      href="{{ url | escape }}"
                      aria-label="{{ b.link_aria_label | escape }}"
                      {%- if s.open_in_new_tab -%}target="_blank" rel="noopener noreferrer"{%- else -%}rel="noopener"{%- endif -%}
                    >
                  {%- else -%}
                    <div class="q-social-grid__tile" aria-hidden="false">
                  {%- endif -%}

                      <div class="q-social-grid__media q-aspect--{{ ratio_class }}">
                        <img
                          src="{{ img | image_url: width: 640 }}"
                          srcset="
                            {{ img | image_url: width: 360 }} 360w,
                            {{ img | image_url: width: 480 }} 480w,
                            {{ img | image_url: width: 640 }} 640w,
                            {{ img | image_url: width: 900 }} 900w,
                            {{ img | image_url: width: 1200 }} 1200w
                          "
                          sizes="(min-width: 990px) 20vw, 45vw"
                          alt="{{ alt_text | escape }}"
                          loading="{{ loading_mode }}"
                          decoding="async"
                        >
                        {%- if s.hover_overlay_mode != 'none' -%}
                          <span class="q-social-grid__overlay" aria-hidden="true">
                            <span class="q-social-grid__overlay-inner">
                              {%- case s.hover_overlay_icon -%}
                                {%- when 'instagram' -%}
                                  <span class="q-social-grid__icon" aria-hidden="true">
                                    <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true" focusable="false">
                                      <path d="M7 2h10a5 5 0 0 1 5 5v10a5 5 0 0 1-5 5H7a5 5 0 0 1-5-5V7a5 5 0 0 1 5-5Z"></path>
                                      <path d="M16 11.37a4 4 0 1 1-7.88 1.26A4 4 0 0 1 16 11.37Z"></path>
                                      <path d="M17.5 6.5h.01"></path>
                                    </svg>
                                  </span>
                                {%- when 'heart' -%}
                                  <span class="q-social-grid__icon" aria-hidden="true">
                                    <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true" focusable="false">
                                      <path d="M20.8 4.6a5.5 5.5 0 0 0-7.8 0L12 5.6l-1-1a5.5 5.5 0 0 0-7.8 7.8l1 1L12 21.2l7.8-7.8 1-1a5.5 5.5 0 0 0 0-7.8Z"></path>
                                    </svg>
                                  </span>
                                {%- when 'play' -%}
                                  <span class="q-social-grid__icon" aria-hidden="true">
                                    <svg viewBox="0 0 24 24" width="18" height="18" fill="currentColor" aria-hidden="true" focusable="false">
                                      <path d="M8 5v14l11-7L8 5Z"></path>
                                    </svg>
                                  </span>
                                {%- else -%}
                              {%- endcase -%}

                              {%- if show_overlay_text -%}
                                <span class="q-social-grid__overlay-text">{{ overlay_text | escape }}</span>
                              {%- endif -%}
                            </span>
                          </span>
                        {%- endif -%}
                      </div>

                    {%- if has_link -%}
                      </a>
                    {%- else -%}
                      </div>
                    {%- endif -%}

                  {%- if show_caption -%}
                    <p class="q-social-grid__caption">{{ caption | escape }}</p>
                  {%- endif -%}
                </div>

              {%- elsif request.design_mode -%}
                <div class="q-social-grid__item q-social-grid__item--placeholder" role="listitem" {{ block.shopify_attributes }}>
                  <div class="q-social-grid__tile">
                    <div class="q-social-grid__media q-aspect--{{ ratio_class }}">
                      <div class="q-social-grid__placeholder">Select an image for this tile.</div>
                    </div>
                  </div>
                </div>
              {%- endif -%}
            {%- endif -%}
          {%- endfor -%}
        </div>
      {%- elsif request.design_mode -%}
        <div class="q-social-grid__empty">
          <p>Add “Instagram tile” blocks to build your grid.</p>
        </div>
      {%- endif -%}

    {%- else -%}
      {%- if request.design_mode -%}
        <div class="q-social-grid__empty">
          <p>Feed mode is enabled. Connect this section to a Quadratum Link feed (handle: {{ s.feed_handle | escape }}).</p>
        </div>
      {%- endif -%}
    {%- endif -%}
  </div>

  <style>
    #social-media-instagram-grid-{{ section.id }} { --qsg-radius: var(--q-radius-lg, 16px); }

    #social-media-instagram-grid-{{ section.id }} .q-social-grid__container {
      max-width: var(--q-container, 1152px);
      margin: 0 auto;
      padding-left: var(--q-pad-x, 16px);
      padding-right: var(--q-pad-x, 16px);
    }

    #social-media-instagram-grid-{{ section.id }} .q-social-grid__kicker { margin: 0; opacity: 0.85; font-size: 0.95em; }
    #social-media-instagram-grid-{{ section.id }} .q-social-grid__heading { margin: 0; }
    #social-media-instagram-grid-{{ section.id }} .q-social-grid__body { opacity: 0.9; }

    #social-media-instagram-grid-{{ section.id }} .q-social-grid__grid {
      display: grid;
      gap: var(--qsg-gap);
      grid-template-columns: repeat(var(--qsg-cols-m), minmax(0, 1fr));
      margin-top: 16px;
    }
    @media (min-width: 990px) {
      #social-media-instagram-grid-{{ section.id }} .q-social-grid__grid {
        grid-template-columns: repeat(var(--qsg-cols-d), minmax(0, 1fr));
      }
    }

    #social-media-instagram-grid-{{ section.id }} .q-social-grid__item { display: flex; flex-direction: column; gap: 10px; }

    #social-media-instagram-grid-{{ section.id }} .q-social-grid__tile {
      display: block;
      border-radius: var(--qsg-radius);
      overflow: hidden;
      text-decoration: none;
      color: inherit;
      outline: none;
    }
    #social-media-instagram-grid-{{ section.id }} .q-social-grid__tile:focus-visible {
      outline: 2px solid currentColor;
      outline-offset: 2px;
    }

    #social-media-instagram-grid-{{ section.id }}.q-social-grid--card-soft .q-social-grid__tile,
    #social-media-instagram-grid-{{ section.id }}.q-social-grid--card-elevated .q-social-grid__tile {
      background: color-mix(in srgb, var(--q-bg-contrast, #f6f7f8) 75%, transparent);
    }
    #social-media-instagram-grid-{{ section.id }}.q-social-grid--card-elevated .q-social-grid__tile {
      border: 1px solid color-mix(in srgb, currentColor 12%, transparent);
      box-shadow: 0 8px 24px color-mix(in srgb, #000 10%, transparent);
    }

    #social-media-instagram-grid-{{ section.id }} .q-social-grid__media {
      position: relative;
      width: 100%;
      background: color-mix(in srgb, currentColor 6%, transparent);
    }
    #social-media-instagram-grid-{{ section.id }} .q-aspect--1-1 { aspect-ratio: 1 / 1; }
    #social-media-instagram-grid-{{ section.id }} .q-aspect--4-5 { aspect-ratio: 4 / 5; }
    #social-media-instagram-grid-{{ section.id }} .q-aspect--3-4 { aspect-ratio: 3 / 4; }
    #social-media-instagram-grid-{{ section.id }} .q-aspect--16-9 { aspect-ratio: 16 / 9; }

    #social-media-instagram-grid-{{ section.id }} .q-social-grid__media img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
      transform: translateZ(0);
    }

    #social-media-instagram-grid-{{ section.id }} .q-social-grid__overlay {
      position: absolute;
      inset: 0;
      opacity: 0;
      transition: opacity 160ms ease;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    #social-media-instagram-grid-{{ section.id }}.q-social-grid--overlay-scrim .q-social-grid__overlay {
      background: linear-gradient(to top, color-mix(in srgb, #000 55%, transparent), color-mix(in srgb, #000 15%, transparent));
    }
    #social-media-instagram-grid-{{ section.id }}.q-social-grid--overlay-solid .q-social-grid__overlay {
      background: color-mix(in srgb, #000 55%, transparent);
    }

    #social-media-instagram-grid-{{ section.id }} .q-social-grid__tile:hover .q-social-grid__overlay,
    #social-media-instagram-grid-{{ section.id }} .q-social-grid__tile:focus-visible .q-social-grid__overlay {
      opacity: 1;
    }

    #social-media-instagram-grid-{{ section.id }} .q-social-grid__overlay-inner {
      color: var(--q-text-on-color, #ffffff);
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 10px 12px;
      border-radius: 999px;
      background: color-mix(in srgb, #000 30%, transparent);
      backdrop-filter: blur(6px);
    }

    #social-media-instagram-grid-{{ section.id }} .q-social-grid__overlay-text { font-size: 0.95em; }

    #social-media-instagram-grid-{{ section.id }} .q-social-grid__caption {
      margin: 0;
      opacity: 0.9;
      font-size: 0.95em;
      display: -webkit-box;
      -webkit-box-orient: vertical;
      -webkit-line-clamp: var(--qsg-caption-lines);
      overflow: hidden;
    }

    #social-media-instagram-grid-{{ section.id }} .q-social-grid__placeholder {
      position: absolute;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 14px;
      text-align: center;
      opacity: 0.8;
      font-size: 0.95em;
    }

    #social-media-instagram-grid-{{ section.id }} .q-social-grid__empty { margin-top: 14px; opacity: 0.85; }
  </style>
</section>
{%- endif -%}

{% schema %}
{
  "name": "Social media · IG Grid",
  "tag": "section",
  "class": "q-section q-social-grid q-social-grid--instagram",
  "settings": [
    {
      "type": "checkbox",
      "id": "enable_section",
      "label": "Enable section",
      "default": true
    },
    {
      "type": "text",
      "id": "kicker",
      "label": "Kicker",
      "default": "Instagram gallery"
    },
    {
      "type": "text",
      "id": "heading",
      "label": "Heading",
      "default": "See what we’re sharing on Instagram"
    },
    {
      "type": "textarea",
      "id": "body",
      "label": "Body text",
      "default": "Highlight your latest posts, behind-the-scenes moments, and UGC in a simple manual grid."
    },
    {
      "type": "select",
      "id": "align",
      "label": "Text alignment",
      "default": "center",
      "options": [
        { "value": "left", "label": "Left" },
        { "value": "center", "label": "Center" }
      ]
    },

    {
      "type": "header",
      "content": "Layout"
    },
    {
      "type": "range",
      "id": "max_columns_desktop",
      "label": "Columns on desktop",
      "min": 2,
      "max": 6,
      "step": 1,
      "default": 4
    },
    {
      "type": "range",
      "id": "max_columns_mobile",
      "label": "Columns on mobile",
      "min": 1,
      "max": 3,
      "step": 1,
      "default": 2
    },
    {
      "type": "range",
      "id": "gap",
      "label": "Grid gap (px)",
      "min": 0,
      "max": 32,
      "step": 2,
      "default": 12
    },
    {
      "type": "select",
      "id": "aspect_ratio",
      "label": "Tile aspect ratio",
      "default": "1:1",
      "options": [
        { "value": "1:1", "label": "Square (1:1)" },
        { "value": "4:5", "label": "Portrait (4:5)" },
        { "value": "3:4", "label": "Portrait (3:4)" },
        { "value": "16:9", "label": "Landscape (16:9)" }
      ]
    },
    {
      "type": "select",
      "id": "card_style",
      "label": "Card style",
      "default": "plain",
      "options": [
        { "value": "plain", "label": "No background" },
        { "value": "soft", "label": "Soft surface" },
        { "value": "elevated", "label": "Elevated card" }
      ]
    },

    {
      "type": "header",
      "content": "Captions & overlay"
    },
    {
      "type": "checkbox",
      "id": "show_captions",
      "label": "Show caption under image",
      "default": true
    },
    {
      "type": "range",
      "id": "caption_max_lines",
      "label": "Caption max lines",
      "min": 1,
      "max": 5,
      "step": 1,
      "default": 2
    },
    {
      "type": "select",
      "id": "hover_overlay_mode",
      "label": "Hover overlay mode",
      "default": "scrim",
      "options": [
        { "value": "none", "label": "None" },
        { "value": "scrim", "label": "Scrim (soft overlay)" },
        { "value": "solid", "label": "Solid overlay" }
      ]
    },
    {
      "type": "select",
      "id": "hover_overlay_icon",
      "label": "Overlay icon",
      "default": "instagram",
      "options": [
        { "value": "none", "label": "None" },
        { "value": "instagram", "label": "Instagram" },
        { "value": "heart", "label": "Heart" },
        { "value": "play", "label": "Play" }
      ]
    },
    {
      "type": "checkbox",
      "id": "open_in_new_tab",
      "label": "Open links in a new tab",
      "default": true
    },

    {
      "type": "header",
      "content": "Data source (Quadratum Link ready)"
    },
    {
      "type": "select",
      "id": "data_source_mode",
      "label": "Data source",
      "default": "manual",
      "options": [
        { "value": "manual", "label": "Manual tiles (theme editor)" },
        { "value": "feed", "label": "Feed (Quadratum Link, future)" }
      ]
    },
    {
      "type": "text",
      "id": "feed_handle",
      "label": "Feed handle (for Quadratum Link)",
      "default": "instagram_default"
    },

    {
      "type": "text",
      "id": "aria_label",
      "label": "ARIA label for section",
      "default": "Instagram style gallery"
    }
  ],
  "blocks": [
    {
      "type": "ig_tile",
      "name": "Instagram tile",
      "settings": [
        {
          "type": "image_picker",
          "id": "image",
          "label": "Image"
        },
        {
          "type": "text",
          "id": "alt_text",
          "label": "Image alt text",
          "default": "Instagram gallery image"
        },
        {
          "type": "textarea",
          "id": "caption",
          "label": "Caption",
          "default": "Caption (optional)"
        },
        {
          "type": "url",
          "id": "link_url",
          "label": "Link URL (optional)"
        },
        {
          "type": "text",
          "id": "link_aria_label",
          "label": "Link ARIA label",
          "default": "View this post on Instagram"
        },
        {
          "type": "text",
          "id": "overlay_label",
          "label": "Overlay text (optional)",
          "default": "View"
        }
      ]
    }
  ],
  "max_blocks": 24,
  "presets": [
    {
      "name": "Social Media - Instagram Grid",
      "category": "Social Media",
      "settings": {},
      "blocks": [
        { "type": "ig_tile" },
        { "type": "ig_tile" },
        { "type": "ig_tile" },
        { "type": "ig_tile" }
      ]
    }
  ]
}
{% endschema %}
