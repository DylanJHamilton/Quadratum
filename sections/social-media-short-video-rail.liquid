{%- liquid
  assign s = section.settings
  assign ratio_class = s.aspect_ratio | replace: ':', '-'
  assign rendered_count = 0
-%}

{%- if s.enable_section or request.design_mode -%}
<section
  class="q-section q-social-rail q-social-rail--{{ s.layout_variant }} q-social-rail--bg-{{ s.background_style }}"
  aria-label="{{ s.aria_label | escape }}"
  data-section-id="{{ section.id }}"
  style="--qsv-gap: {{ s.gap }}px; --qsv-rail-w: {{ s.rail_card_width }}px; --qsv-cols-m: {{ s.grid_cols_mobile }}; --qsv-cols-d: {{ s.grid_cols_desktop }}; --qsv-pt: {{ s.section_padding_top }}px; --qsv-pb: {{ s.section_padding_bottom }}px;"
>
  <div class="q-social-rail__container">
    {%- if s.kicker != blank or s.heading != blank or s.body != blank -%}
      <div class="q-section-header q-stack q-stack--gap-sm q-text-{{ s.align }}">
        {%- if s.kicker != blank -%}
          <p class="q-social-rail__kicker">{{ s.kicker | escape }}</p>
        {%- endif -%}

        {%- if s.heading != blank -%}
          <h2 class="q-social-rail__heading">{{ s.heading | escape }}</h2>
        {%- endif -%}

        {%- if s.body != blank -%}
          <div class="q-social-rail__body">{{ s.body | escape | newline_to_br }}</div>
        {%- endif -%}
      </div>
    {%- endif -%}

    {%- if s.layout_variant == 'grid' -%}
      <div class="q-social-rail__grid" role="list">
    {%- else -%}
      <div class="q-social-rail__rail" role="list">
    {%- endif -%}

      {%- for block in section.blocks limit: s.max_items -%}
        {%- if block.type == 'video_item' -%}
          {%- liquid
            assign b = block.settings
            assign url = b.video_url
            assign is_placeholder = false
            if url == 'https://www.example.com'
              assign is_placeholder = true
            endif
            assign iframe_title = b.label | default: 'Social video'
          -%}

          {%- if url != blank and is_placeholder == false -%}
            {%- assign rendered_count = rendered_count | plus: 1 -%}

            <div
              class="q-social-rail__item{% if s.card_style == 'elevated' %} q-social-rail__item--elevated{% endif %}"
              role="listitem"
              data-platform="{{ b.platform | escape }}"
              {{ block.shopify_attributes }}
            >
              <div class="q-social-rail__video q-aspect--{{ ratio_class }}">
                <iframe
                  src="{{ url | escape }}"
                  title="{{ iframe_title | escape }}"
                  loading="lazy"
                  allowfullscreen
                  referrerpolicy="strict-origin-when-cross-origin"
                  allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
                ></iframe>
              </div>

              {%- if s.show_labels -%}
                {%- if b.label != blank -%}
                  <p class="q-social-rail__label">{{ b.label | escape }}</p>
                {%- endif -%}
              {%- endif -%}

              {%- if s.show_cta -%}
                {%- if b.cta_label != blank -%}
                  <a
                    class="q-social-rail__cta"
                    href="{{ url | escape }}"
                    {%- if b.open_in_new_tab -%} target="_blank" rel="noopener noreferrer"{%- else -%} rel="noopener"{%- endif -%}
                    aria-label="{{ b.aria_label | default: b.cta_label | escape }}"
                  >
                    {{ b.cta_label | escape }}
                  </a>
                {%- endif -%}
              {%- endif -%}
            </div>

          {%- elsif request.design_mode -%}
            <div class="q-social-rail__item q-social-rail__item--placeholder" role="listitem" {{ block.shopify_attributes }}>
              <div class="q-social-rail__video q-aspect--{{ ratio_class }}">
                <div class="q-social-rail__placeholder">
                  Paste an iframe-compatible embed URL in this block to render a video.
                </div>
              </div>
              {%- if s.show_labels -%}
                <p class="q-social-rail__label">Short video</p>
              {%- endif -%}
              {%- if s.show_cta -%}
                <span class="q-social-rail__cta q-social-rail__cta--disabled">Watch now</span>
              {%- endif -%}
            </div>
          {%- endif -%}
        {%- endif -%}
      {%- endfor -%}

      </div>

    {%- if rendered_count == 0 and request.design_mode -%}
      <p class="q-social-rail__empty">
        Add “Video” blocks and paste iframe-compatible embed URLs (Reels/TikTok/Shorts). Placeholder URLs won’t render on the storefront.
      </p>
    {%- endif -%}

    {%- unless s.enable_section -%}
      {%- if request.design_mode -%}
        <p class="q-social-rail__disabled-note">This section is currently hidden (toggle “Show this section” to enable).</p>
      {%- endif -%}
    {%- endunless -%}
  </div>

  <style>
    .q-social-rail { padding-top: var(--qsv-pt); padding-bottom: var(--qsv-pb); }
    .q-social-rail__container { max-width: var(--q-container, 1152px); margin: 0 auto; padding-left: var(--q-pad-x, 16px); padding-right: var(--q-pad-x, 16px); }
    .q-social-rail--bg-default { background: transparent; }
    .q-social-rail--bg-contrast { background: var(--q-bg-contrast, #f6f7f8); }
    .q-social-rail--bg-subtle { background: color-mix(in srgb, var(--q-bg-contrast, #f6f7f8) 60%, transparent); }

    .q-social-rail__kicker { margin: 0; opacity: 0.85; font-size: 0.95em; }
    .q-social-rail__heading { margin: 0; }
    .q-social-rail__body { opacity: 0.9; }

    .q-social-rail__rail {
      display: flex;
      gap: var(--qsv-gap);
      overflow-x: auto;
      padding: 6px 2px;
      scroll-snap-type: x mandatory;
      -webkit-overflow-scrolling: touch;
    }
    .q-social-rail__rail::-webkit-scrollbar { height: 10px; }
    .q-social-rail__rail::-webkit-scrollbar-thumb { background: color-mix(in srgb, currentColor 15%, transparent); border-radius: 999px; }

    .q-social-rail__grid {
      display: grid;
      gap: var(--qsv-gap);
      grid-template-columns: repeat(var(--qsv-cols-m), minmax(0, 1fr));
    }
    @media (min-width: 990px) {
      .q-social-rail__grid { grid-template-columns: repeat(var(--qsv-cols-d), minmax(0, 1fr)); }
    }

    .q-social-rail__item {
      scroll-snap-align: start;
      min-width: var(--qsv-rail-w);
      max-width: var(--qsv-rail-w);
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .q-social-rail--grid .q-social-rail__item {
      min-width: 0;
      max-width: none;
    }

    .q-social-rail__item--elevated {
      padding: 12px;
      border-radius: var(--q-radius-lg, 16px);
      background: var(--q-bg-base, #ffffff);
      border: 1px solid color-mix(in srgb, currentColor 12%, transparent);
    }

    .q-social-rail__video {
      width: 100%;
      border-radius: var(--q-radius-lg, 16px);
      overflow: hidden;
      background: color-mix(in srgb, currentColor 6%, transparent);
      position: relative;
    }
    .q-aspect--9-16 { aspect-ratio: 9 / 16; }
    .q-aspect--4-5 { aspect-ratio: 4 / 5; }
    .q-aspect--1-1 { aspect-ratio: 1 / 1; }
    .q-aspect--16-9 { aspect-ratio: 16 / 9; }

    .q-social-rail__video iframe {
      width: 100%;
      height: 100%;
      border: 0;
      display: block;
    }

    .q-social-rail__label { margin: 0; font-size: 0.95em; opacity: 0.9; }

    .q-social-rail__cta {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      text-decoration: none;
      width: fit-content;
      font: inherit;
      padding: 8px 10px;
      border-radius: var(--q-radius-md, 12px);
      border: 1px solid color-mix(in srgb, currentColor 16%, transparent);
      background: transparent;
    }
    .q-social-rail__cta:focus-visible {
      outline: 2px solid currentColor;
      outline-offset: 2px;
    }

    .q-social-rail__cta--disabled {
      opacity: 0.6;
      pointer-events: none;
    }

    .q-social-rail__placeholder {
      position: absolute;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 14px;
      text-align: center;
      font-size: 0.95em;
      opacity: 0.8;
    }

    .q-social-rail__empty,
    .q-social-rail__disabled-note { margin-top: 14px; opacity: 0.85; }
  </style>
{%- endif -%}
</section>

{% schema %}
{
  "name": "Social Media – Videos",
  "settings": [
    { "type": "header", "content": "Visibility" },
    { "type": "checkbox", "id": "enable_section", "label": "Show this section", "default": true },

    { "type": "header", "content": "Content" },
    { "type": "text", "id": "kicker", "label": "Kicker", "default": "Social video highlights" },
    { "type": "text", "id": "heading", "label": "Heading", "default": "See what we’re posting in short form" },
    { "type": "textarea", "id": "body", "label": "Description", "default": "Showcase your latest Reels, TikToks, and YouTube Shorts to build trust and community." },
    {
      "type": "select",
      "id": "align",
      "label": "Text alignment",
      "default": "center",
      "options": [
        { "value": "left", "label": "Left" },
        { "value": "center", "label": "Center" }
      ]
    },

    { "type": "header", "content": "Layout" },
    {
      "type": "select",
      "id": "layout_variant",
      "label": "Layout style",
      "default": "rail",
      "options": [
        { "value": "rail", "label": "Horizontal scroll rail" },
        { "value": "grid", "label": "Grid layout" }
      ]
    },
    { "type": "range", "id": "max_items", "label": "Max videos to show", "min": 1, "max": 12, "step": 1, "default": 6 },
    {
      "type": "select",
      "id": "aspect_ratio",
      "label": "Video aspect ratio",
      "default": "9:16",
      "options": [
        { "value": "9:16", "label": "Vertical (Reels / TikTok)" },
        { "value": "4:5", "label": "Portrait (4:5)" },
        { "value": "1:1", "label": "Square (1:1)" },
        { "value": "16:9", "label": "Wide (16:9)" }
      ]
    },
    {
      "type": "select",
      "id": "card_style",
      "label": "Card style",
      "default": "plain",
      "options": [
        { "value": "plain", "label": "No card background" },
        { "value": "elevated", "label": "Card with background & border" }
      ]
    },
    { "type": "checkbox", "id": "show_labels", "label": "Show video labels", "default": true },
    { "type": "checkbox", "id": "show_cta", "label": "Show video CTAs", "default": true },
    { "type": "text", "id": "aria_label", "label": "ARIA label for section", "default": "Short-form social video gallery" },

    { "type": "header", "content": "Spacing & Style" },
    {
      "type": "select",
      "id": "background_style",
      "label": "Background style",
      "default": "default",
      "options": [
        { "value": "default", "label": "Default" },
        { "value": "contrast", "label": "Contrast" },
        { "value": "subtle", "label": "Subtle" }
      ]
    },
    { "type": "range", "id": "gap", "label": "Gap (px)", "min": 8, "max": 32, "step": 1, "default": 16 },
    { "type": "range", "id": "rail_card_width", "label": "Rail card width (px)", "min": 200, "max": 420, "step": 10, "default": 280 },
    {
      "type": "select",
      "id": "grid_cols_mobile",
      "label": "Grid columns (mobile)",
      "default": "2",
      "options": [
        { "value": "1", "label": "1" },
        { "value": "2", "label": "2" }
      ]
    },
    {
      "type": "select",
      "id": "grid_cols_desktop",
      "label": "Grid columns (desktop)",
      "default": "3",
      "options": [
        { "value": "2", "label": "2" },
        { "value": "3", "label": "3" },
        { "value": "4", "label": "4" }
      ]
    },
    { "type": "range", "id": "section_padding_top", "label": "Section padding top (px)", "min": 0, "max": 120, "step": 4, "default": 48 },
    { "type": "range", "id": "section_padding_bottom", "label": "Section padding bottom (px)", "min": 0, "max": 120, "step": 4, "default": 48 }
  ],
  "blocks": [
    {
      "type": "video_item",
      "name": "Video",
      "settings": [
        {
          "type": "select",
          "id": "platform",
          "label": "Platform",
          "default": "instagram",
          "options": [
            { "value": "instagram", "label": "Instagram" },
            { "value": "tiktok", "label": "TikTok" },
            { "value": "youtube", "label": "YouTube" },
            { "value": "facebook", "label": "Facebook" },
            { "value": "pinterest", "label": "Pinterest" },
            { "value": "other", "label": "Other / generic" }
          ]
        },
        { "type": "url", "id": "video_url", "label": "Video embed URL" },
        { "type": "text", "id": "label", "label": "Label (optional)", "default": "Short video" },
        { "type": "text", "id": "cta_label", "label": "CTA label (optional)", "default": "Watch now" },
        { "type": "checkbox", "id": "open_in_new_tab", "label": "Open CTA in new tab", "default": true },
        { "type": "text", "id": "aria_label", "label": "ARIA label (optional)", "default": "Open social video in a new tab" }
      ]
    }
  ],
  "presets": [
    {
      "name": "Social Media – Short Video Rail",
      "category": "Social Media",
      "blocks": [
        { "type": "video_item" },
        { "type": "video_item" },
        { "type": "video_item" }
      ]
    }
  ]
}
{% endschema %}
