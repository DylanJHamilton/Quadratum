{% comment %}
  Quadratum — Form: Newsletter (Section)
  • Reuses shared engine:
      - snippets/form-dispatch.liquid (routing + hidden meta)
      - snippets/form-core.liquid (field/steps renderer)
  • Templates: Card / Split / Inline
  • Background media + overlay on ROOT
  • A11y, inline validation hooks, conditional logic
  • Tokenized CSS; mirrors other Forms sections (Support/Quote)
{% endcomment %}
{{ 'forms-sections.css' | asset_url | stylesheet_tag }}

{%- assign s = section.settings -%}
{%- assign g = settings -%}

{%- assign eff_captcha_mode = s.captcha_mode | default: g.forms_captcha_provider | default: 'none' -%}
{%- assign eff_captcha_key  = s.captcha_site_key | default: g.captcha_turnstile_site_key | default: g.captcha_recaptcha_site_key | default: '' -%}

{%- assign tags_theme   = g.forms_default_tags | default: 'form, web' -%}
{%- assign tags_section = s.hidden_tags | default: 'newsletter, web' -%}
{%- assign eff_tags = tags_theme -%}
{%- if tags_section != blank -%}{%- assign eff_tags = tags_theme | append: ', ' | append: tags_section -%}{%- endif -%}

{%- assign eff_endpoint = s.endpoint_url -%}
{%- if eff_endpoint == blank and s.destination == 'custom_endpoint' -%}
  {%- assign eff_endpoint = g.forms_global_endpoint | default: '' -%}
{%- endif -%}

{%- assign T_font_heading = settings.font_heading -%}
{%- assign C_primary      = settings.color_primary        | default: '#2563eb' -%}
{%- assign C_bg_base      = settings.bg_base              | default: '#ffffff' -%}
{%- assign C_bg_contrast  = settings.bg_contrast          | default: '#f6f7f8' -%}
{%- assign C_text_base    = settings.text_base            | default: '#111111' -%}
{%- assign C_text_muted   = settings.text_muted           | default: '#6b7280' -%}
{%- assign C_success      = settings.color_success        | default: '#16a34a' -%}
{%- assign C_error        = settings.color_error          | default: '#dc2626' -%}
{%- assign BTN_default    = settings.button_variant_default | default: 'solid' -%}
{%- assign BTN_radius     = settings.button_radius        | default: 12 -%}
{%- assign BTN_bw         = settings.button_border_width  | default: 1 -%}
{%- assign BTN_hover_op   = settings.button_hover_opacity | default: 92 -%}
{%- assign BTN_active     = settings.button_active_scale  | default: 98 -%}

{%- assign _btn_choice = s.button_variant | default: 'inherit' -%}
{%- assign _btn_variant = BTN_default -%}
{%- if _btn_choice != 'inherit' and _btn_choice != blank -%}{%- assign _btn_variant = _btn_choice -%}{%- endif -%}
{%- assign btn_mode_class = 'q-btn--solid' -%}
{%- if _btn_variant == 'outline' -%}{%- assign btn_mode_class = 'q-btn--outline' -%}{%- endif -%}
{%- if _btn_variant == 'ghost' -%}{%- assign btn_mode_class = 'q-btn--ghost' -%}{%- endif -%}

{%- assign visibility_classes = '' -%}
{%- if s.hide_on_mobile -%}{%- assign visibility_classes = visibility_classes | append: ' hidden md:block q-hide-mobile' -%}{%- endif -%}
{%- if s.hide_on_desktop -%}{%- assign visibility_classes = visibility_classes | append: ' md:hidden q-hide-desktop' -%}{%- endif -%}

{%- assign anchor = s.anchor_id -%}
{%- if anchor == blank -%}{%- assign anchor = 'section-' | append: section.id -%}{%- endif -%}

<style>
  #{{ section.id }}{
    --q-pad-y: {{ s.padding_y | default: 48 }}px;
    --q-pad-x: {{ s.padding_x | default: 24 }}px;
    --q-card-br: {{ s.card_radius | default: 16 }}px;
    --q-card-shadow: {{ s.card_shadow | default: 2 }};
    --q-text: {{ C_text_base }};
    --q-muted: {{ C_text_muted }};
    --q-bg: {{ s.bg_color | default: C_bg_contrast }};
    --q-btn-bg: {{ C_primary }};
    --q-btn-fg: {{ settings.text_on_color | default: '#ffffff' }};
    --q-btn-bdr: {{ C_text_base }};
    --q-btn-bw: {{ BTN_bw }}px;
    --q-btn-br: {{ BTN_radius }}px;
    --q-btn-hover-op: {{ BTN_hover_op }}%;
    --q-btn-active-scale: {{ BTN_active | divided_by: 100.0 }};

    --q-form-bg: {{ s.form_bg | default: C_bg_base }};
    --q-input-br: {{ s.input_radius | default: 10 }}px;
    --q-input-bdr: {{ s.input_border | default: '#e5e7eb' }};
  }
</style>

<section
  id="{{ anchor }}"
  class="q-form q-form--newsletter{{ visibility_classes }}"
  role="region"
  aria-label="{{ s.aria_label | default: 'Newsletter signup form' }}"
  data-template="{{ s.template_style }}"
  data-msg-error="{{ s.error_text | escape }}"
  data-captcha="{{ eff_captcha_mode }}"
  data-captcha-key="{{ eff_captcha_key | escape }}"
  data-btn-variant="{{ btn_mode_class }}"
>
  <div class="q-bleed">
    <div class="q-bg" aria-hidden="true">
      {%- assign vurl = s.bg_video | strip -%}
      {%- if vurl != blank -%}
        {%- assign is_yt = false -%}{%- assign is_vm = false -%}
        {%- if vurl contains 'youtube.com' or vurl contains 'youtu.be' -%}{%- assign is_yt = true -%}{%- endif -%}
        {%- if vurl contains 'vimeo.com' -%}{%- assign is_vm = true -%}{%- endif -%}
        {%- if is_yt -%}
          {%- assign yid = vurl
            | replace: 'https://youtu.be/','' | replace: 'http://youtu.be/',''
            | replace: 'https://www.youtube.com/watch?v=','' | replace: 'http://www.youtube.com/watch?v=',''
            | replace: 'https://youtube.com/watch?v=','' | replace: 'http://youtube.com/watch?v=',''
            | split:'?' | first -%}
          <iframe class="q-media" src="https://www.youtube.com/embed/{{ yid }}?autoplay=1&mute=1&controls=0&playsinline=1&loop=1&playlist={{ yid }}&modestbranding=1&rel=0" title="" tabindex="-1" allow="autoplay; encrypted-media"></iframe>
        {%- elsif is_vm -%}
          {%- assign vid = vurl | split:'/' | last | split:'?' | first -%}
          <iframe class="q-media" src="https://player.vimeo.com/video/{{ vid }}?background=1&autoplay=1&muted=1&loop=1&autopause=0&controls=0" title="" tabindex="-1" allow="autoplay; fullscreen; picture-in-picture"></iframe>
        {%- else -%}
          <video class="q-media" autoplay loop muted playsinline preload="none">
            <source src="{{ vurl | escape }}" type="video/mp4">
          </video>
        {%- endif -%}
      {%- elsif s.bg_image != blank -%}
        {{ s.bg_image | image_url: width: 2880 | image_tag: widths: '960,1440,1920,2560,2880', sizes: '100vw', loading: 'lazy', class: 'q-media', decoding: 'async', alt: '' }}
      {%- else -%}
        <div class="q-media" style="background: var(--q-bg);"></div>
      {%- endif -%}

      {%- if s.overlay_type == 'gradient' -%}
        {%- assign g1c = s.grad_start | default: '#000000' -%}
        {%- assign g2c = s.grad_end   | default: '#000000' -%}
        {%- assign g1o = s.grad_start_opacity | default: 40 | divided_by: 100.0 -%}
        {%- assign g2o = s.grad_end_opacity   | default: 0  | divided_by: 100.0 -%}
        <div class="q-overlay" style="background: linear-gradient({{ s.grad_angle | default: 180 }}deg, {{ g1c | color_modify: 'alpha', g1o }}, {{ g2c | color_modify: 'alpha', g2o }});"></div>
      {%- elsif s.overlay_type == 'solid' -%}
        <div class="q-overlay" style="background-color: {{ s.overlay_color | default: '#000000' }}; opacity: {{ s.overlay_opacity | default: 35 | divided_by: 100.0 }};"></div>
      {%- endif -%}
    </div>

    <div class="q-layer">
      <div class="q-wrap">
        {%- assign is_split_left = false -%}
        {%- assign is_split_right = false -%}
        {%- if s.template_style == 'split' and s.split_media_side == 'left' -%}{%- assign is_split_left = true -%}{%- endif -%}
        {%- if s.template_style == 'split' and s.split_media_side == 'right' -%}{%- assign is_split_right = true -%}{%- endif -%}

        <div class="q-grid{% if is_split_left %} split-left{% endif %}{% if is_split_right %} split-right{% endif %}">

          {%- if s.template_style == 'split' and s.split_image != blank and s.split_media_side == 'left' -%}
            <div class="q-media-card">
              {{ s.split_image | image_url: width: 1600 | image_tag: widths: '800,1200,1600', sizes: '(min-width:768px) 50vw, 100vw', loading: 'lazy', class: 'q-media', decoding: 'async', alt: '' }}
            </div>
          {%- endif -%}

          {%- if s.template_style == 'inline' -%}
            {%- comment -%} Inline (frameless): render engine only, no header/card {%- endcomment -%}
            {% render 'form-dispatch',
              id: section.id,
              settings: section.settings,
              blocks: section.blocks,
              eff_captcha_mode: eff_captcha_mode,
              eff_captcha_key:  eff_captcha_key,
              eff_endpoint_url: eff_endpoint,
              eff_tags:         eff_tags
            %}
          {%- else -%}
            <div class="q-card" data-q-form-card>
              <header class="q-head">
                {%- if s.kicker != blank -%}<p class="q-kicker">{{ s.kicker }}</p>{%- endif -%}
                {%- assign htag = s.heading_level | default: 'h2' -%}
                {%- if s.heading != blank -%}{%- if htag == 'h3' -%}<h3 class="q-heading">{{ s.heading }}</h3>{%- else -%}<h2 class="q-heading">{{ s.heading }}</h2>{%- endif -%}{%- endif -%}
                {%- if s.subheading != blank -%}<p class="q-sub">{{ s.subheading }}</p>{%- endif -%}
              </header>

              {% render 'form-dispatch',
                id: section.id,
                settings: section.settings,
                blocks: section.blocks,
                eff_captcha_mode: eff_captcha_mode,
                eff_captcha_key:  eff_captcha_key,
                eff_endpoint_url: eff_endpoint,
                eff_tags:         eff_tags
              %}
            </div>
          {%- endif -%}

          {%- if s.template_style == 'split' and s.split_image != blank and s.split_media_side == 'right' -%}
            <div class="q-media-card">
              {{ s.split_image | image_url: width: 1600 | image_tag: widths: '800,1200,1600', sizes: '(min-width:768px) 50vw, 100vw', loading: 'lazy', class: 'q-media', decoding: 'async', alt: '' }}
            </div>
          {%- endif -%}
        </div>
      </div>
    </div>
  </div>

  {%- if eff_captcha_mode == 'turnstile' and eff_captcha_key != blank -%}
    <script src="https://challenges.cloudflare.com/turnstile/v0/api.js" defer></script>
  {%- endif -%}
  {%- if eff_captcha_mode == 'recaptcha_v3' and eff_captcha_key != blank -%}
    <script src="https://www.google.com/recaptcha/api.js?render={{ eff_captcha_key | escape }}"></script>
  {%- endif -%}

  {{ 'frontend-form-logic-form-sections.js' | asset_url | script_tag }}
</section>

{% schema %}
{
  "name": "Form – Newsletter",
  "tag": "section",
  "class": "q-form q-form--newsletter",
  "settings": [
    { "type": "text", "id": "aria_label", "label": "ARIA label", "default": "Newsletter signup form" },

    { "type": "header", "content": "Layout" },
    { "type": "select", "id": "template_style", "label": "Template", "default": "card", "options": [
      { "value": "card", "label": "Card (incentive)" },
      { "value": "split", "label": "Split (hero)" },
      { "value": "inline", "label": "Inline (bar)" }
    ]},
    { "type": "select", "id": "split_media_side", "label": "Split: media position", "default": "left", "options": [
      { "value": "left", "label": "Media left" },
      { "value": "right", "label": "Media right" }
    ]},
    { "type": "image_picker", "id": "split_image", "label": "Split: image" },
    { "type": "text", "id": "anchor_id", "label": "Optional anchor ID" },

    { "type": "header", "content": "Background (root)" },
    { "type": "image_picker", "id": "bg_image", "label": "Background image" },
    { "type": "text", "id": "bg_video", "label": "Background video URL (MP4, YouTube, Vimeo)" },
    { "type": "color", "id": "bg_color", "label": "Background color", "default": "#f6f7f8" },
    { "type": "select", "id": "overlay_type", "label": "Overlay", "default": "solid", "options": [
      { "value": "none", "label": "None" },
      { "value": "solid", "label": "Solid" },
      { "value": "gradient", "label": "Gradient" }
    ]},
    { "type": "color", "id": "overlay_color", "label": "Overlay color", "default": "#000000" },
    { "type": "range", "id": "overlay_opacity", "label": "Overlay opacity", "min": 0, "max": 100, "step": 5, "default": 35, "unit": "%" },
    { "type": "color", "id": "grad_start", "label": "Gradient start", "default": "#000000" },
    { "type": "range", "id": "grad_start_opacity", "label": "Start opacity", "min": 0, "max": 100, "step": 5, "default": 40, "unit": "%" },
    { "type": "color", "id": "grad_end", "label": "Gradient end", "default": "#000000" },
    { "type": "range", "id": "grad_end_opacity", "label": "End opacity", "min": 0, "max": 100, "step": 5, "default": 0, "unit": "%" },
    { "type": "range", "id": "grad_angle", "label": "Gradient angle", "min": 0, "max": 360, "step": 5, "default": 180, "unit": "deg" },

    { "type": "header", "content": "Content" },
    { "type": "text", "id": "kicker", "label": "Accent (kicker)", "default": "Join the list" },
    { "type": "text", "id": "heading", "label": "Heading", "default": "Join & get updates" },
    { "type": "select", "id": "heading_level", "label": "Heading level", "default": "h2", "options": [
      { "value": "h2", "label": "H2" },
      { "value": "h3", "label": "H3" }
    ]},
    { "type": "textarea", "id": "subheading", "label": "Subheading", "default": "Be first to hear about new arrivals, sales, and exclusives." },
    { "type": "text", "id": "success_text", "label": "Success message", "default": "Thanks! Check your inbox to confirm." },
    { "type": "text", "id": "error_text", "label": "Error message", "default": "Please fix the highlighted fields and try again." },

    { "type": "header", "content": "Form routing" },
    { "type": "select", "id": "destination", "label": "Destination", "default": "shopify_customer", "options": [
      { "value": "shopify_customer", "label": "Shopify Customer (accepts_marketing)" },
      { "value": "custom_endpoint", "label": "Custom endpoint (POST)" }
    ]},
    { "type": "url", "id": "endpoint_url", "label": "Custom endpoint URL (HTTPS)" },
    { "type": "text", "id": "hidden_tags", "label": "Hidden tags/params (comma-separated)", "default": "newsletter, web" },

    { "type": "header", "content": "CAPTCHA" },
    { "type": "select", "id": "captcha_mode", "label": "Captcha provider", "default": "none", "options": [
      { "value": "none", "label": "None" },
      { "value": "turnstile", "label": "Cloudflare Turnstile" },
      { "value": "recaptcha_v3", "label": "reCAPTCHA v3" }
    ]},
    { "type": "text", "id": "captcha_site_key", "label": "Captcha site key" },

    { "type": "header", "content": "Button" },
    { "type": "text", "id": "button_label", "label": "Button label", "default": "Subscribe" },
    { "type": "select", "id": "button_variant", "label": "Variant", "default": "inherit", "options": [
      { "value": "inherit", "label": "— Theme default —" },
      { "value": "solid", "label": "Solid" },
      { "value": "outline", "label": "Outline" },
      { "value": "ghost", "label": "Ghost" }
    ]},

    { "type": "header", "content": "Form UI" },
    { "type": "color", "id": "form_bg", "label": "Form background", "default": "#ffffff" },
    { "type": "range", "id": "input_radius", "label": "Input radius", "min": 0, "max": 20, "step": 1, "default": 10 },
    { "type": "color", "id": "input_border", "label": "Input border color", "default": "#e5e7eb" },

    { "type": "header", "content": "Sizing & spacing" },
    { "type": "select", "id": "container_mode", "label": "Container", "default": "contained", "options": [
      { "value": "contained", "label": "Contained" },
      { "value": "full", "label": "Full-bleed" }
    ]},
    { "type": "range", "id": "padding_y", "label": "Padding Y", "min": 0, "max": 160, "step": 8, "default": 48 },
    { "type": "range", "id": "padding_x", "label": "Padding X", "min": 0, "max": 120, "step": 8, "default": 24 },
    { "type": "range", "id": "card_radius", "label": "Card radius", "min": 0, "max": 32, "step": 1, "default": 16 },
    { "type": "range", "id": "card_shadow", "label": "Card elevation", "min": 0, "max": 3, "step": 1, "default": 2 },
    { "type": "checkbox", "id": "hide_on_mobile", "label": "Hide on mobile", "default": false },
    { "type": "checkbox", "id": "hide_on_desktop", "label": "Hide on desktop", "default": false }
  ],
  "blocks": [
    {
      "type": "field",
      "name": "Field",
      "settings": [
        { "type": "select", "id": "field_type", "label": "Type", "default": "email", "options": [
          { "value": "email", "label": "Email" },
          { "value": "text", "label": "Text" },
          { "value": "select", "label": "Select" },
          { "value": "checkbox", "label": "Checkbox" },
          { "value": "consent", "label": "Consent" },
          { "value": "hidden", "label": "Hidden" },
          { "value": "html", "label": "HTML content" }
        ]},
        { "type": "text", "id": "name_attr", "label": "Input name (custom endpoint mode)", "default": "email" },
        { "type": "text", "id": "label", "label": "Label" },
        { "type": "text", "id": "placeholder", "label": "Placeholder" },
        { "type": "checkbox", "id": "required", "label": "Required", "default": true },
        { "type": "textarea", "id": "help_text", "label": "Help text" },
        { "type": "text", "id": "default_value", "label": "Default/hidden value" },
        { "type": "textarea", "id": "options", "label": "Options (one per line, value|label)" },
        { "type": "select", "id": "width", "label": "Width", "default": "full", "options": [
          { "value": "half", "label": "1/2" },
          { "value": "full", "label": "Full" }
        ]},
        { "type": "checkbox", "id": "condition_enable", "label": "Show conditionally", "default": false },
        { "type": "text", "id": "condition_field", "label": "When field name equals…" },
        { "type": "text", "id": "condition_value", "label": "…this value (or 'checked')" },
        { "type": "select", "id": "condition_operator", "label": "Operator", "default": "equals", "options": [
          { "value": "equals", "label": "Equals" },
          { "value": "contains", "label": "Contains" },
          { "value": "checked", "label": "Checked" }
        ]},
        { "type": "richtext", "id": "html_content", "label": "HTML content (for HTML type)" }
      ]
    }
  ],
  "max_blocks": 20,
  "presets": [
    {
      "name": "Forms – Newsletter",
      "category": "Forms",
      "settings": {
        "template_style": "card",
        "kicker": "Join the list",
        "heading": "Join & get updates",
        "subheading": "Be first to hear about new arrivals, sales, and exclusives.",
        "destination": "shopify_customer",
        "button_label": "Subscribe"
      },
      "blocks": [
        { "type": "field", "settings": { "field_type": "email",   "name_attr": "contact[email]",              "label": "Email", "placeholder": "you@example.com", "required": true, "width": "full" } },
        { "type": "field", "settings": { "field_type": "text",    "name_attr": "contact[first_name]",         "label": "First name", "placeholder": "Jane", "required": false, "width": "half" } },
        { "type": "field", "settings": { "field_type": "consent", "name_attr": "contact[consent_marketing]",  "label": "I agree to receive marketing emails and understand I can unsubscribe anytime.", "required": true, "width": "full" } }
      ]
    },
    {
      "name": "Forms – Newsletter (Inline)",
      "category": "Forms",
      "settings": {
        "template_style": "inline",
        "kicker": "",
        "heading": "Stay in the loop",
        "subheading": "",
        "destination": "shopify_customer",
        "button_label": "Get updates"
      },
      "blocks": [
        { "type": "field", "settings": { "field_type": "email", "name_attr": "contact[email]", "label": "Email", "placeholder": "you@example.com", "required": true, "width": "full" } },
        { "type": "field", "settings": { "field_type": "consent", "name_attr": "contact[consent_marketing]", "label": "I agree to receive marketing emails.", "required": true, "width": "full" } }
      ]
    }
  ]
}
{% endschema %}
