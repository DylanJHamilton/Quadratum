{%- comment -%}
PRODUCT BUNDLES â€” HARD STABLE BUILD
This version uses PRODUCT HANDLES (not Shopify picker)
because your picker instance is returning NULL.

This WILL render.
{%- endcomment -%}

{% assign s = section.settings %}

{{ 'section-product-bundles.css' | asset_url | stylesheet_tag }}
<script src="{{ 'section-product-bundles.js' | asset_url }}" defer></script>

<section class="product-bundles">
  <div class="pb__inner">

    {% if s.title != blank %}
      <h2 class="pb__title">{{ s.title }}</h2>
    {% endif %}

    {% for block in section.blocks %}
      {% if block.type != 'bundle' %}{% continue %}{% endif %}

      {% assign handles = "" | split: "," %}
      {% assign handles = handles | push: block.settings.product_1 %}
      {% assign handles = handles | push: block.settings.product_2 %}
      {% assign handles = handles | push: block.settings.product_3 %}
      {% assign handles = handles | push: block.settings.product_4 %}
      {% assign handles = handles | push: block.settings.product_5 %}
      {% assign handles = handles | push: block.settings.product_6 %}

      {% assign products = "" | split: "," %}

      {% for h in handles %}
        {% if h == blank %}{% continue %}{% endif %}
        {% assign pr = all_products[h] %}
        {% if pr != blank %}
          {% assign products = products | push: pr %}
        {% endif %}
      {% endfor %}

      {% if products.size >= 2 %}
        {% assign total = 0 %}
        {% assign variant_ids = "" | split: "," %}

        <div class="pb__card">

          {% if block.settings.bundle_title != blank %}
            <h3>{{ block.settings.bundle_title }}</h3>
          {% endif %}

          <div class="pb__items">
            {% for pr in products %}
              {% assign v = pr.selected_or_first_available_variant %}
              {% assign total = total | plus: v.price %}
              {% assign variant_ids = variant_ids | push: v.id %}

              <div class="pb__item">
                <img src="{{ pr.featured_image | image_url: width: 120 }}">
                <div>
                  <div>{{ pr.title }}</div>
                  <div>{{ v.price | money }}</div>
                </div>
              </div>
            {% endfor %}
          </div>

          <div class="pb__total">
            Total: {{ total | money }}
          </div>

          <button
            class="pb__add"
            data-pb-add
            data-items="{{ variant_ids | join: ',' }}"
          >
            {{ s.button_label }}
          </button>

        </div>
      {% endif %}
    {% endfor %}

  </div>
</section>

{% schema %}
{
  "name": "Product bundles",
  "settings": [
    { "type": "text", "id": "title", "label": "Heading", "default": "Frequently bought together" },
    { "type": "text", "id": "button_label", "label": "Button label", "default": "Add bundle" }
  ],
  "blocks": [
    {
      "type": "bundle",
      "name": "Bundle",
      "settings": [
        { "type": "text", "id": "bundle_title", "label": "Bundle title" },

        { "type": "text", "id": "product_1", "label": "Product handle 1" },
        { "type": "text", "id": "product_2", "label": "Product handle 2" },
        { "type": "text", "id": "product_3", "label": "Product handle 3" },
        { "type": "text", "id": "product_4", "label": "Product handle 4" },
        { "type": "text", "id": "product_5", "label": "Product handle 5" },
        { "type": "text", "id": "product_6", "label": "Product handle 6" }
      ]
    }
  ],
  "presets": [
    { "name": "Product bundles" }
  ]
}
{% endschema %}
