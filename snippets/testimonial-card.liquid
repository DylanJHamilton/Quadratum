{%- comment -%}
  Quadratum — Testimonial Card Engine
  Variants: featured | compact | standard
  All visuals controlled by CSS vars forwarded by section(s).
{%- endcomment -%}

{%- liquid
  assign v = variant | default: 'standard'
  assign a = align | default: 'left'

  assign has_quote = false
  if quote != blank
    assign has_quote = true
  endif

  assign has_name = false
  if name != blank
    assign has_name = true
  endif

  assign has_role = false
  if role != blank
    assign has_role = true
  endif

  assign has_avatar = false
  if avatar != blank
    assign has_avatar = true
  endif

  assign has_rating = false
  if show_rating and rating and rating > 0
    assign has_rating = true
  endif

  assign has_badge = false
  if show_badge and platform != blank and platform != 'none'
    assign has_badge = true
  endif

  assign context_text = ''
  if show_context
    if association_product != blank
      assign context_text = 'Bought: ' | append: association_product.title
    elsif association_collection != blank
      assign context_text = 'Collection: ' | append: association_collection.title
    elsif service_label != blank
      assign context_text = 'Service: ' | append: service_label
    endif
  endif

  assign has_context = false
  if context_text != blank
    assign has_context = true
  endif

  assign has_featured = false
  if show_featured_product and featured_product != blank
    assign has_featured = true
  endif

  assign fp = featured_product
-%}

<figure class="q-tm q-tm--{{ v }} q-tm-align--{{ a }}">
  {%- if has_quote -%}
    <blockquote class="q-tm__quote">
      <span class="q-tm__quote-mark" aria-hidden="true">“</span>
      <span class="q-tm__quote-text">{{ quote }}</span>
    </blockquote>
  {%- endif -%}

  <figcaption class="q-tm__meta">
    {%- if has_avatar -%}
      <img
        class="q-tm__avatar"
        src="{{ avatar | image_url: width: 120 }}"
        alt="{% if has_name %}{{ name | escape }}{% else %}Customer{% endif %}"
        loading="lazy"
      >
    {%- endif -%}

    <div class="q-tm__byline">
      {%- if has_name -%}
        <span class="q-tm__name">{{ name | escape }}</span>
      {%- endif -%}
      {%- if has_role -%}
        <span class="q-tm__role">{{ role | escape }}</span>
      {%- endif -%}
    </div>

    {%- if has_rating -%}
      {%- assign rating_num = rating | plus: 0 -%}
      <div class="q-tm__rating" aria-label="{{ rating_num }} out of 5 stars">
        <div class="q-tm__stars" style="--q-rating: {{ rating_num }};">
          <span class="q-tm__stars-bg" aria-hidden="true">★★★★★</span>
          <span class="q-tm__stars-fg" aria-hidden="true">★★★★★</span>
        </div>
        <span class="q-tm__rating-num">{{ rating_num }}</span>
      </div>
    {%- endif -%}

    {%- if has_badge -%}
      <div class="q-tm__badge">
        {%- if platform == 'custom' and custom_badge_icon != blank -%}
          <img
            class="q-tm__badge-icon"
            src="{{ custom_badge_icon | image_url: width: 48 }}"
            alt=""
            loading="lazy"
          >
        {%- endif -%}

        <span class="q-tm__badge-text">
          {%- if platform == 'custom' -%}
            {{ custom_badge_label | default: 'Verified' | escape }}
          {%- else -%}
            {{ platform | capitalize }}
          {%- endif -%}
        </span>
      </div>
    {%- endif -%}

    {%- if has_context -%}
      <div class="q-tm__context">{{ context_text | escape }}</div>
    {%- endif -%}

    {%- if has_featured -%}
      <div class="q-tm__featured">
        <div class="q-tm__featured-line">
          <span class="q-tm__featured-label">Featured:</span>
          <a class="q-tm__featured-link" href="{{ fp.url }}">{{ fp.title | escape }}</a>
        </div>

        {%- if show_featured_product_preview -%}
          <a class="q-tm__fp" href="{{ fp.url }}">
            {%- if fp.featured_media != blank -%}
              <img
                class="q-tm__fp-media"
                src="{{ fp.featured_media | image_url: width: 220 }}"
                alt="{{ fp.title | escape }}"
                loading="lazy"
              >
            {%- endif -%}
            <div class="q-tm__fp-body">
              <div class="q-tm__fp-title">{{ fp.title | escape }}</div>
              <div class="q-tm__fp-price">
                {%- if fp.price_varies -%}
                  {{ fp.price_min | money }} – {{ fp.price_max | money }}
                {%- else -%}
                  {{ fp.price | money }}
                {%- endif -%}
              </div>
            </div>
          </a>
        {%- endif -%}
      </div>
    {%- endif -%}
  </figcaption>
</figure>

<style>
  .q-tm{
    background: var(--q-tm-surface, transparent);
    border: var(--q-tm-border-w, 1px) solid var(--q-tm-border, transparent);
    border-radius: var(--q-tm-radius, 16px);
    padding: 1.4em;
    box-shadow: 0 10px 30px rgba(0,0,0,var(--q-tm-shadow-strength, 0));
    color: var(--q-tm-text, currentColor);
  }
  .q-tm-align--center{ text-align: center; }
  .q-tm-align--center .q-tm__meta{ justify-content: center; }
  .q-tm-align--center .q-tm__byline{ align-items: center; }

  .q-tm__quote{
    margin: 0 0 1.1em;
    display: grid;
    grid-template-columns: auto 1fr;
    gap: .35em;
    align-items: start;
  }
  .q-tm__quote-mark{
    font-size: 2.2em;
    line-height: 1;
    color: var(--q-tm-accent, currentColor);
    opacity: .55;
    transform: translateY(-.05em);
  }
  .q-tm__quote-text{ display: inline; }

  .q-tm--featured .q-tm__quote-text{
    font-size: var(--q-tm-quote-fs-featured, 1.75rem);
    line-height: var(--q-tm-quote-lh-featured, 1.2);
  }
  .q-tm--compact .q-tm__quote-text{
    font-size: 1rem;
    line-height: 1.35;
  }

  .q-tm__meta{
    display: flex;
    align-items: center;
    gap: .75em;
    flex-wrap: wrap;
    color: var(--q-tm-muted, rgba(0,0,0,.65));
  }

  .q-tm__avatar{
    width: var(--q-tm-avatar, 44px);
    height: var(--q-tm-avatar, 44px);
    border-radius: var(--q-tm-avatar-radius, 999px);
    border: var(--q-tm-avatar-border-w, 1px) solid var(--q-tm-avatar-border, rgba(0,0,0,.12));
    object-fit: cover;
  }

  .q-tm__byline{
    display: flex;
    flex-direction: column;
    gap: .1em;
    min-width: 160px;
  }
  .q-tm__name{
    font-size: var(--q-tm-name-fs, 15px);
    font-weight: 650;
    color: var(--q-tm-text, currentColor);
    line-height: 1.1;
  }
  .q-tm__role{
    font-size: var(--q-tm-role-fs, 13px);
    line-height: 1.2;
  }

  .q-tm__rating{
    display: inline-flex;
    align-items: center;
    gap: .5em;
    margin-left: .2em;
  }

  .q-tm__stars{
    position: relative;
    font-size: var(--q-tm-star-size, 14px);
    letter-spacing: var(--q-tm-star-gap, 2px);
    line-height: 1;
    display: inline-block;
  }
  .q-tm__stars-bg{ color: var(--q-tm-star-muted, rgba(0,0,0,.12)); }
  .q-tm__stars-fg{
    position: absolute;
    inset: 0;
    width: calc((var(--q-rating, 0) / 5) * 100%);
    overflow: hidden;
    white-space: nowrap;
    color: var(--q-tm-star, currentColor);
  }
  .q-tm__rating-num{
    font-size: .9em;
    color: var(--q-tm-muted, rgba(0,0,0,.65));
  }

  .q-tm__badge{
    display: inline-flex;
    align-items: center;
    gap: .4em;
    border: 1px solid var(--q-tm-badge-border, rgba(0,0,0,.12));
    background: var(--q-tm-badge-bg, transparent);
    color: var(--q-tm-badge-text, currentColor);
    border-radius: var(--q-tm-badge-radius, 999px);
    padding: var(--q-tm-badge-pad-y, 4px) var(--q-tm-badge-pad-x, 10px);
    font-size: var(--q-tm-badge-fs, 12px);
    line-height: 1;
  }
  .q-tm__badge-icon{
    width: 16px;
    height: 16px;
    object-fit: contain;
  }

  .q-tm__context{
    width: 100%;
    margin-top: .25em;
    font-size: .92em;
    color: var(--q-tm-muted, rgba(0,0,0,.65));
  }

  .q-tm__featured{
    width: 100%;
    margin-top: .65em;
    display: grid;
    gap: .5em;
  }
  .q-tm__featured-line{
    display: flex;
    gap: .4em;
    flex-wrap: wrap;
    align-items: baseline;
    color: var(--q-tm-muted, rgba(0,0,0,.65));
  }
  .q-tm__featured-label{ opacity: .9; }
  .q-tm__featured-link{
    color: var(--q-tm-text, currentColor);
    text-decoration: underline;
    text-underline-offset: .18em;
  }

  .q-tm__fp{
    display: grid;
    grid-template-columns: auto 1fr;
    gap: .7em;
    align-items: center;
    text-decoration: none;
    border-radius: var(--q-tm-fp-radius, 14px);
    border: var(--q-tm-fp-border-w, 1px) solid var(--q-tm-fp-border, rgba(0,0,0,.12));
    padding: .65em;
    background: rgba(255,255,255,.0);
    color: inherit;
  }
  .q-tm__fp:hover{
    border-color: var(--q-tm-accent, currentColor);
  }
  .q-tm__fp-media{
    width: 64px;
    height: 64px;
    border-radius: 12px;
    object-fit: cover;
  }
  .q-tm__fp-title{
    font-weight: 650;
    line-height: 1.15;
    color: var(--q-tm-text, currentColor);
  }
  .q-tm__fp-price{
    color: var(--q-tm-muted, rgba(0,0,0,.65));
    font-size: .92em;
    margin-top: .15em;
  }
</style>
