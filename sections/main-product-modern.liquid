{%- comment -%}
  Quadratum — Main Product Modern (Standalone / No Snippet Dependencies) — Variant Two (Blocks)
  File: sections/main-product-modern-varianttwo.liquid

  PATCH (ROUTINE ONLY)
  1) Thumbnail selected state cleanup (no outline; border + subtle shadow)
  2) Per-block styling controls (text_color, font_size, font_weight, margin_bottom) for all key blocks
     - FIX: Ensure styling actually applies (override internal element font-size/weight that was blocking changes)
  3) Buy Buttons size option (small/medium/large) + CSS
  4) New qty_buy_combo block (Quantity + Buy Buttons)
  5) Accordion styling controls applied to <summary> (and spacing applied via wrapper)
  6) Buy button background color capability (buy_buttons + qty_buy_combo)

  KEEP:
  - Media behavior/settings unchanged.
  - JS expects IDs: QtmVariantId, QtmPrice, QtmCompare, QtmSkuWrap, QtmSku, QtmAvailText, QtmAtc, QtmQty, QtmQtyHidden.
{%- endcomment -%}

{%- liquid
  assign p = product
  if p == blank
    break
  endif

  assign s = section.settings

  assign current_variant = p.selected_or_first_available_variant
  if current_variant == blank
    assign current_variant = p.variants.first
  endif

  assign section_aria = s.section_aria_label
  if section_aria == blank
    assign section_aria = 'Product details'
  endif

  assign padding_top_mobile = s.padding_top | times: 0.75 | round: 0
  assign padding_bottom_mobile = s.padding_bottom | times: 0.75 | round: 0

  assign image_media_all = p.media | where: 'media_type', 'image'

  assign featured = p.selected_or_first_available_variant.featured_media | default: p.featured_media
  if featured == blank and image_media_all.first
    assign featured = image_media_all.first
  endif

  assign featured_src = ''
  if featured and featured.media_type == 'image'
    assign featured_src = featured | image_url: width: 1800
  endif

  comment
    Build list of variant media ids (for "hide other variant media").
    Best-effort: if multiple variants share the same image, it still counts.
  endcomment
  assign variant_media_ids_csv = ''
  for v in p.variants
    if v.featured_media
      assign variant_media_ids_csv = variant_media_ids_csv | append: v.featured_media.id | append: ','
    endif
  endfor
  assign variant_media_ids = variant_media_ids_csv | split: ','

  comment
    Build the "display" image list based on hide_variants.
    Always keep the featured image.
  endcomment
  assign image_media = '' | split: ''
  for m in image_media_all
    assign keep = true
    if s.hide_variants and variant_media_ids contains m.id
      if featured and m.id != featured.id
        assign keep = false
      endif
    endif
    if keep
      assign image_media = image_media | push: m
    endif
  endfor

  if image_media.size == 0
    assign image_media = image_media_all
  endif

  assign media_ratio = 0.55
  if s.media_size == 'large'
    assign media_ratio = 0.65
  elsif s.media_size == 'small'
    assign media_ratio = 0.45
  endif

  assign product_form_id = 'product-form-' | append: section.id

  comment
    Detect qty_buy_combo to avoid duplicate Quantity / Buy Buttons (same IDs).
  endcomment
  assign has_qty_buy_combo = false
  for b in section.blocks
    if b.type == 'qty_buy_combo'
      assign has_qty_buy_combo = true
      break
    endif
  endfor
-%}

<section
  id="MainProductModern-{{ section.id }}"
  class="qtm-modern section-{{ section.id }}-padding{% if s.media_position == 'right' %} qtm-modern--media-right{% else %} qtm-modern--media-left{% endif %}"
  aria-label="{{ section_aria | escape }}"
  data-section-id="{{ section.id }}"
  data-product-id="{{ p.id }}"
  data-gallery-layout="{{ s.gallery_layout }}"
  data-mobile-thumbnails="{{ s.mobile_thumbnails }}"
  data-media-fit="{{ s.media_fit }}"
  data-constrain="{{ s.constrain_to_viewport }}"
>
  <style>
    .section-{{ section.id }}-padding { padding-top: {{ padding_top_mobile }}px; padding-bottom: {{ padding_bottom_mobile }}px; }
    @media (min-width: 750px){
      .section-{{ section.id }}-padding { padding-top: {{ s.padding_top }}px; padding-bottom: {{ s.padding_bottom }}px; }
    }

    /* ========= Layout ========= */
    #MainProductModern-{{ section.id }} .qtm-modern__grid{
      display:grid;
      gap: 2.5rem;
      align-items:start;
    }

    @media (min-width: 990px){
      #MainProductModern-{{ section.id }} .qtm-modern__grid{
        grid-template-columns: {{ media_ratio }}fr {{ 1.0 | minus: media_ratio }}fr;
      }
      #MainProductModern-{{ section.id }}.qtm-modern--media-right .qtm-modern__media { order: 2; }
      #MainProductModern-{{ section.id }}.qtm-modern--media-right .qtm-modern__info { order: 1; }
      #MainProductModern-{{ section.id }} .qtm-modern__info.qtm-modern__info--sticky{
        position: sticky;
        top: 1.25rem;
      }
    }

    /* ========= Media base ========= */
    #MainProductModern-{{ section.id }} .qtm-modern__main-media{
      position:relative;
      border-radius: 14px;
      overflow:hidden;
      background: rgba(0,0,0,0.03);
    }
    #MainProductModern-{{ section.id }} .qtm-modern__main-media button{
      display:block;
      width:100%;
      border:0;
      padding:0;
      background:transparent;
      cursor: pointer;
    }
    #MainProductModern-{{ section.id }} .qtm-modern__main-media img{
      display:block;
      width:100%;
      height:auto;
    }

    /* Constrain to viewport (best-effort) */
    #MainProductModern-{{ section.id }}[data-constrain="true"] .qtm-modern__main-media{
      max-height: calc(100vh - 12rem);
    }
    #MainProductModern-{{ section.id }}[data-constrain="true"] .qtm-modern__main-media img{
      height: 100%;
      max-height: calc(100vh - 12rem);
      width: 100%;
    }

    /* Fit */
    #MainProductModern-{{ section.id }}[data-media-fit="fill"] .qtm-modern__main-media img{ object-fit: cover; }
    #MainProductModern-{{ section.id }}[data-media-fit="original"] .qtm-modern__main-media img{ object-fit: contain; }
    #MainProductModern-{{ section.id }}[data-media-fit="fill"][data-constrain="true"] .qtm-modern__main-media img{ object-fit: cover; }
    #MainProductModern-{{ section.id }}[data-media-fit="original"][data-constrain="true"] .qtm-modern__main-media img{ object-fit: contain; }

    /* Zoom button */
    #MainProductModern-{{ section.id }} .qtm-modern__zoom-btn{
      position:absolute;
      inset:auto 0 0 0;
      width:100%;
      background: rgba(0,0,0,0.55);
      color:#fff;
      border:0;
      padding: .85rem 1rem;
      cursor:pointer;
      font-weight:600;
      text-align:center;
    }

    /* ========= Thumbnails (PATCH: selected state cleanup) ========= */
    #MainProductModern-{{ section.id }} .qtm-modern__thumbs{
      display:flex;
      gap:.6rem;
      flex-wrap:wrap;
      margin-top:.75rem;
    }
    #MainProductModern-{{ section.id }} .qtm-modern__thumb{
      width:72px;
      height:72px;
      border-radius: 10px;
      overflow:hidden;
      border: 1px solid rgba(0,0,0,0.08);
      padding:0;
      background:#fff;
      cursor:pointer;
      transition: all .2s ease;
    }
    #MainProductModern-{{ section.id }} .qtm-modern__thumb[aria-current="true"]{
      border-color: currentColor;
      box-shadow: 0 0 0 1px currentColor;
    }
    #MainProductModern-{{ section.id }} .qtm-modern__thumb img{
      width:100%;
      height:100%;
      object-fit:cover;
      display:block;
    }

    /* Thumbnail placement variations */
    #MainProductModern-{{ section.id }} .qtm-modern__media-row{ display:block; }
    @media (min-width: 990px){
      #MainProductModern-{{ section.id }}[data-gallery-layout="thumbnails"] .qtm-modern__media-row{
        display:grid;
        grid-template-columns: 92px 1fr;
        gap: 1rem;
        align-items:start;
      }
      #MainProductModern-{{ section.id }}[data-gallery-layout="thumbnails"] .qtm-modern__thumbs{
        margin-top:0;
        flex-direction:column;
        flex-wrap:nowrap;
        max-height: calc(100vh - 14rem);
        overflow:auto;
        padding-right:.25rem;
      }
      #MainProductModern-{{ section.id }}[data-gallery-layout="thumbnails"] .qtm-modern__thumb{
        width: 84px;
        height: 84px;
      }
    }

    /* Mobile thumbnail modes */
    #MainProductModern-{{ section.id }}[data-mobile-thumbnails="hide"] .qtm-modern__thumbs{ display:none; }
    #MainProductModern-{{ section.id }}[data-mobile-thumbnails="columns"] .qtm-modern__thumbs{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:.6rem;
    }
    #MainProductModern-{{ section.id }}[data-mobile-thumbnails="columns"] .qtm-modern__thumb{
      width:100%;
      height: 92px;
    }

    /* Two columns gallery (media) */
    #MainProductModern-{{ section.id }} .qtm-modern__grid-gallery{
      display:grid;
      gap:.85rem;
    }
    #MainProductModern-{{ section.id }} .qtm-modern__grid-gallery button{
      border:0;
      padding:0;
      background:transparent;
      cursor:pointer;
      border-radius: 14px;
      overflow:hidden;
      background: rgba(0,0,0,0.03);
    }
    #MainProductModern-{{ section.id }} .qtm-modern__grid-gallery img{
      width:100%;
      height:auto;
      display:block;
    }
    #MainProductModern-{{ section.id }}[data-gallery-layout="columns"] .qtm-modern__grid-gallery{ grid-template-columns: 1fr 1fr; }
    @media (max-width: 749px){
      #MainProductModern-{{ section.id }}[data-gallery-layout="columns"] .qtm-modern__grid-gallery{ grid-template-columns: 1fr; }
    }

    /* Thumbnail carousel (simple horizontal scroll) */
    #MainProductModern-{{ section.id }} .qtm-modern__thumb-carousel{
      display:none;
      align-items:center;
      gap:.5rem;
      margin-top:.75rem;
    }
    #MainProductModern-{{ section.id }} .qtm-modern__thumb-rail{
      display:flex;
      gap:.6rem;
      overflow:auto;
      scroll-behavior:smooth;
      padding: .15rem .05rem;
    }
    #MainProductModern-{{ section.id }} .qtm-modern__thumb-rail::-webkit-scrollbar{ height: 8px; }
    #MainProductModern-{{ section.id }} .qtm-modern__thumb-nav{
      border:1px solid rgba(0,0,0,0.18);
      background: rgba(255,255,255,0.75);
      width:38px;
      height:38px;
      border-radius: 999px;
      cursor:pointer;
      font-weight:900;
    }
    #MainProductModern-{{ section.id }}[data-gallery-layout="thumbnail_carousel"] .qtm-modern__thumbs{ display:none; }
    #MainProductModern-{{ section.id }}[data-gallery-layout="thumbnail_carousel"] .qtm-modern__thumb-carousel{ display:flex; }

    /* ========= Info ========= */
    #MainProductModern-{{ section.id }} .qtm-modern__title{ margin: 0; }
    #MainProductModern-{{ section.id }} .qtm-modern__price{ display:flex; gap:.75rem; align-items:baseline; margin: 0; }
    #MainProductModern-{{ section.id }} .qtm-modern__compare{ text-decoration: line-through; opacity:.6; }
    #MainProductModern-{{ section.id }} .qtm-modern__current{ font-weight:700; font-size: 1.35rem; }
    #MainProductModern-{{ section.id }} .qtm-modern__meta{
      display:flex;
      flex-wrap:wrap;
      gap: .75rem 1.25rem;
      opacity: .85;
      font-size: .95rem;
      margin: 0;
    }

    /* Form spacing controlled per block */
    #MainProductModern-{{ section.id }} .qtm-modern__form{
      display:block;
      margin-top: 1rem;
    }

    #MainProductModern-{{ section.id }} .qtm-modern__option label{
      display:block;
      font-weight:600;
      margin-bottom:.35rem;
    }
    #MainProductModern-{{ section.id }} .qtm-modern__radios{
      display:flex;
      flex-wrap:wrap;
      gap:.5rem;
    }
    #MainProductModern-{{ section.id }} .qtm-modern__radios input{ position:absolute; opacity:0; pointer-events:none; }
    #MainProductModern-{{ section.id }} .qtm-modern__radios label{
      border: 1px solid rgba(0,0,0,0.18);
      border-radius: 999px;
      padding: .55rem .85rem;
      cursor:pointer;
      user-select:none;
      margin:0;
      font-weight:600;
      background:#fff;
    }
    #MainProductModern-{{ section.id }} .qtm-modern__radios input:checked + label{
      outline:2px solid currentColor;
      outline-offset:2px;
    }
    #MainProductModern-{{ section.id }} .qtm-modern__radios input:disabled + label{
      opacity:.45;
      cursor:not-allowed;
    }

    #MainProductModern-{{ section.id }} .qtm-modern__qty input{
      width: 110px;
      padding: .6rem .7rem;
    }

    #MainProductModern-{{ section.id }} .qtm-modern__atc{
      font-weight: 700;
      border:0;
      border-radius: 12px;
      cursor:pointer;
      width: 100%;
    }
    #MainProductModern-{{ section.id }} .qtm-modern__atc[disabled]{ opacity:.55; cursor:not-allowed; }

    /* Buy button size options (PATCH) */
    #MainProductModern-{{ section.id }} .qtm-btn--small{ padding: .6rem .9rem; font-size: 14px; }
    #MainProductModern-{{ section.id }} .qtm-btn--medium{ padding: 1rem 1.1rem; font-size: 16px; }
    #MainProductModern-{{ section.id }} .qtm-btn--large{ padding: 1.3rem 1.4rem; font-size: 18px; }

    /* Qty + Buy combo (PATCH) */
    #MainProductModern-{{ section.id }} .qtm-modern__qty-buy{
      display:flex;
      gap: 1rem;
      align-items: stretch;
    }
    #MainProductModern-{{ section.id }} .qtm-modern__qty-buy .qtm-modern__qty{
      flex: 0 0 auto;
    }
    #MainProductModern-{{ section.id }} .qtm-modern__qty-buy .qtm-modern__qty input{
      height: 100%;
    }
    #MainProductModern-{{ section.id }} .qtm-modern__qty-buy .qtm-modern__atc{
      flex: 1 1 auto;
    }

    /* ========= Per-block styling FIX (PATCH) =========
       Your inline wrapper styles were being overridden by element-level CSS (ex: .qtm-modern__current font-size).
       We standardize block styling via CSS variables and force the key elements to inherit them.
    */
    #MainProductModern-{{ section.id }} .qtm-block-style{
      --qtm-bc: #111111;
      --qtm-bfs: 18px;
      --qtm-bfw: 600;
      color: var(--qtm-bc);
      font-size: var(--qtm-bfs);
      font-weight: var(--qtm-bfw);
    }
    #MainProductModern-{{ section.id }} .qtm-block-style .qtm-modern__title{
      color: inherit;
      font-size: inherit;
      font-weight: inherit;
    }
    #MainProductModern-{{ section.id }} .qtm-block-style .qtm-modern__price{
      color: inherit;
      font-size: inherit;
      font-weight: inherit;
    }
    #MainProductModern-{{ section.id }} .qtm-block-style .qtm-modern__current{
      color: inherit;
      font-size: inherit;   /* overrides the old 1.35rem */
      font-weight: inherit; /* overrides the old 700 */
    }
    #MainProductModern-{{ section.id }} .qtm-block-style .qtm-modern__compare{
      color: inherit;
      font-size: inherit;
      font-weight: inherit;
    }
    #MainProductModern-{{ section.id }} .qtm-block-style .qtm-modern__meta{
      color: inherit;
      font-size: inherit;   /* overrides the old .95rem */
      font-weight: inherit;
      opacity: 0.85;        /* keep existing look */
    }
    #MainProductModern-{{ section.id }} .qtm-block-style .qtm-modern__option label{
      color: inherit;
      font-size: inherit;
      font-weight: inherit;
    }
    #MainProductModern-{{ section.id }} .qtm-block-style select{
      font-size: inherit;
      color: inherit;
    }
    #MainProductModern-{{ section.id }} .qtm-block-style .qtm-modern__radios label{
      font-size: inherit;
      color: inherit;
      font-weight: inherit;
    }
    #MainProductModern-{{ section.id }} .qtm-block-style .rte,
    #MainProductModern-{{ section.id }} .qtm-block-style .rte p,
    #MainProductModern-{{ section.id }} .qtm-block-style .rte li{
      color: inherit;
      font-size: inherit;
      font-weight: inherit;
    }

    /* ========= Accordion ========= */
    #MainProductModern-{{ section.id }} .qtm-modern__accordion{
      margin-top:1.25rem;
      display:grid;
      gap:.75rem;
    }
    #MainProductModern-{{ section.id }} .qtm-modern__accordion details{
      border: 1px solid rgba(0,0,0,0.12);
      border-radius: 12px;
      padding: .75rem 1rem;
      background: rgba(255,255,255,0.65);
    }
    #MainProductModern-{{ section.id }} .qtm-modern__accordion summary{
      cursor:pointer;
      list-style:none;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:1rem;
    }
    #MainProductModern-{{ section.id }} .qtm-modern__accordion summary::-webkit-details-marker{ display:none; }
    #MainProductModern-{{ section.id }} .qtm-modern__accordion .qtm-modern__accordion-content{ margin-top:.75rem; }

    /* ========= Modal ========= */
    #MainProductModern-{{ section.id }} dialog.qtm-modern__modal{
      width:min(980px, 96vw);
      border:0;
      border-radius: 14px;
      padding:0;
      overflow:hidden;
    }
    #MainProductModern-{{ section.id }} dialog.qtm-modern__modal::backdrop{ background: rgba(0,0,0,0.7); }
    #MainProductModern-{{ section.id }} .qtm-modern__modal-head{
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding: .75rem 1rem;
      background: rgba(0,0,0,0.85);
      color:#fff;
    }
    #MainProductModern-{{ section.id }} .qtm-modern__modal-close{
      border:0;
      background: transparent;
      color:#fff;
      font-size: 1.15rem;
      font-weight:800;
      cursor:pointer;
    }
    #MainProductModern-{{ section.id }} .qtm-modern__modal-body{ position:relative; background:#000; }
    #MainProductModern-{{ section.id }} .qtm-modern__modal-body img{ display:block; width:100%; height:auto; }
    #MainProductModern-{{ section.id }} .qtm-modern__modal-nav{
      position:absolute;
      inset:0;
      display:flex;
      justify-content:space-between;
      align-items:center;
      pointer-events:none;
      padding: 0 .5rem;
    }
    #MainProductModern-{{ section.id }} .qtm-modern__modal-nav button{
      pointer-events:auto;
      border:0;
      width:44px;
      height:44px;
      border-radius: 999px;
      background: rgba(255,255,255,0.18);
      color:#fff;
      font-weight:900;
      cursor:pointer;
    }
  </style>

  <div class="page-width">
    <div class="qtm-modern__grid">

      {%- comment -%} ================= MEDIA ================= {%- endcomment -%}
      <div class="qtm-modern__media">
        {%- if s.gallery_layout == 'columns' -%}
          <div class="qtm-modern__grid-gallery" aria-label="Product images grid">
            {%- for m in image_media -%}
              {%- assign full_src = m | image_url: width: 1800 -%}
              <button
                type="button"
                data-qtm-image="{{ full_src }}"
                data-qtm-index="{{ forloop.index0 }}"
                aria-label="Open image {{ forloop.index }}"
                {% if s.image_zoom != 'lightbox' %}data-qtm-no-modal="true"{% endif %}
              >
                <img src="{{ m | image_url: width: 1200 }}" alt="{{ m.alt | escape }}" loading="{% if forloop.first %}eager{% else %}lazy{% endif %}">
              </button>
            {%- endfor -%}
          </div>
        {%- else -%}
          <div class="qtm-modern__media-row">
            {%- if s.gallery_layout == 'thumbnails' -%}
              <div>
                {%- if image_media.size > 1 and s.mobile_thumbnails != 'hide' -%}
                  <div class="qtm-modern__thumbs" aria-label="Product thumbnails">
                    {%- for m in image_media -%}
                      {%- assign thumb_src = m | image_url: width: 240 -%}
                      {%- assign full_src = m | image_url: width: 1800 -%}
                      <button
                        type="button"
                        class="qtm-modern__thumb"
                        data-qtm-image="{{ full_src }}"
                        data-qtm-index="{{ forloop.index0 }}"
                        aria-current="{% if featured and m.id == featured.id %}true{% else %}false{% endif %}"
                      >
                        <img src="{{ thumb_src }}" alt="{{ m.alt | escape }}" loading="lazy">
                      </button>
                    {%- endfor -%}
                  </div>
                {%- endif -%}
              </div>
            {%- endif -%}

            <div>
              <div class="qtm-modern__main-media">
                <button
                  type="button"
                  data-qtm-open-main
                  aria-haspopup="dialog"
                  {% if s.image_zoom != 'lightbox' %}data-qtm-no-modal="true"{% endif %}
                >
                  <img
                    id="QtmMainImage-{{ section.id }}"
                    src="{{ featured_src }}"
                    alt="{{ featured.alt | escape }}"
                    loading="eager"
                  >
                </button>

                {%- if s.image_zoom == 'lightbox' -%}
                  <button
                    type="button"
                    class="qtm-modern__zoom-btn"
                    data-qtm-open-modal
                    aria-haspopup="dialog"
                  >
                    View larger
                  </button>
                {%- endif -%}
              </div>

              {%- if image_media.size > 1 and s.gallery_layout != 'thumbnails' -%}
                {%- if s.gallery_layout == 'thumbnail_carousel' -%}
                  <div class="qtm-modern__thumb-carousel" aria-label="Product thumbnails carousel">
                    <button type="button" class="qtm-modern__thumb-nav" data-qtm-thumb-prev aria-label="Previous thumbnails">‹</button>
                    <div class="qtm-modern__thumb-rail" data-qtm-thumb-rail>
                      {%- for m in image_media -%}
                        {%- assign thumb_src = m | image_url: width: 240 -%}
                        {%- assign full_src = m | image_url: width: 1800 -%}
                        <button
                          type="button"
                          class="qtm-modern__thumb"
                          data-qtm-image="{{ full_src }}"
                          data-qtm-index="{{ forloop.index0 }}"
                          aria-current="{% if featured and m.id == featured.id %}true{% else %}false{% endif %}"
                        >
                          <img src="{{ thumb_src }}" alt="{{ m.alt | escape }}" loading="lazy">
                        </button>
                      {%- endfor -%}
                    </div>
                    <button type="button" class="qtm-modern__thumb-nav" data-qtm-thumb-next aria-label="Next thumbnails">›</button>
                  </div>
                {%- else -%}
                  {%- if s.mobile_thumbnails != 'hide' -%}
                    <div class="qtm-modern__thumbs" aria-label="Product thumbnails">
                      {%- for m in image_media -%}
                        {%- assign thumb_src = m | image_url: width: 240 -%}
                        {%- assign full_src = m | image_url: width: 1800 -%}
                        <button
                          type="button"
                          class="qtm-modern__thumb"
                          data-qtm-image="{{ full_src }}"
                          data-qtm-index="{{ forloop.index0 }}"
                          aria-current="{% if featured and m.id == featured.id %}true{% else %}false{% endif %}"
                        >
                          <img src="{{ thumb_src }}" alt="{{ m.alt | escape }}" loading="lazy">
                        </button>
                      {%- endfor -%}
                    </div>
                  {%- endif -%}
                {%- endif -%}
              {%- endif -%}
            </div>
          </div>
        {%- endif -%}
      </div>

      {%- comment -%} ================= INFO (BLOCK-DRIVEN) ================= {%- endcomment -%}
      <div class="qtm-modern__info{% if s.enable_sticky_info %} qtm-modern__info--sticky{% endif %}">

        {%- comment -%} Render NON-FORM blocks first (title/price/status/description) {%- endcomment -%}
        {%- for block in section.blocks -%}
          {%- case block.type -%}

            {%- when 'title' -%}
              <div
                class="qtm-block-style"
                style="
                  --qtm-bc: {{ block.settings.text_color | default: '#111111' }};
                  --qtm-bfs: {{ block.settings.font_size | default: 18 }}px;
                  --qtm-bfw: {{ block.settings.font_weight | default: '600' }};
                  margin-bottom: {{ block.settings.margin_bottom | default: 16 }}px;
                "
                {{ block.shopify_attributes }}
              >
                <h1 class="qtm-modern__title">{{ p.title | escape }}</h1>
              </div>

            {%- when 'price' -%}
              <div
                class="qtm-block-style"
                style="
                  --qtm-bc: {{ block.settings.text_color | default: '#111111' }};
                  --qtm-bfs: {{ block.settings.font_size | default: 18 }}px;
                  --qtm-bfw: {{ block.settings.font_weight | default: '600' }};
                  margin-bottom: {{ block.settings.margin_bottom | default: 16 }}px;
                "
                {{ block.shopify_attributes }}
              >
                <div class="qtm-modern__price" id="QtmPriceWrap-{{ section.id }}">
                  <span
                    class="qtm-modern__compare"
                    id="QtmCompare-{{ section.id }}"
                    {% unless current_variant.compare_at_price > current_variant.price %}style="display:none"{% endunless %}
                  >
                    {{ current_variant.compare_at_price | money }}
                  </span>
                  <span class="qtm-modern__current" id="QtmPrice-{{ section.id }}">
                    {{ current_variant.price | money }}
                  </span>
                </div>
              </div>

            {%- when 'sku_status' -%}
              <div
                class="qtm-block-style"
                style="
                  --qtm-bc: {{ block.settings.text_color | default: '#111111' }};
                  --qtm-bfs: {{ block.settings.font_size | default: 18 }}px;
                  --qtm-bfw: {{ block.settings.font_weight | default: '600' }};
                  margin-bottom: {{ block.settings.margin_bottom | default: 16 }}px;
                "
                {{ block.shopify_attributes }}
              >
                <div class="qtm-modern__meta">
                  <span id="QtmSkuWrap-{{ section.id }}" {% if current_variant.sku == blank %}style="display:none"{% endif %}>
                    <strong>SKU:</strong> <span id="QtmSku-{{ section.id }}">{{ current_variant.sku }}</span>
                  </span>
                  <span id="QtmAvail-{{ section.id }}">
                    <strong>Status:</strong>
                    <span id="QtmAvailText-{{ section.id }}">
                      {% if current_variant.available %}In stock{% else %}Sold out{% endif %}
                    </span>
                  </span>
                </div>
              </div>

            {%- when 'description' -%}
              {%- assign mode = block.settings.mode | default: 'short' -%}
              {%- if mode != 'none' -%}
                <div
                  class="qtm-block-style"
                  style="
                    --qtm-bc: {{ block.settings.text_color | default: '#111111' }};
                    --qtm-bfs: {{ block.settings.font_size | default: 18 }}px;
                    --qtm-bfw: {{ block.settings.font_weight | default: '600' }};
                    margin-bottom: {{ block.settings.margin_bottom | default: 16 }}px;
                  "
                  {{ block.shopify_attributes }}
                >
                  <div class="rte">
                    {%- if mode == 'full' -%}
                      {{ p.description }}
                    {%- else -%}
                      {%- assign short_src = '' -%}
                      {%- assign key_raw = block.settings.short_metafield_key | strip -%}

                      {%- if key_raw != blank -%}
                        {%- assign parts = key_raw | split: '.' -%}
                        {%- assign ns = parts[0] | default: '' -%}
                        {%- assign k = parts[1] | default: '' -%}
                        {%- if ns != blank and k != blank -%}
                          {%- assign mf = p.metafields[ns][k] -%}
                          {%- if mf != blank -%}
                            {%- if mf.value != blank -%}
                              {%- assign short_src = mf.value -%}
                            {%- else -%}
                              {%- assign short_src = mf -%}
                            {%- endif -%}
                          {%- endif -%}
                        {%- endif -%}
                      {%- endif -%}

                      {%- if short_src != blank -%}
                        {{ short_src }}
                      {%- else -%}
                        {{ p.description | strip_html | truncate: 200 }}
                      {%- endif -%}
                    {%- endif -%}
                  </div>
                </div>
              {%- endif -%}

          {%- endcase -%}
        {%- endfor -%}

        {%- comment -%} Single product form wrapper; FORM blocks render inside {%- endcomment -%}
        <form
          id="{{ product_form_id }}"
          class="qtm-modern__form"
          method="post"
          action="{{ routes.cart_add_url }}"
          enctype="multipart/form-data"
        >
          <input type="hidden" name="id" id="QtmVariantId-{{ section.id }}" value="{{ current_variant.id }}">
          <input type="hidden" name="quantity" id="QtmQtyHidden-{{ section.id }}" value="1">

          {%- for block in section.blocks -%}
            {%- case block.type -%}

              {%- when 'variant_picker' -%}
                {%- unless p.has_only_default_variant -%}
                  <div
                    class="qtm-block-style"
                    style="
                      --qtm-bc: {{ block.settings.text_color | default: '#111111' }};
                      --qtm-bfs: {{ block.settings.font_size | default: 18 }}px;
                      --qtm-bfw: {{ block.settings.font_weight | default: '600' }};
                      margin-bottom: {{ block.settings.margin_bottom | default: 16 }}px;
                    "
                    {{ block.shopify_attributes }}
                  >
                    {%- for option in p.options_with_values -%}
                      <div class="qtm-modern__option" data-qtm-option data-index="{{ option.position }}">
                        <label>{{ option.name | escape }}</label>

                        {%- if block.settings.picker == 'dropdown' -%}
                          <select name="qtm-option-{{ option.position }}">
                            {%- for value in option.values -%}
                              <option value="{{ value | escape }}" {% if value.selected %}selected{% endif %}>
                                {{ value }}
                              </option>
                            {%- endfor -%}
                          </select>
                        {%- else -%}
                          <div class="qtm-modern__radios" role="radiogroup" aria-label="{{ option.name | escape }}">
                            {%- for value in option.values -%}
                              {%- capture input_id -%}QtmOpt-{{ section.id }}-{{ option.position }}-{{ forloop.index0 }}{%- endcapture -%}
                              <input
                                type="radio"
                                id="{{ input_id }}"
                                name="qtm-option-{{ option.position }}"
                                value="{{ value | escape }}"
                                {% if value.selected %}checked{% endif %}
                              >
                              <label for="{{ input_id }}">{{ value }}</label>
                            {%- endfor -%}
                          </div>
                        {%- endif -%}
                      </div>
                    {%- endfor -%}
                  </div>
                {%- endunless -%}

              {%- when 'qty_buy_combo' -%}
                <div
                  class="qtm-block-style"
                  style="
                    --qtm-bc: {{ block.settings.text_color | default: '#111111' }};
                    --qtm-bfs: {{ block.settings.font_size | default: 18 }}px;
                    --qtm-bfw: {{ block.settings.font_weight | default: '600' }};
                    margin-bottom: {{ block.settings.margin_bottom | default: 16 }}px;
                  "
                  {{ block.shopify_attributes }}
                >
                  <div class="qtm-modern__qty-buy">
                    <div class="qtm-modern__qty">
                      <label for="QtmQty-{{ section.id }}">Quantity</label>
                      <input id="QtmQty-{{ section.id }}" type="number" min="1" value="1">
                    </div>

                    <button
                      type="submit"
                      class="qtm-modern__atc qtm-btn--{{ block.settings.button_size | default: 'medium' }}"
                      id="QtmAtc-{{ section.id }}"
                      style="
                        background: {{ block.settings.button_background | default: '#111111' }};
                        color: {{ block.settings.button_text_color | default: '#ffffff' }};
                      "
                      {% unless current_variant.available %}disabled{% endunless %}
                    >
                      {% if current_variant.available %}Add to cart{% else %}Sold out{% endif %}
                    </button>
                  </div>

                  {%- if block.settings.show_dynamic_checkout -%}
                    <div style="margin-top: .75rem;">
                      {%- form 'product', p, id: 'QtmDyn-' | append: section.id -%}
                        <input type="hidden" name="id" value="{{ current_variant.id }}">
                        {{ form | payment_button }}
                      {%- endform -%}
                    </div>
                  {%- endif -%}
                </div>

              {%- when 'quantity' -%}
                {%- unless has_qty_buy_combo -%}
                  <div
                    class="qtm-block-style"
                    style="
                      --qtm-bc: {{ block.settings.text_color | default: '#111111' }};
                      --qtm-bfs: {{ block.settings.font_size | default: 18 }}px;
                      --qtm-bfw: {{ block.settings.font_weight | default: '600' }};
                      margin-bottom: {{ block.settings.margin_bottom | default: 16 }}px;
                    "
                    {{ block.shopify_attributes }}
                  >
                    <div class="qtm-modern__qty">
                      <label for="QtmQty-{{ section.id }}">Quantity</label>
                      <input id="QtmQty-{{ section.id }}" type="number" min="1" value="1">
                    </div>
                  </div>
                {%- endunless -%}

              {%- when 'buy_buttons' -%}
                {%- unless has_qty_buy_combo -%}
                  <div
                    class="qtm-block-style"
                    style="
                      --qtm-bc: {{ block.settings.text_color | default: '#111111' }};
                      --qtm-bfs: {{ block.settings.font_size | default: 18 }}px;
                      --qtm-bfw: {{ block.settings.font_weight | default: '600' }};
                      margin-bottom: {{ block.settings.margin_bottom | default: 16 }}px;
                    "
                    {{ block.shopify_attributes }}
                  >
                    <button
                      type="submit"
                      class="qtm-modern__atc qtm-btn--{{ block.settings.button_size | default: 'medium' }}"
                      id="QtmAtc-{{ section.id }}"
                      style="
                        background: {{ block.settings.button_background | default: '#111111' }};
                        color: {{ block.settings.button_text_color | default: '#ffffff' }};
                      "
                      {% unless current_variant.available %}disabled{% endunless %}
                    >
                      {% if current_variant.available %}Add to cart{% else %}Sold out{% endif %}
                    </button>

                    {%- if block.settings.show_dynamic_checkout -%}
                      <div style="margin-top: .75rem;">
                        {%- form 'product', p, id: 'QtmDyn-' | append: section.id -%}
                          <input type="hidden" name="id" value="{{ current_variant.id }}">
                          {{ form | payment_button }}
                        {%- endform -%}
                      </div>
                    {%- endif -%}
                  </div>
                {%- endunless -%}

            {%- endcase -%}
          {%- endfor -%}
        </form>

        {%- comment -%} Accordion blocks area {%- endcomment -%}
        {%- assign has_accordion = false -%}
        {%- for b in section.blocks -%}
          {%- if b.type contains 'accordion_' -%}
            {%- assign has_accordion = true -%}
          {%- endif -%}
        {%- endfor -%}

        {%- if has_accordion -%}
          <div class="qtm-modern__accordion">
            {%- for block in section.blocks -%}
              {%- case block.type -%}

                {%- when 'accordion_description' -%}
                  <div style="margin-bottom: {{ block.settings.margin_bottom | default: 16 }}px;">
                    <details {% if block.settings.open_by_default %}open{% endif %} {{ block.shopify_attributes }}>
                      <summary
                        class="qtm-block-style"
                        style="
                          --qtm-bc: {{ block.settings.text_color | default: '#111111' }};
                          --qtm-bfs: {{ block.settings.font_size | default: 18 }}px;
                          --qtm-bfw: {{ block.settings.font_weight | default: '600' }};
                        "
                      >
                        <span>{{ block.settings.title | default: 'Product description' | escape }}</span>
                        <span aria-hidden="true">+</span>
                      </summary>
                      <div class="qtm-modern__accordion-content rte">
                        {{ p.description }}
                      </div>
                    </details>
                  </div>

                {%- when 'accordion_reviews' -%}
                  <div style="margin-bottom: {{ block.settings.margin_bottom | default: 16 }}px;">
                    <details {% if block.settings.open_by_default %}open{% endif %} {{ block.shopify_attributes }}>
                      <summary
                        class="qtm-block-style"
                        style="
                          --qtm-bc: {{ block.settings.text_color | default: '#111111' }};
                          --qtm-bfs: {{ block.settings.font_size | default: 18 }}px;
                          --qtm-bfw: {{ block.settings.font_weight | default: '600' }};
                        "
                      >
                        <span>{{ block.settings.title | default: 'Reviews' | escape }}</span>
                        <span aria-hidden="true">+</span>
                      </summary>
                      <div class="qtm-modern__accordion-content rte">
                        <p>{{ block.settings.placeholder_text | default: 'Add your reviews app block elsewhere on the product template, or paste embed code into a Custom liquid accordion.' }}</p>
                      </div>
                    </details>
                  </div>

                {%- when 'accordion_metafield' -%}
                  {%- assign mf_out = '' -%}
                  {%- assign key_raw = block.settings.metafield_key | strip -%}
                  {%- if key_raw != blank -%}
                    {%- assign parts = key_raw | split: '.' -%}
                    {%- assign ns = parts[0] | default: '' -%}
                    {%- assign k = parts[1] | default: '' -%}
                    {%- if ns != blank and k != blank -%}
                      {%- assign mf = p.metafields[ns][k] -%}
                      {%- if mf != blank -%}
                        {%- if mf.value != blank -%}{%- assign mf_out = mf.value -%}{%- else -%}{%- assign mf_out = mf -%}{%- endif -%}
                      {%- endif -%}
                    {%- endif -%}
                  {%- endif -%}

                  <div style="margin-bottom: {{ block.settings.margin_bottom | default: 16 }}px;">
                    <details {% if block.settings.open_by_default %}open{% endif %} {{ block.shopify_attributes }}>
                      <summary
                        class="qtm-block-style"
                        style="
                          --qtm-bc: {{ block.settings.text_color | default: '#111111' }};
                          --qtm-bfs: {{ block.settings.font_size | default: 18 }}px;
                          --qtm-bfw: {{ block.settings.font_weight | default: '600' }};
                        "
                      >
                        <span>{{ block.settings.title | escape }}</span>
                        <span aria-hidden="true">+</span>
                      </summary>
                      <div class="qtm-modern__accordion-content rte">
                        {%- if mf_out != blank -%}
                          {{ mf_out }}
                        {%- else -%}
                          {%- if block.settings.fallback_text != blank -%}
                            <p>{{ block.settings.fallback_text | escape }}</p>
                          {%- endif -%}
                        {%- endif -%}
                      </div>
                    </details>
                  </div>

                {%- when 'accordion_page' -%}
                  <div style="margin-bottom: {{ block.settings.margin_bottom | default: 16 }}px;">
                    <details {% if block.settings.open_by_default %}open{% endif %} {{ block.shopify_attributes }}>
                      <summary
                        class="qtm-block-style"
                        style="
                          --qtm-bc: {{ block.settings.text_color | default: '#111111' }};
                          --qtm-bfs: {{ block.settings.font_size | default: 18 }}px;
                          --qtm-bfw: {{ block.settings.font_weight | default: '600' }};
                        "
                      >
                        <span>{{ block.settings.title | escape }}</span>
                        <span aria-hidden="true">+</span>
                      </summary>
                      <div class="qtm-modern__accordion-content rte">
                        {%- if block.settings.page != blank -%}
                          {{ block.settings.page.content }}
                        {%- endif -%}
                      </div>
                    </details>
                  </div>

                {%- when 'accordion_liquid' -%}
                  <div style="margin-bottom: {{ block.settings.margin_bottom | default: 16 }}px;">
                    <details {% if block.settings.open_by_default %}open{% endif %} {{ block.shopify_attributes }}>
                      <summary
                        class="qtm-block-style"
                        style="
                          --qtm-bc: {{ block.settings.text_color | default: '#111111' }};
                          --qtm-bfs: {{ block.settings.font_size | default: 18 }}px;
                          --qtm-bfw: {{ block.settings.font_weight | default: '600' }};
                        "
                      >
                        <span>{{ block.settings.title | escape }}</span>
                        <span aria-hidden="true">+</span>
                      </summary>
                      <div class="qtm-modern__accordion-content rte">
                        {{ block.settings.custom_liquid }}
                      </div>
                    </details>
                  </div>

              {%- endcase -%}
            {%- endfor -%}
          </div>
        {%- endif -%}

      </div>
    </div>
  </div>

  {%- comment -%} ================= LIGHTBOX MODAL ================= {%- endcomment -%}
  {%- if s.image_zoom == 'lightbox' -%}
    <dialog class="qtm-modern__modal" id="QtmModal-{{ section.id }}" aria-label="Product images">
      <div class="qtm-modern__modal-head">
        <div style="font-weight:800;">{{ p.title | escape }}</div>
        <button type="button" class="qtm-modern__modal-close" data-qtm-close-modal aria-label="Close">✕</button>
      </div>
      <div class="qtm-modern__modal-body">
        <img id="QtmModalImg-{{ section.id }}" src="{{ featured_src }}" alt="{{ featured.alt | escape }}">
        <div class="qtm-modern__modal-nav">
          <button type="button" data-qtm-prev aria-label="Previous">‹</button>
          <button type="button" data-qtm-next aria-label="Next">›</button>
        </div>
      </div>
    </dialog>
  {%- endif -%}

  {%- comment -%} ================= PRODUCT JSON ================= {%- endcomment -%}
  <script type="application/json" id="QtmProductJson-{{ section.id }}">
    {{ p | json }}
  </script>

  <script>
    (function(){
      var root = document.getElementById('MainProductModern-{{ section.id }}');
      if (!root) return;

      var productJsonEl = document.getElementById('QtmProductJson-{{ section.id }}');
      if (!productJsonEl) return;

      var product = JSON.parse(productJsonEl.textContent);
      var variants = product.variants || [];

      // Media
      var mainImg = document.getElementById('QtmMainImage-{{ section.id }}');
      var thumbs = root.querySelectorAll('.qtm-modern__thumb');
      var gridButtons = root.querySelectorAll('.qtm-modern__grid-gallery [data-qtm-image]');

      // Lightbox
      var modal = document.getElementById('QtmModal-{{ section.id }}');
      var modalImg = document.getElementById('QtmModalImg-{{ section.id }}');

      var openBtn = root.querySelector('[data-qtm-open-modal]');
      var closeBtn = root.querySelector('[data-qtm-close-modal]');
      var prevBtn = root.querySelector('[data-qtm-prev]');
      var nextBtn = root.querySelector('[data-qtm-next]');
      var mainOpen = root.querySelector('[data-qtm-open-main]');

      // Carousel rail nav
      var rail = root.querySelector('[data-qtm-thumb-rail]');
      var railPrev = root.querySelector('[data-qtm-thumb-prev]');
      var railNext = root.querySelector('[data-qtm-thumb-next]');

      var currentIndex = 0;

      function setActiveThumb(idx){
        thumbs.forEach(function(t){ t.setAttribute('aria-current','false'); });
        if (thumbs[idx]) thumbs[idx].setAttribute('aria-current','true');
      }

      function getButtonByIndex(idx){
        if (thumbs && thumbs.length) return thumbs[idx] || null;
        if (gridButtons && gridButtons.length) return gridButtons[idx] || null;
        return null;
      }

      function setImageByIndex(idx){
        var btn = getButtonByIndex(idx);
        if (!btn) return;

        currentIndex = idx;

        var src = btn.getAttribute('data-qtm-image');
        if (src && mainImg) mainImg.src = src;
        if (src && modalImg) modalImg.src = src;

        if (thumbs && thumbs.length) setActiveThumb(idx);
      }

      // thumb click
      thumbs.forEach(function(btn){
        btn.addEventListener('click', function(){
          var idx = parseInt(btn.getAttribute('data-qtm-index'), 10) || 0;
          setImageByIndex(idx);
        });
      });

      // grid click (columns layout)
      gridButtons.forEach(function(btn){
        btn.addEventListener('click', function(){
          var idx = parseInt(btn.getAttribute('data-qtm-index'), 10) || 0;
          setImageByIndex(idx);
          if (modal && modal.showModal && root.getAttribute('data-gallery-layout') === 'columns'){
            modal.showModal();
          }
        });
      });

      // modal open/close
      function openModal(){
        if (modal && modal.showModal){
          modal.showModal();
        }
      }
      if (openBtn) openBtn.addEventListener('click', openModal);

      if (mainOpen){
        mainOpen.addEventListener('click', function(){
          if (!modal) return;
          openModal();
        });
      }

      if (closeBtn && modal){
        closeBtn.addEventListener('click', function(){ modal.close(); });
      }

      if (modal){
        modal.addEventListener('click', function(e){
          if (e.target === modal) modal.close();
        });
        document.addEventListener('keydown', function(e){
          if (e.key === 'Escape' && modal.open) modal.close();
          if (!modal.open) return;
          if (e.key === 'ArrowLeft') prev();
          if (e.key === 'ArrowRight') next();
        });
      }

      function prev(){
        var total = (thumbs && thumbs.length) ? thumbs.length : (gridButtons ? gridButtons.length : 0);
        if (!total) return;
        var idx = currentIndex - 1;
        if (idx < 0) idx = total - 1;
        setImageByIndex(idx);
      }
      function next(){
        var total = (thumbs && thumbs.length) ? thumbs.length : (gridButtons ? gridButtons.length : 0);
        if (!total) return;
        var idx = currentIndex + 1;
        if (idx >= total) idx = 0;
        setImageByIndex(idx);
      }
      if (prevBtn) prevBtn.addEventListener('click', prev);
      if (nextBtn) nextBtn.addEventListener('click', next);

      // carousel scroll
      function scrollRail(dir){
        if (!rail) return;
        var amt = Math.max(220, rail.clientWidth * 0.75);
        rail.scrollLeft += (dir === 'next' ? amt : -amt);
      }
      if (railPrev) railPrev.addEventListener('click', function(){ scrollRail('prev'); });
      if (railNext) railNext.addEventListener('click', function(){ scrollRail('next'); });

      // Variant selection -> updates price/sku/availability + hidden variant id
      var variantIdInput = document.getElementById('QtmVariantId-{{ section.id }}');
      var priceEl = document.getElementById('QtmPrice-{{ section.id }}');
      var compareEl = document.getElementById('QtmCompare-{{ section.id }}');
      var skuWrap = document.getElementById('QtmSkuWrap-{{ section.id }}');
      var skuEl = document.getElementById('QtmSku-{{ section.id }}');
      var availText = document.getElementById('QtmAvailText-{{ section.id }}');
      var atcBtn = document.getElementById('QtmAtc-{{ section.id }}');

      var qtyInput = document.getElementById('QtmQty-{{ section.id }}');
      var qtyHidden = document.getElementById('QtmQtyHidden-{{ section.id }}');

      if (qtyInput && qtyHidden){
        qtyInput.addEventListener('input', function(){
          var v = parseInt(qtyInput.value, 10);
          if (!v || v < 1) v = 1;
          qtyHidden.value = String(v);
        });
      }

      function formatMoney(cents){
        try{
          return new Intl.NumberFormat(undefined, { style: 'currency', currency: '{{ cart.currency.iso_code | default: "USD" }}' }).format(cents/100);
        }catch(e){
          return '$' + (cents/100).toFixed(2);
        }
      }

      function getSelectedOptions(){
        var selections = [];
        var optionGroups = root.querySelectorAll('[data-qtm-option]');
        optionGroups.forEach(function(group){
          var radios = group.querySelectorAll('input[type="radio"]');
          if (radios.length){
            var checked = group.querySelector('input[type="radio"]:checked');
            selections.push(checked ? checked.value : '');
          } else {
            var select = group.querySelector('select');
            selections.push(select ? select.value : '');
          }
        });
        return selections;
      }

      function findVariantByOptions(opts){
        return variants.find(function(v){
          if (!v || !v.options) return false;
          for (var i=0; i<opts.length; i++){
            if (v.options[i] !== opts[i]) return false;
          }
          return true;
        }) || null;
      }

      function applyVariant(v){
        if (!v) return;

        if (variantIdInput) variantIdInput.value = v.id;

        if (priceEl) priceEl.textContent = formatMoney(v.price);

        if (compareEl){
          if (v.compare_at_price && v.compare_at_price > v.price){
            compareEl.style.display = '';
            compareEl.textContent = formatMoney(v.compare_at_price);
          } else {
            compareEl.style.display = 'none';
          }
        }

        if (skuWrap && skuEl){
          if (v.sku){
            skuWrap.style.display = '';
            skuEl.textContent = v.sku;
          } else {
            skuWrap.style.display = 'none';
          }
        }

        if (availText && atcBtn){
          if (v.available){
            availText.textContent = 'In stock';
            atcBtn.disabled = false;
            atcBtn.textContent = 'Add to cart';
          } else {
            availText.textContent = 'Sold out';
            atcBtn.disabled = true;
            atcBtn.textContent = 'Sold out';
          }
        }

        // If variant has a featured image, try to switch main image to match
        if (v.featured_image && v.featured_image.src && mainImg){
          mainImg.src = v.featured_image.src;
          if (modalImg) modalImg.src = v.featured_image.src;

          // update active thumb if it matches (best-effort)
          thumbs.forEach(function(t, idx){
            var src = t.getAttribute('data-qtm-image');
            if (src && src.indexOf(v.featured_image.src) !== -1){
              currentIndex = idx;
              setActiveThumb(idx);
            }
          });
        }

        // Update URL with variant param
        try{
          var url = new URL(window.location.href);
          url.searchParams.set('variant', v.id);
          window.history.replaceState({}, '', url.toString());
        }catch(e){}
      }

      // Listen to option changes
      root.addEventListener('change', function(e){
        if (!e.target) return;
        if (e.target.name && e.target.name.indexOf('qtm-option-') === 0){
          var opts = getSelectedOptions();
          var v = findVariantByOptions(opts);
          applyVariant(v);
        }
      });

      // Initialize currentIndex based on aria-current (if thumbs exist)
      thumbs.forEach(function(t, idx){
        if (t.getAttribute('aria-current') === 'true') currentIndex = idx;
      });

    })();
  </script>

</section>

{% schema %}
{
  "name": "Main Product — Modern 2",
  "tag": "section",
  "class": "section",
  "settings": [
    {
      "type": "text",
      "id": "section_aria_label",
      "label": "Section ARIA label",
      "default": "Product details"
    },
    {
      "type": "checkbox",
      "id": "enable_sticky_info",
      "label": "Sticky content",
      "default": false
    },

    {
      "type": "header",
      "content": "Media"
    },
    {
      "type": "select",
      "id": "media_size",
      "label": "Width",
      "default": "medium",
      "options": [
        { "value": "small", "label": "Small" },
        { "value": "medium", "label": "Medium" },
        { "value": "large", "label": "Large" }
      ]
    },
    {
      "type": "checkbox",
      "id": "constrain_to_viewport",
      "label": "Constrain to screen height",
      "default": false
    },
    {
      "type": "select",
      "id": "media_fit",
      "label": "Fit",
      "default": "original",
      "options": [
        { "value": "original", "label": "Original" },
        { "value": "fill", "label": "Fill" }
      ]
    },
    {
      "type": "select",
      "id": "gallery_layout",
      "label": "Layout",
      "default": "stacked",
      "options": [
        { "value": "stacked", "label": "Stacked" },
        { "value": "columns", "label": "2 columns" },
        { "value": "thumbnails", "label": "Thumbnails" },
        { "value": "thumbnail_carousel", "label": "Thumbnail carousel" }
      ]
    },
    {
      "type": "select",
      "id": "mobile_thumbnails",
      "label": "Mobile layout",
      "default": "show",
      "options": [
        { "value": "hide", "label": "Hide thumbnails" },
        { "value": "columns", "label": "2 columns" },
        { "value": "show", "label": "Show thumbnails" }
      ]
    },
    {
      "type": "select",
      "id": "media_position",
      "label": "Position",
      "default": "left",
      "options": [
        { "value": "left", "label": "Left" },
        { "value": "right", "label": "Right" }
      ]
    },
    {
      "type": "select",
      "id": "image_zoom",
      "label": "Zoom",
      "default": "lightbox",
      "options": [
        { "value": "lightbox", "label": "Open lightbox" },
        { "value": "none", "label": "None" }
      ]
    },
    {
      "type": "checkbox",
      "id": "hide_variants",
      "label": "Hide other variant media after one is selected",
      "default": false
    },
    {
      "type": "checkbox",
      "id": "enable_video_looping",
      "label": "Loop video",
      "default": false
    },

    {
      "type": "header",
      "content": "Spacing"
    },
    {
      "type": "range",
      "id": "padding_top",
      "min": 0,
      "max": 100,
      "step": 4,
      "unit": "px",
      "label": "Padding top",
      "default": 36
    },
    {
      "type": "range",
      "id": "padding_bottom",
      "min": 0,
      "max": 100,
      "step": 4,
      "unit": "px",
      "label": "Padding bottom",
      "default": 36
    }
  ],
  "blocks": [
    {
      "type": "title",
      "name": "Title",
      "limit": 1,
      "settings": [
        { "type": "color", "id": "text_color", "label": "Text color", "default": "#111111" },
        { "type": "range", "id": "font_size", "min": 12, "max": 60, "step": 1, "unit": "px", "label": "Font size", "default": 18 },
        {
          "type": "select",
          "id": "font_weight",
          "label": "Font weight",
          "default": "600",
          "options": [
            { "value": "400", "label": "Normal" },
            { "value": "500", "label": "Medium" },
            { "value": "600", "label": "Semi Bold" },
            { "value": "700", "label": "Bold" }
          ]
        },
        { "type": "range", "id": "margin_bottom", "min": 0, "max": 60, "step": 4, "unit": "px", "label": "Bottom spacing", "default": 16 }
      ]
    },
    {
      "type": "price",
      "name": "Price",
      "limit": 1,
      "settings": [
        { "type": "color", "id": "text_color", "label": "Text color", "default": "#111111" },
        { "type": "range", "id": "font_size", "min": 12, "max": 60, "step": 1, "unit": "px", "label": "Font size", "default": 18 },
        {
          "type": "select",
          "id": "font_weight",
          "label": "Font weight",
          "default": "600",
          "options": [
            { "value": "400", "label": "Normal" },
            { "value": "500", "label": "Medium" },
            { "value": "600", "label": "Semi Bold" },
            { "value": "700", "label": "Bold" }
          ]
        },
        { "type": "range", "id": "margin_bottom", "min": 0, "max": 60, "step": 4, "unit": "px", "label": "Bottom spacing", "default": 16 }
      ]
    },
    {
      "type": "sku_status",
      "name": "SKU + Status",
      "limit": 1,
      "settings": [
        { "type": "color", "id": "text_color", "label": "Text color", "default": "#111111" },
        { "type": "range", "id": "font_size", "min": 12, "max": 60, "step": 1, "unit": "px", "label": "Font size", "default": 18 },
        {
          "type": "select",
          "id": "font_weight",
          "label": "Font weight",
          "default": "600",
          "options": [
            { "value": "400", "label": "Normal" },
            { "value": "500", "label": "Medium" },
            { "value": "600", "label": "Semi Bold" },
            { "value": "700", "label": "Bold" }
          ]
        },
        { "type": "range", "id": "margin_bottom", "min": 0, "max": 60, "step": 4, "unit": "px", "label": "Bottom spacing", "default": 16 }
      ]
    },
    {
      "type": "variant_picker",
      "name": "Variant picker",
      "limit": 1,
      "settings": [
        {
          "type": "select",
          "id": "picker",
          "label": "Style",
          "default": "buttons",
          "options": [
            { "value": "buttons", "label": "Buttons" },
            { "value": "dropdown", "label": "Dropdown" }
          ]
        },
        { "type": "color", "id": "text_color", "label": "Text color", "default": "#111111" },
        { "type": "range", "id": "font_size", "min": 12, "max": 60, "step": 1, "unit": "px", "label": "Font size", "default": 18 },
        {
          "type": "select",
          "id": "font_weight",
          "label": "Font weight",
          "default": "600",
          "options": [
            { "value": "400", "label": "Normal" },
            { "value": "500", "label": "Medium" },
            { "value": "600", "label": "Semi Bold" },
            { "value": "700", "label": "Bold" }
          ]
        },
        { "type": "range", "id": "margin_bottom", "min": 0, "max": 60, "step": 4, "unit": "px", "label": "Bottom spacing", "default": 16 }
      ]
    },
    {
      "type": "quantity",
      "name": "Quantity selector",
      "limit": 1,
      "settings": [
        { "type": "color", "id": "text_color", "label": "Text color", "default": "#111111" },
        { "type": "range", "id": "font_size", "min": 12, "max": 60, "step": 1, "unit": "px", "label": "Font size", "default": 18 },
        {
          "type": "select",
          "id": "font_weight",
          "label": "Font weight",
          "default": "600",
          "options": [
            { "value": "400", "label": "Normal" },
            { "value": "500", "label": "Medium" },
            { "value": "600", "label": "Semi Bold" },
            { "value": "700", "label": "Bold" }
          ]
        },
        { "type": "range", "id": "margin_bottom", "min": 0, "max": 60, "step": 4, "unit": "px", "label": "Bottom spacing", "default": 16 }
      ]
    },
    {
      "type": "buy_buttons",
      "name": "Buy buttons",
      "limit": 1,
      "settings": [
        { "type": "checkbox", "id": "show_dynamic_checkout", "default": false, "label": "Show dynamic checkout button" },
        {
          "type": "select",
          "id": "button_size",
          "label": "Button size",
          "default": "medium",
          "options": [
            { "value": "small", "label": "Small" },
            { "value": "medium", "label": "Medium" },
            { "value": "large", "label": "Large" }
          ]
        },
        { "type": "color", "id": "button_background", "label": "Button background", "default": "#111111" },
        { "type": "color", "id": "button_text_color", "label": "Button text color", "default": "#ffffff" },

        { "type": "color", "id": "text_color", "label": "Text color", "default": "#111111" },
        { "type": "range", "id": "font_size", "min": 12, "max": 60, "step": 1, "unit": "px", "label": "Font size", "default": 18 },
        {
          "type": "select",
          "id": "font_weight",
          "label": "Font weight",
          "default": "600",
          "options": [
            { "value": "400", "label": "Normal" },
            { "value": "500", "label": "Medium" },
            { "value": "600", "label": "Semi Bold" },
            { "value": "700", "label": "Bold" }
          ]
        },
        { "type": "range", "id": "margin_bottom", "min": 0, "max": 60, "step": 4, "unit": "px", "label": "Bottom spacing", "default": 16 }
      ]
    },
    {
      "type": "qty_buy_combo",
      "name": "Quantity + Buy Buttons",
      "limit": 1,
      "settings": [
        { "type": "checkbox", "id": "show_dynamic_checkout", "default": false, "label": "Show dynamic checkout" },
        {
          "type": "select",
          "id": "button_size",
          "label": "Button size",
          "default": "medium",
          "options": [
            { "value": "small", "label": "Small" },
            { "value": "medium", "label": "Medium" },
            { "value": "large", "label": "Large" }
          ]
        },
        { "type": "color", "id": "button_background", "label": "Button background", "default": "#111111" },
        { "type": "color", "id": "button_text_color", "label": "Button text color", "default": "#ffffff" },

        { "type": "color", "id": "text_color", "label": "Text color", "default": "#111111" },
        { "type": "range", "id": "font_size", "min": 12, "max": 60, "step": 1, "unit": "px", "label": "Font size", "default": 18 },
        {
          "type": "select",
          "id": "font_weight",
          "label": "Font weight",
          "default": "600",
          "options": [
            { "value": "400", "label": "Normal" },
            { "value": "500", "label": "Medium" },
            { "value": "600", "label": "Semi Bold" },
            { "value": "700", "label": "Bold" }
          ]
        },
        { "type": "range", "id": "margin_bottom", "min": 0, "max": 60, "step": 4, "unit": "px", "label": "Bottom spacing", "default": 16 }
      ]
    },
    {
      "type": "description",
      "name": "Description",
      "limit": 1,
      "settings": [
        {
          "type": "select",
          "id": "mode",
          "label": "Content",
          "default": "short",
          "options": [
            { "value": "none", "label": "None" },
            { "value": "short", "label": "Short description" },
            { "value": "full", "label": "Full description" }
          ]
        },
        {
          "type": "text",
          "id": "short_metafield_key",
          "label": "Short description metafield key",
          "default": "custom.short_description",
          "info": "Enter as namespace.key (example: custom.short_description)."
        },
        { "type": "color", "id": "text_color", "label": "Text color", "default": "#111111" },
        { "type": "range", "id": "font_size", "min": 12, "max": 60, "step": 1, "unit": "px", "label": "Font size", "default": 18 },
        {
          "type": "select",
          "id": "font_weight",
          "label": "Font weight",
          "default": "600",
          "options": [
            { "value": "400", "label": "Normal" },
            { "value": "500", "label": "Medium" },
            { "value": "600", "label": "Semi Bold" },
            { "value": "700", "label": "Bold" }
          ]
        },
        { "type": "range", "id": "margin_bottom", "min": 0, "max": 60, "step": 4, "unit": "px", "label": "Bottom spacing", "default": 16 }
      ]
    },

    {
      "type": "accordion_description",
      "name": "Accordion — Description",
      "settings": [
        { "type": "text", "id": "title", "label": "Title", "default": "Product description" },
        { "type": "checkbox", "id": "open_by_default", "label": "Open by default", "default": true },

        { "type": "color", "id": "text_color", "label": "Text color", "default": "#111111" },
        { "type": "range", "id": "font_size", "min": 12, "max": 60, "step": 1, "unit": "px", "label": "Font size", "default": 18 },
        {
          "type": "select",
          "id": "font_weight",
          "label": "Font weight",
          "default": "600",
          "options": [
            { "value": "400", "label": "Normal" },
            { "value": "500", "label": "Medium" },
            { "value": "600", "label": "Semi Bold" },
            { "value": "700", "label": "Bold" }
          ]
        },
        { "type": "range", "id": "margin_bottom", "min": 0, "max": 60, "step": 4, "unit": "px", "label": "Bottom spacing", "default": 16 }
      ]
    },
    {
      "type": "accordion_reviews",
      "name": "Accordion — Reviews",
      "settings": [
        { "type": "text", "id": "title", "label": "Title", "default": "Reviews" },
        { "type": "checkbox", "id": "open_by_default", "label": "Open by default", "default": false },
        {
          "type": "textarea",
          "id": "placeholder_text",
          "label": "Placeholder text",
          "default": "Reviews will display here once your reviews app is embedded (use a Custom liquid accordion, or add the app block elsewhere on the product template)."
        },

        { "type": "color", "id": "text_color", "label": "Text color", "default": "#111111" },
        { "type": "range", "id": "font_size", "min": 12, "max": 60, "step": 1, "unit": "px", "label": "Font size", "default": 18 },
        {
          "type": "select",
          "id": "font_weight",
          "label": "Font weight",
          "default": "600",
          "options": [
            { "value": "400", "label": "Normal" },
            { "value": "500", "label": "Medium" },
            { "value": "600", "label": "Semi Bold" },
            { "value": "700", "label": "Bold" }
          ]
        },
        { "type": "range", "id": "margin_bottom", "min": 0, "max": 60, "step": 4, "unit": "px", "label": "Bottom spacing", "default": 16 }
      ]
    },
    {
      "type": "accordion_metafield",
      "name": "Accordion — Metafield",
      "settings": [
        { "type": "text", "id": "title", "label": "Title", "default": "Product details" },
        { "type": "checkbox", "id": "open_by_default", "label": "Open by default", "default": false },
        {
          "type": "text",
          "id": "metafield_key",
          "label": "Metafield key",
          "default": "custom.product_details",
          "info": "Enter as namespace.key (example: custom.product_details)."
        },
        { "type": "text", "id": "fallback_text", "label": "Fallback text (optional)" },

        { "type": "color", "id": "text_color", "label": "Text color", "default": "#111111" },
        { "type": "range", "id": "font_size", "min": 12, "max": 60, "step": 1, "unit": "px", "label": "Font size", "default": 18 },
        {
          "type": "select",
          "id": "font_weight",
          "label": "Font weight",
          "default": "600",
          "options": [
            { "value": "400", "label": "Normal" },
            { "value": "500", "label": "Medium" },
            { "value": "600", "label": "Semi Bold" },
            { "value": "700", "label": "Bold" }
          ]
        },
        { "type": "range", "id": "margin_bottom", "min": 0, "max": 60, "step": 4, "unit": "px", "label": "Bottom spacing", "default": 16 }
      ]
    },
    {
      "type": "accordion_page",
      "name": "Accordion — Page",
      "settings": [
        { "type": "text", "id": "title", "label": "Title", "default": "More info" },
        { "type": "checkbox", "id": "open_by_default", "label": "Open by default", "default": false },
        { "type": "page", "id": "page", "label": "Page" },

        { "type": "color", "id": "text_color", "label": "Text color", "default": "#111111" },
        { "type": "range", "id": "font_size", "min": 12, "max": 60, "step": 1, "unit": "px", "label": "Font size", "default": 18 },
        {
          "type": "select",
          "id": "font_weight",
          "label": "Font weight",
          "default": "600",
          "options": [
            { "value": "400", "label": "Normal" },
            { "value": "500", "label": "Medium" },
            { "value": "600", "label": "Semi Bold" },
            { "value": "700", "label": "Bold" }
          ]
        },
        { "type": "range", "id": "margin_bottom", "min": 0, "max": 60, "step": 4, "unit": "px", "label": "Bottom spacing", "default": 16 }
      ]
    },
    {
      "type": "accordion_liquid",
      "name": "Accordion — Custom liquid",
      "settings": [
        { "type": "text", "id": "title", "label": "Title", "default": "Details" },
        { "type": "checkbox", "id": "open_by_default", "label": "Open by default", "default": false },
        { "type": "liquid", "id": "custom_liquid", "label": "Custom liquid" },

        { "type": "color", "id": "text_color", "label": "Text color", "default": "#111111" },
        { "type": "range", "id": "font_size", "min": 12, "max": 60, "step": 1, "unit": "px", "label": "Font size", "default": 18 },
        {
          "type": "select",
          "id": "font_weight",
          "label": "Font weight",
          "default": "600",
          "options": [
            { "value": "400", "label": "Normal" },
            { "value": "500", "label": "Medium" },
            { "value": "600", "label": "Semi Bold" },
            { "value": "700", "label": "Bold" }
          ]
        },
        { "type": "range", "id": "margin_bottom", "min": 0, "max": 60, "step": 4, "unit": "px", "label": "Bottom spacing", "default": 16 }
      ]
    }
  ],
  "presets": [
    {
      "name": "Main Product — Modern (Variant Two)",
      "blocks": [
        { "type": "title" },
        { "type": "price" },
        { "type": "sku_status" },
        { "type": "variant_picker" },
        { "type": "quantity" },
        { "type": "buy_buttons" },
        { "type": "description" },
        { "type": "accordion_description" },
        { "type": "accordion_reviews" },
        { "type": "accordion_metafield" }
      ]
    }
  ]
}
{% endschema %}
