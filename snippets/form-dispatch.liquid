{% comment %}
  Quadratum — Form Dispatch (BC-safe w/ optional integrations)
  - Accepts optional parameters (if not provided, falls back to section.settings):
      eff_endpoint_url, eff_tags, eff_captcha_mode, eff_captcha_key
      eff_marketing_app, eff_marketing_proxy, eff_marketing_map_name, eff_marketing_map_phone, eff_marketing_map_company
      eff_marketing_consent_mode, eff_marketing_double_opt_in
      eff_utm_source, eff_utm_medium, eff_utm_campaign
{% endcomment %}

{%- assign s = settings -%}

{%- assign has_file = false -%}
{%- for b in blocks -%}
  {%- if b.type == 'field' and b.settings.field_type == 'file' -%}{%- assign has_file = true -%}{%- endif -%}
{%- endfor -%}

{%- comment %} Effective values (use provided overrides, else fallback to section settings) {% endcomment -%}
{%- assign eff_endpoint   = eff_endpoint_url | default: s.endpoint_url -%}
{%- assign eff_tags       = eff_tags | default: s.hidden_tags | default: '' -%}
{%- assign eff_captcha    = eff_captcha_mode | default: s.captcha_mode | default: 'none' -%}
{%- assign eff_captcha_key= eff_captcha_key | default: s.captcha_site_key | default: '' -%}

{%- comment %} Optional marketing/UTM — only used if present (keeps current behavior otherwise) {% endcomment -%}
{%- assign m_app        = eff_marketing_app | default: '' -%}
{%- assign m_proxy      = eff_marketing_proxy | default: '' -%}
{%- assign m_map_name   = eff_marketing_map_name | default: '' -%}
{%- assign m_map_phone  = eff_marketing_map_phone | default: '' -%}
{%- assign m_map_company= eff_marketing_map_company | default: '' -%}
{%- assign m_consent    = eff_marketing_consent_mode | default: '' -%}
{%- assign m_double     = eff_marketing_double_opt_in | default: '' -%}
{%- assign m_utm_source = eff_utm_source | default: '' -%}
{%- assign m_utm_medium = eff_utm_medium | default: '' -%}
{%- assign m_utm_campaign = eff_utm_campaign | default: '' -%}

{%- assign tags_str = eff_tags | strip -%}
{%- assign now_unix = 'now' | date: '%s' -%}

{%- if s.destination == 'custom_endpoint' and eff_endpoint != blank -%}
  <form class="q-form" id="q-form-{{ id }}" method="post" action="{{ eff_endpoint | escape }}"
        {% if has_file %}enctype="multipart/form-data"{% endif %} novalidate>
    {%- if tags_str != blank -%}<input type="hidden" name="tags" value="{{ tags_str | escape }}">{%- endif -%}
    <input type="hidden" name="source" value="quote_form">
    <input type="hidden" name="section_id" value="{{ id }}">
    <input type="text" name="hp_field" tabindex="-1" autocomplete="off" class="q-hp" aria-hidden="true" style="position:absolute;left:-10000px;top:auto;width:1px;height:1px;overflow:hidden;">
    <input type="hidden" name="submitted_at" value="{{ now_unix }}">

    {%- if eff_captcha == 'turnstile' -%}<input type="hidden" name="cf-turnstile-response" value="">
    {%- elsif eff_captcha == 'recaptcha_v3' -%}<input type="hidden" name="g-recaptcha-response" value="">{%- endif -%}

    {%- comment %} Optional marketing meta (only output if provided) {% endcomment -%}
    {%- if m_app != blank -%}<input type="hidden" name="marketing[app]" value="{{ m_app }}">{%- endif -%}
    {%- if m_proxy != blank -%}<input type="hidden" name="marketing[proxy]" value="{{ m_proxy | escape }}">{%- endif -%}
    {%- if m_map_name != blank -%}<input type="hidden" name="marketing[map_name]" value="{{ m_map_name }}">{%- endif -%}
    {%- if m_map_phone != blank -%}<input type="hidden" name="marketing[map_phone]" value="{{ m_map_phone }}">{%- endif -%}
    {%- if m_map_company != blank -%}<input type="hidden" name="marketing[map_company]" value="{{ m_map_company }}">{%- endif -%}
    {%- if m_consent != blank -%}<input type="hidden" name="marketing[consent_mode]" value="{{ m_consent }}">{%- endif -%}
    {%- if m_double != blank -%}<input type="hidden" name="marketing[double_opt_in]" value="{{ m_double }}">{%- endif -%}
    {%- if m_utm_source != blank -%}<input type="hidden" name="utm[source]" value="{{ m_utm_source | escape }}">{%- endif -%}
    {%- if m_utm_medium != blank -%}<input type="hidden" name="utm[medium]" value="{{ m_utm_medium | escape }}">{%- endif -%}
    {%- if m_utm_campaign != blank -%}<input type="hidden" name="utm[campaign]" value="{{ m_utm_campaign | escape }}">{%- endif -%}

    {%- render 'form-core', id: id, settings: s, blocks: blocks -%}
  </form>
{%- else -%}
  {%- comment %} Shopify Contact form pathway (unchanged baseline) {% endcomment -%}
  {%- assign form_dom_id = 'q-form-' | append: id -%}
  {% form 'contact', id: form_dom_id, class: 'q-form', novalidate: 'novalidate' %}
    {%- if tags_str != blank -%}<input type="hidden" name="contact[tags]" value="{{ tags_str | escape }}">{%- endif -%}
    <input type="text" name="contact[hp_field]" tabindex="-1" autocomplete="off" class="q-hp" aria-hidden="true" style="position:absolute;left:-10000px;top:auto;width:1px;height:1px;overflow:hidden;">
    <input type="hidden" name="contact[submitted_at]" value="{{ now_unix }}">

    {%- if eff_captcha == 'turnstile' -%}<input type="hidden" name="cf-turnstile-response" value="">
    {%- elsif eff_captcha == 'recaptcha_v3' -%}<input type="hidden" name="g-recaptcha-response" value="">{%- endif -%}

    {%- comment %} Optional marketing meta recorded into contact[...] only if provided {% endcomment -%}
    {%- if m_app != blank -%}<input type="hidden" name="contact[marketing_app]" value="{{ m_app }}">{%- endif -%}
    {%- if m_proxy != blank -%}<input type="hidden" name="contact[marketing_proxy]" value="{{ m_proxy | escape }}">{%- endif -%}
    {%- if m_map_name != blank -%}<input type="hidden" name="contact[marketing_map_name]" value="{{ m_map_name }}">{%- endif -%}
    {%- if m_map_phone != blank -%}<input type="hidden" name="contact[marketing_map_phone]" value="{{ m_map_phone }}">{%- endif -%}
    {%- if m_map_company != blank -%}<input type="hidden" name="contact[marketing_map_company]" value="{{ m_map_company }}">{%- endif -%}
    {%- if m_consent != blank -%}<input type="hidden" name="contact[marketing_consent_mode]" value="{{ m_consent }}">{%- endif -%}
    {%- if m_double != blank -%}<input type="hidden" name="contact[marketing_double_opt_in]" value="{{ m_double }}">{%- endif -%}
    {%- if m_utm_source != blank -%}<input type="hidden" name="contact[utm_source]" value="{{ m_utm_source | escape }}">{%- endif -%}
    {%- if m_utm_medium != blank -%}<input type="hidden" name="contact[utm_medium]" value="{{ m_utm_medium | escape }}">{%- endif -%}
    {%- if m_utm_campaign != blank -%}<input type="hidden" name="contact[utm_campaign]" value="{{ m_utm_campaign | escape }}">{%- endif -%}

    {%- if form.posted_successfully? -%}
      <div class="q-live"><span class="ok">{{ s.success_text | default: 'Thanks! Your request has been sent.' }}</span></div>
    {%- elsif form.errors -%}
      <div class="q-live"><span class="bad">{{ s.error_text | default: 'Please fix the highlighted fields and try again.' }}</span></div>
    {%- else -%}
      <div class="q-live" aria-live="polite" role="status"></div>
    {%- endif -%}

    {%- render 'form-core', id: id, settings: s, blocks: blocks, shopify_form: form -%}
  {% endform %}
{%- endif -%}
