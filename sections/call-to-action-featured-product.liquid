{% comment %}
  Quadratum — CTA: Featured Product (v2)
  • Frictionless “buy / learn” CTA spotlighting a single SKU
  • Variants: compact-card | wide-split | minimal | slideshow
  • A11y: aria-live stock/price, focus traps on slideshow
  • Perf: lazy media, minimal JS (<2KB), CLS-safe
{% endcomment %}

{{ 'call-to-action-featured-product.css' | asset_url | stylesheet_tag }}
{%- assign s = section.settings -%}

{%- comment -%}
  Product resolution logic
{%- endcomment -%}
{%- assign product = nil -%}
{%- if s.product != blank -%}
  {%- if s.product contains 'shopify://products/' -%}
    {%- assign _handle = s.product | replace: 'shopify://products/', '' -%}
    {%- assign product = all_products[_handle] -%}
  {%- else -%}
    {%- assign product = all_products[s.product] | default: s.product -%}
  {%- endif -%}
{%- endif -%}
{%- if product == blank and s.dev_product_handle != blank -%}
  {%- assign product = all_products[s.dev_product_handle] -%}
{%- endif -%}

{%- comment %} Theme tokens {% endcomment -%}
{%- assign C_primary = settings.color_primary | default: '#2563eb' -%}
{%- assign C_text = settings.text_base | default: '#111111' -%}
{%- assign C_muted = settings.text_muted | default: '#6b7280' -%}
{%- assign C_surface = settings.bg_contrast | default: '#f6f7f8' -%}
{%- assign C_on_color = settings.text_on_color | default: '#ffffff' -%}
{%- assign R_btn = settings.button_radius | default: 8 -%}

{%- assign layout_class = 'is-compact' -%}
{%- if s.layout == 'split' -%}{%- assign layout_class = 'is-split' -%}{%- endif -%}
{%- if s.layout == 'minimal' -%}{%- assign layout_class = 'is-minimal' -%}{%- endif -%}
{%- if s.layout == 'slideshow' -%}{%- assign layout_class = 'is-slideshow' -%}{%- endif -%}

<section
  id="{{ s.anchor_id | default: section.id }}"
  class="q-section cta-featured-product {{ layout_class }}{% if s.full_bleed %} is-fullbleed{% endif %}"
  role="region"
  aria-label="{{ s.aria_label | default: 'Featured product call to action' }}"
  data-section-id="{{ section.id }}"
  style="
    --q-btn-br: {{ R_btn }}px;
    --q-btn-bg: {{ C_primary }};
    --q-btn-fg: {{ C_on_color }};
    --q-text: {{ C_text }};
    --q-muted: {{ C_muted }};
    --q-surface: {{ C_surface }};
    --q-media-ratio: {{ s.media_ratio | default: 0.67 }};
    padding-top: {{ s.pad_top | divided_by: 100.0 }}rem;
    padding-bottom: {{ s.pad_bottom | divided_by: 100.0 }}rem;
  "
>
  <div class="{% unless s.full_bleed %}container{% endunless %}">
    {%- if product == blank -%}
      <div class="q-admin-empty card">
        <h3 class="q-heading">Select a product to feature</h3>
        <p class="q-sub">This CTA highlights a single product with live price, variants, and purchase actions.</p>
      </div>
    {%- else -%}
      {%- assign v = product.selected_or_first_available_variant -%}
      {%- assign _primary_label = s.primary_label | default: 'Shop Now' -%}
      <div class="q-wrap {{ layout_class }}">
        {%- unless layout_class == 'is-minimal' -%}
          <div class="q-media">
            {%- if s.layout == 'slideshow' and product.media.size > 1 -%}
              <div class="swiper" data-cta-slider>
                <div class="swiper-wrapper">
                  {%- for m in product.media -%}
                    <div class="swiper-slide">
                      {{ m | image_url: width: 1600 | image_tag: loading: 'lazy', class: 'q-img', alt: m.alt | default: product.title }}
                    </div>
                  {%- endfor -%}
                </div>
                <div class="swiper-pagination"></div>
                <div class="swiper-button-prev"></div>
                <div class="swiper-button-next"></div>
              </div>
            {%- else -%}
              {%- assign media = s.custom_media | default: product.featured_media -%}
              {%- if media and media.preview_image != blank -%}
                {{ media.preview_image | image_url: width: 1600 | image_tag: loading: 'lazy', class: 'q-img', alt: media.alt | default: product.title }}
              {%- elsif product.featured_image -%}
                {{ product.featured_image | image_url: width: 1600 | image_tag: loading: 'lazy', class: 'q-img', alt: product.title }}
              {%- endif -%}
            {%- endif -%}
          </div>
        {%- endunless -%}

        <div class="q-content">
          {%- if s.eyebrow != blank -%}<p class="q-eyebrow">{{ s.eyebrow }}</p>{%- endif -%}
          <h2 class="q-heading">{{ s.headline | default: product.title }}</h2>
          {%- if s.subheading != blank -%}<p class="q-sub">{{ s.subheading }}</p>{%- endif -%}

          <div class="q-price" aria-live="polite">
            {%- if s.show_price -%}<span class="q-price-now">{{ v.price | money }}</span>{%- endif -%}
            {%- if s.show_compare and v.compare_at_price > v.price -%}
              <span class="q-price-compare">{{ v.compare_at_price | money }}</span>
            {%- endif -%}
          </div>

          {%- form 'product', product, id: 'form-' | append: section.id, class: 'q-form' -%}
            <input type="hidden" name="id" value="{{ v.id }}">
            <div class="q-ctas">
              {%- if s.primary_cta_type == 'view' -%}
                <a class="btn q-btn q-btn--solid" href="{{ product.url }}">{{ _primary_label }}</a>
              {%- else -%}
                <button class="btn q-btn q-btn--solid" type="submit" name="{% if s.primary_cta_type == 'buy' %}checkout{% else %}add{% endif %}">
                  {{ _primary_label }}
                </button>
              {%- endif -%}
              {%- if s.secondary_label and s.secondary_url -%}
                <a class="btn q-btn q-btn--ghost" href="{{ s.secondary_url }}">{{ s.secondary_label }}</a>
              {%- endif -%}
            </div>
          {%- endform -%}

          {%- if s.microcopy != blank -%}<p class="q-microcopy">{{ s.microcopy }}</p>{%- endif -%}
        </div>
      </div>

      {%- if s.sticky_mobile_cta and request.design_mode == false -%}
        <div class="q-sticky" data-sticky>
          <div class="q-sticky-inner">
            <div class="q-sticky-price">{{ v.price | money }}</div>
            <button class="btn q-btn q-btn--solid" form="form-{{ section.id }}" type="submit">{{ _primary_label }}</button>
          </div>
        </div>
      {%- endif -%}

      <script type="application/json" data-product-json>{{ product | json }}</script>
      {{ 'call-to-action-featured-product.js' | asset_url | script_tag | replace: '<script', '<script defer' }}
    {%- endif -%}
  </div>
</section>

{% schema %}
{
  "name": "CTA — Featured Product",
  "settings": [
    { "type": "text", "id": "aria_label", "label": "ARIA label", "default": "Featured product" },
    { "type": "product", "id": "product", "label": "Product" },
    { "type": "text", "id": "dev_product_handle", "label": "DEV ONLY: Product handle" },

    { "type": "header", "content": "Layout" },
    { "type": "select", "id": "layout", "label": "Layout style", "default": "split", "options": [
      { "value": "compact", "label": "Compact" },
      { "value": "split", "label": "Split wide" },
      { "value": "minimal", "label": "Minimal (no image)" },
      { "value": "slideshow", "label": "Slideshow (product media)" }
    ]},
    { "type": "checkbox", "id": "full_bleed", "label": "Full-bleed section", "default": false },
    { "type": "range", "id": "media_ratio", "label": "Image ratio (height / width)", "min": 0.4, "max": 1.4, "step": 0.1, "default": 0.7 },

    { "type": "header", "content": "Content" },
    { "type": "text", "id": "eyebrow", "label": "Eyebrow", "default": "Editor's Pick" },
    { "type": "text", "id": "headline", "label": "Headline", "default": "Sleep better tonight" },
    { "type": "textarea", "id": "subheading", "label": "Subheading", "default": "Clinically proven cooling foam keeps you comfortable." },
    { "type": "text", "id": "microcopy", "label": "Microcopy", "default": "Free 30-day returns. Fast shipping." },

    { "type": "header", "content": "Pricing" },
    { "type": "checkbox", "id": "show_price", "label": "Show price", "default": true },
    { "type": "checkbox", "id": "show_compare", "label": "Show compare price", "default": true },

    { "type": "header", "content": "Actions" },
    { "type": "select", "id": "primary_cta_type", "label": "Primary action", "default": "add", "options": [
      { "value": "add", "label": "Add to cart" },
      { "value": "buy", "label": "Buy now" },
      { "value": "view", "label": "View product" }
    ]},
    { "type": "text", "id": "primary_label", "label": "Primary label", "default": "Shop Now" },
    { "type": "text", "id": "secondary_label", "label": "Secondary label" },
    { "type": "url", "id": "secondary_url", "label": "Secondary link" },

    { "type": "header", "content": "Mobile Sticky CTA" },
    { "type": "checkbox", "id": "sticky_mobile_cta", "label": "Enable sticky CTA", "default": true },

    { "type": "header", "content": "Spacing" },
    { "type": "range", "id": "pad_top", "label": "Padding top (×100rem)", "min": 0, "max": 96, "step": 2, "default": 32 },
    { "type": "range", "id": "pad_bottom", "label": "Padding bottom (×100rem)", "min": 0, "max": 96, "step": 2, "default": 32 },
    { "type": "text", "id": "anchor_id", "label": "Anchor ID" }
  ],
  "presets": [
    { "name": "Featured Product (Slideshow)", "category": "Call to Action", "settings": { "layout": "slideshow" } }
  ]
}
{% endschema %}
