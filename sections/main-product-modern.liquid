{%- comment -%}
  Quadratum — Main Product Modern (Standalone / No Snippet Dependencies)
  File: sections/main-product-modern.liquid

  PURPOSE
  - Dawn-like editor experience (settings + blocks) WITHOUT Dawn snippet dependencies.
  - Keep existing simple media gallery + lightbox.
  - Rebuild "Dawn feel" via blocks: title, price, variant picker, quantity, buy buttons,
    plus accordion blocks (description, metafield, custom text, and @app blocks).

  KEY NOTES
  - Variant logic updates: price / compare / sku / availability / ATC + URL + featured image.
  - Under-ATC content is controlled by section setting:
      none | description | short metafield
  - Accordion content is controlled by blocks:
      accordion_description, accordion_metafield, accordion_custom, and @app (rendered inside accordion)
  - No schema properties on @app blocks except: { "type": "@app" }

{%- endcomment -%}

{%- liquid
  assign p = product
  if p == blank
    break
  endif

  assign s = section.settings

  assign current_variant = p.selected_or_first_available_variant
  if current_variant == blank
    assign current_variant = p.variants.first
  endif

  assign section_aria = s.section_aria_label
  if section_aria == blank
    assign section_aria = 'Product details'
  endif

  assign padding_top_mobile = s.padding_top | times: 0.75 | round: 0
  assign padding_bottom_mobile = s.padding_bottom | times: 0.75 | round: 0

  assign image_media = p.media | where: 'media_type', 'image'
  assign featured = p.selected_or_first_available_variant.featured_media | default: p.featured_media
  assign featured_src = ''
  assign featured_alt = ''
  if featured and featured.media_type == 'image'
    assign featured_src = featured | image_url: width: 1600
    assign featured_alt = featured.alt
  elsif image_media.first
    assign featured_src = image_media.first | image_url: width: 1600
    assign featured_alt = image_media.first.alt
  endif

  assign product_form_id = 'product-form-' | append: section.id
-%}

<section
  id="MainProductModern-{{ section.id }}"
  class="qtm-modern section-{{ section.id }}-padding color-{{ s.color_scheme }} gradient{% if s.media_position == 'right' %} qtm-modern--media-right{% else %} qtm-modern--media-left{% endif %}"
  aria-label="{{ section_aria | escape }}"
  data-section-id="{{ section.id }}"
  data-product-id="{{ p.id }}"
>
  <style>
    .section-{{ section.id }}-padding { padding-top: {{ padding_top_mobile }}px; padding-bottom: {{ padding_bottom_mobile }}px; }
    @media (min-width: 750px){
      .section-{{ section.id }}-padding { padding-top: {{ s.padding_top }}px; padding-bottom: {{ s.padding_bottom }}px; }
    }

    /* Layout */
    #MainProductModern-{{ section.id }} .qtm-modern__grid{
      display:grid;
      gap: 2.5rem;
      align-items:start;
    }
    @media (min-width: 990px){
      #MainProductModern-{{ section.id }} .qtm-modern__grid{
        grid-template-columns: 1.05fr 0.95fr;
      }
      #MainProductModern-{{ section.id }}.qtm-modern--media-right .qtm-modern__media { order: 2; }
      #MainProductModern-{{ section.id }}.qtm-modern--media-right .qtm-modern__info { order: 1; }
    }

    /* Media */
    #MainProductModern-{{ section.id }} .qtm-modern__main-media{
      position:relative;
      border-radius: 12px;
      overflow:hidden;
      background: rgba(0,0,0,0.03);
    }
    #MainProductModern-{{ section.id }} .qtm-modern__main-media img{
      display:block;
      width:100%;
      height:auto;
    }
    #MainProductModern-{{ section.id }} .qtm-modern__zoom-btn{
      position:absolute;
      inset:auto 0 0 0;
      width:100%;
      background: rgba(0,0,0,0.55);
      color:#fff;
      border:0;
      padding: .85rem 1rem;
      cursor:pointer;
      font-weight:600;
      text-align:center;
    }
    #MainProductModern-{{ section.id }} .qtm-modern__thumbs{
      display:flex;
      gap:.6rem;
      flex-wrap:wrap;
      margin-top:.75rem;
    }
    #MainProductModern-{{ section.id }} .qtm-modern__thumb{
      width:72px;
      height:72px;
      border-radius: 10px;
      overflow:hidden;
      border: 1px solid rgba(0,0,0,0.12);
      padding:0;
      background:#fff;
      cursor:pointer;
    }
    #MainProductModern-{{ section.id }} .qtm-modern__thumb[aria-current="true"]{
      outline: 2px solid currentColor;
      outline-offset: 2px;
    }
    #MainProductModern-{{ section.id }} .qtm-modern__thumb img{
      width:100%;
      height:100%;
      object-fit:cover;
      display:block;
    }

    /* Info */
    #MainProductModern-{{ section.id }} .qtm-modern__title{ margin: 0 0 .5rem; }
    #MainProductModern-{{ section.id }} .qtm-modern__price{
      display:flex;
      gap:.75rem;
      align-items:baseline;
      margin: .75rem 0 1rem;
    }
    #MainProductModern-{{ section.id }} .qtm-modern__compare{ text-decoration: line-through; opacity:.6; }
    #MainProductModern-{{ section.id }} .qtm-modern__current{ font-weight:700; font-size: 1.35rem; }
    #MainProductModern-{{ section.id }} .qtm-modern__meta{
      display:flex;
      flex-wrap:wrap;
      gap: .75rem 1.25rem;
      opacity: .85;
      font-size: .95rem;
      margin-bottom: 1rem;
    }
    #MainProductModern-{{ section.id }} .qtm-modern__form{
      display:grid;
      gap: 1rem;
      margin-top: 1rem;
    }
    #MainProductModern-{{ section.id }} .qtm-modern__option label{
      display:block;
      font-weight:600;
      margin-bottom:.35rem;
    }
    #MainProductModern-{{ section.id }} .qtm-modern__radios{
      display:flex;
      flex-wrap:wrap;
      gap:.5rem;
    }
    #MainProductModern-{{ section.id }} .qtm-modern__radios input{ position:absolute; opacity:0; pointer-events:none; }
    #MainProductModern-{{ section.id }} .qtm-modern__radios label{
      border: 1px solid rgba(0,0,0,0.18);
      border-radius: 999px;
      padding: .55rem .85rem;
      cursor:pointer;
      user-select:none;
      margin:0;
      font-weight:600;
      background:#fff;
    }
    #MainProductModern-{{ section.id }} .qtm-modern__radios input:checked + label{
      outline:2px solid currentColor;
      outline-offset:2px;
    }
    #MainProductModern-{{ section.id }} .qtm-modern__radios input:disabled + label{
      opacity:.45;
      cursor:not-allowed;
    }
    #MainProductModern-{{ section.id }} .qtm-modern__select{
      width:100%;
      padding:.65rem .8rem;
      border-radius: 12px;
      border:1px solid rgba(0,0,0,0.18);
      background:#fff;
    }
    #MainProductModern-{{ section.id }} .qtm-modern__qty input{
      width: 110px;
      padding: .6rem .7rem;
    }
    #MainProductModern-{{ section.id }} .qtm-modern__atc{
      padding: 1rem 1.1rem;
      font-weight: 700;
      border:0;
      border-radius: 12px;
      cursor:pointer;
    }
    #MainProductModern-{{ section.id }} .qtm-modern__atc[disabled]{ opacity:.55; cursor:not-allowed; }

    /* Under ATC */
    #MainProductModern-{{ section.id }} .qtm-modern__under-atc{
      margin-top: 1.1rem;
    }

    /* Accordion */
    #MainProductModern-{{ section.id }} .qtm-modern__accordion{
      margin-top: 1.25rem;
      display:grid;
      gap:.75rem;
    }
    #MainProductModern-{{ section.id }} .qtm-modern__accordion details{
      border: 1px solid rgba(0,0,0,0.12);
      border-radius: 12px;
      padding: .75rem 1rem;
      background: rgba(255,255,255,0.65);
    }
    #MainProductModern-{{ section.id }} .qtm-modern__accordion summary{
      cursor:pointer;
      font-weight:700;
      list-style:none;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:1rem;
    }
    #MainProductModern-{{ section.id }} .qtm-modern__accordion summary::-webkit-details-marker{ display:none; }
    #MainProductModern-{{ section.id }} .qtm-modern__accordion .qtm-modern__accordion-content{
      margin-top:.75rem;
    }

    /* Modal */
    #MainProductModern-{{ section.id }} dialog.qtm-modern__modal{
      width:min(980px, 96vw);
      border:0;
      border-radius: 14px;
      padding:0;
      overflow:hidden;
    }
    #MainProductModern-{{ section.id }} dialog.qtm-modern__modal::backdrop{
      background: rgba(0,0,0,0.7);
    }
    #MainProductModern-{{ section.id }} .qtm-modern__modal-head{
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding: .75rem 1rem;
      background: rgba(0,0,0,0.85);
      color:#fff;
    }
    #MainProductModern-{{ section.id }} .qtm-modern__modal-close{
      border:0;
      background: transparent;
      color:#fff;
      font-size: 1.15rem;
      font-weight:800;
      cursor:pointer;
    }
    #MainProductModern-{{ section.id }} .qtm-modern__modal-body{
      position:relative;
      background:#000;
    }
    #MainProductModern-{{ section.id }} .qtm-modern__modal-body img{
      display:block;
      width:100%;
      height:auto;
    }
    #MainProductModern-{{ section.id }} .qtm-modern__modal-nav{
      position:absolute;
      inset:0;
      display:flex;
      justify-content:space-between;
      align-items:center;
      pointer-events:none;
      padding: 0 .5rem;
    }
    #MainProductModern-{{ section.id }} .qtm-modern__modal-nav button{
      pointer-events:auto;
      border:0;
      width:44px;
      height:44px;
      border-radius: 999px;
      background: rgba(255,255,255,0.18);
      color:#fff;
      font-weight:900;
      cursor:pointer;
    }
  </style>

  <div class="page-width">
    <div class="qtm-modern__grid">

      {%- comment -%} ================= MEDIA ================= {%- endcomment -%}
      <div class="qtm-modern__media">
        <div class="qtm-modern__main-media">
          <img
            id="QtmMainImage-{{ section.id }}"
            src="{{ featured_src }}"
            alt="{{ featured_alt | escape }}"
            loading="eager"
          >

          {%- if s.image_zoom == 'lightbox' -%}
            <button
              type="button"
              class="qtm-modern__zoom-btn"
              data-qtm-open-modal
              aria-haspopup="dialog"
            >
              View larger
            </button>
          {%- endif -%}
        </div>

        {%- if image_media.size > 1 -%}
          <div class="qtm-modern__thumbs" aria-label="Product images">
            {%- for m in image_media -%}
              {%- assign thumb_src = m | image_url: width: 240 -%}
              {%- assign full_src = m | image_url: width: 1600 -%}
              <button
                type="button"
                class="qtm-modern__thumb"
                data-qtm-image="{{ full_src }}"
                data-qtm-index="{{ forloop.index0 }}"
                aria-current="{% if full_src == featured_src %}true{% else %}false{% endif %}"
              >
                <img src="{{ thumb_src }}" alt="{{ m.alt | escape }}" loading="lazy">
              </button>
            {%- endfor -%}
          </div>
        {%- endif -%}
      </div>

      {%- comment -%} ================= INFO (BLOCK-DRIVEN) ================= {%- endcomment -%}
      <div class="qtm-modern__info">

        {%- comment -%}
          Product form wrapper: we keep ONE form and blocks render inside it as needed.
        {%- endcomment -%}
        <form
          id="{{ product_form_id }}"
          class="qtm-modern__form"
          method="post"
          action="{{ routes.cart_add_url }}"
          enctype="multipart/form-data"
        >
          <input type="hidden" name="id" id="QtmVariantId-{{ section.id }}" value="{{ current_variant.id }}">
          <input type="hidden" name="quantity" id="QtmQtyHidden-{{ section.id }}" value="1">

          {%- comment -%} Render standard (non-accordion) blocks {%- endcomment -%}
          {%- for block in section.blocks -%}
            {%- case block.type -%}

              {%- when 'title' -%}
                <div {{ block.shopify_attributes }}>
                  <h1 class="qtm-modern__title">{{ p.title | escape }}</h1>
                </div>

              {%- when 'price' -%}
                <div {{ block.shopify_attributes }}>
                  <div class="qtm-modern__price" id="QtmPriceWrap-{{ section.id }}">
                    <span
                      class="qtm-modern__compare"
                      id="QtmCompare-{{ section.id }}"
                      {% unless current_variant.compare_at_price > current_variant.price %}style="display:none"{% endunless %}
                    >
                      {{ current_variant.compare_at_price | money }}
                    </span>
                    <span class="qtm-modern__current" id="QtmPrice-{{ section.id }}">
                      {{ current_variant.price | money }}
                    </span>
                  </div>

                  {%- if block.settings.show_meta -%}
                    <div class="qtm-modern__meta">
                      <span id="QtmSkuWrap-{{ section.id }}" {% if current_variant.sku == blank %}style="display:none"{% endif %}>
                        <strong>SKU:</strong> <span id="QtmSku-{{ section.id }}">{{ current_variant.sku }}</span>
                      </span>
                      <span id="QtmAvail-{{ section.id }}">
                        <strong>Status:</strong>
                        <span id="QtmAvailText-{{ section.id }}">
                          {% if current_variant.available %}In stock{% else %}Sold out{% endif %}
                        </span>
                      </span>
                    </div>
                  {%- endif -%}
                </div>

              {%- when 'variant_picker' -%}
                <div {{ block.shopify_attributes }}>
                  {%- unless p.has_only_default_variant -%}
                    {%- for option in p.options_with_values -%}
                      <div class="qtm-modern__option" data-qtm-option data-index="{{ option.position }}">
                        <label>{{ option.name | escape }}</label>

                        {%- if block.settings.picker_type == 'dropdown' -%}
                          <select class="qtm-modern__select" name="qtm-option-{{ option.position }}">
                            {%- for value in option.values -%}
                              <option value="{{ value | escape }}" {% if value.selected %}selected{% endif %}>
                                {{ value }}
                              </option>
                            {%- endfor -%}
                          </select>
                        {%- else -%}
                          <div class="qtm-modern__radios" role="radiogroup" aria-label="{{ option.name | escape }}">
                            {%- for value in option.values -%}
                              {%- capture input_id -%}QtmOpt-{{ section.id }}-{{ option.position }}-{{ forloop.index0 }}{%- endcapture -%}
                              <input
                                type="radio"
                                id="{{ input_id }}"
                                name="qtm-option-{{ option.position }}"
                                value="{{ value | escape }}"
                                {% if value.selected %}checked{% endif %}
                              >
                              <label for="{{ input_id }}">{{ value }}</label>
                            {%- endfor -%}
                          </div>
                        {%- endif -%}
                      </div>
                    {%- endfor -%}
                  {%- endunless -%}
                </div>

              {%- when 'quantity_selector' -%}
                <div class="qtm-modern__qty" {{ block.shopify_attributes }}>
                  <label for="QtmQty-{{ section.id }}">{{ block.settings.label | escape }}</label>
                  <input
                    id="QtmQty-{{ section.id }}"
                    type="number"
                    min="1"
                    value="1"
                  >
                </div>

              {%- when 'buy_buttons' -%}
                <div {{ block.shopify_attributes }}>
                  <button
                    type="submit"
                    class="qtm-modern__atc"
                    id="QtmAtc-{{ section.id }}"
                    {% unless current_variant.available %}disabled{% endunless %}
                  >
                    {% if current_variant.available %}{{ block.settings.atc_label | escape }}{% else %}Sold out{% endif %}
                  </button>

                  {%- if block.settings.show_dynamic_checkout -%}
                    {%- comment -%}
                      Standalone dynamic checkout: use a SECOND product form.
                      This is the simplest safe approach without Dawn's product-form component.
                    {%- endcomment -%}
                    {%- form 'product', p, id: 'QtmDyn-' | append: section.id -%}
                      <input type="hidden" name="id" value="{{ current_variant.id }}">
                      {{ form | payment_button }}
                    {%- endform -%}
                  {%- endif -%}
                </div>

              {%- else -%}
                {%- comment -%} Ignore other blocks here; accordions render after form. {%- endcomment -%}
            {%- endcase -%}
          {%- endfor -%}

        </form>

        {%- comment -%} Under-ATC content (section-level setting) {%- endcomment -%}
        {%- if s.under_atc_content != 'none' -%}
          <div class="qtm-modern__under-atc rte">
            {%- if s.under_atc_content == 'description' -%}
              {{ p.description }}
            {%- elsif s.under_atc_content == 'short_metafield' -%}
              {%- assign short_desc = p.metafields[s.short_description_metafield_namespace][s.short_description_metafield_key] -%}
              {%- if short_desc != blank -%}
                {{ short_desc | metafield_tag }}
              {%- endif -%}
            {%- endif -%}
          </div>
        {%- endif -%}

        {%- comment -%} Accordion blocks (no tabs) {%- endcomment -%}
        {%- assign has_accordion = false -%}
        {%- for block in section.blocks -%}
          {%- if block.type contains 'accordion_' or block.type == '@app' -%}
            {%- assign has_accordion = true -%}
          {%- endif -%}
        {%- endfor -%}

        {%- if has_accordion -%}
          <div class="qtm-modern__accordion" aria-label="Product information accordions">
            {%- for block in section.blocks -%}
              {%- case block.type -%}

                {%- when 'accordion_description' -%}
                  {%- if p.description != blank -%}
                    <details {% if block.settings.open_by_default %}open{% endif %} {{ block.shopify_attributes }}>
                      <summary>
                        <span>{{ block.settings.heading | escape }}</span>
                        <span aria-hidden="true">+</span>
                      </summary>
                      <div class="qtm-modern__accordion-content rte">
                        {{ p.description }}
                      </div>
                    </details>
                  {%- endif -%}

                {%- when 'accordion_metafield' -%}
                  {%- assign mf = p.metafields[block.settings.metafield_namespace][block.settings.metafield_key] -%}
                  {%- if mf != blank -%}
                    <details {% if block.settings.open_by_default %}open{% endif %} {{ block.shopify_attributes }}>
                      <summary>
                        <span>{{ block.settings.heading | escape }}</span>
                        <span aria-hidden="true">+</span>
                      </summary>
                      <div class="qtm-modern__accordion-content rte">
                        {{ mf | metafield_tag }}
                      </div>
                    </details>
                  {%- endif -%}

                {%- when 'accordion_custom' -%}
                  {%- if block.settings.content != blank -%}
                    <details {% if block.settings.open_by_default %}open{% endif %} {{ block.shopify_attributes }}>
                      <summary>
                        <span>{{ block.settings.heading | escape }}</span>
                        <span aria-hidden="true">+</span>
                      </summary>
                      <div class="qtm-modern__accordion-content rte">
                        {{ block.settings.content }}
                      </div>
                    </details>
                  {%- endif -%}

                {%- when '@app' -%}
                  {%- comment -%}
                    IMPORTANT:
                    - Do NOT add "name" or other attributes inside an @app block schema.
                    - Shopify provides the actual app block UI.
                    - Here we wrap whatever it renders in our accordion shell.
                  {%- endcomment -%}
                  <details {{ block.shopify_attributes }}>
                    <summary>
                      <span>{{ s.app_block_default_heading | escape }}</span>
                      <span aria-hidden="true">+</span>
                    </summary>
                    <div class="qtm-modern__accordion-content">
                      {% render block %}
                    </div>
                  </details>

              {%- endcase -%}
            {%- endfor -%}
          </div>
        {%- endif -%}

      </div>
    </div>
  </div>

  {%- comment -%} ================= LIGHTBOX MODAL ================= {%- endcomment -%}
  {%- if s.image_zoom == 'lightbox' -%}
    <dialog class="qtm-modern__modal" id="QtmModal-{{ section.id }}" aria-label="Product images">
      <div class="qtm-modern__modal-head">
        <div style="font-weight:800;">{{ p.title | escape }}</div>
        <button type="button" class="qtm-modern__modal-close" data-qtm-close-modal aria-label="Close">✕</button>
      </div>
      <div class="qtm-modern__modal-body">
        <img id="QtmModalImg-{{ section.id }}" src="{{ featured_src }}" alt="{{ featured_alt | escape }}">
        <div class="qtm-modern__modal-nav">
          <button type="button" data-qtm-prev aria-label="Previous">‹</button>
          <button type="button" data-qtm-next aria-label="Next">›</button>
        </div>
      </div>
    </dialog>
  {%- endif -%}

  {%- comment -%} ================= PRODUCT JSON ================= {%- endcomment -%}
  <script type="application/json" id="QtmProductJson-{{ section.id }}">
    {{ p | json }}
  </script>

  <script>
    (function(){
      var root = document.getElementById('MainProductModern-{{ section.id }}');
      if (!root) return;

      var product = JSON.parse(document.getElementById('QtmProductJson-{{ section.id }}').textContent);
      var variants = product.variants || [];

      var mainImg = document.getElementById('QtmMainImage-{{ section.id }}');
      var thumbs = root.querySelectorAll('.qtm-modern__thumb');

      // Lightbox
      var modal = document.getElementById('QtmModal-{{ section.id }}');
      var modalImg = document.getElementById('QtmModalImg-{{ section.id }}');

      var openBtn = root.querySelector('[data-qtm-open-modal]');
      var closeBtn = root.querySelector('[data-qtm-close-modal]');
      var prevBtn = root.querySelector('[data-qtm-prev]');
      var nextBtn = root.querySelector('[data-qtm-next]');

      var currentIndex = 0;

      function setActiveThumb(idx){
        thumbs.forEach(function(t){ t.setAttribute('aria-current','false'); });
        if (thumbs[idx]) thumbs[idx].setAttribute('aria-current','true');
      }

      function setImageByIndex(idx){
        if (!thumbs.length) return;
        var btn = thumbs[idx];
        if (!btn) return;
        currentIndex = idx;
        var src = btn.getAttribute('data-qtm-image');
        if (src && mainImg) mainImg.src = src;
        if (src && modalImg) modalImg.src = src;
        setActiveThumb(idx);
      }

      thumbs.forEach(function(btn){
        btn.addEventListener('click', function(){
          var idx = parseInt(btn.getAttribute('data-qtm-index'), 10) || 0;
          setImageByIndex(idx);
        });
      });

      if (openBtn && modal){
        openBtn.addEventListener('click', function(){
          if (modal.showModal) modal.showModal();
        });
      }
      if (closeBtn && modal){
        closeBtn.addEventListener('click', function(){ modal.close(); });
      }
      if (modal){
        modal.addEventListener('click', function(e){
          // click outside the dialog closes (best-effort)
          if (e.target === modal) modal.close();
        });
      }

      function prev(){
        if (!thumbs.length) return;
        var idx = currentIndex - 1;
        if (idx < 0) idx = thumbs.length - 1;
        setImageByIndex(idx);
      }
      function next(){
        if (!thumbs.length) return;
        var idx = currentIndex + 1;
        if (idx >= thumbs.length) idx = 0;
        setImageByIndex(idx);
      }
      if (prevBtn) prevBtn.addEventListener('click', prev);
      if (nextBtn) nextBtn.addEventListener('click', next);

      // Variant selection -> updates price/sku/availability + hidden variant id
      var variantIdInput = document.getElementById('QtmVariantId-{{ section.id }}');
      var priceEl = document.getElementById('QtmPrice-{{ section.id }}');
      var compareEl = document.getElementById('QtmCompare-{{ section.id }}');
      var skuWrap = document.getElementById('QtmSkuWrap-{{ section.id }}');
      var skuEl = document.getElementById('QtmSku-{{ section.id }}');
      var availText = document.getElementById('QtmAvailText-{{ section.id }}');
      var atcBtn = document.getElementById('QtmAtc-{{ section.id }}');

      var qtyInput = document.getElementById('QtmQty-{{ section.id }}');
      var qtyHidden = document.getElementById('QtmQtyHidden-{{ section.id }}');

      if (qtyInput && qtyHidden){
        qtyInput.addEventListener('input', function(){
          var v = parseInt(qtyInput.value, 10);
          if (!v || v < 1) v = 1;
          qtyHidden.value = String(v);
        });
      }

      function formatMoney(cents){
        try{
          return new Intl.NumberFormat(undefined, { style: 'currency', currency: '{{ cart.currency.iso_code | default: "USD" }}' }).format(cents/100);
        }catch(e){
          return '$' + (cents/100).toFixed(2);
        }
      }

      function getSelectedOptions(){
        var selections = [];
        var optionGroups = root.querySelectorAll('[data-qtm-option]');
        optionGroups.forEach(function(group){
          var radios = group.querySelectorAll('input[type="radio"]');
          if (radios.length){
            var checked = group.querySelector('input[type="radio"]:checked');
            selections.push(checked ? checked.value : '');
          } else {
            var select = group.querySelector('select');
            selections.push(select ? select.value : '');
          }
        });
        return selections;
      }

      function findVariantByOptions(opts){
        return variants.find(function(v){
          if (!v || !v.options) return false;
          for (var i=0; i<opts.length; i++){
            if (v.options[i] !== opts[i]) return false;
          }
          return true;
        }) || null;
      }

      function applyVariant(v){
        if (!v) return;

        if (variantIdInput) variantIdInput.value = v.id;

        if (priceEl) priceEl.textContent = formatMoney(v.price);

        if (compareEl){
          if (v.compare_at_price && v.compare_at_price > v.price){
            compareEl.style.display = '';
            compareEl.textContent = formatMoney(v.compare_at_price);
          } else {
            compareEl.style.display = 'none';
          }
        }

        if (skuWrap && skuEl){
          if (v.sku){
            skuWrap.style.display = '';
            skuEl.textContent = v.sku;
          } else {
            skuWrap.style.display = 'none';
          }
        }

        if (availText && atcBtn){
          if (v.available){
            availText.textContent = 'In stock';
            atcBtn.disabled = false;
            atcBtn.textContent = '{{ section.settings.atc_default_label | escape }}';
          } else {
            availText.textContent = 'Sold out';
            atcBtn.disabled = true;
            atcBtn.textContent = 'Sold out';
          }
        }

        // If variant has featured image, try to switch main image
        if (v.featured_image && v.featured_image.src && mainImg){
          mainImg.src = v.featured_image.src;
          if (modalImg) modalImg.src = v.featured_image.src;

          thumbs.forEach(function(t, idx){
            var src = t.getAttribute('data-qtm-image');
            if (src && src.indexOf(v.featured_image.src) !== -1){
              currentIndex = idx;
              setActiveThumb(idx);
            }
          });
        }

        // Update URL with variant param
        try{
          var url = new URL(window.location.href);
          url.searchParams.set('variant', v.id);
          window.history.replaceState({}, '', url.toString());
        }catch(e){}
      }

      root.addEventListener('change', function(e){
        if (!e.target) return;
        if (e.target.name && e.target.name.indexOf('qtm-option-') === 0){
          var opts = getSelectedOptions();
          var v = findVariantByOptions(opts);
          applyVariant(v);
        }
      });

      // Initialize currentIndex from aria-current
      thumbs.forEach(function(t, idx){
        if (t.getAttribute('aria-current') === 'true') currentIndex = idx;
      });

    })();
  </script>

</section>

{% schema %}
{
  "name": "Main Product — Modern",
  "tag": "section",
  "class": "section",
  "settings": [
    {
      "type": "text",
      "id": "section_aria_label",
      "label": "Section ARIA label",
      "default": "Product details"
    },
    {
      "type": "color_scheme",
      "id": "color_scheme",
      "label": "Color scheme",
      "default": "scheme-1"
    },
    {
      "type": "select",
      "id": "media_position",
      "options": [
        { "value": "left", "label": "Media left" },
        { "value": "right", "label": "Media right" }
      ],
      "default": "left",
      "label": "Media position"
    },
    {
      "type": "select",
      "id": "image_zoom",
      "options": [
        { "value": "lightbox", "label": "Lightbox" },
        { "value": "none", "label": "None" }
      ],
      "default": "lightbox",
      "label": "Image zoom"
    },
    {
      "type": "header",
      "content": "Under Add to Cart"
    },
    {
      "type": "select",
      "id": "under_atc_content",
      "label": "Content below Add to cart",
      "default": "none",
      "options": [
        { "value": "none", "label": "None" },
        { "value": "description", "label": "Product description" },
        { "value": "short_metafield", "label": "Short description metafield" }
      ]
    },
    {
      "type": "text",
      "id": "short_description_metafield_namespace",
      "label": "Short description metafield namespace",
      "default": "custom"
    },
    {
      "type": "text",
      "id": "short_description_metafield_key",
      "label": "Short description metafield key",
      "default": "short_description"
    },
    {
      "type": "text",
      "id": "app_block_default_heading",
      "label": "Default heading for app accordion blocks",
      "default": "Reviews"
    },
    {
      "type": "text",
      "id": "atc_default_label",
      "label": "Default Add to cart label (JS fallback)",
      "default": "Add to cart"
    },
    {
      "type": "header",
      "content": "Spacing"
    },
    {
      "type": "range",
      "id": "padding_top",
      "min": 0,
      "max": 100,
      "step": 4,
      "unit": "px",
      "label": "Padding top",
      "default": 36
    },
    {
      "type": "range",
      "id": "padding_bottom",
      "min": 0,
      "max": 100,
      "step": 4,
      "unit": "px",
      "label": "Padding bottom",
      "default": 36
    }
  ],
  "blocks": [
    {
      "type": "title",
      "name": "Title",
      "limit": 1
    },
    {
      "type": "price",
      "name": "Price",
      "limit": 1,
      "settings": [
        {
          "type": "checkbox",
          "id": "show_meta",
          "label": "Show SKU + availability",
          "default": true
        }
      ]
    },
    {
      "type": "variant_picker",
      "name": "Variant picker",
      "limit": 1,
      "settings": [
        {
          "type": "select",
          "id": "picker_type",
          "label": "Picker type",
          "default": "button",
          "options": [
            { "value": "button", "label": "Buttons" },
            { "value": "dropdown", "label": "Dropdown" }
          ]
        }
      ]
    },
    {
      "type": "quantity_selector",
      "name": "Quantity selector",
      "limit": 1,
      "settings": [
        {
          "type": "text",
          "id": "label",
          "label": "Label",
          "default": "Quantity"
        }
      ]
    },
    {
      "type": "buy_buttons",
      "name": "Buy buttons",
      "limit": 1,
      "settings": [
        {
          "type": "text",
          "id": "atc_label",
          "label": "Add to cart label",
          "default": "Add to cart"
        },
        {
          "type": "checkbox",
          "id": "show_dynamic_checkout",
          "label": "Show dynamic checkout button",
          "default": false
        }
      ]
    },
    {
      "type": "accordion_description",
      "name": "Accordion — Description",
      "settings": [
        {
          "type": "text",
          "id": "heading",
          "label": "Heading",
          "default": "Product description"
        },
        {
          "type": "checkbox",
          "id": "open_by_default",
          "label": "Open by default",
          "default": true
        }
      ]
    },
    {
      "type": "accordion_metafield",
      "name": "Accordion — Metafield",
      "settings": [
        {
          "type": "text",
          "id": "heading",
          "label": "Heading",
          "default": "Details"
        },
        {
          "type": "text",
          "id": "metafield_namespace",
          "label": "Metafield namespace",
          "default": "custom"
        },
        {
          "type": "text",
          "id": "metafield_key",
          "label": "Metafield key",
          "default": "details"
        },
        {
          "type": "checkbox",
          "id": "open_by_default",
          "label": "Open by default",
          "default": false
        }
      ]
    },
    {
      "type": "accordion_custom",
      "name": "Accordion — Custom",
      "settings": [
        {
          "type": "text",
          "id": "heading",
          "label": "Heading",
          "default": "More info"
        },
        {
          "type": "richtext",
          "id": "content",
          "label": "Content",
          "default": "<p>Add your content here.</p>"
        },
        {
          "type": "checkbox",
          "id": "open_by_default",
          "label": "Open by default",
          "default": false
        }
      ]
    },
    {
      "type": "@app"
    }
  ],
  "presets": [
    {
      "name": "Main Product — Modern",
      "blocks": [
        { "type": "title" },
        { "type": "price" },
        { "type": "variant_picker" },
        { "type": "quantity_selector" },
        { "type": "buy_buttons" },
        { "type": "accordion_description" },
        { "type": "accordion_metafield" }
      ]
    }
  ]
}
{% endschema %}
