{%- comment -%}
  SECTION: product-cross-sell.liquid
  Role: Related / complementary products near bottom of PDP.

  Modes:
  - manual (blocks)
  - collection
  - dynamic (Shopify recommendations JSON) with fallback

  Rendering: MUST use product-card snippet. No inline product markup.
  Styling: Section-level CSS targets common card selectors and/or your theme's card classes.
{%- endcomment -%}

{%- liquid
  assign s = section.settings
  assign p = product
  if p == blank
    break
  endif

  assign mode = s.mode | default: 'dynamic'
  assign layout = s.layout | default: 'grid'
  assign max_products = s.max_products | default: 4

  assign cols_desktop = s.columns_desktop | default: 4
  assign cols_tablet  = s.columns_tablet  | default: 2
  assign cols_mobile  = s.columns_mobile | default: '1' | plus: 0

  assign current_id = p.id
  assign c = s.collection

  # Determine if we can render anything server-side (for non-dynamic)
  assign has_manual = false
  for block in section.blocks
    if block.type == 'product_reference' and block.settings.product != blank
      assign bp = block.settings.product
      if bp.id != current_id and bp.available
        assign has_manual = true
        break
      endif
    endif
  endfor

  assign has_collection = false
  if c != blank
    for cp in c.products
      if cp != blank and cp.id != current_id and cp.available
        assign has_collection = true
        break
      endif
    endfor
  endif

  assign should_render = false
  if mode == 'dynamic'
    assign should_render = true
  elsif mode == 'collection' and has_collection
    assign should_render = true
  elsif mode == 'manual' and has_manual
    assign should_render = true
  endif

  if should_render == false
    break
  endif

  # Grid vars
  assign grid_style = ''
  if layout == 'grid'
    assign grid_style = ' --q-cols-desktop:' | append: cols_desktop | append: '; --q-cols-tablet:' | append: cols_tablet | append: '; --q-cols-mobile:' | append: cols_mobile | append: ';'
  endif

  # Card style vars
  assign card_border_width = s.card_border_width | default: 1
  assign card_radius = s.card_radius | default: 12
  assign card_padding = s.card_padding | default: 0
  assign card_shadow = s.card_shadow | default: 'none'
  assign card_text_align = s.card_text_align | default: 'left'

  assign image_radius = s.image_radius | default: 12
  assign image_aspect = s.image_aspect | default: '1 / 1'

  assign title_size = s.title_size | default: 16
  assign title_weight = s.title_weight | default: 600

  assign price_size = s.price_size | default: 14
  assign price_weight = s.price_weight | default: 600

  assign btn_radius = s.button_radius | default: 12
  assign btn_padding_y = s.button_padding_y | default: 12
  assign btn_padding_x = s.button_padding_x | default: 16

  assign override_label = s.override_button_label
  assign button_label_text = s.button_label_text
-%}

<section
  id="product-cross-sell"
  class="q-product-cross-sell"
  data-mode="{{ mode }}"
  data-layout="{{ layout }}"
>
  <div class="q-product-cross-sell__inner">

    {%- if s.title != blank -%}
      <h2 class="q-product-cross-sell__title">{{ s.title }}</h2>
    {%- endif -%}

    {%- if s.subheading != blank -%}
      <div class="q-product-cross-sell__subheading rte">
        {{ s.subheading }}
      </div>
    {%- endif -%}

    <div
      class="q-product-cross-sell__products q-product-cross-sell__products--{{ layout }}"
      style="{{ grid_style }}"
      data-products-container
      data-current-id="{{ current_id }}"
      data-max="{{ max_products }}"
    >
      {%- if mode != 'dynamic' -%}
        {%- liquid
          assign rendered = 0
          assign seen_ids = ''
        -%}

        {%- if mode == 'collection' and c != blank -%}
          {%- for cp in c.products -%}
            {%- if cp != blank and cp.id != current_id and cp.available -%}
              {%- assign id_token = '|' | append: cp.id | append: '|' -%}
              {%- unless seen_ids contains id_token -%}
                {%- assign seen_ids = seen_ids | append: id_token -%}
                {% render 'product-card', product: cp %}
                {%- assign rendered = rendered | plus: 1 -%}
                {%- if rendered >= max_products -%}{%- break -%}{%- endif -%}
              {%- endunless -%}
            {%- endif -%}
          {%- endfor -%}
        {%- elsif mode == 'manual' -%}
          {%- for block in section.blocks -%}
            {%- if block.type == 'product_reference' -%}
              {%- assign bp = block.settings.product -%}
              {%- if bp != blank and bp.id != current_id and bp.available -%}
                {%- assign id_token = '|' | append: bp.id | append: '|' -%}
                {%- unless seen_ids contains id_token -%}
                  {%- assign seen_ids = seen_ids | append: id_token -%}
                  {% render 'product-card', product: bp %}
                  {%- assign rendered = rendered | plus: 1 -%}
                  {%- if rendered >= max_products -%}{%- break -%}{%- endif -%}
                {%- endunless -%}
              {%- endif -%}
            {%- endif -%}
          {%- endfor -%}
        {%- endif -%}

        {%- if rendered == 0 -%}
          {%- comment -%} No products resolved => render nothing {%- endcomment -%}
          {%- break -%}
        {%- endif -%}
      {%- endif -%}
    </div>

    {%- comment -%}
      Hidden fallback markup for Dynamic mode:
      - Collection fallback first
      - Manual fallback second
    {%- endcomment -%}
    {%- if mode == 'dynamic' -%}
      <div hidden>
        <div data-fallback-collection>
          {%- if c != blank -%}
            {%- liquid
              assign rendered_c = 0
              assign seen_c = ''
            -%}
            {%- for cp in c.products -%}
              {%- if cp != blank and cp.id != current_id and cp.available -%}
                {%- assign id_token = '|' | append: cp.id | append: '|' -%}
                {%- unless seen_c contains id_token -%}
                  {%- assign seen_c = seen_c | append: id_token -%}
                  {% render 'product-card', product: cp %}
                  {%- assign rendered_c = rendered_c | plus: 1 -%}
                  {%- if rendered_c >= max_products -%}{%- break -%}{%- endif -%}
                {%- endunless -%}
              {%- endif -%}
            {%- endfor -%}
          {%- endif -%}
        </div>

        <div data-fallback-manual>
          {%- liquid
            assign rendered_m = 0
            assign seen_m = ''
          -%}
          {%- for block in section.blocks -%}
            {%- if block.type == 'product_reference' -%}
              {%- assign bp = block.settings.product -%}
              {%- if bp != blank and bp.id != current_id and bp.available -%}
                {%- assign id_token = '|' | append: bp.id | append: '|' -%}
                {%- unless seen_m contains id_token -%}
                  {%- assign seen_m = seen_m | append: id_token -%}
                  {% render 'product-card', product: bp %}
                  {%- assign rendered_m = rendered_m | plus: 1 -%}
                  {%- if rendered_m >= max_products -%}{%- break -%}{%- endif -%}
                {%- endunless -%}
              {%- endif -%}
            {%- endif -%}
          {%- endfor -%}
        </div>
      </div>
    {%- endif -%}

  </div>

  {%- comment -%}
    Section-level styling controls:
    We target common card selectors without changing the card snippet.
    Works best if your card uses standard .card / .card__* classes OR your own .q-card classes.
  {%- endcomment -%}

  <style>
    #product-cross-sell {
      --q-card-border-width: {{ card_border_width }}px;
      --q-card-radius: {{ card_radius }}px;
      --q-card-padding: {{ card_padding }}px;
      --q-card-text-align: {{ card_text_align }};
      --q-card-image-radius: {{ image_radius }}px;
      --q-card-image-aspect: {{ image_aspect }};

      --q-title-size: {{ title_size }}px;
      --q-title-weight: {{ title_weight }};
      --q-price-size: {{ price_size }}px;
      --q-price-weight: {{ price_weight }};

      --q-btn-radius: {{ btn_radius }}px;
      --q-btn-pad-y: {{ btn_padding_y }}px;
      --q-btn-pad-x: {{ btn_padding_x }}px;

      {%- if s.card_bg != blank -%}
      --q-card-bg: {{ s.card_bg }};
      {%- endif -%}
      {%- if s.card_border_color != blank -%}
      --q-card-border-color: {{ s.card_border_color }};
      {%- endif -%}
      {%- if s.title_color != blank -%}
      --q-title-color: {{ s.title_color }};
      {%- endif -%}
      {%- if s.price_color != blank -%}
      --q-price-color: {{ s.price_color }};
      {%- endif -%}
      {%- if s.button_bg != blank -%}
      --q-btn-bg: {{ s.button_bg }};
      {%- endif -%}
      {%- if s.button_text != blank -%}
      --q-btn-text: {{ s.button_text }};
      {%- endif -%}
      {%- if s.button_border_color != blank -%}
      --q-btn-border: {{ s.button_border_color }};
      {%- endif -%}
    }

    /* Layout */
    .q-product-cross-sell__inner {
      max-width: var(--page-width, 1200px);
      margin: 0 auto;
      padding: 2rem 1rem;
    }

    .q-product-cross-sell__products--grid {
      display: grid;
      gap: {{ s.grid_gap | default: 16 }}px;
      grid-template-columns: repeat(var(--q-cols-desktop, 4), 1fr);
    }
    @media (max-width: 989px) {
      .q-product-cross-sell__products--grid { grid-template-columns: repeat(var(--q-cols-tablet, 2), 1fr); }
    }
    @media (max-width: 749px) {
      .q-product-cross-sell__products--grid { grid-template-columns: repeat(var(--q-cols-mobile, 1), 1fr); }
    }

    .q-product-cross-sell__products--carousel {
      display: grid;
      grid-auto-flow: column;
      grid-auto-columns: minmax({{ s.carousel_item_min | default: 240 }}px, 1fr);
      gap: {{ s.grid_gap | default: 16 }}px;
      overflow-x: auto;
      scroll-snap-type: x mandatory;
      -webkit-overflow-scrolling: touch;
      padding-bottom: 0.25rem;
    }
    .q-product-cross-sell__products--carousel > * { scroll-snap-align: start; }

    /* =========================================
       Card styling (targets common structures)
       ========================================= */

    /* Card root candidates: customize if your theme uses different classes */
    #product-cross-sell .card,
    #product-cross-sell .q-card,
    #product-cross-sell [class*="product-card"] {
      text-align: var(--q-card-text-align, left);
    }

    /* Border / background / radius / shadow */
    #product-cross-sell .card,
    #product-cross-sell .q-card {
      background: var(--q-card-bg, transparent);
      border: var(--q-card-border-width, 0px) solid var(--q-card-border-color, rgba(0,0,0,0.12));
      border-radius: var(--q-card-radius, 12px);
      padding: var(--q-card-padding, 0px);
      overflow: hidden;
    }

    {%- if card_shadow == 'soft' -%}
      #product-cross-sell .card, #product-cross-sell .q-card { box-shadow: 0 6px 18px rgba(0,0,0,0.08); }
    {%- elsif card_shadow == 'medium' -%}
      #product-cross-sell .card, #product-cross-sell .q-card { box-shadow: 0 10px 30px rgba(0,0,0,0.14); }
    {%- else -%}
      #product-cross-sell .card, #product-cross-sell .q-card { box-shadow: none; }
    {%- endif -%}

    /* Media wrapper candidates */
    #product-cross-sell .card__media,
    #product-cross-sell .q-card__media,
    #product-cross-sell .media {
      border-radius: var(--q-card-image-radius, 12px);
      overflow: hidden;
    }

    /* Force consistent aspect ratio when possible */
    #product-cross-sell .card__media,
    #product-cross-sell .q-card__media,
    #product-cross-sell .media {
      aspect-ratio: var(--q-card-image-aspect, 1 / 1);
    }

    /* Titles (common selectors) */
    #product-cross-sell .card__heading,
    #product-cross-sell .card__heading a,
    #product-cross-sell .q-card__title,
    #product-cross-sell .product-card__title {
      font-size: var(--q-title-size, 16px);
      font-weight: var(--q-title-weight, 600);
      color: var(--q-title-color, inherit);
      text-decoration: none;
    }

    /* Price (common selectors) */
    #product-cross-sell .price,
    #product-cross-sell .q-card__price,
    #product-cross-sell .product-card__price {
      font-size: var(--q-price-size, 14px);
      font-weight: var(--q-price-weight, 600);
      color: var(--q-price-color, inherit);
    }

    /* Buttons (common quick-add selectors) */
    #product-cross-sell .quick-add__submit,
    #product-cross-sell .product-form__submit,
    #product-cross-sell .button {
      border-radius: var(--q-btn-radius, 12px);
      padding: var(--q-btn-pad-y, 12px) var(--q-btn-pad-x, 16px);
    }

    /* Optional “custom button skin” */
    {%- if s.enable_button_skin -%}
      #product-cross-sell .quick-add__submit,
      #product-cross-sell .product-form__submit {
        background: var(--q-btn-bg, currentColor);
        color: var(--q-btn-text, #fff);
        border: 1px solid var(--q-btn-border, transparent);
      }
    {%- endif -%}

    /* OPTIONAL: Override button label via CSS (hacky by nature, section-only) */
    {%- if override_label and button_label_text != blank -%}
      /* Common patterns: button text as direct text node or inside span */
      #product-cross-sell .quick-add__submit,
      #product-cross-sell .product-form__submit {
        position: relative;
      }

      /* Hide common inner label elements if present */
      #product-cross-sell .quick-add__submit span,
      #product-cross-sell .product-form__submit span {
        visibility: hidden;
      }

      /* Replace label */
      #product-cross-sell .quick-add__submit::after,
      #product-cross-sell .product-form__submit::after {
        content: "{{ button_label_text | escape }}";
        position: absolute;
        inset: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        pointer-events: none;
        color: inherit;
      }
    {%- endif -%}
  </style>

  {%- if mode == 'dynamic' -%}
    <script>
      (function() {
        var section = document.getElementById('product-cross-sell');
        if (!section) return;

        var container = section.querySelector('[data-products-container]');
        if (!container) return;

        var currentId = container.getAttribute('data-current-id');
        var max = parseInt(container.getAttribute('data-max') || '4', 10);

        var fbCollection = section.querySelector('[data-fallback-collection]');
        var fbManual = section.querySelector('[data-fallback-manual]');

        function hideSection() { section.style.display = 'none'; }

        function swapFallback() {
          if (fbCollection && fbCollection.innerHTML.trim().length) {
            container.innerHTML = fbCollection.innerHTML;
            return;
          }
          if (fbManual && fbManual.innerHTML.trim().length) {
            container.innerHTML = fbManual.innerHTML;
            return;
          }
          hideSection();
        }

        function fetchRecommendations() {
          var url = '/recommendations/products.json?product_id=' + encodeURIComponent(currentId) + '&limit=' + encodeURIComponent(max);
          return fetch(url, { credentials: 'same-origin' })
            .then(function(r){ if(!r.ok) throw new Error('recommendations failed'); return r.json(); });
        }

        function fetchCard(handle) {
          // Uses your existing product-card view endpoint
          return fetch('/products/' + handle + '?view=product-card', { credentials: 'same-origin' })
            .then(function(r){ if(!r.ok) throw new Error('card fetch failed'); return r.text(); });
        }

        fetchRecommendations().then(function(data) {
          var products = (data && data.products) ? data.products : [];
          if (!products.length) { swapFallback(); return; }

          var handles = [];
          var seen = {};
          for (var i = 0; i < products.length; i++) {
            var pr = products[i];
            if (!pr || !pr.handle) continue;
            if (String(pr.id) === String(currentId)) continue;
            if (seen[pr.handle]) continue;
            seen[pr.handle] = true;
            handles.push(pr.handle);
            if (handles.length >= max) break;
          }

          if (!handles.length) { swapFallback(); return; }

          Promise.all(handles.map(fetchCard)).then(function(htmlParts) {
            var combined = htmlParts.join('');
            if (!combined.trim()) { swapFallback(); return; }
            container.innerHTML = combined;
          }).catch(function(){ swapFallback(); });
        }).catch(function(){ swapFallback(); });
      })();
    </script>
  {%- endif -%}
</section>

{% schema %}
{
  "name": "Product Cross Sell",
  "settings": [
    { "type": "text", "id": "title", "default": "You may also like", "label": "Title" },
    { "type": "richtext", "id": "subheading", "label": "Subheading" },

    {
      "type": "select",
      "id": "mode",
      "label": "Mode",
      "default": "dynamic",
      "options": [
        { "value": "manual", "label": "Manual" },
        { "value": "collection", "label": "Collection" },
        { "value": "dynamic", "label": "Dynamic" }
      ]
    },

    {
      "type": "collection",
      "id": "collection",
      "label": "Collection",
      "info": "Used for Collection mode and as fallback for Dynamic mode"
    },

    { "type": "range", "id": "max_products", "label": "Max products", "min": 2, "max": 12, "step": 1, "default": 4 },

    {
      "type": "select",
      "id": "layout",
      "label": "Layout",
      "default": "grid",
      "options": [
        { "value": "grid", "label": "Grid" },
        { "value": "carousel", "label": "Carousel" }
      ]
    },

    { "type": "range", "id": "columns_desktop", "label": "Columns (desktop)", "min": 2, "max": 6, "step": 1, "default": 4 },
    { "type": "range", "id": "columns_tablet", "label": "Columns (tablet)", "min": 1, "max": 4, "step": 1, "default": 2 },

    {
      "type": "select",
      "id": "columns_mobile",
      "label": "Columns (mobile)",
      "default": "1",
      "options": [
        { "value": "1", "label": "1" },
        { "value": "2", "label": "2" }
      ]
    },

    { "type": "header", "content": "Feed layout styling" },
    { "type": "range", "id": "grid_gap", "label": "Gap between items (px)", "min": 8, "max": 40, "step": 1, "default": 16 },
    { "type": "range", "id": "carousel_item_min", "label": "Carousel item min width (px)", "min": 180, "max": 420, "step": 10, "default": 240 },

    { "type": "header", "content": "Card styling" },
    { "type": "color", "id": "card_bg", "label": "Card background" },
    { "type": "color", "id": "card_border_color", "label": "Card border color" },
    { "type": "range", "id": "card_border_width", "label": "Card border width (px)", "min": 0, "max": 6, "step": 1, "default": 1 },
    { "type": "range", "id": "card_radius", "label": "Card radius (px)", "min": 0, "max": 28, "step": 1, "default": 12 },
    { "type": "range", "id": "card_padding", "label": "Card padding (px)", "min": 0, "max": 28, "step": 1, "default": 0 },
    {
      "type": "select",
      "id": "card_shadow",
      "label": "Card shadow",
      "default": "none",
      "options": [
        { "value": "none", "label": "None" },
        { "value": "soft", "label": "Soft" },
        { "value": "medium", "label": "Medium" }
      ]
    },
    {
      "type": "select",
      "id": "card_text_align",
      "label": "Text alignment",
      "default": "left",
      "options": [
        { "value": "left", "label": "Left" },
        { "value": "center", "label": "Center" }
      ]
    },

    { "type": "header", "content": "Image styling" },
    {
      "type": "select",
      "id": "image_aspect",
      "label": "Image aspect ratio",
      "default": "1 / 1",
      "options": [
        { "value": "1 / 1", "label": "Square (1:1)" },
        { "value": "4 / 5", "label": "Portrait (4:5)" },
        { "value": "3 / 4", "label": "Portrait (3:4)" },
        { "value": "4 / 3", "label": "Landscape (4:3)" },
        { "value": "16 / 9", "label": "Wide (16:9)" }
      ]
    },
    { "type": "range", "id": "image_radius", "label": "Image radius (px)", "min": 0, "max": 28, "step": 1, "default": 12 },

    { "type": "header", "content": "Typography" },
    { "type": "color", "id": "title_color", "label": "Title color" },
    { "type": "range", "id": "title_size", "label": "Title size (px)", "min": 12, "max": 26, "step": 1, "default": 16 },
    { "type": "range", "id": "title_weight", "label": "Title weight", "min": 400, "max": 800, "step": 100, "default": 600 },

    { "type": "color", "id": "price_color", "label": "Price color" },
    { "type": "range", "id": "price_size", "label": "Price size (px)", "min": 12, "max": 24, "step": 1, "default": 14 },
    { "type": "range", "id": "price_weight", "label": "Price weight", "min": 400, "max": 800, "step": 100, "default": 600 },

    { "type": "header", "content": "Button styling (CSS only)" },
    { "type": "checkbox", "id": "enable_button_skin", "label": "Apply custom button colors", "default": false },
    { "type": "color", "id": "button_bg", "label": "Button background" },
    { "type": "color", "id": "button_text", "label": "Button text color" },
    { "type": "color", "id": "button_border_color", "label": "Button border color" },
    { "type": "range", "id": "button_radius", "label": "Button radius (px)", "min": 0, "max": 28, "step": 1, "default": 12 },
    { "type": "range", "id": "button_padding_y", "label": "Button padding Y (px)", "min": 6, "max": 22, "step": 1, "default": 12 },
    { "type": "range", "id": "button_padding_x", "label": "Button padding X (px)", "min": 10, "max": 30, "step": 1, "default": 16 },

    { "type": "checkbox", "id": "override_button_label", "label": "Override button label (CSS hack)", "default": false },
    { "type": "text", "id": "button_label_text", "label": "Button label text", "default": "Add to cart" }
  ],
  "blocks": [
    {
      "type": "product_reference",
      "name": "Product",
      "settings": [
        { "type": "product", "id": "product", "label": "Product" }
      ]
    }
  ],
  "max_blocks": 12,
  "presets": [
    { "name": "Product Cross Sell" }
  ]
}
{% endschema %}
