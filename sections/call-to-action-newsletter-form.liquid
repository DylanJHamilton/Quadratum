{% comment %}
  Quadratum — CTA: Newsletter (Section)
  • Layouts: Card / Split / Steps
  • Background media + overlay on ROOT (image/video/gradient/solid)
  • Uses global JS: assets/frontend-form-logic.js (validation, steps, captcha)
  • Two destinations:
      - shopify_customer   → {% form 'customer' %} (accepts_marketing + tags)
      - custom_endpoint    → <form action="{{ endpoint_url }}"> (server fan-out to ESPs)
{% endcomment %}
{{ 'call-to-action-quote-form.css' | asset_url | stylesheet_tag }}

{%- assign s = section.settings -%}

{%- comment %} THEME TOKENS (mirror CTA–Quote) {% endcomment -%}
{%- assign T_font_heading = settings.font_heading -%}
{%- assign C_primary      = settings.color_primary        | default: '#2563eb' -%}
{%- assign C_bg_base      = settings.bg_base              | default: '#ffffff' -%}
{%- assign C_bg_contrast  = settings.bg_contrast          | default: '#f6f7f8' -%}
{%- assign C_text_base    = settings.text_base            | default: '#111111' -%}
{%- assign C_text_muted   = settings.text_muted           | default: '#6b7280' -%}
{%- assign C_success      = settings.color_success        | default: '#16a34a' -%}
{%- assign C_error        = settings.color_error          | default: '#dc2626' -%}
{%- assign BTN_default    = settings.button_variant_default | default: 'solid' -%}
{%- assign BTN_radius     = settings.button_radius        | default: 12 -%}
{%- assign BTN_bw         = settings.button_border_width  | default: 1 -%}
{%- assign BTN_hover_op   = settings.button_hover_opacity | default: 92 -%}
{%- assign BTN_active     = settings.button_active_scale  | default: 98 -%}

{%- comment %} Button variant resolution {% endcomment -%}
{%- assign _btn_choice = s.button_variant | default: 'inherit' -%}
{%- assign _btn_variant = BTN_default -%}
{%- if _btn_choice != 'inherit' and _btn_choice != blank -%}{%- assign _btn_variant = _btn_choice -%}{%- endif -%}
{%- assign btn_mode_class = 'q-btn--solid' -%}
{%- if _btn_variant == 'outline' -%}{%- assign btn_mode_class = 'q-btn--outline' -%}{%- endif -%}
{%- if _btn_variant == 'ghost' -%}{%- assign btn_mode_class = 'q-btn--ghost' -%}{%- endif -%}

{%- comment %} Visibility classes {% endcomment -%}
{%- assign visibility_classes = '' -%}
{%- if s.hide_on_mobile -%}{%- assign visibility_classes = visibility_classes | append: ' hidden md:block q-hide-mobile' -%}{%- endif -%}
{%- if s.hide_on_desktop -%}{%- assign visibility_classes = visibility_classes | append: ' md:hidden q-hide-desktop' -%}{%- endif -%}

{%- assign anchor = s.anchor_id -%}
{%- if anchor == blank -%}{%- assign anchor = 'section-' | append: section.id -%}{%- endif -%}

{%- comment %} Steps count for UI (global JS paints) {% endcomment -%}
{%- assign steps_count = 0 -%}
{%- for block in section.blocks -%}{%- if block.type == 'step' -%}{%- assign steps_count = steps_count | plus: 1 -%}{%- endif -%}{%- endfor -%}
{%- if steps_count == 0 and s.template_style == 'steps' -%}{%- assign steps_count = 1 -%}{%- endif -%}

<style>
  #{{ section.id }}{
    --q-pad-y: {{ s.padding_y | default: 64 }}px;
    --q-pad-x: {{ s.padding_x | default: 24 }}px;
    --q-card-br: {{ s.card_radius | default: 16 }}px;
    --q-card-shadow: {{ s.card_shadow | default: 2 }};
    --q-text: {{ C_text_base }};
    --q-muted: {{ C_text_muted }};
    --q-bg: {{ s.bg_color | default: C_bg_contrast }};
    --q-btn-bg: {{ C_primary }};
    --q-btn-fg: {{ settings.text_on_color | default: '#ffffff' }};
    --q-btn-bdr: {{ C_text_base }};
    --q-btn-bw: {{ BTN_bw }}px;
    --q-btn-br: {{ BTN_radius }}px;
    --q-btn-hover-op: {{ BTN_hover_op }}%;
    --q-btn-active-scale: {{ BTN_active | divided_by: 100.0 }};
  }
  #{{ section.id }} .q-wrap{max-width: {% if settings.style_kit == 'full' %}100%{% elsif settings.style_kit == 'wide' %}var(--q-cont-xl, 1440px){% else %}var(--q-cont-lg, 1152px){% endif %}; margin:0 auto; padding:0 var(--q-pad-x);}
  #{{ section.id }} .q-bleed{position:relative;}
  #{{ section.id }} .q-bg{position:absolute; inset:0; z-index:0; overflow:hidden; pointer-events:none;}
  #{{ section.id }} .q-media{width:100%; height:100%; object-fit:cover; display:block;}
  #{{ section.id }} .q-overlay{position:absolute; inset:0; pointer-events:none;}
  #{{ section.id }} .q-layer{position:relative; z-index:1; padding: var(--q-pad-y) 0;}
  #{{ section.id }} .q-grid{display:grid; gap:24px; align-items:stretch;}
  @media (min-width: 768px){
    #{{ section.id }} .q-grid.split-left{grid-template-columns: 1.1fr 1fr;}
    #{{ section.id }} .q-grid.split-right{grid-template-columns: 1fr 1.1fr;}
  }
  #{{ section.id }} .q-card{
    background: {{ s.form_bg | default: C_bg_base }};
    border-radius: var(--q-card-br);
    box-shadow:
      {% if s.card_shadow > 0 %}0 1px 2px rgba(0,0,0,.06){% else %}none{% endif %},
      {% if s.card_shadow > 1 %}0 8px 24px rgba(0,0,0,.08){% else %}0 0 0 rgba(0,0,0,0){% endif %};
    padding: 28px;
  }
  #{{ section.id }} .q-media-card{ border-radius: var(--q-card-br); overflow:hidden; background: #000; min-height: 240px; }
  #{{ section.id }} .q-head .q-kicker{color: var(--q-muted); font-size: .95rem; margin:0 0 4px;}
  #{{ section.id }} .q-head .q-heading{
    margin:0 0 8px; color: var(--q-text);
    {% if T_font_heading %}font-family: {{ T_font_heading.family }}, {{ T_font_heading.fallback_families }};{% endif %}
  }
  #{{ section.id }} .q-head .q-sub{color: var(--q-muted); margin:0 0 16px;}

  #{{ section.id }} .q-fields{display:flex; flex-wrap:wrap; gap:12px;}
  #{{ section.id }} .q-field{width:100%;}
  #{{ section.id }} .q-field.half{width: calc(50% - 6px);}
  @media (max-width: 639.98px){ #{{ section.id }} .q-field.half{ width:100%; } }

  #{{ section.id }} .q-label{display:block; font-weight:600; margin:8px 0 6px; color: var(--q-text);}
  #{{ section.id }} .q-help{font-size:.875rem; color: var(--q-muted); margin:4px 0 0;}
  #{{ section.id }} .q-input, #{{ section.id }} .q-select, #{{ section.id }} .q-textarea{
    width:100%; border:1px solid {{ s.input_border | default: '#e5e7eb' }}; border-radius: {{ s.input_radius | default: 10 }}px; padding: 12px 14px; background:#fff; color:var(--q-text);
  }
  #{{ section.id }} .q-radio{ display:flex; gap:10px; align-items:center; margin: 4px 0; }
  #{{ section.id }} .q-error{ color: {{ C_error }}; font-size:.85rem; margin-top:6px; }
  #{{ section.id }} [aria-invalid="true"]{ border-color: {{ C_error }}; outline:1px solid {{ C_error }}; }

  #{{ section.id }} .q-btn{
    display:inline-flex; align-items:center; justify-content:center;
    padding: 12px 20px; border-radius: var(--q-btn-br); border-width: var(--q-btn-bw); border-style: solid;
    transition: transform .12s ease, opacity .12s ease, background-color .12s ease, color .12s ease;
    text-decoration:none; cursor:pointer; user-select:none;
  }
  #{{ section.id }} .q-btn.q-btn--solid{ background: var(--q-btn-bg); color: var(--q-btn-fg); border-color: var(--q-btn-bg); }
  #{{ section.id }} .q-btn.q-btn--outline{ background: transparent; color: var(--q-btn-bg); border-color: var(--q-btn-bg); }
  #{{ section.id }} .q-btn.q-btn--ghost{ background: transparent; color: var(--q-btn-bg); border-color: transparent; }
  #{{ section.id }} .q-btn[disabled]{ opacity:.6; pointer-events:none; }
  #{{ section.id }} .q-btn:not([disabled]):hover{ opacity: calc(var(--q-btn-hover-op) / 100); }
  #{{ section.id }} .q-btn:not([disabled]):active{ transform: scale(var(--q-btn-active-scale)); }

  #{{ section.id }} .q-live{ position:relative; margin:8px 0 0; min-height: 1.2em; }
  #{{ section.id }} .q-live .ok{ color: {{ C_success }}; }
  #{{ section.id }} .q-live .bad{ color: {{ C_error }}; }

  /* Steps */
  #{{ section.id }} [data-q-steps]{ margin-top: 10px; }
  #{{ section.id }} .q-steps-nav{ display:flex; align-items:center; gap:10px; margin:0 0 12px; }
  #{{ section.id }} .q-steps-bar{ flex:1; height:6px; background: rgba(0,0,0,.08); border-radius:6px; overflow:hidden; }
  #{{ section.id }} .q-steps-fill{ height:100%; background: var(--q-btn-bg); width:0%; }
  #{{ section.id }} .q-steps-count{ font-size:.875rem; color: var(--q-muted); }
  #{{ section.id }} .q-steps-actions{ display:flex; gap:8px; margin-top:16px; }
  #{{ section.id }} .q-step{ display:none; }
  #{{ section.id }} .q-step.is-active{ display:block; }

  /* Conditional */
  #{{ section.id }} .is-hidden{ display:none !important; }

  
.q-cta-quote-form .q-radio{ display:flex; align-items:center; gap:10px; justify-content:flex-start; width:max-content; }
.q-cta-quote-form .q-radio input.q-input{
  width:auto; padding:0; border:1px solid rgba(0,0,0,.35); border-radius:3px; height:1.05rem; margin:0;
}
.q-cta-quote-form input.q-input[aria-invalid="true"]{
  border-color: var(--q-error, #dc2626);
  outline:2px solid var(--q-error, #dc2626);
  outline-offset:2px;
}
.q-cta-quote-form input:not([type="checkbox"]):not([type="radio"]).q-input[aria-invalid="true"],
.q-cta-quote-form select[aria-invalid="true"],
.q-cta-quote-form textarea[aria-invalid="true"]{
  outline:1px solid var(--q-error, #dc2626);
}


</style>

<section
  id="{{ anchor }}"
  class="q-cta-quote-form q-cta-newsletter{{ visibility_classes }}"
  role="region"
  aria-label="{{ s.aria_label | default: 'Newsletter signup' }}"
  data-template="{{ s.template_style }}"
  data-msg-error="{{ s.error_text | escape }}"
  data-captcha="{{ s.captcha_mode | default: 'none' }}"
  data-captcha-key="{{ s.captcha_site_key | escape }}"
  data-btn-variant="{{ btn_mode_class }}"
>
  <div class="q-bleed">
    <div class="q-bg" aria-hidden="true">
      {%- assign vurl = s.bg_video | strip -%}
      {%- if vurl != blank -%}
        {%- assign is_yt = false -%}{%- assign is_vm = false -%}
        {%- if vurl contains 'youtube.com' or vurl contains 'youtu.be' -%}{%- assign is_yt = true -%}{%- endif -%}
        {%- if vurl contains 'vimeo.com' -%}{%- assign is_vm = true -%}{%- endif -%}
        {%- if is_yt -%}
          {%- assign yid = vurl
            | replace: 'https://youtu.be/','' | replace: 'http://youtu.be/',''
            | replace: 'https://www.youtube.com/watch?v=','' | replace: 'http://www.youtube.com/watch?v=',''
            | replace: 'https://youtube.com/watch?v=','' | replace: 'http://youtube.com/watch?v=',''
            | split:'?' | first -%}
          <iframe class="q-media" src="https://www.youtube.com/embed/{{ yid }}?autoplay=1&mute=1&controls=0&playsinline=1&loop=1&playlist={{ yid }}&modestbranding=1&rel=0" title="" tabindex="-1" allow="autoplay; encrypted-media"></iframe>
        {%- elsif is_vm -%}
          {%- assign vid = vurl | split:'/' | last | split:'?' | first -%}
          <iframe class="q-media" src="https://player.vimeo.com/video/{{ vid }}?background=1&autoplay=1&muted=1&loop=1&autopause=0&controls=0" title="" tabindex="-1" allow="autoplay; fullscreen; picture-in-picture"></iframe>
        {%- else -%}
          <video class="q-media" autoplay loop muted playsinline preload="none">
            <source src="{{ vurl | escape }}" type="video/mp4">
          </video>
        {%- endif -%}
      {%- elsif s.bg_image != blank -%}
        {{ s.bg_image | image_url: width: 2880 | image_tag: widths: '960,1440,1920,2560,2880', sizes: '100vw', loading: 'lazy', class: 'q-media', decoding: 'async', alt: '' }}
      {%- else -%}
        <div class="q-media" style="background: var(--q-bg);"></div>
      {%- endif -%}

      {%- if s.overlay_type == 'gradient' -%}
        {%- assign g1c = s.grad_start | default: '#000000' -%}
        {%- assign g2c = s.grad_end   | default: '#000000' -%}
        {%- assign g1o = s.grad_start_opacity | default: 40 | divided_by: 100.0 -%}
        {%- assign g2o = s.grad_end_opacity   | default: 0  | divided_by: 100.0 -%}
        <div class="q-overlay" style="background: linear-gradient({{ s.grad_angle | default: 180 }}deg, {{ g1c | color_modify: 'alpha', g1o }}, {{ g2c | color_modify: 'alpha', g2o }});"></div>
      {%- elsif s.overlay_type == 'solid' -%}
        <div class="q-overlay" style="background-color: {{ s.overlay_color | default: '#000000' }}; opacity: {{ s.overlay_opacity | default: 35 | divided_by: 100.0 }};"></div>
      {%- endif -%}
    </div>

    <div class="q-layer">
      <div class="q-wrap">
        {%- assign is_split_left = false -%}
        {%- assign is_split_right = false -%}
        {%- if s.template_style == 'split' and s.split_media_side == 'left' -%}{%- assign is_split_left = true -%}{%- endif -%}
        {%- if s.template_style == 'split' and s.split_media_side == 'right' -%}{%- assign is_split_right = true -%}{%- endif -%}

        <div class="q-grid{% if is_split_left %} split-left{% endif %}{% if is_split_right %} split-right{% endif %}">

          {%- if s.template_style == 'split' and s.split_image != blank and s.split_media_side == 'left' -%}
            <div class="q-media-card">
              {{ s.split_image | image_url: width: 1600 | image_tag: widths: '800,1200,1600', sizes: '(min-width:768px) 50vw, 100vw', loading: 'lazy', class: 'q-media', decoding: 'async', alt: '' }}
            </div>
          {%- endif -%}

          <div class="q-card" data-q-form-card>
            <header class="q-head">
              {%- if s.kicker != blank -%}<p class="q-kicker">{{ s.kicker }}</p>{%- endif -%}
              {%- assign htag = s.heading_level | default: 'h2' -%}
              {%- if s.heading != blank -%}{%- if htag == 'h3' -%}<h3 class="q-heading">{{ s.heading }}</h3>{%- else -%}<h2 class="q-heading">{{ s.heading }}</h2>{%- endif -%}{%- endif -%}
              {%- if s.subheading != blank -%}<p class="q-sub">{{ s.subheading }}</p>{%- endif -%}
            </header>

            {%- comment -%}
              === FORM ROUTER ===
              • shopify_customer   → {% form 'customer' %} (accepts_marketing)
              • custom_endpoint    → <form action="{{ endpoint_url }}">
              Uses the same block system as CTA—Quote (field / step).
            {%- endcomment -%}

            {%- comment -%} SAFE FLAG (no comparison inside assign) {%- endcomment -%}
            {%- assign _use_shopify = false -%}
            {%- if s.destination == 'shopify_customer' -%}{%- assign _use_shopify = true -%}{%- endif -%}

            {%- if _use_shopify -%}
              {%- assign nl_form_id = 'newsletter-' | append: section.id -%}
              {% form 'customer', id: nl_form_id, class: 'q-form', novalidate: 'novalidate' %}
                <input type="hidden" name="contact[tags]" value="{{ s.hidden_tags | default: 'newsletter, web' | escape }}">
                <input type="hidden" name="customer[accepts_marketing]" value="true">

                <div class="q-fields">
                  {%- for block in section.blocks -%}
                    {%- if block.type == 'step' and s.template_style == 'steps' -%}
                      <div class="q-step">
                        {%- if block.settings.step_title != blank -%}<p class="q-kicker">{{ block.settings.step_title }}</p>{%- endif -%}
                        {%- if block.settings.step_desc != blank -%}<p class="q-sub">{{ block.settings.step_desc }}</p>{%- endif -%}
                      </div>
                    {%- elsif block.type == 'field' -%}
                      {%- assign b = block.settings -%}
                      {%- assign wcls = 'q-field' -%}{% if b.width == 'half' %}{% assign wcls = wcls | append: ' half' %}{% endif %}
                      <div class="{{ wcls }}" data-q-field data-required="{{ b.required }}" {% if b.condition_enable %}data-cond="1" data-cond-field="{{ b.condition_field | escape }}" data-cond-operator="{{ b.condition_operator }}" data-cond-value="{{ b.condition_value | escape }}"{% endif %}>
                        {%- if b.field_type == 'html' -%}
                          <div class="rte">{{ b.html_content }}</div>
                        {%- else -%}
                          {%- assign input_id = section.id | append: '-' | append: forloop.index -%}
                          {%- if b.label != blank -%}<label class="q-label" for="{{ input_id }}">{{ b.label }}</label>{%- endif -%}

                          {%- case b.field_type -%}
                            {%- when 'email' -%}
                              <input id="{{ input_id }}" class="q-input" type="email" name="contact[email]" placeholder="{{ b.placeholder }}" value="{{ b.default_value }}" {% if b.required %}required{% endif %}>
                            {%- when 'text' -%}
                              <input id="{{ input_id }}" class="q-input" type="text" name="{{ b.name_attr | default: 'contact[first_name]' }}" placeholder="{{ b.placeholder }}" value="{{ b.default_value }}" {% if b.required %}required{% endif %}>
                            {%- when 'select' -%}
                              {%- assign opts = b.options | newline_to_br | split: '<br />' -%}
                              <select id="{{ input_id }}" class="q-select" name="{{ b.name_attr | default: 'contact[topic]' }}" {% if b.required %}required{% endif %}>
                                <option value="">{{ b.placeholder }}</option>
                                {%- for opt in opts -%}
                                  {%- assign pair = opt | split: '|' -%}
                                  <option value="{{ pair.first | strip | escape }}" {% if b.default_value == pair.first %}selected{% endif %}>{{ pair.last | default: pair.first | strip }}</option>
                                {%- endfor -%}
                              </select>
                            {%- when 'checkbox' -%}
                              <label class="q-radio">
                                <input id="{{ input_id }}" class="q-input q-check" type="checkbox" name="{{ b.name_attr | default: 'contact[consent_gdpr]' }}" value="yes" {% if b.required %}required{% endif %}>
                                <span>{{ b.label | default: 'I agree to receive emails.' }}</span>
                              </label>
                            {%- when 'consent' -%}
                              <label class="q-radio">
                                <input id="{{ input_id }}" class="q-input q-check" type="checkbox" name="{{ b.name_attr | default: 'contact[consent]' }}" value="yes" {% if b.required %}required{% endif %}>
                                <span>{{ b.label | default: 'I agree to the privacy policy' }}</span>
                              </label>
                            {%- when 'radio' -%}
                              {%- assign opts = b.options | newline_to_br | split: '<br />' -%}
                              {%- for opt in opts -%}
                                {%- assign pair = opt | split: '|' -%}
                                <label class="q-radio">
                                  <input class="q-input" type="radio" name="{{ b.name_attr | default: 'contact[preference]' }}" value="{{ pair.first | strip | escape }}" {% if b.required and forloop.first %}required{% endif %}>
                                  <span>{{ pair.last | default: pair.first | strip }}</span>
                                </label>
                              {%- endfor -%}
                            {%- else -%}
                              <input id="{{ input_id }}" class="q-input" type="text" name="{{ b.name_attr | default: 'contact[field]' }}" placeholder="{{ b.placeholder }}" value="{{ b.default_value }}" {% if b.required %}required{% endif %}>
                          {%- endcase -%}

                          <p id="{{ input_id }}-err" class="q-error" aria-live="polite"></p>
                          {%- if b.help_text != blank -%}<p class="q-help">{{ b.help_text }}</p>{%- endif -%}
                        {%- endif -%}
                      </div>
                    {%- endif -%}
                  {%- endfor -%}
                </div>

                <div>
                  <button type="submit" class="q-btn {{ btn_mode_class }}">{{ s.button_label | default: 'Subscribe' }}</button>
                  <div class="q-live" aria-live="polite"></div>
                </div>
              {% endform %}
            {%- else -%}
              <form class="q-form" method="post" action="{{ s.endpoint_url | escape }}" novalidate>
                <input type="hidden" name="source" value="newsletter">
                <input type="hidden" name="tags" value="{{ s.hidden_tags | default: 'newsletter, web' | escape }}">

                <div class="q-fields">
                  {%- for block in section.blocks -%}
                    {%- if block.type == 'step' and s.template_style == 'steps' -%}
                      <div class="q-step">
                        {%- if block.settings.step_title != blank -%}<p class="q-kicker">{{ block.settings.step_title }}</p>{%- endif -%}
                        {%- if block.settings.step_desc != blank -%}<p class="q-sub">{{ block.settings.step_desc }}</p>{%- endif -%}
                      </div>
                    {%- elsif block.type == 'field' -%}
                      {%- assign b = block.settings -%}
                      {%- assign wcls = 'q-field' -%}{% if b.width == 'half' %}{% assign wcls = wcls | append: ' half' %}{% endif %}
                      <div class="{{ wcls }}" data-q-field data-required="{{ b.required }}" {% if b.condition_enable %}data-cond="1" data-cond-field="{{ b.condition_field | escape }}" data-cond-operator="{{ b.condition_operator }}" data-cond-value="{{ b.condition_value | escape }}"{% endif %}>
                        {%- if b.field_type == 'html' -%}
                          <div class="rte">{{ b.html_content }}</div>
                        {%- else -%}
                          {%- assign input_id = section.id | append: '-' | append: forloop.index -%}
                          {%- if b.label != blank -%}<label class="q-label" for="{{ input_id }}">{{ b.label }}</label>{%- endif -%}
                          {%- case b.field_type -%}
                            {%- when 'email' -%}
                              <input id="{{ input_id }}" class="q-input" type="email" name="email" placeholder="{{ b.placeholder | default: 'you@example.com' }}" value="{{ b.default_value }}" {% if b.required %}required{% endif %}>
                            {%- when 'text' -%}
                              <input id="{{ input_id }}" class="q-input" type="text" name="{{ b.name_attr | default: 'first_name' }}" placeholder="{{ b.placeholder }}" value="{{ b.default_value }}" {% if b.required %}required{% endif %}>
                            {%- when 'select' -%}
                              {%- assign opts = b.options | newline_to_br | split: '<br />' -%}
                              <select id="{{ input_id }}" class="q-select" name="{{ b.name_attr | default: 'topic' }}" {% if b.required %}required{% endif %}>
                                <option value="">{{ b.placeholder }}</option>
                                {%- for opt in opts -%}
                                  {%- assign pair = opt | split: '|' -%}
                                  <option value="{{ pair.first | strip | escape }}" {% if b.default_value == pair.first %}selected{% endif %}>{{ pair.last | default: pair.first | strip }}</option>
                                {%- endfor -%}
                              </select>
                            {%- when 'checkbox' -%}
                              <label class="q-radio">
                                <input id="{{ input_id }}" class="q-input q-check" type="checkbox" name="{{ b.name_attr | default: 'consent_gdpr' }}" value="yes" {% if b.required %}required{% endif %}>
                                <span>{{ b.label | default: 'I agree to receive emails.' }}</span>
                              </label>
                            {%- when 'consent' -%}
                              <label class="q-radio">
                                <input id="{{ input_id }}" class="q-input q-check" type="checkbox" name="{{ b.name_attr | default: 'consent' }}" value="yes" {% if b.required %}required{% endif %}>
                                <span>{{ b.label | default: 'I agree to the privacy policy' }}</span>
                              </label>
                            {%- when 'radio' -%}
                              {%- assign opts = b.options | newline_to_br | split: '<br />' -%}
                              {%- for opt in opts -%}
                                {%- assign pair = opt | split: '|' -%}
                                <label class="q-radio">
                                  <input class="q-input" type="radio" name="{{ b.name_attr | default: 'preference' }}" value="{{ pair.first | strip | escape }}" {% if b.required and forloop.first %}required{% endif %}>
                                  <span>{{ pair.last | default: pair.first | strip }}</span>
                                </label>
                              {%- endfor -%}
                            {%- else -%}
                              <input id="{{ input_id }}" class="q-input" type="text" name="{{ b.name_attr | default: 'field' }}" placeholder="{{ b.placeholder }}" value="{{ b.default_value }}" {% if b.required %}required{% endif %}>
                          {%- endcase -%}
                          <p id="{{ input_id }}-err" class="q-error" aria-live="polite"></p>
                          {%- if b.help_text != blank -%}<p class="q-help">{{ b.help_text }}</p>{%- endif -%}
                        {%- endif -%}
                      </div>
                    {%- endif -%}
                  {%- endfor -%}
                </div>

                <div>
                  <button type="submit" class="q-btn {{ btn_mode_class }}">{{ s.button_label | default: 'Subscribe' }}</button>
                  <div class="q-live" aria-live="polite"></div>
                </div>
              </form>
            {%- endif -%}

            {%- if s.template_style == 'steps' -%}
              <div class="q-steps-nav" data-q-steps>
                <div class="q-steps-bar"><div class="q-steps-fill" data-q-steps-fill></div></div>
                <div class="q-steps-count" data-q-steps-count></div>
              </div>
            {%- endif -%}
          </div>

          {%- if s.template_style == 'split' and s.split_image != blank and s.split_media_side == 'right' -%}
            <div class="q-media-card">
              {{ s.split_image | image_url: width: 1600 | image_tag: widths: '800,1200,1600', sizes: '(min-width:768px) 50vw, 100vw', loading: 'lazy', class: 'q-media', decoding: 'async', alt: '' }}
            </div>
          {%- endif -%}
        </div>
      </div>
    </div>
  </div>

  {%- if s.captcha_mode == 'turnstile' and s.captcha_site_key != blank -%}
    <script src="https://challenges.cloudflare.com/turnstile/v0/api.js" defer></script>
  {%- endif -%}
  {%- if s.captcha_mode == 'recaptcha_v3' and s.captcha_site_key != blank -%}
    <script src="https://www.google.com/recaptcha/api.js?render={{ s.captcha_site_key | escape }}"></script>
  {%- endif -%}
  {{ 'frontend-form-logic.js' | asset_url | script_tag }}
</section>

{% schema %}
{
  "name": "CTA – Newsletter",
  "tag": "section",
  "class": "q-cta-quote-form q-cta-newsletter",
  "settings": [
    { "type": "text", "id": "aria_label", "label": "ARIA label", "default": "Newsletter signup" },

    { "type": "header", "content": "Layout" },
    { "type": "select", "id": "template_style", "label": "Template", "default": "card", "options": [
      { "value": "card", "label": "Card" },
      { "value": "split", "label": "Split" },
      { "value": "steps", "label": "Steps" }
    ]},
    { "type": "select", "id": "split_media_side", "label": "Split: media position", "default": "left", "options": [
      { "value": "left", "label": "Media left" },
      { "value": "right", "label": "Media right" }
    ]},
    { "type": "image_picker", "id": "split_image", "label": "Split: image" },
    { "type": "text", "id": "anchor_id", "label": "Optional anchor ID" },

    { "type": "header", "content": "Background (root)" },
    { "type": "image_picker", "id": "bg_image", "label": "Background image" },
    { "type": "text", "id": "bg_video", "label": "Background video URL (MP4, YouTube, Vimeo)" },
    { "type": "color", "id": "bg_color", "label": "Background color", "default": "#f6f7f8" },
    { "type": "select", "id": "overlay_type", "label": "Overlay", "default": "solid", "options": [
      { "value": "none", "label": "None" },
      { "value": "solid", "label": "Solid" },
      { "value": "gradient", "label": "Gradient" }
    ]},
    { "type": "color", "id": "overlay_color", "label": "Overlay color", "default": "#000000" },
    { "type": "range", "id": "overlay_opacity", "label": "Overlay opacity", "min": 0, "max": 100, "step": 5, "default": 35, "unit": "%" },
    { "type": "color", "id": "grad_start", "label": "Gradient start", "default": "#000000" },
    { "type": "range", "id": "grad_start_opacity", "label": "Start opacity", "min": 0, "max": 100, "step": 5, "default": 40, "unit": "%" },
    { "type": "color", "id": "grad_end", "label": "Gradient end", "default": "#000000" },
    { "type": "range", "id": "grad_end_opacity", "label": "End opacity", "min": 0, "max": 100, "step": 5, "default": 0, "unit": "%" },
    { "type": "range", "id": "grad_angle", "label": "Gradient angle", "min": 0, "max": 360, "step": 5, "default": 180, "unit": "deg" },

    { "type": "header", "content": "Content" },
    { "type": "text", "id": "kicker", "label": "Accent (kicker)", "default": "Join the list" },
    { "type": "text", "id": "heading", "label": "Heading", "default": "Get emails you’ll actually open" },
    { "type": "select", "id": "heading_level", "label": "Heading level", "default": "h2", "options": [
      { "value": "h2", "label": "H2" },
      { "value": "h3", "label": "H3" }
    ]},
    { "type": "textarea", "id": "subheading", "label": "Subheading", "default": "Fresh articles, launch news, and occasional deals." },
    { "type": "text", "id": "success_text", "label": "Success message", "default": "Thanks! Check your inbox." },
    { "type": "text", "id": "error_text", "label": "Error message", "default": "Please fix the highlighted fields and try again." },

    { "type": "header", "content": "Destination" },
    { "type": "select", "id": "destination", "label": "Send signups to", "default": "shopify_customer", "options": [
      { "value": "shopify_customer", "label": "Shopify newsletter (accepts_marketing)" },
      { "value": "custom_endpoint", "label": "Custom endpoint (POST)" }
    ]},
    { "type": "url", "id": "endpoint_url", "label": "Custom endpoint URL (HTTPS)" },
    { "type": "text", "id": "hidden_tags", "label": "Hidden tags/params (comma-separated)", "default": "newsletter, web" },

    { "type": "header", "content": "CAPTCHA" },
    { "type": "select", "id": "captcha_mode", "label": "Captcha provider", "default": "none", "options": [
      { "value": "none", "label": "None" },
      { "value": "turnstile", "label": "Cloudflare Turnstile" },
      { "value": "recaptcha_v3", "label": "reCAPTCHA v3" }
    ]},
    { "type": "text", "id": "captcha_site_key", "label": "Captcha site key" },

    { "type": "header", "content": "Button" },
    { "type": "text", "id": "button_label", "label": "Button label", "default": "Subscribe" },
    { "type": "select", "id": "button_variant", "label": "Variant", "default": "inherit", "options": [
      { "value": "inherit", "label": "— Theme default —" },
      { "value": "solid", "label": "Solid" },
      { "value": "outline", "label": "Outline" },
      { "value": "ghost", "label": "Ghost" }
    ]},

    { "type": "header", "content": "Form UI" },
    { "type": "color", "id": "form_bg", "label": "Form background", "default": "#ffffff" },
    { "type": "range", "id": "input_radius", "label": "Input radius", "min": 0, "max": 20, "step": 1, "default": 10 },
    { "type": "color", "id": "input_border", "label": "Input border color", "default": "#e5e7eb" },

    { "type": "header", "content": "Sizing & visibility" },
    { "type": "select", "id": "container_mode", "label": "Container", "default": "contained", "options": [
      { "value": "contained", "label": "Contained" },
      { "value": "full", "label": "Full-bleed" }
    ]},
    { "type": "range", "id": "padding_y", "label": "Padding Y", "min": 0, "max": 160, "step": 8, "default": 64 },
    { "type": "range", "id": "padding_x", "label": "Padding X", "min": 0, "max": 120, "step": 8, "default": 24 },
    { "type": "range", "id": "card_radius", "label": "Card radius", "min": 0, "max": 32, "step": 1, "default": 16 },
    { "type": "range", "id": "card_shadow", "label": "Card elevation", "min": 0, "max": 3, "step": 1, "default": 2 },
    { "type": "checkbox", "id": "hide_on_mobile", "label": "Hide on mobile", "default": false },
    { "type": "checkbox", "id": "hide_on_desktop", "label": "Hide on desktop", "default": false }
  ],
  "blocks": [
    {
      "type": "field",
      "name": "Field",
      "settings": [
        { "type": "select", "id": "field_type", "label": "Type", "default": "email", "options": [
          { "value": "email", "label": "Email" },
          { "value": "text", "label": "Text" },
          { "value": "select", "label": "Select" },
          { "value": "radio", "label": "Radio group" },
          { "value": "checkbox", "label": "Checkbox" },
          { "value": "consent", "label": "Consent" },
          { "value": "html", "label": "HTML content" }
        ]},
        { "type": "text", "id": "name_attr", "label": "Input name (custom endpoint mode)" },
        { "type": "text", "id": "label", "label": "Label" },
        { "type": "text", "id": "placeholder", "label": "Placeholder"},
        { "type": "checkbox", "id": "required", "label": "Required", "default": true },
        { "type": "textarea", "id": "help_text", "label": "Help text" },
        { "type": "text", "id": "default_value", "label": "Default/hidden value" },
        { "type": "textarea", "id": "options", "label": "Options (one per line, value|label)" },
        { "type": "select", "id": "width", "label": "Width", "default": "full", "options": [
          { "value": "half", "label": "1/2" },
          { "value": "full", "label": "Full" }
        ]},
        { "type": "checkbox", "id": "condition_enable", "label": "Show conditionally", "default": false },
        { "type": "text", "id": "condition_field", "label": "When field name equals…" },
        { "type": "text", "id": "condition_value", "label": "…this value (or 'checked')" },
        { "type": "select", "id": "condition_operator", "label": "Operator", "default": "equals", "options": [
          { "value": "equals", "label": "Equals" },
          { "value": "contains", "label": "Contains" },
          { "value": "checked", "label": "Checked" }
        ]},
        { "type": "richtext", "id": "html_content", "label": "HTML content (for HTML type)" }
      ]
    },
    {
      "type": "step",
      "name": "Step (Steps template)",
      "settings": [
        { "type": "text", "id": "step_title", "label": "Title", "default": "Step" },
        { "type": "textarea", "id": "step_desc", "label": "Description" }
      ]
    }
  ],
  "max_blocks": 30,
  "presets": [
    {
      "name": "Call To Action – Newsletter",
      "category": "Call To Action",
      "settings": {
        "template_style": "card",
        "kicker": "Join the list",
        "heading": "Get emails you’ll actually open",
        "subheading": "Fresh articles, launch news, and occasional deals.",
        "destination": "shopify_customer",
        "button_label": "Subscribe"
      },
      "blocks": [
        { "type": "field", "settings": { "field_type": "email", "label": "Email", "placeholder": "you@example.com", "required": true, "width": "full" } },
        { "type": "field", "settings": { "field_type": "text", "name_attr": "contact[first_name]", "label": "First name", "placeholder": "Jane", "required": false, "width": "half" } },
        { "type": "field", "settings": { "field_type": "consent", "name_attr": "contact[consent]", "label": "I agree to the privacy policy", "required": true, "width": "full" } }
      ]
    }
  ]
}
{% endschema %}
