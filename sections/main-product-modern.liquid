{%- comment -%}
  Quadratum — Main Product Modern (Step 1: WORKING BASE + MIN LAYOUT CSS)
  File: sections/main-product-modern.liquid

  STEP 1 (must work with no external CSS/JS):
  - No color_scheme setting types
  - No preset includes @app blocks
  - Layout must NOT implode: includes minimal inline CSS scaffold (grid + media containment)
  - Add to cart works with no JS:
      - real <select name="id"> OR hidden fallback if picker removed
{%- endcomment -%}

{%- liquid
  assign s = section.settings
  assign p = product
  if p == blank
    break
  endif

  assign current_variant = p.selected_or_first_available_variant
  if current_variant == blank
    assign current_variant = p.variants.first
  endif

  assign media_limit = s.media_limit | default: 12

  assign featured_media = current_variant.featured_media
  if featured_media == blank
    assign featured_media = p.featured_media
  endif

  assign product_form_id = 'q-product-form-' | append: section.id

  assign has_variant_picker = false
  for b in section.blocks
    if b.type == 'variant_picker'
      assign has_variant_picker = true
    endif
  endfor
-%}

<style>
  /* ------------------------------------------------------------
     STEP 1: minimal scaffold so layout behaves before CSS file.
     This is NOT the final Quadratum styling system.
  ------------------------------------------------------------ */
  #q-main-product-modern-{{ section.id }} .q-page-width{
    max-width: 72rem; /* Dawn-ish comfortable read width */
    margin: 0 auto;
    padding: 0 1.25rem;
  }
  #q-main-product-modern-{{ section.id }}{
    padding: 2rem 0;
  }

  /* Grid */
  #q-main-product-modern-{{ section.id }} .q-grid{
    display: grid;
    gap: 2rem;
  }
  @media (min-width: 750px){
    #q-main-product-modern-{{ section.id }} .q-grid--2\@750{
      grid-template-columns: 1.15fr 0.85fr; /* media dominant but not billboard */
      align-items: start;
    }
  }

  /* Media */
  #q-main-product-modern-{{ section.id }} .q-media__viewer{
    width: 100%;
  }
  #q-main-product-modern-{{ section.id }} .q-media__frame{
    width: 100%;
    border-radius: 12px;
    overflow: hidden;
  }

  /* Constrain all media types emitted by media_tag */
  #q-main-product-modern-{{ section.id }} .q-media__frame img,
  #q-main-product-modern-{{ section.id }} .q-media__frame video,
  #q-main-product-modern-{{ section.id }} .q-media__frame iframe,
  #q-main-product-modern-{{ section.id }} .q-media__frame model-viewer{
    max-width: 100%;
    width: 100%;
    height: auto;
    display: block;
  }

  /* Thumbnails */
  #q-main-product-modern-{{ section.id }} .q-thumbs{
    list-style: none;
    margin: 1rem 0 0;
    padding: 0;
    display: flex;
    flex-wrap: wrap;
    gap: 0.75rem;
  }
  #q-main-product-modern-{{ section.id }} .q-thumb{
    display: inline-flex;
    width: 64px;
    height: 64px;
    border-radius: 10px;
    overflow: hidden;
    border: 1px solid rgba(0,0,0,.12);
    background: rgba(0,0,0,.03);
  }
  #q-main-product-modern-{{ section.id }} .q-thumb img{
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  /* Info basics */
  #q-main-product-modern-{{ section.id }} .q-product__vendor{
    font-size: .875rem;
    opacity: .75;
    margin-bottom: .25rem;
  }
  #q-main-product-modern-{{ section.id }} .q-product__title{
    font-size: clamp(1.5rem, 2.2vw, 2.25rem);
    line-height: 1.15;
    margin: 0 0 .75rem;
  }
  #q-main-product-modern-{{ section.id }} .q-price{
    font-size: 1.25rem;
    font-weight: 600;
  }
  #q-main-product-modern-{{ section.id }} .q-price--compare{
    margin-left: .5rem;
    opacity: .6;
    font-weight: 500;
  }
  #q-main-product-modern-{{ section.id }} .q-tax-note{
    margin-top: .5rem;
    font-size: .875rem;
    opacity: .75;
  }

  /* Form primitives */
  #q-main-product-modern-{{ section.id }} .q-label{
    display: block;
    font-size: .875rem;
    margin: 1rem 0 .35rem;
  }
  #q-main-product-modern-{{ section.id }} .q-select,
  #q-main-product-modern-{{ section.id }} .q-input{
    width: 100%;
    max-width: 26rem;
    padding: .65rem .75rem;
    border-radius: 10px;
    border: 1px solid rgba(0,0,0,.18);
    background: #fff;
  }
  #q-main-product-modern-{{ section.id }} .q-btn{
    width: 100%;
    max-width: 26rem;
    margin-top: 1rem;
    padding: .85rem 1rem;
    border-radius: 10px;
    border: 1px solid rgba(0,0,0,.85);
    background: rgba(0,0,0,.92);
    color: #fff;
    font-weight: 600;
    cursor: pointer;
  }
  #q-main-product-modern-{{ section.id }} .q-btn[disabled]{
    opacity: .5;
    cursor: not-allowed;
  }
  #q-main-product-modern-{{ section.id }} .q-dynamic-checkout{
    max-width: 26rem;
    margin-top: .75rem;
  }

  /* RTE */
  #q-main-product-modern-{{ section.id }} .q-rte{
    margin-top: 1.25rem;
  }

  /* Collapsible */
  #q-main-product-modern-{{ section.id }} details{
    max-width: 42rem;
    margin-top: 1rem;
    border: 1px solid rgba(0,0,0,.12);
    border-radius: 10px;
    padding: .75rem .9rem;
    background: rgba(0,0,0,.02);
  }
  #q-main-product-modern-{{ section.id }} summary{
    cursor: pointer;
    font-weight: 600;
  }
  #q-main-product-modern-{{ section.id }} .q-accordion__content{
    margin-top: .75rem;
  }
</style>

<section
  id="q-main-product-modern-{{ section.id }}"
  class="q-main-product-modern"
  data-section-id="{{ section.id }}"
  data-product-id="{{ p.id }}"
>
  <div class="q-page-width">
    <div class="q-product q-grid q-grid--1 q-grid--2@750">
      <!-- MEDIA COLUMN -->
      <div class="q-product__media">
        {%- if p.media.size > 0 -%}
          <div class="q-media">
            <div class="q-media__viewer" id="q-media-viewer-{{ section.id }}">
              {%- if featured_media != blank -%}
                <div class="q-media__frame" data-media-id="{{ featured_media.id }}">
                  {{ featured_media | media_tag }}
                </div>
              {%- else -%}
                <div class="q-media__frame">
                  {{ p.media.first | media_tag }}
                </div>
              {%- endif -%}
            </div>

            {%- if s.show_thumbnails and p.media.size > 1 -%}
              <div class="q-media__thumbs" aria-label="Product media thumbnails">
                <ul class="q-thumbs" role="list">
                  {%- for m in p.media limit: media_limit -%}
                    {%- assign timg = m.preview_image -%}
                    <li class="q-thumbs__item" role="listitem">
                      {%- if timg != blank -%}
                        {%- assign loading_attr = 'lazy' -%}
                        {%- assign fetchpriority_attr = blank -%}
                        {%- if forloop.first -%}
                          {%- assign loading_attr = 'eager' -%}
                          {%- assign fetchpriority_attr = 'high' -%}
                        {%- endif -%}

                        {%- comment -%}
                          Step 1: no JS gallery switching.
                          Clicking a thumb should NOT navigate away.
                          So we render thumbnails as non-link buttons for now.
                        {%- endcomment -%}
                        <button
                          type="button"
                          class="q-thumb"
                          aria-label="Thumbnail {{ forloop.index }}"
                        >
                          <img
                            src="{{ timg | image_url: width: 160 }}"
                            alt="{{ timg.alt | default: p.title | escape }}"
                            loading="{{ loading_attr }}"
                            {%- if fetchpriority_attr != blank -%}fetchpriority="{{ fetchpriority_attr }}"{%- endif -%}
                            width="160"
                            height="160"
                          >
                        </button>
                      {%- else -%}
                        <span class="q-thumb" aria-hidden="true"></span>
                      {%- endif -%}
                    </li>
                  {%- endfor -%}
                </ul>
              </div>
            {%- endif -%}
          </div>
        {%- else -%}
          <div class="q-media q-media--empty" aria-hidden="true"></div>
        {%- endif -%}
      </div>

      <!-- INFO COLUMN -->
      <div class="q-product__info">
        {%- for block in section.blocks -%}
          {%- case block.type -%}

            {%- when '@app' -%}
              <div class="q-block q-block--app" {{ block.shopify_attributes }}>
                {%- render block -%}
              </div>

            {%- when 'text' -%}
              <p class="q-block q-block--text" {{ block.shopify_attributes }}>
                {{ block.settings.text }}
              </p>

            {%- when 'title' -%}
              <div class="q-block q-block--title" {{ block.shopify_attributes }}>
                {%- if s.show_vendor and p.vendor != blank -%}
                  <div class="q-product__vendor">{{ p.vendor }}</div>
                {%- endif -%}
                <h1 class="q-product__title">{{ p.title }}</h1>
              </div>

            {%- when 'price' -%}
              <div class="q-block q-block--price" {{ block.shopify_attributes }}>
                {%- if current_variant.compare_at_price > current_variant.price -%}
                  <span class="q-price q-price--sale">{{ current_variant.price | money }}</span>
                  <span class="q-price q-price--compare"><s>{{ current_variant.compare_at_price | money }}</s></span>
                {%- else -%}
                  <span class="q-price q-price--regular">{{ current_variant.price | money }}</span>
                {%- endif -%}

                {%- if cart.taxes_included or cart.duties_included or shop.shipping_policy.body != blank -%}
                  <div class="q-tax-note">
                    {%- if cart.duties_included and cart.taxes_included -%}
                      {{ 'products.product.duties_and_taxes_included' | t }}
                    {%- elsif cart.taxes_included -%}
                      {{ 'products.product.taxes_included' | t }}
                    {%- elsif cart.duties_included -%}
                      {{ 'products.product.duties_included' | t }}
                    {%- endif -%}
                    {%- if shop.shipping_policy.body != blank -%}
                      {{ 'products.product.shipping_policy_html' | t: link: shop.shipping_policy.url }}
                    {%- endif -%}
                  </div>
                {%- endif -%}

                {%- if s.show_payment_terms -%}
                  {%- assign installment_id = 'q-installment-' | append: section.id -%}
                  {%- form 'product', p, id: installment_id, class: 'q-installment' -%}
                    <input type="hidden" name="id" value="{{ current_variant.id }}">
                    {{ form | payment_terms }}
                  {%- endform -%}
                {%- endif -%}
              </div>

            {%- when 'sku' -%}
              <div class="q-block q-block--sku" {{ block.shopify_attributes }}>
                {%- if current_variant.sku != blank -%}
                  <span class="q-sku-label">{{ 'products.product.sku' | t }}:</span>
                  <span class="q-sku">{{ current_variant.sku }}</span>
                {%- endif -%}
              </div>

            {%- when 'inventory' -%}
              <div class="q-block q-block--inventory" {{ block.shopify_attributes }}>
                {%- if current_variant.inventory_management == 'shopify' -%}
                  {%- if current_variant.inventory_quantity > 0 -%}
                    {%- if current_variant.inventory_quantity <= block.settings.inventory_threshold -%}
                      <span class="q-inventory q-inventory--low">
                        {%- if block.settings.show_inventory_quantity -%}
                          {{ 'products.product.inventory_low_stock_show_count' | t: quantity: current_variant.inventory_quantity }}
                        {%- else -%}
                          {{ 'products.product.inventory_low_stock' | t }}
                        {%- endif -%}
                      </span>
                    {%- else -%}
                      <span class="q-inventory q-inventory--in">
                        {%- if block.settings.show_inventory_quantity -%}
                          {{ 'products.product.inventory_in_stock_show_count' | t: quantity: current_variant.inventory_quantity }}
                        {%- else -%}
                          {{ 'products.product.inventory_in_stock' | t }}
                        {%- endif -%}
                      </span>
                    {%- endif -%}
                  {%- else -%}
                    {%- if current_variant.inventory_policy == 'continue' -%}
                      <span class="q-inventory q-inventory--continue">
                        {{ 'products.product.inventory_out_of_stock_continue_selling' | t }}
                      </span>
                    {%- else -%}
                      <span class="q-inventory q-inventory--out">
                        {{ 'products.product.inventory_out_of_stock' | t }}
                      </span>
                    {%- endif -%}
                  {%- endif -%}
                {%- endif -%}
              </div>

            {%- when 'variant_picker' -%}
              <div class="q-block q-block--variant-picker" {{ block.shopify_attributes }}>
                {%- unless p.has_only_default_variant -%}
                  <label class="q-label" for="q-variant-select-{{ section.id }}">
                    {{ block.settings.label | default: 'Variant' }}
                  </label>
                {%- endunless -%}

                <select id="q-variant-select-{{ section.id }}" name="id" form="{{ product_form_id }}" class="q-select">
                  {%- for v in p.variants -%}
                    <option
                      value="{{ v.id }}"
                      {% if v.id == current_variant.id %}selected{% endif %}
                      {% unless v.available %}disabled{% endunless %}
                    >
                      {{ v.title }}{%- unless v.available -%} — {{ 'products.product.sold_out' | t }}{%- endunless -%}
                    </option>
                  {%- endfor -%}
                </select>
              </div>

            {%- when 'quantity_selector' -%}
              <div class="q-block q-block--qty" {{ block.shopify_attributes }}>
                <label class="q-label" for="q-qty-{{ section.id }}">{{ 'products.product.quantity.label' | t }}</label>
                <input
                  id="q-qty-{{ section.id }}"
                  class="q-input"
                  type="number"
                  name="quantity"
                  value="1"
                  min="1"
                  inputmode="numeric"
                  form="{{ product_form_id }}"
                >
              </div>

            {%- when 'buy_buttons' -%}
              <div class="q-block q-block--buy" {{ block.shopify_attributes }}>
                {%- form 'product', p, id: product_form_id, class: 'q-product-form', novalidate: 'novalidate' -%}
                  {%- unless has_variant_picker -%}
                    <input type="hidden" name="id" value="{{ current_variant.id }}">
                  {%- endunless -%}

                  <button
                    type="submit"
                    name="add"
                    class="q-btn q-btn--primary"
                    {% unless current_variant.available %}disabled{% endunless %}
                  >
                    {%- if current_variant.available -%}
                      {{ 'products.product.add_to_cart' | t }}
                    {%- else -%}
                      {{ 'products.product.sold_out' | t }}
                    {%- endif -%}
                  </button>

                  {%- if block.settings.show_dynamic_checkout -%}
                    <div class="q-dynamic-checkout">
                      {{ form | payment_button }}
                    </div>
                  {%- endif -%}
                {%- endform -%}
              </div>

            {%- when 'description' -%}
              <div class="q-block q-block--description q-rte" {{ block.shopify_attributes }}>
                {%- if p.description != blank -%}
                  {{ p.description }}
                {%- endif -%}
              </div>

            {%- when 'collapsible_tab' -%}
              <div class="q-block q-block--accordion" {{ block.shopify_attributes }}>
                <details>
                  <summary>
                    <span class="q-accordion__title">
                      {{ block.settings.heading | default: block.settings.page.title | escape }}
                    </span>
                  </summary>
                  <div class="q-accordion__content q-rte">
                    {{ block.settings.content }}
                    {{ block.settings.page.content }}
                  </div>
                </details>
              </div>

            {%- when 'popup' -%}
              <div class="q-block q-block--popup" {{ block.shopify_attributes }}>
                <details class="q-popup">
                  <summary class="q-link">
                    {{ block.settings.text | default: block.settings.page.title | escape }}
                  </summary>
                  <div class="q-popup__content q-rte">
                    {%- if block.settings.page != blank -%}
                      <h2 class="q-h2">{{ block.settings.page.title | escape }}</h2>
                      {{ block.settings.page.content }}
                    {%- endif -%}
                  </div>
                </details>
              </div>

            {%- when 'share' -%}
              <div class="q-block q-block--share" {{ block.shopify_attributes }}>
                {%- assign share_url = current_variant.url | default: p.url | prepend: request.origin -%}
                <label class="q-label" for="q-share-{{ section.id }}">
                  {{ block.settings.share_label | default: 'Share' }}
                </label>
                <input id="q-share-{{ section.id }}" class="q-input" type="text" readonly value="{{ share_url }}">
              </div>

            {%- when 'rating' -%}
              <div class="q-block q-block--rating" {{ block.shopify_attributes }}>
                {%- if p.metafields.reviews.rating.value != blank -%}
                  <div class="q-rating">
                    <span class="q-rating__value">
                      {{ p.metafields.reviews.rating.value.rating }} / {{ p.metafields.reviews.rating.value.scale_max }}
                    </span>
                    {%- if p.metafields.reviews.rating_count != blank -%}
                      <span class="q-rating__count">({{ p.metafields.reviews.rating_count }})</span>
                    {%- endif -%}
                  </div>
                {%- endif -%}
              </div>

            {%- when 'complementary' -%}
              <div class="q-block q-block--complementary" {{ block.shopify_attributes }}>
                <h2 class="q-h2">{{ block.settings.block_heading | default: 'You may also like' }}</h2>
                <div class="q-note">Step 2 wires this to recommendations.</div>
              </div>

            {%- when 'custom_liquid' -%}
              <div class="q-block q-block--custom-liquid" {{ block.shopify_attributes }}>
                {{ block.settings.custom_liquid }}
              </div>

          {%- endcase -%}
        {%- endfor -%}

        <script type="application/ld+json">
          {{ p | structured_data }}
        </script>
      </div>
    </div>
  </div>
</section>

{% schema %}
{
  "name": "Main Product - Modern",
  "tag": "section",
  "class": "section",
  "settings": [
    { "type": "header", "content": "Layout" },
    { "type": "checkbox", "id": "show_vendor", "label": "Show vendor", "default": true },
    { "type": "checkbox", "id": "show_thumbnails", "label": "Show thumbnails", "default": true },
    { "type": "range", "id": "media_limit", "label": "Media limit", "min": 1, "max": 24, "step": 1, "default": 12 },
    { "type": "checkbox", "id": "show_payment_terms", "label": "Show payment terms", "default": true }
  ],
  "blocks": [
    { "type": "@app" },

    {
      "type": "text",
      "name": "Text",
      "settings": [
        { "type": "inline_richtext", "id": "text", "label": "Text", "default": "Free shipping over $50" }
      ]
    },

    { "type": "title", "name": "Title", "limit": 1 },
    { "type": "price", "name": "Price", "limit": 1 },

    { "type": "sku", "name": "SKU", "limit": 1 },

    {
      "type": "inventory",
      "name": "Inventory",
      "limit": 1,
      "settings": [
        { "type": "range", "id": "inventory_threshold", "label": "Low stock threshold", "min": 0, "max": 100, "step": 1, "default": 10 },
        { "type": "checkbox", "id": "show_inventory_quantity", "label": "Show inventory quantity", "default": true }
      ]
    },

    {
      "type": "variant_picker",
      "name": "Variant picker",
      "limit": 1,
      "settings": [
        { "type": "text", "id": "label", "label": "Label", "default": "Variant" }
      ]
    },

    { "type": "quantity_selector", "name": "Quantity selector", "limit": 1 },

    {
      "type": "buy_buttons",
      "name": "Buy buttons",
      "limit": 1,
      "settings": [
        { "type": "checkbox", "id": "show_dynamic_checkout", "label": "Show dynamic checkout", "default": false }
      ]
    },

    { "type": "description", "name": "Description", "limit": 1 },

    {
      "type": "collapsible_tab",
      "name": "Collapsible row",
      "settings": [
        { "type": "text", "id": "heading", "label": "Heading", "default": "Details" },
        { "type": "richtext", "id": "content", "label": "Content" },
        { "type": "page", "id": "page", "label": "Page" }
      ]
    },

    {
      "type": "popup",
      "name": "Popup",
      "settings": [
        { "type": "text", "id": "text", "label": "Link label", "default": "Learn more" },
        { "type": "page", "id": "page", "label": "Page" }
      ]
    },

    {
      "type": "share",
      "name": "Share",
      "limit": 1,
      "settings": [
        { "type": "text", "id": "share_label", "label": "Label", "default": "Share" }
      ]
    },

    { "type": "rating", "name": "Rating", "limit": 1 },

    {
      "type": "complementary",
      "name": "Complementary products",
      "limit": 1,
      "settings": [
        { "type": "text", "id": "block_heading", "label": "Heading", "default": "You may also like" }
      ]
    },

    {
      "type": "custom_liquid",
      "name": "Custom liquid",
      "settings": [
        { "type": "liquid", "id": "custom_liquid", "label": "Liquid" }
      ]
    }
  ],
  "presets": [
    {
      "name": "Main Product - Modern",
      "category": "Product",
      "blocks": [
        { "type": "title" },
        { "type": "price" },
        { "type": "variant_picker" },
        { "type": "quantity_selector" },
        { "type": "buy_buttons" },
        { "type": "description" }
      ]
    }
  ]
}
{% endschema %}
