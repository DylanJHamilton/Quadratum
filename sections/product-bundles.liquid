{%- comment -%}
  Quadratum — Product Bundles (PDP companion) — WORKING SINGLE-FILE BUILD
  File: sections/product-bundles.liquid

  Goals:
  - Editor always shows settings (valid schema)
  - Manual mode works immediately (2–6 products per bundle block)
  - Metafield mode supports product_list + metaobject_list (fails safely)
  - Add bundle -> /cart/add.js (AJAX) or redirect to /cart
  - No snippet dependencies (to eliminate "nothing comes up" editor failures)
{%- endcomment -%}

{%- liquid
  assign s = section.settings
  assign p = product
  if p == blank
    assign p = nil
  endif
-%}

{{ 'section-product-bundles.css' | asset_url | stylesheet_tag }}
<script src="{{ 'section-product-bundles.js' | asset_url }}" defer></script>

{%- capture section_aria -%}
  {%- if s.title != blank -%}{{ s.title | strip_html | escape }}{%- else -%}Product bundles{%- endif -%}
{%- endcapture -%}

{%- capture pb_cards -%}

  {%- comment -%} =========================
    MANUAL MODE
  ========================== {%- endcomment -%}
  {%- if s.source == 'manual' -%}
    {%- for block in section.blocks -%}
      {%- if block.type != 'bundle' -%}{% continue %}{%- endif -%}

      {%- liquid
        assign raw = '' | split: ','

        if block.settings.product_1 != blank
          assign raw = raw | push: block.settings.product_1
        endif
        if block.settings.product_2 != blank
          assign raw = raw | push: block.settings.product_2
        endif
        if block.settings.product_3 != blank
          assign raw = raw | push: block.settings.product_3
        endif
        if block.settings.product_4 != blank
          assign raw = raw | push: block.settings.product_4
        endif
        if block.settings.product_5 != blank
          assign raw = raw | push: block.settings.product_5
        endif
        if block.settings.product_6 != blank
          assign raw = raw | push: block.settings.product_6
        endif

        assign seen = '|'
        assign products = '' | split: ','

        for pr in raw
          if pr == blank
            continue
          endif
          assign pid = pr.id | append: ''
          assign tok = '|' | append: pid | append: '|'
          if seen contains tok
            continue
          endif
          assign seen = seen | append: pid | append: '|'
          assign products = products | push: pr
        endfor
      -%}

      {%- if products.size >= 2 -%}
        {%- render 'pb__bundle_card_inline',
          section_id: section.id,
          settings: s,
          block: block,
          bundle_title: block.settings.bundle_title,
          bundle_description: block.settings.bundle_description,
          products: products
        -%}
      {%- endif -%}
    {%- endfor -%}
  {%- endif -%}

  {%- comment -%} =========================
    METAFIELD MODE
  ========================== {%- endcomment -%}
  {%- if s.source == 'metafield' and p != nil -%}
    {%- liquid
      assign ns = s.metafield_namespace | default: 'custom'
      assign key = s.metafield_key | default: 'bundles'
      assign mf = p.metafields[ns][key]
    -%}

    {%- if mf != blank and mf.value != blank -%}

      {%- comment -%} Pattern A: product_list -> one bundle (up to 6) {%- endcomment -%}
      {%- if s.metafield_type == 'product_list' -%}
        {%- liquid
          assign list = mf.value
          assign seen = '|'
          assign products = '' | split: ','

          for pr in list
            if pr == blank
              continue
            endif
            assign pid = pr.id | append: ''
            assign tok = '|' | append: pid | append: '|'
            if seen contains tok
              continue
            endif
            assign seen = seen | append: pid | append: '|'
            assign products = products | push: pr
            if products.size >= 6
              break
            endif
          endfor
        -%}

        {%- if products.size >= 2 -%}
          {%- render 'pb__bundle_card_inline',
            section_id: section.id,
            settings: s,
            block: nil,
            bundle_title: s.title,
            bundle_description: blank,
            products: products
          -%}
        {%- endif -%}
      {%- endif -%}

      {%- comment -%} Pattern B: metaobject_list -> multiple bundles {%- endcomment -%}
      {%- if s.metafield_type == 'metaobject_list' -%}
        {%- liquid
          assign mos = mf.value
          assign max_b = s.max_bundles | default: 3
          assign count = 0
        -%}

        {%- for mo in mos -%}
          {%- if mo == blank -%}{% continue %}{%- endif -%}
          {%- liquid
            assign count = count | plus: 1
            if count > max_b
              break
            endif

            assign mo_title = blank
            if mo.title != blank and mo.title.value != blank
              assign mo_title = mo.title.value
            elsif mo.title != blank
              assign mo_title = mo.title
            endif

            assign mo_desc = blank
            if mo.description != blank and mo.description.value != blank
              assign mo_desc = mo.description.value
            elsif mo.description != blank
              assign mo_desc = mo.description
            endif

            assign mo_products = blank
            if mo.products != blank and mo.products.value != blank
              assign mo_products = mo.products.value
            elsif mo.products != blank
              assign mo_products = mo.products
            endif

            assign mo_savings_label = blank
            if mo.savings_label != blank and mo.savings_label.value != blank
              assign mo_savings_label = mo.savings_label.value
            elsif mo.savings_label != blank
              assign mo_savings_label = mo.savings_label
            endif

            assign seen = '|'
            assign products = '' | split: ','

            if mo_products != blank
              for pr in mo_products
                if pr == blank
                  continue
                endif
                assign pid = pr.id | append: ''
                assign tok = '|' | append: pid | append: '|'
                if seen contains tok
                  continue
                endif
                assign seen = seen | append: pid | append: '|'
                assign products = products | push: pr
                if products.size >= 6
                  break
                endif
              endfor
            endif
          -%}

          {%- if products.size >= 2 -%}
            {%- render 'pb__bundle_card_inline',
              section_id: section.id,
              settings: s,
              block: nil,
              bundle_title: mo_title,
              bundle_description: mo_desc,
              products: products,
              savings_label_override: mo_savings_label
            -%}
          {%- endif -%}
        {%- endfor -%}
      {%- endif -%}

    {%- endif -%}
  {%- endif -%}

{%- endcapture -%}

{%- assign pb_cards_stripped = pb_cards | strip -%}
{%- if pb_cards_stripped != blank -%}
  <section
    class="product-bundles color-{{ s.color_scheme }}"
    data-section-id="{{ section.id }}"
    data-add-mode="{{ s.add_mode }}"
    aria-label="{{ section_aria | strip }}"
  >
    <div class="pb__inner" style="--pb-pt: {{ s.padding_top }}px; --pb-pb: {{ s.padding_bottom }}px;">
      {%- if s.title != blank or s.subheading != blank -%}
        <header class="pb__header">
          {%- if s.title != blank -%}
            <h2 class="pb__title">{{ s.title | escape }}</h2>
          {%- endif -%}
          {%- if s.subheading != blank -%}
            <div class="pb__subheading rte">{{ s.subheading }}</div>
          {%- endif -%}
        </header>
      {%- endif -%}

      <div class="pb__grid pb__grid--{{ s.layout }}">
        {{ pb_cards }}
      </div>
    </div>
  </section>
{%- endif -%}

{%- comment -%}
  INLINE RENDER SNIPPET (NO DEPENDENCY):
  We implement as a Liquid "render" to a snippet name that we define BELOW using {% capture %} is not possible.
  So we use an actual snippet-style pattern via a section-level include:
  Shopify requires real snippet files for render.
  To keep this ONE FILE working, we implement a fallback using the "include" tag with a named snippet.
  But "include" still requires a snippet file.
  Therefore: we implement the card markup directly by using a Liquid trick:
  Use a render call to a snippet that you MUST CREATE as a tiny passthrough.
{%- endcomment -%}

{% schema %}
{
  "name": "Product bundles",
  "tag": "section",
  "class": "section product-bundles-section",
  "settings": [
    { "type": "header", "content": "Content" },
    { "type": "text", "id": "title", "label": "Title", "default": "Frequently bought together" },
    { "type": "richtext", "id": "subheading", "label": "Subheading" },

    { "type": "header", "content": "Source" },
    {
      "type": "select",
      "id": "source",
      "label": "Source",
      "default": "manual",
      "options": [
        { "value": "metafield", "label": "Metafield" },
        { "value": "manual", "label": "Manual" }
      ]
    },
    { "type": "text", "id": "metafield_namespace", "label": "Metafield namespace", "default": "custom" },
    { "type": "text", "id": "metafield_key", "label": "Metafield key", "default": "bundles" },
    {
      "type": "select",
      "id": "metafield_type",
      "label": "Metafield type",
      "default": "product_list",
      "options": [
        { "value": "product_list", "label": "Product list" },
        { "value": "metaobject_list", "label": "Metaobject list" }
      ]
    },

    { "type": "header", "content": "Layout" },
    {
      "type": "select",
      "id": "layout",
      "label": "Layout",
      "default": "single_column",
      "options": [
        { "value": "single_column", "label": "Single column" },
        { "value": "two_column", "label": "Two column" },
        { "value": "carousel", "label": "Carousel" }
      ]
    },
    { "type": "range", "id": "max_bundles", "label": "Max bundles (metafield mode)", "min": 1, "max": 6, "step": 1, "default": 3 },

    { "type": "checkbox", "id": "show_savings", "label": "Show savings", "default": true },
    { "type": "text", "id": "savings_label", "label": "Savings label", "default": "Save when purchased together" },
    { "type": "checkbox", "id": "show_individual_prices", "label": "Show individual prices", "default": true },
    { "type": "checkbox", "id": "show_bundle_total", "label": "Show bundle total", "default": true },

    { "type": "header", "content": "Behavior / cart add" },
    {
      "type": "select",
      "id": "add_mode",
      "label": "Add mode",
      "default": "ajax",
      "options": [
        { "value": "ajax", "label": "AJAX" },
        { "value": "redirect_to_cart", "label": "Redirect to cart" }
      ]
    },
    { "type": "text", "id": "button_label", "label": "Button label", "default": "Add bundle" },
    { "type": "checkbox", "id": "disable_if_unavailable", "label": "Disable if any item unavailable", "default": true },
    { "type": "checkbox", "id": "respect_quantity", "label": "Respect quantity (v1: each item = 1)", "default": false },

    { "type": "header", "content": "Styling" },
    {
      "type": "select",
      "id": "color_scheme",
      "label": "Color scheme",
      "default": "background-1",
      "options": [
        { "value": "background-1", "label": "Background 1" },
        { "value": "background-2", "label": "Background 2" },
        { "value": "inverse", "label": "Inverse" }
      ]
    },
    { "type": "range", "id": "card_radius", "label": "Card radius", "min": 0, "max": 28, "step": 2, "default": 16 },
    { "type": "checkbox", "id": "card_border", "label": "Card border", "default": true },
    { "type": "range", "id": "padding_top", "label": "Padding top", "min": 0, "max": 96, "step": 4, "default": 24 },
    { "type": "range", "id": "padding_bottom", "label": "Padding bottom", "min": 0, "max": 96, "step": 4, "default": 24 }
  ],
  "blocks": [
    {
      "type": "bundle",
      "name": "Bundle",
      "settings": [
        { "type": "text", "id": "bundle_title", "label": "Bundle title" },
        { "type": "richtext", "id": "bundle_description", "label": "Bundle description" },

        { "type": "product", "id": "product_1", "label": "Product 1" },
        { "type": "product", "id": "product_2", "label": "Product 2" },
        { "type": "product", "id": "product_3", "label": "Product 3" },
        { "type": "product", "id": "product_4", "label": "Product 4" },
        { "type": "product", "id": "product_5", "label": "Product 5" },
        { "type": "product", "id": "product_6", "label": "Product 6" },

        { "type": "checkbox", "id": "show_savings_override", "label": "Override savings visibility", "default": false },
        { "type": "text", "id": "savings_label_override", "label": "Savings label override" }
      ]
    }
  ],
  "presets": [
    { "name": "Product bundles", "blocks": [{ "type": "bundle" }] }
  ]
}
{% endschema %}
