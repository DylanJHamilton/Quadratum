{% comment %}
  Quadratum • Special Offers Banner
  - Multi-offer promo tiles with animated badges + optional featured product block.
  - Background: solid or gradient (two colors + angle) and optional image + overlay.
  - Perf: responsive images; eager only on first visual; lazy elsewhere.
  - A11y: reduced-motion aware; clear aria; focus-visible rings; contrastable buttons.
  - Analytics: optional events; data-cta & indexes on clicks; cart add custom event.
{% endcomment %}

{% assign s = section.settings %}

{%- comment -%} container padding if contained {%- endcomment -%}
{% assign container_pad = '' %}
{% if s.container_mode == 'contained' %}
  {% assign container_pad = 'px-4 md:px-6' %}
{% endif %}

{%- comment -%} show/hide visibility {%- endcomment -%}
{% assign visibility_classes = '' %}
{% if s.hide_on_mobile %}{% assign visibility_classes = visibility_classes | append: ' hidden md:block' %}{% endif %}
{% if s.hide_on_desktop %}{% assign visibility_classes = visibility_classes | append: ' md:hidden' %}{% endif %}

{%- comment -%} grid columns for offers {%- endcomment -%}
{% assign cols = s.cols_desktop | default: '2' %}
{% case cols %}
  {% when '1' %}{% assign grid_cols = 'grid-cols-1' %}
  {% when '2' %}{% assign grid_cols = 'grid-cols-1 md:grid-cols-2' %}
  {% when '3' %}{% assign grid_cols = 'grid-cols-1 md:grid-cols-3' %}
  {% else %}{% assign grid_cols = 'grid-cols-1 md:grid-cols-2' %}
{% endcase %}

{%- comment -%} background style (gradient + image + overlay) {%- endcomment -%}
{% assign has_gradient = s.use_gradient %}
{% assign angle = s.gradient_angle | default: 135 %}
{% assign grad_c1 = s.gradient_color_1 | default: '#111111' %}
{% assign grad_c2 = s.gradient_color_2 | default: '#000000' %}
{% assign bg_style = '' %}
{% if has_gradient %}
  {% assign bg_style = 'background: linear-gradient(' | append: angle | append: 'deg, ' | append: grad_c1 | append: ', ' | append: grad_c2 | append: ');' %}
{% else %}
  {% assign bg_style = 'background-color: ' | append: s.solid_bg_color | append: ';' %}
{% endif %}

<section
  id="{{ s.anchor_id | default: 'section-' | append: section.id }}"
  class="relative {{ s.pad_y | default: 'py-12 md:py-16' }}{{ visibility_classes }}"
  role="region"
  aria-label="{{ s.region_label | default: 'Special offers' }}"
  style="{{ bg_style }}"
>
  {%- if s.background_image != blank -%}
    {%- assign sizes_str = '100vw' -%}
    {%- assign widths_str = '960,1280,1600,1920,2240' -%}
    <div class="absolute inset-0 -z-10">
      {{ s.background_image
        | image_url: width: 2240
        | image_tag:
          widths: widths_str,
          sizes: sizes_str,
          loading: 'eager',
          fetchpriority: 'high',
          class: 'absolute inset-0 w-full h-full object-cover',
          alt: s.bg_image_alt }}
      <div class="absolute inset-0" aria-hidden="true"
           style="background-color: {{ s.overlay_color }}; opacity: {{ s.overlay_opacity | divided_by: 100.0 }};">
      </div>
    </div>
  {%- endif -%}

  {%- if s.kicker != blank or s.heading != blank or s.subheading != blank -%}
    <div class="mx-auto max-w-screen-xl {{ container_pad }} mb-8 md:mb-10">
      {%- if s.kicker != blank -%}
        <p class="text-sm font-semibold tracking-wide uppercase text-muted-foreground rtl:text-right">{{ s.kicker }}</p>
      {%- endif -%}
      {%- if s.heading != blank -%}
        <h2 class="mt-2 text-2xl md:text-4xl font-semibold leading-tight text-foreground">{{ s.heading | escape }}</h2>
      {%- endif -%}
      {%- if s.subheading != blank -%}
        <p class="mt-3 text-base md:text-lg text-muted-foreground">{{ s.subheading }}</p>
      {%- endif -%}
    </div>
  {%- endif -%}

  <div class="mx-auto max-w-screen-xl {{ container_pad }}">
    <div class="grid {{ grid_cols }} gap-4 md:gap-6">
      {%- assign offers = section.blocks | where: 'type', 'offer' -%}
      {%- assign prods  = section.blocks | where: 'type', 'product' -%}

      {%- for block in offers -%}
        {%- assign b = block.settings -%}
        {%- assign sizes_offer = '(min-width: 768px) 50vw, 100vw' -%}
        {%- assign widths_offer = '640,750,828,960,1080,1280' -%}

        <article class="relative overflow-hidden rounded-2xl bg-card ring-1 ring-border group focus-within:ring-2 focus-within:ring-primary" {{ block.shopify_attributes }}>
          {%- if b.background_image != blank -%}
            <div class="absolute inset-0 -z-10">
              {{ b.background_image
                | image_url: width: 1280
                | image_tag:
                  widths: widths_offer,
                  sizes: sizes_offer,
                  loading: 'lazy',
                  class: 'absolute inset-0 w-full h-full object-cover',
                  alt: b.image_alt }}
              <div class="absolute inset-0" aria-hidden="true"
                   style="background-color: {{ b.overlay_color | default: '#000000' }}; opacity: {{ b.overlay_opacity | default: 30 | divided_by: 100.0 }};">
              </div>
            </div>
          {%- endif -%}

          <div class="relative p-6 md:p-8 flex flex-col gap-3">
            {%- if b.badge_text != blank -%}
              <span class="inline-flex items-center gap-2 text-xs font-bold uppercase tracking-wide text-white
                           {% if b.badge_shape == 'pill' %}rounded-full px-3 py-1 bg-[{{ b.badge_bg }}]{% else %}q-burst px-3 py-1{% endif %}
                           {% if b.flash_badge %}q-flash{% endif %}"
                    style="{% if b.badge_shape == 'pill' %}background-color: {{ b.badge_bg }};{% endif %} color: {{ b.badge_color }};"
                    aria-label="{{ b.badge_aria | default: b.badge_text | escape }}">
                {%- if b.badge_icon != 'none' -%}
                  {% case b.badge_icon %}
                    {% when 'star' %}
                      <svg class="h-3.5 w-3.5" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.802 2.036a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.802-2.036a1 1 0 00-1.176 0l-2.802 2.036c-.785.57-1.84-.197-1.54-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.88 8.72c-.783-.57-.38-1.81.588-1.81h3.462a1 1 0 00.95-.69l1.07-3.292z"/></svg>
                    {% when 'bolt' %}
                      <svg class="h-3.5 w-3.5" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true"><path d="M11.3 1L3 11h5l-.8 8L15 9h-5l1.3-8z"/></svg>
                    {% when 'tag' %}
                      <svg class="h-3.5 w-3.5" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true"><path d="M17.707 10.293l-7-7A1 1 0 009.586 3H4a1 1 0 00-1 1v5.586a1 1 0 00.293.707l7 7a1 1 0 001.414 0l6-6a1 1 0 000-1.414zM6 7a1 1 0 110-2 1 1 0 010 2z"/></svg>
                  {% endcase %}
                {%- endif -%}
                <span>{{ b.badge_text }}</span>
              </span>
            {%- endif -%}

            {%- if b.kicker != blank -%}
              <p class="text-sm font-semibold tracking-wide uppercase text-primary-foreground/90">{{ b.kicker }}</p>
            {%- endif -%}

            {%- if b.heading != blank -%}
              <h3 class="text-2xl md:text-3xl font-semibold leading-tight text-primary-foreground">{{ b.heading }}</h3>
            {%- endif -%}

            {%- if b.subheading != blank -%}
              <p class="text-base md:text-lg text-primary-foreground/90 {% if b.hide_text_mobile %}hidden md:block{% endif %}">
                {{ b.subheading }}
              </p>
            {%- endif -%}

            {% assign has_cta1 = false %}
            {% if b.cta_text != blank and b.cta_link != blank %}
            {% assign has_cta1 = true %}
            {% endif %}
            {% assign has_cta2 = false %}
            {% if b.cta2_text != blank and b.cta2_link != blank %}
            {% assign has_cta2 = true %}
            {% endif %}

            {%- if has_cta1 or has_cta2 -%}
              <div class="mt-2 flex flex-wrap gap-3 {% if b.cta_group_align == 'left' %}justify-start{% elsif b.cta_group_align == 'right' %}justify-end{% else %}justify-center{% endif %}">
                {%- if has_cta1 -%}
                  <a href="{{ b.cta_link }}"
                     data-cta="primary" data-offer-index="{{ forloop.index0 }}"
                     class="inline-flex items-center justify-center rounded-xl px-4 py-2 text-sm font-medium focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-offset-2 transition
                            {% if s.button_mode == 'outline' %}border bg-transparent{% else %}bg-primary text-primary-foreground hover:opacity-90{% endif %}"
                     style="{% if s.button_mode == 'outline' %}color: {{ s.button_text_color }}; border-color: {{ s.button_border_color }}; border-width: {{ s.button_border_width }}px;{% else %}color: {{ s.button_text_color }}; background-color: {{ s.button_bg_color }};{% endif %} border-radius: {{ s.button_radius }}px;"
                     aria-label="{{ b.cta_aria_label | default: b.cta_text | escape }}">{{ b.cta_text }}</a>
                {%- endif -%}
                {%- if has_cta2 -%}
                  <a href="{{ b.cta2_link }}"
                     data-cta="secondary" data-offer-index="{{ forloop.index0 }}"
                     class="inline-flex items-center justify-center rounded-xl px-4 py-2 text-sm font-medium focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-offset-2 transition
                            {% if s.button_mode == 'outline' %}border bg-transparent{% else %}border border-input bg-background hover:bg-accent hover:text-accent-foreground{% endif %}"
                     style="{% if s.button_mode == 'outline' %}color: {{ s.button_text_color }}; border-color: {{ s.button_border_color }}; border-width: {{ s.button_border_width }}px;{% else %}color: {{ s.button_text_color }};{% endif %} border-radius: {{ s.button_radius }}px;"
                     aria-label="{{ b.cta2_aria_label | default: b.cta2_text | escape }}">{{ b.cta2_text }}</a>
                {%- endif -%}
              </div>
            {%- endif -%}
          </div>
        </article>
      {%- endfor -%}

      {%- for block in prods -%}
        {%- assign p = block.settings -%}
        {%- assign product = p.product -%}
        <aside class="relative overflow-hidden rounded-2xl bg-white ring-1 ring-gray-200 p-6 md:p-8 grid grid-cols-1 sm:grid-cols-3 gap-6" {{ block.shopify_attributes }}>
          <div class="col-span-1">
            {%- if product != blank and product.featured_image != blank -%}
              {%- assign sizes_prod = '(min-width: 640px) 33vw, 100vw' -%}
              {%- assign widths_prod = '320,480,640,750,828,960,1080' -%}
              {{ product.featured_image
                | image_url: width: 1080
                | image_tag:
                  widths: widths_prod,
                  sizes: sizes_prod,
                  loading: 'lazy',
                  class: 'w-full h-auto rounded-xl',
                  alt: product.title | escape }}
            {%- endif -%}
          </div>
          <div class="col-span-1 sm:col-span-2 flex flex-col justify-center">
            <h3 class="text-xl md:text-2xl font-semibold text-gray-900">{{ product.title | default: 'Featured product' }}</h3>
            {%- if product != blank -%}
              <div class="mt-2 text-base">
                {%- assign price = product.price | default: 0 -%}
                {%- assign compare = product.compare_at_price | default: 0 -%}
                <span class="font-semibold">{{ price | money }}</span>
                {%- if compare > price and compare > 0 -%}
                  <span class="ml-2 line-through text-gray-500">{{ compare | money }}</span>
                  <span class="ml-2 text-emerald-600 font-medium">
                    Save {{ compare | minus: price | money }}
                  </span>
                {%- endif -%}
              </div>

              {%- if p.quick_add and product.selected_or_first_available_variant -%}
                <form class="mt-4" data-q-quick-add style="display:inline-block">
                  <input type="hidden" name="id" value="{{ product.selected_or_first_available_variant.id }}">
                  <button type="submit"
                          class="inline-flex items-center justify-center rounded-xl px-4 py-2 text-sm font-medium focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-offset-2 transition bg-primary text-primary-foreground hover:opacity-90"
                          aria-label="Add {{ product.title | escape }} to cart">
                    {{ p.quick_add_label }}
                  </button>
                </form>
              {%- endif -%}

              <div class="mt-3">
                <a href="{{ product.url | default: '/' }}"
                   class="inline-flex items-center justify-center rounded-xl px-4 py-2 text-sm font-medium focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-offset-2 transition border border-gray-300 bg-background hover:bg-accent hover:text-accent-foreground">
                  {{ p.view_product_label }}
                </a>
              </div>
            {%- else -%}
              <p class="mt-2 text-gray-600">Pick a product in the editor to show pricing and Quick Add.</p>
            {%- endif -%}
          </div>
        </aside>
      {%- endfor -%}
    </div>
  </div>

  {%- if s.send_events -%}
    <script>
      (function(){
        var root = document.getElementById('{{ s.anchor_id | default: 'section-' | append: section.id }}');
        if(!root) return;
        root.addEventListener('click', function(e){
          var a = e.target.closest('a[data-cta]');
          if(!a) return;
          var payload = {
            component: 'special_offers_banner',
            cta_type: a.getAttribute('data-cta'),
            index: Number(a.getAttribute('data-offer-index') || 0),
            href: a.getAttribute('href')
          };
          window.dispatchEvent(new CustomEvent('quadratum:cta', { detail: payload }));
          if(window.dataLayer && Array.isArray(window.dataLayer)){
            window.dataLayer.push({ event: 'quadratum_cta', component: payload.component, cta_type: payload.cta_type, index: payload.index, href: payload.href });
          }
        });

        var forms = root.querySelectorAll('form[data-q-quick-add]');
        forms.forEach(function(f){
          f.addEventListener('submit', function(ev){
            ev.preventDefault();
            var fd = new FormData(f);
            fetch('/cart/add.js', { method: 'POST', headers: { 'Accept': 'application/json' }, body: fd })
              .then(function(res){ return res.json(); })
              .then(function(data){
                window.dispatchEvent(new CustomEvent('quadratum:cart:add', { detail: data }));
                if(window.dataLayer && Array.isArray(window.dataLayer)){
                  window.dataLayer.push({ event: 'quadratum_cart_add', items: data });
                }
              })
              .catch(function(){ /* swallow */ });
          });
        });
      })();
    </script>
  {%- endif -%}

  <style>
    /* Badge starburst */
    .q-burst {
      position: relative;
      background-color: transparent;
      color: #fff;
      padding: .375rem .75rem;
      isolation: isolate;
    }
    .q-burst::before {
      content: "";
      position: absolute;
      inset: -6px;
      background: radial-gradient(circle at center, rgba(255,255,255,.18), rgba(255,255,255,0) 60%);
      z-index: -1;
      border-radius: 9999px;
      filter: blur(2px);
    }

    /* Flash animation (subtle, motion-safe) */
    @keyframes qFlash {
      0%   { filter: brightness(1);   transform: translateZ(0); }
      100% { filter: brightness(1.25); transform: translateZ(0); }
    }
    .q-flash { animation: qFlash 1.2s ease-in-out infinite alternate; will-change: filter; }
    @media (prefers-reduced-motion: reduce) {
      .q-flash { animation: none !important; }
    }
  </style>
</section>

{% render 'tw-safelist-banners' %}

{% schema %}
{
  "name": "Special Offers Banner",
  "tag": "section",
  "class": "q-special-offers",
  "settings": [
    { "type": "header", "content": "Heading" },
    { "type": "text", "id": "kicker", "label": "Kicker", "default": "Special offers" },
    { "type": "text", "id": "heading", "label": "Heading", "default": "Don’t miss these deals" },
    { "type": "textarea", "id": "subheading", "label": "Subheading", "default": "Limited-time promos, bundles, and markdowns." },

    { "type": "header", "content": "Background" },
    { "type": "checkbox", "id": "use_gradient", "label": "Use gradient background", "default": true },
    { "type": "color", "id": "gradient_color_1", "label": "Gradient color 1", "default": "#111827" },
    { "type": "color", "id": "gradient_color_2", "label": "Gradient color 2", "default": "#0b0f19" },
    { "type": "range", "id": "gradient_angle", "label": "Gradient angle (deg)", "min": 0, "max": 360, "step": 5, "default": 135 },
    { "type": "color", "id": "solid_bg_color", "label": "Solid background (when gradient off)", "default": "#111111" },
    { "type": "image_picker", "id": "background_image", "label": "Background image (optional)" },
    { "type": "text", "id": "bg_image_alt", "label": "Background image alt", "default": "Decorative background" },
    { "type": "color", "id": "overlay_color", "label": "Overlay color", "default": "#000000" },
    { "type": "range", "id": "overlay_opacity", "label": "Overlay opacity", "min": 0, "max": 100, "step": 5, "default": 30, "unit": "%" },

    { "type": "header", "content": "Layout & padding" },
    { "type": "select", "id": "cols_desktop", "label": "Offer columns (desktop)", "default": "2", "options": [
      { "value": "1", "label": "1" },
      { "value": "2", "label": "2" },
      { "value": "3", "label": "3" }
    ]},
    { "type": "select", "id": "container_mode", "label": "Container", "default": "contained", "options": [
      { "value": "contained", "label": "Contained (side padding)" },
      { "value": "full", "label": "Full-bleed (edge to edge)" }
    ]},
    { "type": "select", "id": "pad_y", "label": "Vertical padding", "default": "py-12 md:py-16", "options": [
      { "value": "py-8 md:py-12", "label": "Small" },
      { "value": "py-12 md:py-16", "label": "Medium" },
      { "value": "py-16 md:py-24", "label": "Large" }
    ]},

    { "type": "header", "content": "Buttons (global defaults)" },
    { "type": "select", "id": "button_mode", "label": "Button style", "default": "solid", "options": [
      { "value": "solid", "label": "Solid" },
      { "value": "outline", "label": "Outline" }
    ]},
    { "type": "color", "id": "button_bg_color", "label": "Button background (solid)", "default": "#ffffff" },
    { "type": "color", "id": "button_text_color", "label": "Button text color", "default": "#000000" },
    { "type": "color", "id": "button_border_color", "label": "Button border color (outline)", "default": "#ffffff" },
    { "type": "range", "id": "button_border_width", "label": "Outline border width", "min": 0, "max": 6, "step": 1, "default": 1 },
    { "type": "range", "id": "button_radius", "label": "Corner radius", "min": 0, "max": 36, "step": 2, "default": 12 },

    { "type": "header", "content": "Visibility & analytics" },
    { "type": "text", "id": "anchor_id", "label": "Optional anchor ID" },
    { "type": "text", "id": "region_label", "label": "Accessible region label", "default": "Special offers" },
    { "type": "checkbox", "id": "hide_on_mobile", "label": "Hide on mobile", "default": false },
    { "type": "checkbox", "id": "hide_on_desktop", "label": "Hide on desktop", "default": false },
    { "type": "checkbox", "id": "send_events", "label": "Send analytics events on clicks", "default": true }
  ],
  "blocks": [
    {
      "type": "offer",
      "name": "Offer",
      "settings": [
        { "type": "header", "content": "Media (optional)" },
        { "type": "image_picker", "id": "background_image", "label": "Background image" },
        { "type": "text", "id": "image_alt", "label": "Image alt", "default": "Offer background" },
        { "type": "color", "id": "overlay_color", "label": "Overlay color", "default": "#000000" },
        { "type": "range", "id": "overlay_opacity", "label": "Overlay opacity", "min": 0, "max": 100, "step": 5, "default": 30, "unit": "%" },

        { "type": "header", "content": "Badge" },
        { "type": "select", "id": "badge_shape", "label": "Badge shape", "default": "star", "options": [
          { "value": "star", "label": "Starburst" },
          { "value": "pill", "label": "Pill" }
        ]},
        { "type": "select", "id": "badge_icon", "label": "Badge icon", "default": "star", "options": [
          { "value": "none", "label": "None" },
          { "value": "star", "label": "Star" },
          { "value": "bolt", "label": "Bolt" },
          { "value": "tag",  "label": "Tag" }
        ]},
        { "type": "text", "id": "badge_text", "label": "Badge text", "default": "Hot deal" },
        { "type": "color", "id": "badge_bg", "label": "Badge background", "default": "#EF4444" },
        { "type": "color", "id": "badge_color", "label": "Badge text color", "default": "#FFFFFF" },
        { "type": "checkbox", "id": "flash_badge", "label": "Flash animation on badge", "default": true },
        { "type": "text", "id": "badge_aria", "label": "Badge ARIA label", "default": "Special offer" },

        { "type": "header", "content": "Text" },
        { "type": "text", "id": "kicker", "label": "Kicker", "default": "Limited time" },
        { "type": "text", "id": "heading", "label": "Heading", "default": "Save big today" },
        { "type": "textarea", "id": "subheading", "label": "Subheading", "default": "Extra savings applied at checkout." },
        { "type": "checkbox", "id": "hide_text_mobile", "label": "Hide subheading on mobile", "default": false },

        { "type": "header", "content": "Buttons" },
        { "type": "select", "id": "cta_group_align", "label": "Button alignment", "default": "center", "options": [
          { "value": "left", "label": "Left" }, { "value": "center", "label": "Center" }, { "value": "right", "label": "Right" }
        ]},
        { "type": "text", "id": "cta_text", "label": "Primary button text", "default": "Shop now" },
        { "type": "url", "id": "cta_link", "label": "Primary button URL" },
        { "type": "text", "id": "cta_aria_label", "label": "Primary button ARIA label", "default": "Shop now" },
        { "type": "text", "id": "cta2_text", "label": "Secondary button text", "default": "Learn more" },
        { "type": "url", "id": "cta2_link", "label": "Secondary button URL" },
        { "type": "text", "id": "cta2_aria_label", "label": "Secondary button ARIA label", "default": "Learn more" }
      ]
    },
    {
      "type": "product",
      "name": "Featured product",
      "settings": [
        { "type": "product", "id": "product", "label": "Product" },
        { "type": "checkbox", "id": "quick_add", "label": "Enable Quick Add (first available variant)", "default": true },
        { "type": "text", "id": "quick_add_label", "label": "Quick Add button label", "default": "Add to cart" },
        { "type": "text", "id": "view_product_label", "label": "View product link label", "default": "View product" }
      ]
    }
  ],
  "max_blocks": 6,
  "presets": [
    {
      "name": "Special Offers • Sale + Product",
      "category": "Banner",
      "blocks": [
        { "type": "offer", "settings": { "badge_text": "Extra 20% off", "kicker": "Today only", "heading": "Last chance savings", "cta_text": "Shop deals" } },
        { "type": "offer", "settings": { "badge_shape": "pill", "badge_bg": "#10B981", "badge_text": "Bundles", "kicker": "Save more", "heading": "Buy 2, save 15%", "cta_text": "Build bundle" } },
        { "type": "product" }
      ]
    }
  ]
}
{% endschema %}
