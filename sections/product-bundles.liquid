{%- comment -%}
QUADRATUM — PRODUCT BUNDLES (FINAL STABLE)
Supports ALL Shopify picker return formats:
- product object
- { value: product }
- { product: product }
- handle fallback

Will render reliably.
{%- endcomment -%}

{%- liquid
assign s = section.settings
-%}

{{ 'section-product-bundles.css' | asset_url | stylesheet_tag }}
<script src="{{ 'section-product-bundles.js' | asset_url }}" defer></script>

{%- capture pb_cards -%}
{%- if s.source == 'manual' -%}

{%- for block in section.blocks -%}
{%- if block.type != 'bundle' -%}{% continue %}{%- endif -%}

{%- liquid
assign raw = '' | split: ','
assign raw = raw | push: block.settings.product_1
assign raw = raw | push: block.settings.product_2
assign raw = raw | push: block.settings.product_3
assign raw = raw | push: block.settings.product_4
assign raw = raw | push: block.settings.product_5
assign raw = raw | push: block.settings.product_6

assign products = '' | split: ','
assign seen = '|'

for item in raw
  if item == blank
    continue
  endif

  assign pr = blank

  comment
  RESOLVE ALL SHOPIFY PICKER FORMATS
  endcomment

  if item.id != blank
    assign pr = item
  elsif item.value != blank and item.value.id != blank
    assign pr = item.value
  elsif item.product != blank and item.product.id != blank
    assign pr = item.product
  elsif item.handle != blank
    assign pr = all_products[item.handle]
  else
    assign str = item | append: ''
    if str != blank
      assign pr = all_products[str]
    endif
  endif

  if pr == blank
    continue
  endif

  assign pid = pr.id | append: ''
  assign tok = '|' | append: pid | append: '|'
  if seen contains tok
    continue
  endif

  assign seen = seen | append: pid | append: '|'
  assign products = products | push: pr
endfor
-%}

{%- if products.size >= 2 -%}

{%- liquid
assign total_price = 0
assign compare_total = 0
assign ids = '' | split: ','
assign ids_seen = '|'
assign all_available = true

for pr in products
  assign v = pr.selected_or_first_available_variant
  if v == blank
    assign v = pr.variants.first
  endif

  if v == blank or v.available == false
    assign all_available = false
  endif

  if v != blank
    assign total_price = total_price | plus: v.price

    if v.compare_at_price > v.price
      assign compare_total = compare_total | plus: v.compare_at_price
    else
      assign compare_total = compare_total | plus: v.price
    endif

    assign vid = v.id | append: ''
    assign tok2 = '|' | append: vid | append: '|'
    if ids_seen contains tok2
      continue
    endif

    assign ids_seen = ids_seen | append: vid | append: '|'
    assign ids = ids | push: vid
  endif
endfor

assign savings = 0
if compare_total > total_price
  assign savings = compare_total | minus: total_price
endif

assign disabled = false
if s.disable_if_unavailable and all_available == false
  assign disabled = true
endif

assign data_items = ids | join: ','
-%}

<article class="pb__card" {{ block.shopify_attributes }}>
<div class="pb__card-inner">

<h3>{{ block.settings.bundle_title | default: "Bundle" }}</h3>

<ul class="pb__items">
{%- for pr in products -%}
{%- assign v = pr.selected_or_first_available_variant -%}
{%- if v == blank -%}{%- assign v = pr.variants.first -%}{%- endif -%}
<li>
{{ pr.title }} — {{ v.price | money }}
</li>
{%- endfor -%}
</ul>

<div class="pb__summary">
<strong>Total:</strong> {{ total_price | money }}
{%- if savings > 0 and s.show_savings -%}
<br><span>Save {{ savings | money }}</span>
{%- endif -%}
</div>

<button
type="button"
class="pb__add button"
data-pb-add
data-items="{{ data_items }}"
{% if disabled %}disabled{% endif %}
>
{{ s.button_label }}
</button>

</div>
</article>

{%- endif -%}
{%- endfor -%}
{%- endif -%}
{%- endcapture -%}

{%- assign out = pb_cards | strip -%}

<section class="product-bundles">
<div class="pb__inner">

{%- if s.title != blank -%}
<h2>{{ s.title }}</h2>
{%- endif -%}

{%- if out != blank -%}
{{ pb_cards }}
{%- else -%}
<div style="padding:16px;border:1px dashed #999;">
Add at least 2 products to bundle
</div>
{%- endif -%}

</div>
</section>

{% schema %}
{
"name": "Product bundles",
"settings": [
{ "type":"text","id":"title","label":"Heading","default":"Frequently bought together" },
{ "type":"text","id":"button_label","label":"Button","default":"Add bundle" },
{ "type":"checkbox","id":"disable_if_unavailable","label":"Disable if unavailable","default":true },
{ "type":"checkbox","id":"show_savings","label":"Show savings","default":true }
],
"blocks":[
{
"type":"bundle",
"name":"Bundle",
"settings":[
{ "type":"text","id":"bundle_title","label":"Title" },
{ "type":"product","id":"product_1","label":"Product 1" },
{ "type":"product","id":"product_2","label":"Product 2" },
{ "type":"product","id":"product_3","label":"Product 3" },
{ "type":"product","id":"product_4","label":"Product 4" },
{ "type":"product","id":"product_5","label":"Product 5" },
{ "type":"product","id":"product_6","label":"Product 6" }
]
}
],
"presets":[{ "name":"Product bundles" }]
}
{% endschema %}
