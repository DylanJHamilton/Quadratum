{% comment %}
  Quadratum • Featured Product Hero
  - Product picker, price/compare-at/savings, Quick Add, dual CTAs.
  - Media left/right, optional BG image + overlay, tokenized buttons.
  - Perf: right-sized responsive images; eager only when above the fold.
  - A11y: labeled region, strong focus rings, reduced-motion friendly.
  - Analytics: data-cta and optional events toggle.
{% endcomment %}

{% assign s = section.settings %}

{%- comment -%} Container padding {%- endcomment -%}
{% assign container_pad = '' %}
{% if s.container_mode == 'contained' %}
  {% assign container_pad = 'px-4 md:px-6' %}
{% endif %}

{%- comment -%} Visibility toggles {%- endcomment -%}
{% assign visibility_classes = '' %}
{% if s.hide_on_mobile %}{% assign visibility_classes = visibility_classes | append: ' hidden md:block' %}{% endif %}
{% if s.hide_on_desktop %}{% assign visibility_classes = visibility_classes | append: ' md:hidden' %}{% endif %}

{%- comment -%} Picked product & variant {%- endcomment -%}
{% assign p = s.product %}
{% assign has_product = false %}
{% if p != blank %}{% assign has_product = true %}{% endif %}
{% if has_product %}
  {% assign v = p.selected_or_first_available_variant %}
{% endif %}

{%- comment -%} CTA href resolution (pickers → URLs fallback) {%- endcomment -%}
{% assign href1 = s.cta_link %}
{% if href1 == blank and s.cta_product %}{% assign href1 = s.cta_product.url %}{% endif %}
{% if href1 == blank and s.cta_collection %}{% assign href1 = s.cta_collection.url %}{% endif %}
{% if href1 == blank and s.cta_article %}{% assign href1 = s.cta_article.url %}{% endif %}

{% assign href2 = s.cta2_link %}
{% if href2 == blank and s.cta2_product %}{% assign href2 = s.cta2_product.url %}{% endif %}
{% if href2 == blank and s.cta2_collection %}{% assign href2 = s.cta2_collection.url %}{% endif %}
{% if href2 == blank and s.cta2_article %}{% assign href2 = s.cta2_article.url %}{% endif %}

{%- comment -%} Responsive sizes {%- endcomment -%}
{% assign sizes_bg = '100vw' %}
{% assign widths_bg = '960,1280,1600,1920,2240' %}
{% assign sizes_media = '(min-width: 1024px) 50vw, 100vw' %}
{% assign widths_media = '640,750,828,960,1080,1280,1440,1600' %}

<section
  id="{{ s.anchor_id | default: 'section-' | append: section.id }}"
  class="relative overflow-hidden {{ visibility_classes }}"
  role="region"
  aria-label="{{ s.region_label | default: 'Featured product hero' }}"
  style="min-height: {{ s.min_height_vh | default: 70 }}vh;"
>
  {%- if s.background_image != blank -%}
    <div class="absolute inset-0 -z-20">
      {{ s.background_image
        | image_url: width: 2240
        | image_tag:
          widths: widths_bg,
          sizes: sizes_bg,
          loading: 'eager',
          fetchpriority: 'high',
          class: 'absolute inset-0 w-full h-full object-cover',
          alt: s.bg_image_alt }}
      <div class="absolute inset-0" aria-hidden="true"
           style="background-color: {{ s.overlay_color }}; opacity: {{ s.overlay_opacity | divided_by: 100.0 }};">
      </div>
    </div>
  {% endif %}

  <div class="relative z-10">
    <div class="mx-auto max-w-screen-xl {{ container_pad }}">
      <div class="grid grid-cols-1 lg:grid-cols-12 gap-6 md:gap-8 items-center"
           style="padding-top: {{ s.padding_top | default: 72 }}px; padding-bottom: {{ s.padding_bottom | default: 72 }}px;">
        {%- comment -%} Determine ordering {%- endcomment -%}
        {% assign media_first = false %}
        {% if s.media_position == 'left' %}{% assign media_first = true %}{% endif %}

        {%- comment -%} Column spans {%- endcomment -%}
        {% assign media_cols = 6 %}
        {% assign content_cols = 6 %}
        {% if s.media_width == '5' %}{% assign media_cols = 5 %}{% assign content_cols = 7 %}{% endif %}
        {% if s.media_width == '7' %}{% assign media_cols = 7 %}{% assign content_cols = 5 %}{% endif %}
        {% assign media_col_class = 'lg:col-span-' | append: media_cols %}
        {% assign content_col_class = 'lg:col-span-' | append: content_cols %}

        {% if media_first %}
          <div class="col-span-1 {{ media_col_class }}">
            {% if has_product and p.featured_image %}
              {{ p.featured_image
                | image_url: width: 1600
                | image_tag:
                  widths: widths_media,
                  sizes: sizes_media,
                  loading: 'lazy',
                  class: 'w-full h-auto object-cover rounded-2xl',
                  alt: p.title }}
            {% elsif s.fallback_image != blank %}
              {{ s.fallback_image
                | image_url: width: 1600
                | image_tag:
                  widths: widths_media,
                  sizes: sizes_media,
                  loading: 'lazy',
                  class: 'w-full h-auto object-cover rounded-2xl',
                  alt: s.fallback_alt }}
            {% endif %}
          </div>
        {% endif %}

        <div class="col-span-1 {{ content_col_class }}">
          <div class="{{ s.text_align | default: 'text-left' }}">
            {% if s.badge_text != blank %}
              <div class="inline-flex items-center gap-2 rounded-full px-3 py-1 text-xs font-semibold ring-1 ring-border bg-card mb-4 relative overflow-hidden">
                {% if s.badge_icon == 'bolt' %}
                  <svg class="h-3.5 w-3.5" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true"><path d="M11.3 1L3 11h5l-.8 8L15 9h-5l1.3-8z"/></svg>
                {% elsif s.badge_icon == 'star' %}
                  <svg class="h-3.5 w-3.5" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 0 0 .95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.802 2.036a1 1 0 0 0-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.802-2.036a1 1 0 0 0-1.176 0l-2.802 2.036c-.785.57-1.84-.197-1.54-1.118l1.07-3.292a1 1 0 0 0-.364-1.118L2.88 8.72c-.783-.57-.38-1.81.588-1.81h3.462a1 1 0 0 0 .95-.69l1.07-3.292z"/></svg>
                {% endif %}
                <span>{{ s.badge_text }}</span>
                {% if s.badge_flash %}
                  <span class="absolute inset-0 pointer-events-none" aria-hidden="true" style="background: radial-gradient(120px 120px at 0% 50%, rgba(255,255,255,.25), transparent 60%); animation: qFlash 2.8s linear infinite;"></span>
                {% endif %}
              </div>
            {% endif %}

            {% assign heading_text = s.heading | default: p.title %}
            {% if heading_text != blank %}
              {% if s.heading_level == 'h1' %}
                <h1 class="text-3xl md:text-5xl font-semibold leading-tight text-foreground">{{ heading_text | escape }}</h1>
              {% else %}
                <h2 class="text-3xl md:text-5xl font-semibold leading-tight text-foreground">{{ heading_text | escape }}</h2>
              {% endif %}
            {% endif %}

            {% if s.subheading != blank %}
              <p class="mt-3 text-base md:text-lg text-foreground/80 {% if s.hide_sub_mobile %}hidden md:block{% endif %}">
                {{ s.subheading }}
              </p>
            {% endif %}

            {% if has_product %}
              <div class="mt-4 flex flex-wrap items-center gap-3">
                {% capture price_html %}
                  <span class="text-2xl font-semibold">{{ v.price | money }}</span>
                {% endcapture %}
                {% assign compare_html = '' %}
                {% if v.compare_at_price > v.price %}
                  {% assign savings = v.compare_at_price | minus: v.price %}
                  {% assign pct = savings | times: 100 | divided_by: v.compare_at_price %}
                  {% capture compare_html %}<span class="text-foreground/60 line-through">{{ v.compare_at_price | money }}</span> <span class="text-emerald-600 text-sm font-semibold">-{{ pct | round }}%</span>{% endcapture %}
                {% endif %}
                <div class="flex items-baseline gap-3">{{ price_html }} {{ compare_html }}</div>
                {% if v.available == false %}
                  <span class="text-sm font-medium text-foreground/70">{{ 'products.product.sold_out' | t }}</span>
                {% endif %}
              </div>

              {% if p.variants.size > 1 %}
                <div class="mt-4">
                  <label for="q-variant-{{ section.id }}" class="sr-only">{{ 'products.product.select_variant' | t }}</label>
                  <select id="q-variant-{{ section.id }}" class="w-full max-w-xs rounded-md border border-input bg-background px-3 py-2 text-sm"
                          aria-label="{{ 'products.product.select_variant' | t }}">
                    {% for variant in p.variants %}
                      <option value="{{ variant.id }}" {% if variant.id == v.id %}selected{% endif %} {% unless variant.available %}disabled{% endunless %}>
                        {{ variant.title }} {% unless variant.available %}— {{ 'products.product.sold_out' | t }}{% endunless %}
                      </option>
                    {% endfor %}
                  </select>
                </div>
              {% endif %}

              <form method="post" action="/cart/add" enctype="multipart/form-data" class="mt-4 flex flex-wrap gap-3 items-center" data-q-quickadd>
                <input type="hidden" name="id" value="{{ v.id }}">
                <input type="hidden" name="quantity" value="1">
                <button type="submit"
                        class="inline-flex items-center justify-center rounded-xl px-5 py-2.5 text-sm font-medium focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-offset-2 transition
                               {% if s.button_mode == 'outline' %}border bg-transparent{% else %}bg-primary text-primary-foreground hover:opacity-90{% endif %}"
                        style="{% if s.button_mode == 'outline' %}color: {{ s.button_text_color }}; border-color: {{ s.button_border_color }}; border-width: {{ s.button_border_width }}px;{% else %}color: {{ s.button_text_color }}; background-color: {{ s.button_bg_color }};{% endif %} border-radius: {{ s.button_radius }}px;"
                        {% unless v.available %}disabled{% endunless %}
                        data-cta="primary"
                        aria-label="{{ 'products.product.add_to_cart' | t }}">
                  {{ 'products.product.add_to_cart' | t }}
                </button>

                {% assign has_secondary = false %}
                {% if s.cta2_text != blank and href2 != blank %}{% assign has_secondary = true %}{% endif %}
                {% if has_secondary %}
                  <a href="{{ href2 }}"
                     data-cta="secondary"
                     class="inline-flex items-center justify-center rounded-xl px-5 py-2.5 text-sm font-medium focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-offset-2 transition
                            {% if s.button_mode == 'outline' %}border bg-transparent{% else %}border border-input bg-background hover:bg-accent hover:text-accent-foreground{% endif %}"
                     style="{% if s.button_mode == 'outline' %}color: {{ s.button_text_color }}; border-color: {{ s.button_border_color }}; border-width: {{ s.button_border_width }}px;{% else %}color: {{ s.button_text_color }};{% endif %} border-radius: {{ s.button_radius }}px;"
                     aria-label="{{ s.cta2_aria_label | default: s.cta2_text | escape }}">
                    {{ s.cta2_text }}
                  </a>
                {% endif %}
              </form>
            {% endif %}

            {% assign has_cta1 = false %}
            {% if s.cta_text != blank and href1 != blank %}{% assign has_cta1 = true %}{% endif %}

            {%- comment -%}
              When there is NO product selected, show the CTA row if:
              - primary CTA is valid OR
              - secondary CTA text + link are valid
              (No parentheses in Liquid conditions.)
            {%- endcomment -%}
            {% if has_product == false %}
              {% if has_cta1 or s.cta2_text != blank and href2 != blank %}
                <div class="mt-5 flex flex-wrap gap-3 {% if s.cta_group_align == 'left' %}justify-start{% elsif s.cta_group_align == 'right' %}justify-end{% else %}justify-start{% endif %}">
                  {% if has_cta1 %}
                    <a href="{{ href1 }}" data-cta="primary"
                       class="inline-flex items-center justify-center rounded-xl px-5 py-2.5 text-sm font-medium focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-offset-2 transition
                              {% if s.button_mode == 'outline' %}border bg-transparent{% else %}bg-primary text-primary-foreground hover:opacity-90{% endif %}"
                       style="{% if s.button_mode == 'outline' %}color: {{ s.button_text_color }}; border-color: {{ s.button_border_color }}; border-width: {{ s.button_border_width }}px;{% else %}color: {{ s.button_text_color }}; background-color: {{ s.button_bg_color }};{% endif %} border-radius: {{ s.button_radius }}px;"
                       aria-label="{{ s.cta_aria_label | default: s.cta_text | escape }}">
                      {{ s.cta_text }}
                    </a>
                  {% endif %}
                  {% if s.cta2_text != blank and href2 != blank %}
                    <a href="{{ href2 }}" data-cta="secondary"
                       class="inline-flex items-center justify-center rounded-xl px-5 py-2.5 text-sm font-medium focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-offset-2 transition
                              {% if s.button_mode == 'outline' %}border bg-transparent{% else %}border border-input bg-background hover:bg-accent hover:text-accent-foreground{% endif %}"
                       style="{% if s.button_mode == 'outline' %}color: {{ s.button_text_color }}; border-color: {{ s.button_border_color }}; border-width: {{ s.button_border_width }}px;{% else %}color: {{ s.button_text_color }};{% endif %} border-radius: {{ s.button_radius }}px;"
                       aria-label="{{ s.cta2_aria_label | default: s.cta2_text | escape }}">
                      {{ s.cta2_text }}
                    </a>
                  {% endif %}
                </div>
              {% endif %}
            {% endif %}
          </div>
        </div>

        {% unless media_first %}
          <div class="col-span-1 {{ media_col_class }}">
            {% if has_product and p.featured_image %}
              {{ p.featured_image
                | image_url: width: 1600
                | image_tag:
                  widths: widths_media,
                  sizes: sizes_media,
                  loading: 'lazy',
                  class: 'w-full h-auto object-cover rounded-2xl',
                  alt: p.title }}
            {% elsif s.fallback_image != blank %}
              {{ s.fallback_image
                | image_url: width: 1600
                | image_tag:
                  widths: widths_media,
                  sizes: sizes_media,
                  loading: 'lazy',
                  class: 'w-full h-auto object-cover rounded-2xl',
                  alt: s.fallback_alt }}
            {% endif %}
          </div>
        {% endunless %}
      </div>
    </div>
  </div>

  {% if s.send_events %}
    <script>
      (function(){
        var root = document.getElementById('{{ s.anchor_id | default: 'section-' | append: section.id }}');
        if(!root) return;

        // Variant <select> → update Quick Add id
        var sel = root.querySelector('#q-variant-{{ section.id }}');
        var form = root.querySelector('[data-q-quickadd]');
        if (sel && form) {
          sel.addEventListener('change', function(){
            var input = form.querySelector('input[name="id"]');
            if (input) input.value = this.value;
          });
        }

        root.addEventListener('click', function(e){
          var a = e.target.closest('a[data-cta]');
          if(!a || !{{ s.send_events | json }}) return;
          var payload = { component: 'featured_product_hero', cta_type: a.getAttribute('data-cta'), href: a.getAttribute('href') };
          window.dispatchEvent(new CustomEvent('quadratum:cta', { detail: payload }));
          if(window.dataLayer && Array.isArray(window.dataLayer)){
            window.dataLayer.push({ event: 'quadratum_cta', component: payload.component, cta_type: payload.cta_type, href: payload.href });
          }
        });
      })();
    </script>
  {% endif %}

  <style>
    @keyframes qFlash {
      0% { transform: translateX(-30%); opacity: .8; }
      100% { transform: translateX(130%); opacity: 0; }
    }
    @media (prefers-reduced-motion: reduce) {
      [style*="qFlash"] { animation: none !important; }
    }
  </style>
</section>

{% render 'tw-safelist-banners' %}

{% schema %}
{
  "name": "Featured Product Hero",
  "tag": "section",
  "class": "q-featured-product-hero",
  "settings": [
    { "type": "header", "content": "Content" },
    { "type": "text", "id": "heading", "label": "Heading", "default": "Our best-seller, now better" },
    { "type": "textarea", "id": "subheading", "label": "Subheading", "default": "Trusted by thousands. Designed for daily performance." },
    { "type": "select", "id": "heading_level", "label": "Heading level", "default": "h2", "options": [
      { "value": "h1", "label": "H1" }, { "value": "h2", "label": "H2" }
    ]},

    { "type": "header", "content": "Product" },
    { "type": "product", "id": "product", "label": "Product" },
    { "type": "image_picker", "id": "fallback_image", "label": "Fallback image (if no product)" },
    { "type": "text", "id": "fallback_alt", "label": "Fallback image alt", "default": "Product image" },

    { "type": "header", "content": "Layout & alignment" },
    { "type": "range", "id": "min_height_vh", "label": "Min height (vh)", "min": 40, "max": 100, "step": 5, "default": 70 },
    { "type": "range", "id": "padding_top", "label": "Padding top (px)", "min": 0, "max": 200, "step": 8, "default": 72 },
    { "type": "range", "id": "padding_bottom", "label": "Padding bottom (px)", "min": 0, "max": 200, "step": 8, "default": 72 },
    { "type": "select", "id": "media_position", "label": "Media position", "default": "right", "options": [
      { "value": "left", "label": "Left" }, { "value": "right", "label": "Right" }
    ]},
    { "type": "select", "id": "media_width", "label": "Media width (desktop)", "default": "6", "options": [
      { "value": "5", "label": "5/12" }, { "value": "6", "label": "1/2" }, { "value": "7", "label": "7/12" }
    ]},
    { "type": "select", "id": "text_align", "label": "Text alignment", "default": "text-left", "options": [
      { "value": "text-left", "label": "Left" }, { "value": "text-center", "label": "Center" }, { "value": "text-right", "label": "Right" }
    ]},
    { "type": "select", "id": "content_max_w", "label": "Text width", "default": "max-w-3xl", "options": [
      { "value": "max-w-2xl", "label": "Narrow" }, { "value": "max-w-3xl", "label": "Comfort" }, { "value": "max-w-4xl", "label": "Wide" }
    ]},
    { "type": "select", "id": "container_mode", "label": "Container", "default": "contained", "options": [
      { "value": "contained", "label": "Contained (side padding)" }, { "value": "full", "label": "Full-bleed (edge to edge)" }
    ]},

    { "type": "header", "content": "Badge" },
    { "type": "text", "id": "badge_text", "label": "Badge text", "default": "Special offer" },
    { "type": "select", "id": "badge_icon", "label": "Badge icon", "default": "bolt", "options": [
      { "value": "none", "label": "None" }, { "value": "bolt", "label": "Bolt" }, { "value": "star", "label": "Star" }
    ]},
    { "type": "checkbox", "id": "badge_flash", "label": "Flash animation", "default": true },

    { "type": "header", "content": "Background (optional)" },
    { "type": "image_picker", "id": "background_image", "label": "Background image" },
    { "type": "text", "id": "bg_image_alt", "label": "Background image alt", "default": "Decorative background" },
    { "type": "color", "id": "overlay_color", "label": "Overlay color", "default": "#000000" },
    { "type": "range", "id": "overlay_opacity", "label": "Overlay opacity", "min": 0, "max": 100, "step": 5, "default": 20, "unit": "%" },

    { "type": "header", "content": "Buttons" },
    { "type": "select", "id": "cta_group_align", "label": "CTA alignment (when no product)", "default": "left", "options": [
      { "value": "left", "label": "Left" }, { "value": "center", "label": "Center" }, { "value": "right", "label": "Right" }
    ]},
    { "type": "select", "id": "button_mode", "label": "Button style", "default": "solid", "options": [
      { "value": "solid", "label": "Solid" }, { "value": "outline", "label": "Outline" }
    ]},
    { "type": "color", "id": "button_bg_color", "label": "Button background (solid)", "default": "#111111" },
    { "type": "color", "id": "button_text_color", "label": "Button text color", "default": "#ffffff" },
    { "type": "color", "id": "button_border_color", "label": "Button border (outline)", "default": "#111111" },
    { "type": "range", "id": "button_border_width", "label": "Outline border width", "min": 0, "max": 6, "step": 1, "default": 1 },
    { "type": "range", "id": "button_radius", "label": "Corner radius", "min": 0, "max": 36, "step": 2, "default": 12 },
    { "type": "text", "id": "cta_text", "label": "Primary CTA text", "default": "Shop now" },
    { "type": "url", "id": "cta_link", "label": "Primary CTA URL" },
    { "type": "product", "id": "cta_product", "label": "…or link to product" },
    { "type": "collection", "id": "cta_collection", "label": "…or link to collection" },
    { "type": "article", "id": "cta_article", "label": "…or link to article" },
    { "type": "text", "id": "cta_aria_label", "label": "Primary CTA ARIA label", "default": "Shop now" },
    { "type": "text", "id": "cta2_text", "label": "Secondary CTA text", "default": "Learn more" },
    { "type": "url", "id": "cta2_link", "label": "Secondary CTA URL" },
    { "type": "product", "id": "cta2_product", "label": "Secondary… link to product" },
    { "type": "collection", "id": "cta2_collection", "label": "Secondary… link to collection" },
    { "type": "article", "id": "cta2_article", "label": "Secondary… link to article" },
    { "type": "text", "id": "cta2_aria_label", "label": "Secondary CTA ARIA label", "default": "Learn more" },

    { "type": "header", "content": "Visibility & analytics" },
    { "type": "text", "id": "anchor_id", "label": "Optional anchor ID" },
    { "type": "text", "id": "region_label", "label": "Accessible region label", "default": "Featured product hero" },
    { "type": "checkbox", "id": "hide_on_mobile", "label": "Hide on mobile", "default": false },
    { "type": "checkbox", "id": "hide_on_desktop", "label": "Hide on desktop", "default": false },
    { "type": "checkbox", "id": "send_events", "label": "Send analytics events on clicks", "default": true }
  ],
  "blocks": [],
  "presets": [
    {
      "name": "Featured Product • Hero",
      "category": "Banner",
      "settings": {
        "badge_text": "New & improved",
        "media_position": "right"
      }
    }
  ]
}
{% endschema %}

{% render 'tw-safelist-banners' %}
