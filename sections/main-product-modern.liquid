{%- comment -%}
  Quadratum — Main Product Modern (Dawn-inspired)
  File: sections/main-product-modern.liquid

  Uses existing Dawn-style snippets:
    - product-media-gallery
    - product-media-modal
    - product-thumbnail (used by gallery)
    - product-media (used by modal)
    - price
    - product-variant-options

  NOTE:
  This section is self-contained for the "information" area (Dawn style).
{%- endcomment -%}

{%- liquid
  assign s = section.settings
  assign p = product

  if p == blank
    break
  endif

  assign current_variant = p.selected_or_first_available_variant
  if current_variant == blank
    assign current_variant = p.variants.first
  endif

  assign section_aria = s.section_aria_label
  if section_aria == blank
    assign section_aria = 'Product details'
  endif

  assign media_limit = s.media_limit | default: null

  assign variant_images = p.images | where: 'attached_to_variant?', true | map: 'src'

  assign first_3d_model = p.media | where: 'media_type', 'model' | first

  assign product_form_id = 'product-form-' | append: section.id
-%}

<section
  class="qtm-main-product-modern color-{{ s.color_scheme }} gradient section-{{ section.id }}-padding"
  aria-label="{{ section_aria | escape }}"
  data-section-id="{{ section.id }}"
  data-product-id="{{ p.id }}"
>
  {%- style -%}
    .section-{{ section.id }}-padding {
      padding-top: {{ s.padding_top | default: 36 | times: 0.75 | round: 0 }}px;
      padding-bottom: {{ s.padding_bottom | default: 36 | times: 0.75 | round: 0 }}px;
    }
    @media (min-width: 750px) {
      .section-{{ section.id }}-padding {
        padding-top: {{ s.padding_top | default: 36 }}px;
        padding-bottom: {{ s.padding_bottom | default: 36 }}px;
      }
    }

    .qtm-pdp-modern {
      display: grid;
      gap: 2rem;
      align-items: start;
    }

    @media (min-width: 990px) {
      .qtm-pdp-modern {
        grid-template-columns: minmax(0, 1fr) minmax(0, 1fr);
      }
      .qtm-pdp-modern--media-right .qtm-pdp-modern__media { order: 2; }
      .qtm-pdp-modern--media-right .qtm-pdp-modern__info  { order: 1; }
    }

    .qtm-pdp-modern__media,
    .qtm-pdp-modern__info {
      min-width: 0;
    }

    .qtm-pdp-modern__info-inner {
      display: grid;
      gap: 1.25rem;
    }

    .qtm-pdp-modern__info-inner.qtm-sticky {
      position: sticky;
      top: var(--header-height, 1rem);
    }

    .qtm-modern-divider {
      margin: 2rem 0;
      border: 0;
      border-top: 1px solid rgba(0,0,0,0.12);
    }

    /* Tabs */
    .qtm-tabs {
      display: grid;
      gap: 1rem;
      margin-top: 2.5rem;
    }
    .qtm-tabs__nav {
      display: flex;
      flex-wrap: wrap;
      gap: .5rem;
      border-bottom: 1px solid rgba(0,0,0,0.12);
      padding-bottom: .5rem;
    }
    .qtm-tabs__btn {
      appearance: none;
      background: transparent;
      border: 1px solid rgba(0,0,0,0.18);
      padding: .5rem .75rem;
      border-radius: 999px;
      cursor: pointer;
    }
    .qtm-tabs__btn[aria-selected="true"] {
      border-color: rgba(0,0,0,0.45);
      font-weight: 600;
    }
    .qtm-tabpanel[hidden] { display: none; }
  {%- endstyle -%}

  <div class="page-width">
    <div class="qtm-pdp-modern {% if s.media_position == 'right' %}qtm-pdp-modern--media-right{% endif %}">
      <!-- MEDIA -->
      <div class="qtm-pdp-modern__media">
        {%- render 'product-media-gallery',
          product: p,
          variant_images: variant_images,
          limit: media_limit,
          first_3d_model: first_3d_model
        -%}

        {%- if s.enable_lightbox -%}
          {%- render 'product-media-modal',
            product: p,
            variant_images: variant_images
          -%}
        {%- endif -%}
      </div>

      <!-- INFO -->
      <div class="qtm-pdp-modern__info" id="ProductInfo-{{ section.id }}">
        <div class="qtm-pdp-modern__info-inner{% if s.enable_sticky_info %} qtm-sticky{% endif %}">
          {%- for block in section.blocks -%}
            {%- case block.type -%}

              {%- when 'title' -%}
                <div {{ block.shopify_attributes }}>
                  <h1 class="product__title h2">{{ p.title | escape }}</h1>
                  {%- if s.show_vendor -%}
                    <p class="product__vendor caption">{{ p.vendor | escape }}</p>
                  {%- endif -%}
                </div>

              {%- when 'price' -%}
                <div {{ block.shopify_attributes }}>
                  {% render 'price',
                    product: p,
                    use_variant: true,
                    show_badges: true,
                    price_class: 'price--large'
                  %}
                </div>

              {%- when 'sku' -%}
                <div class="caption" {{ block.shopify_attributes }}>
                  {%- if current_variant.sku != blank -%}
                    <span><strong>SKU:</strong> {{ current_variant.sku | escape }}</span>
                  {%- endif -%}
                </div>

              {%- when 'variant_picker' -%}
                <div {{ block.shopify_attributes }}>
                  {%- unless p.has_only_default_variant -%}
                    <product-form class="product-form">
                      {%- form 'product', p, id: product_form_id, class: 'form', novalidate: 'novalidate' -%}
                        <input type="hidden" name="id" value="{{ current_variant.id }}">

                        {%- for option in p.options_with_values -%}
                          {%- assign picker_type = block.settings.picker_type | default: 'button' -%}
                          <fieldset class="product-form__input">
                            <legend class="form__label">{{ option.name }}</legend>

                            {%- if picker_type == 'dropdown' or picker_type == 'swatch_dropdown' -%}
                              <div class="select">
                                <select
                                  id="Option-{{ section.id }}-{{ forloop.index0 }}"
                                  name="options[{{ option.name | escape }}]"
                                  form="{{ product_form_id }}"
                                >
                                  {% render 'product-variant-options',
                                    product: p,
                                    option: option,
                                    block: block,
                                    picker_type: picker_type
                                  %}
                                </select>
                              </div>
                            {%- else -%}
                              <div class="product-form__controls">
                                {% render 'product-variant-options',
                                  product: p,
                                  option: option,
                                  block: block,
                                  picker_type: picker_type
                                %}
                              </div>
                            {%- endif -%}
                          </fieldset>
                        {%- endfor -%}
                      {%- endform -%}
                    </product-form>
                  {%- endunless -%}
                </div>

              {%- when 'quantity' -%}
                <div {{ block.shopify_attributes }}>
                  <label class="form__label" for="Quantity-{{ section.id }}">Quantity</label>
                  <quantity-input class="quantity">
                    <button class="quantity__button" name="minus" type="button">-</button>
                    <input
                      class="quantity__input"
                      type="number"
                      name="quantity"
                      id="Quantity-{{ section.id }}"
                      min="1"
                      value="1"
                      form="{{ product_form_id }}"
                    >
                    <button class="quantity__button" name="plus" type="button">+</button>
                  </quantity-input>
                </div>

              {%- when 'buy_buttons' -%}
                <div {{ block.shopify_attributes }}>
                  <product-form class="product-form">
                    {%- form 'product', p, id: product_form_id, class: 'form', novalidate: 'novalidate' -%}
                      <input type="hidden" name="id" value="{{ current_variant.id }}">

                      <div class="product-form__buttons">
                        <button
                          type="submit"
                          name="add"
                          class="product-form__submit button button--full-width"
                          {% unless current_variant.available %}disabled{% endunless %}
                        >
                          {%- if current_variant.available -%}
                            {{ 'products.product.add_to_cart' | t }}
                          {%- else -%}
                            {{ 'products.product.sold_out' | t }}
                          {%- endif -%}
                        </button>

                        {%- if s.enable_dynamic_checkout -%}
                          {{ form | payment_button }}
                        {%- endif -%}
                      </div>
                    {%- endform -%}
                  </product-form>
                </div>

              {%- when 'description' -%}
                <div class="rte" {{ block.shopify_attributes }}>
                  {%- if p.description != blank -%}
                    {{ p.description }}
                  {%- endif -%}
                </div>

              {%- when 'custom_liquid' -%}
                <div {{ block.shopify_attributes }}>
                  {{ block.settings.custom_liquid }}
                </div>

              {%- when 'share' -%}
                <div {{ block.shopify_attributes }}>
                  <share-button>
                    <button class="button button--secondary" type="button">
                      {{ 'general.share.share' | t }}
                    </button>
                  </share-button>
                </div>

            {%- endcase -%}
          {%- endfor -%}
        </div>
      </div>
    </div>

    {%- comment -%}
      BELOW CONTENT: Description / Reviews / Meta
      - If "tabs": render a lightweight tab UI (no snippet dependency)
      - If "sections": render H2 blocks
    {%- endcomment -%}

    {%- assign mode = s.content_display_mode | default: 'tabs' -%}

    {%- if mode == 'tabs' -%}
      <div class="qtm-tabs" data-qtm-tabs>
        <div class="qtm-tabs__nav" role="tablist" aria-label="Product content">
          <button class="qtm-tabs__btn" type="button" role="tab" aria-selected="true" aria-controls="TabDesc-{{ section.id }}" id="TabBtnDesc-{{ section.id }}">
            Product Description
          </button>
          <button class="qtm-tabs__btn" type="button" role="tab" aria-selected="false" aria-controls="TabReviews-{{ section.id }}" id="TabBtnReviews-{{ section.id }}">
            Reviews
          </button>
          <button class="qtm-tabs__btn" type="button" role="tab" aria-selected="false" aria-controls="TabMeta-{{ section.id }}" id="TabBtnMeta-{{ section.id }}">
            Meta Data
          </button>
        </div>

        <div id="TabDesc-{{ section.id }}" class="qtm-tabpanel rte" role="tabpanel" aria-labelledby="TabBtnDesc-{{ section.id }}">
          {%- if p.description != blank -%}
            {{ p.description }}
          {%- endif -%}
        </div>

        <div id="TabReviews-{{ section.id }}" class="qtm-tabpanel rte" role="tabpanel" aria-labelledby="TabBtnReviews-{{ section.id }}" hidden>
          {%- comment -%}
            Replace with your reviews app hook if needed.
            This is a safe default.
          {%- endcomment -%}
          {%- if p.metafields.reviews.rating.value != blank -%}
            <p>Rating: {{ p.metafields.reviews.rating.value }} ({{ p.metafields.reviews.rating_count }})</p>
          {%- else -%}
            <p>No reviews yet.</p>
          {%- endif -%}
        </div>

        <div id="TabMeta-{{ section.id }}" class="qtm-tabpanel rte" role="tabpanel" aria-labelledby="TabBtnMeta-{{ section.id }}" hidden>
          <p><strong>Vendor:</strong> {{ p.vendor | escape }}</p>
          <p><strong>Type:</strong> {{ p.type | escape }}</p>
          {%- if current_variant.sku != blank -%}
            <p><strong>SKU:</strong> {{ current_variant.sku | escape }}</p>
          {%- endif -%}
        </div>
      </div>

      <script>
        (function () {
          var root = document.querySelector('[data-qtm-tabs]');
          if (!root) return;

          var tabs = root.querySelectorAll('[role="tab"]');
          var panels = root.querySelectorAll('[role="tabpanel"]');

          function activate(tab) {
            tabs.forEach(function (t) {
              var selected = (t === tab);
              t.setAttribute('aria-selected', selected ? 'true' : 'false');
            });

            panels.forEach(function (p) {
              var isTarget = p.id === tab.getAttribute('aria-controls');
              p.hidden = !isTarget;
            });
          }

          tabs.forEach(function (tab) {
            tab.addEventListener('click', function () { activate(tab); });
            tab.addEventListener('keydown', function (e) {
              if (e.key !== 'ArrowRight' && e.key !== 'ArrowLeft') return;
              e.preventDefault();
              var idx = Array.prototype.indexOf.call(tabs, tab);
              var next = e.key === 'ArrowRight' ? idx + 1 : idx - 1;
              if (next < 0) next = tabs.length - 1;
              if (next >= tabs.length) next = 0;
              tabs[next].focus();
              activate(tabs[next]);
            });
          });
        })();
      </script>
    {%- else -%}
      <div class="qtm-pdp-modern__below">
        {%- if p.description != blank -%}
          <h2 class="h3">Product Description</h2>
          <div class="rte">{{ p.description }}</div>
        {%- endif -%}

        <hr class="qtm-modern-divider">

        <h2 class="h3">Reviews</h2>
        <div class="rte">
          {%- if p.metafields.reviews.rating.value != blank -%}
            <p>Rating: {{ p.metafields.reviews.rating.value }} ({{ p.metafields.reviews.rating_count }})</p>
          {%- else -%}
            <p>No reviews yet.</p>
          {%- endif -%}
        </div>

        <hr class="qtm-modern-divider">

        <h2 class="h3">Meta Data</h2>
        <div class="rte">
          <p><strong>Vendor:</strong> {{ p.vendor | escape }}</p>
          <p><strong>Type:</strong> {{ p.type | escape }}</p>
          {%- if current_variant.sku != blank -%}
            <p><strong>SKU:</strong> {{ current_variant.sku | escape }}</p>
          {%- endif -%}
        </div>
      </div>
    {%- endif -%}

    <script type="application/ld+json">
      {{ p | structured_data }}
    </script>
  </div>
</section>

{% schema %}
{
  "name": "Main Product — Modern",
  "tag": "section",
  "class": "section",
  "settings": [
    { "type": "text", "id": "section_aria_label", "label": "ARIA label", "default": "Product details" },
    { "type": "color_scheme", "id": "color_scheme", "label": "Color scheme", "default": "scheme-1" },

    { "type": "header", "content": "Media layout" },
    {
      "type": "select",
      "id": "media_position",
      "label": "Media position",
      "default": "left",
      "options": [
        { "value": "left", "label": "Left" },
        { "value": "right", "label": "Right" }
      ]
    },
    {
      "type": "select",
      "id": "gallery_layout",
      "label": "Desktop gallery layout",
      "default": "thumbnail_slider",
      "options": [
        { "value": "stacked", "label": "Stacked" },
        { "value": "columns", "label": "Columns" },
        { "value": "thumbnail_slider", "label": "Thumbnail slider" }
      ]
    },
    {
      "type": "select",
      "id": "mobile_thumbnails",
      "label": "Mobile thumbnails",
      "default": "columns",
      "options": [
        { "value": "hide", "label": "Hide" },
        { "value": "show", "label": "Show" },
        { "value": "columns", "label": "Columns" }
      ]
    },
    {
      "type": "select",
      "id": "media_size",
      "label": "Media size",
      "default": "large",
      "options": [
        { "value": "small", "label": "Small" },
        { "value": "medium", "label": "Medium" },
        { "value": "large", "label": "Large" }
      ]
    },
    {
      "type": "select",
      "id": "media_fit",
      "label": "Media fit",
      "default": "contain",
      "options": [
        { "value": "contain", "label": "Contain" },
        { "value": "cover", "label": "Cover" }
      ]
    },
    { "type": "checkbox", "id": "constrain_to_viewport", "label": "Constrain media to viewport", "default": true },
    { "type": "checkbox", "id": "enable_video_looping", "label": "Loop videos", "default": false },
    { "type": "checkbox", "id": "hide_variants", "label": "Hide variant images", "default": false },
    { "type": "checkbox", "id": "enable_lightbox", "label": "Enable media modal (lightbox)", "default": true },
    { "type": "checkbox", "id": "enable_sticky_info", "label": "Sticky info column", "default": true },
    {
      "type": "range",
      "id": "media_limit",
      "label": "Max media items (optional)",
      "min": 1,
      "max": 20,
      "step": 1,
      "default": 8
    },

    { "type": "header", "content": "Content" },
    {
      "type": "select",
      "id": "content_display_mode",
      "label": "Below content mode",
      "default": "tabs",
      "options": [
        { "value": "tabs", "label": "Tabs" },
        { "value": "sections", "label": "Sections (H2 dividers)" }
      ]
    },
    { "type": "checkbox", "id": "show_vendor", "label": "Show vendor", "default": false },
    { "type": "checkbox", "id": "enable_dynamic_checkout", "label": "Enable dynamic checkout button", "default": true },

    { "type": "header", "content": "Image zoom" },
    {
      "type": "select",
      "id": "image_zoom",
      "label": "Image zoom icon behavior",
      "default": "lightbox",
      "options": [
        { "value": "lightbox", "label": "Lightbox" },
        { "value": "zoom", "label": "Zoom" },
        { "value": "none", "label": "None" }
      ]
    },

    { "type": "header", "content": "Section padding" },
    { "type": "range", "id": "padding_top", "min": 0, "max": 120, "step": 4, "unit": "px", "label": "Padding top", "default": 36 },
    { "type": "range", "id": "padding_bottom", "min": 0, "max": 120, "step": 4, "unit": "px", "label": "Padding bottom", "default": 36 }
  ],
  "blocks": [
    { "type": "title", "name": "Title", "limit": 1 },
    { "type": "price", "name": "Price", "limit": 1 },
    { "type": "sku", "name": "SKU", "limit": 1 },
    {
      "type": "variant_picker",
      "name": "Variant picker",
      "limit": 1,
      "settings": [
        {
          "type": "select",
          "id": "picker_type",
          "label": "Picker type",
          "default": "button",
          "options": [
            { "value": "button", "label": "Buttons" },
            { "value": "dropdown", "label": "Dropdown" },
            { "value": "swatch", "label": "Swatches" },
            { "value": "swatch_dropdown", "label": "Swatch dropdown" }
          ]
        },
        {
          "type": "select",
          "id": "swatch_shape",
          "label": "Swatch shape",
          "default": "circle",
          "options": [
            { "value": "circle", "label": "Circle" },
            { "value": "square", "label": "Square" }
          ]
        }
      ]
    },
    { "type": "quantity", "name": "Quantity", "limit": 1 },
    { "type": "buy_buttons", "name": "Buy buttons", "limit": 1 },
    { "type": "description", "name": "Description", "limit": 1 },
    { "type": "share", "name": "Share", "limit": 1 },
    { "type": "custom_liquid", "name": "Custom liquid" }
  ],
  "presets": [
    {
      "name": "Main Product — Modern",
      "blocks": [
        { "type": "title" },
        { "type": "price" },
        { "type": "variant_picker" },
        { "type": "quantity" },
        { "type": "buy_buttons" }
      ]
    }
  ]
}
{% endschema %}
