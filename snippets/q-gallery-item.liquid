{%- liquid
  assign s = section.settings
  assign b = block.settings
  assign img = b.image

  assign title = b.title
  assign desc = b.description
  assign tag = b.tag
  assign link = b.link_url

  assign alt = ''
  if img != blank and img.alt != blank
    assign alt = img.alt
  elsif title != blank
    assign alt = title
  elsif tag != blank
    assign alt = tag
  else
    assign alt = 'Gallery image'
  endif

  assign has_caption = false
  if s.caption_style != 'none'
    if title != blank
      assign has_caption = true
    elsif desc != blank
      assign has_caption = true
    elsif tag != blank
      assign has_caption = true
    endif
  endif

  assign href = ''
  if click_action == 'none'
    assign href = ''
  else
    if enable_lightbox and click_action == 'lightbox'
      if img != blank
        assign href = img | image_url: width: 2400
      endif
    else
      if link != blank
        assign href = link
      else
        if enable_lightbox and img != blank
          assign href = img | image_url: width: 2400
        endif
      endif
    endif
  endif

  assign is_active = false
  if mode == 'image_accordion'
    if accordion_index == accordion_default
      assign is_active = true
    endif
  endif

  assign ratio_class = 'q-ratio--natural'
  if ratio == 'square'
    assign ratio_class = 'q-ratio--1x1'
  elsif ratio == 'landscape'
    assign ratio_class = 'q-ratio--4x3'
  elsif ratio == 'portrait'
    assign ratio_class = 'q-ratio--3x4'
  endif

  assign fit_attr = fit
  if fit_attr == blank
    assign fit_attr = 'cover'
  endif
-%}

<div
  class="q-gallery__item{% if mode == 'carousel' %} q-gallery__slide{% endif %}{% if mode == 'image_accordion' %} q-gallery__panel{% endif %}{% if is_active %} is-active{% endif %}"
  role="{% if mode == 'image_accordion' %}listitem{% else %}group{% endif %}"
  {{ block.shopify_attributes }}
  data-q-gallery-item
  {% if img != blank %}data-src="{{ img | image_url: width: 2400 }}"{% endif %}
  data-alt="{{ alt | escape }}"
  data-title="{{ title | escape }}"
  data-desc="{{ desc | escape }}"
  data-tag="{{ tag | escape }}"
  {% if mode == 'image_accordion' %}data-accordion-index="{{ accordion_index }}"{% endif %}
>
  {%- if href != blank -%}
    <a
      class="q-gallery__media-link"
      href="{{ href }}"
      aria-label="{{ alt | escape }}"
      {% if enable_lightbox and click_action == 'lightbox' %}data-q-lightbox-open{% endif %}
    >
  {%- else -%}
    <div
      class="q-gallery__media-link"
      tabindex="0"
      role="button"
      aria-label="{{ alt | escape }}"
      {% if enable_lightbox and click_action == 'lightbox' %}data-q-lightbox-open{% endif %}
    >
  {%- endif -%}

      <div class="q-gallery__media {{ ratio_class }}" data-fit="{{ fit_attr }}">
        {%- if img != blank -%}
          {{ img | image_url: width: 1600 | image_tag:
            loading: 'lazy',
            decoding: 'async',
            alt: alt,
            class: 'q-gallery__img'
          }}
        {%- else -%}
          <div class="q-gallery__img-fallback">
            <span class="q-gallery__img-fallback-text">{{ alt | escape }}</span>
          </div>
        {%- endif -%}

        {%- if has_caption and s.caption_style == 'overlay' -%}
          <div class="q-gallery__caption q-gallery__caption--overlay">
            {%- if tag != blank -%}<div class="q-gallery__tag">{{ tag | escape }}</div>{%- endif -%}
            {%- if title != blank -%}<div class="q-gallery__title">{{ title | escape }}</div>{%- endif -%}
            {%- if desc != blank -%}<div class="q-gallery__desc">{{ desc | escape }}</div>{%- endif -%}
          </div>
        {%- endif -%}
      </div>

  {%- if href != blank -%}</a>{%- else -%}</div>{%- endif -%}

  {%- if has_caption and s.caption_style == 'below_image' -%}
    <div class="q-gallery__caption q-gallery__caption--below">
      {%- if tag != blank -%}<div class="q-gallery__tag">{{ tag | escape }}</div>{%- endif -%}
      {%- if title != blank -%}<div class="q-gallery__title">{{ title | escape }}</div>{%- endif -%}
      {%- if desc != blank -%}<div class="q-gallery__desc">{{ desc | escape }}</div>{%- endif -%}
    </div>
  {%- endif -%}
</div>
