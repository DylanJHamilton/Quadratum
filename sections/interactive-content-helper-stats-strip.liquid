{%- comment -%}
  Quadratum — Interactive · Stats & Highlights Strip
  File: sections/interactive-content-helper-stats-strip.liquid

  v2:
  - Premium static strip/grid by default (SEO-safe)
  - Optional count-up animation (section toggle + per-block toggle)
  - Defensive parsing: animates ONLY when numeric target can be derived
  - Reduced-motion safe
  - No overflow / no horizontal scroll
{%- endcomment -%}

{%- liquid
  assign sid = section.id
  assign s = section.settings
  assign stats = section.blocks | where: 'type', 'stat'
  assign count = stats.size

  if count == 0
    break
  endif

  assign layout = s.layout | default: 'inline_strip'
  assign alignment = s.alignment | default: 'center'
  assign show_dividers = s.show_dividers
  assign enable_counters = s.enable_counters

  assign max_width = s.max_width | default: 1200
  assign pad_y = s.pad_y | default: 56

  assign value_font_size = s.value_font_size | default: 2
  assign value_font_weight = s.value_font_weight | default: 600
  assign label_font_size = s.label_font_size | default: 1
  assign label_opacity = s.label_opacity | default: 0.85

  assign icon_size = s.icon_size | default: 1.25

  assign divider_thickness = s.divider_thickness | default: 1
  assign radius = s.radius | default: 16
  assign gap = s.gap | default: 24

  assign shadow_strength = s.shadow_strength | default: 'md'
-%}

<section
  class="q-stats-strip q-layout-{{ layout }} q-align-{{ alignment }}"
  data-q-stats-strip
  {% if enable_counters %}data-q-counters="true"{% endif %}
  style="
    --q-stats-maxw: {{ max_width }}px;
    --q-stats-pad-y: {{ pad_y }}px;

    --q-stats-value-size: {{ value_font_size }}rem;
    --q-stats-value-weight: {{ value_font_weight }};
    --q-stats-label-size: {{ label_font_size }}rem;
    --q-stats-label-opacity: {{ label_opacity }};

    --q-stats-icon-size: {{ icon_size }}rem;

    --q-stats-divider-thickness: {{ divider_thickness }}px;

    --q-stats-radius: {{ radius }}px;

    --q-stats-gap: {{ gap }}px;
  "
>
  <div class="q-stats-inner">
    {%- if s.title != blank or s.subtitle != blank -%}
      <header class="q-stats-header">
        {%- if s.title != blank -%}
          <h2 class="q-stats-title">{{ s.title | escape }}</h2>
        {%- endif -%}

        {%- if s.subtitle != blank -%}
          <div class="q-stats-subtitle rte">{{ s.subtitle }}</div>
        {%- endif -%}
      </header>
    {%- endif -%}

    <ul class="q-stats-list" role="list" aria-label="{{ s.title | default: 'Stats' | escape }}">
      {%- for block in stats -%}
        {%- liquid
          assign b = block.settings
          assign icon = b.icon
          assign value = b.value
          assign label = b.label
          assign animate = b.animate

          assign should_animate = false
          if enable_counters and animate
            assign should_animate = true
          endif
        -%}

        <li class="q-stat-item" {{ block.shopify_attributes }}>
          <div class="q-stat-content">
            {%- if icon != blank -%}
              <span class="q-stat-icon" aria-hidden="true">
                {{ icon }}
              </span>
            {%- endif -%}

            <div class="q-stat-text">
              <strong
                class="q-stat-value"
                {% if should_animate %}
                  data-q-counter
                  data-q-counter-text="{{ value | strip | escape }}"
                {% endif %}
              >
                {{ value | escape }}
              </strong>

              <span class="q-stat-label">
                {{ label | escape }}
              </span>
            </div>
          </div>

          {%- if layout == 'inline_strip'
            and show_dividers
            and count > 1
            and forloop.last == false -%}
            <span class="q-stat-divider" aria-hidden="true"></span>
          {%- endif -%}
        </li>
      {%- endfor -%}
    </ul>
  </div>

  <style>
    /* Section surface */
    #shopify-section-{{ sid }} .q-stats-strip{
      padding-block: var(--q-stats-pad-y);
      background: {{ s.background | default: 'transparent' }};
    }

    #shopify-section-{{ sid }} .q-stats-inner{
      width: 100%;
      max-width: var(--q-stats-maxw);
      margin-inline: auto;
      padding-inline: var(--q-container-pad-x, var(--q-pad-x, 1rem));
      display: grid;
      gap: calc(var(--q-stats-gap) * 1.1);
    }

    #shopify-section-{{ sid }} .q-stats-header{
      display: grid;
      gap: calc(var(--q-stats-gap) * 0.5);
      text-align: center;
    }

    #shopify-section-{{ sid }} .q-align-left .q-stats-header{
      text-align: left;
    }

    #shopify-section-{{ sid }} .q-stats-title{
      margin: 0;
      font-size: var(--q-text-2xl, 1.5rem);
      font-weight: var(--q-font-weight-semibold, 600);
      line-height: var(--q-leading-tight, 1.2);
      letter-spacing: var(--q-letterspacing-tight, normal);
    }

    #shopify-section-{{ sid }} .q-stats-subtitle{
      margin: 0;
      color: var(--q-text-2, var(--q-color-text-2, color-mix(in oklab, rgb(var(--color-foreground,0 0 0)) 80%, transparent)));
    }

    /* List base */
    #shopify-section-{{ sid }} .q-stats-list{
      list-style: none;
      padding: 0;
      margin: 0;
      min-width: 0;
    }

    /* INLINE STRIP: wraps naturally, never overflows */
    #shopify-section-{{ sid }} .q-layout-inline_strip .q-stats-list{
      display: flex;
      flex-wrap: wrap;
      gap: var(--q-stats-gap);
      justify-content: center;
      align-items: center;
    }

    #shopify-section-{{ sid }} .q-align-left.q-layout-inline_strip .q-stats-list{
      justify-content: flex-start;
    }

    #shopify-section-{{ sid }} .q-layout-inline_strip .q-stat-item{
      display: flex;
      align-items: center;
      gap: var(--q-stats-gap);
      min-width: 0;
      max-width: 100%;
    }

    /* GRID: card tiles */
    #shopify-section-{{ sid }} .q-layout-block_grid .q-stats-list{
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(min(240px, 100%), 1fr));
      gap: var(--q-stats-gap);
    }

    #shopify-section-{{ sid }} .q-layout-block_grid .q-stat-item{
      background: {{ s.card_background | default: 'transparent' }};
      border-radius: var(--q-stats-radius);
      padding: calc(var(--q-stats-gap) * 1.05);
      min-width: 0;
      overflow: hidden;

      /* shadow mapping */
      {% case shadow_strength %}
        {% when 'none' %} box-shadow: none;
        {% when 'sm' %} box-shadow: var(--q-shadow-1, var(--q-shadow-sm, 0 8px 20px rgba(0,0,0,.06)));
        {% when 'md' %} box-shadow: var(--q-shadow-2, var(--q-shadow-md, 0 12px 28px rgba(0,0,0,.08)));
        {% when 'lg' %} box-shadow: var(--q-shadow-3, var(--q-shadow-lg, 0 18px 42px rgba(0,0,0,.10)));
        {% else %} box-shadow: var(--q-shadow-2, var(--q-shadow-md, 0 12px 28px rgba(0,0,0,.08)));
      {% endcase %}
    }

    #shopify-section-{{ sid }} .q-stat-content{
      display: flex;
      align-items: center;
      gap: calc(var(--q-stats-gap) * 0.75);
      min-width: 0;
    }

    #shopify-section-{{ sid }} .q-stat-icon{
      font-size: var(--q-stats-icon-size);
      line-height: 1;
      flex: 0 0 auto;
    }

    #shopify-section-{{ sid }} .q-stat-text{
      display: grid;
      gap: 0.25em;
      min-width: 0;
    }

    #shopify-section-{{ sid }} .q-stat-value{
      font-size: var(--q-stats-value-size);
      font-weight: var(--q-stats-value-weight);
      white-space: nowrap; /* keeps 4.9★ intact */
      line-height: 1.1;
      font-variant-numeric: tabular-nums;
      min-width: 0;
    }

    #shopify-section-{{ sid }} .q-stat-label{
      font-size: var(--q-stats-label-size);
      opacity: var(--q-stats-label-opacity);
      overflow-wrap: anywhere;
    }

    #shopify-section-{{ sid }} .q-stat-divider{
      width: var(--q-stats-divider-thickness);
      height: 2.25em;
      background: {{ s.divider_color | default: 'currentColor' }};
      opacity: 0.25;
      flex: 0 0 auto;
    }

    /* Responsive intent: column stack at smaller widths */
    @media (max-width: 48rem){
      #shopify-section-{{ sid }} .q-layout-inline_strip .q-stats-list{
        flex-direction: column;
        align-items: stretch;
      }
      #shopify-section-{{ sid }} .q-layout-inline_strip .q-stat-item{
        justify-content: space-between;
      }
      #shopify-section-{{ sid }} .q-layout-inline_strip .q-stat-divider{
        display: none; /* divider would be awkward in vertical stack */
      }
    }
  </style>

  {%- if enable_counters -%}
    <script>
      (function(){
        var root = document.querySelector('#shopify-section-{{ sid }} [data-q-stats-strip]');
        if(!root) return;

        // Respect reduced motion
        try {
          if (window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches) return;
        } catch(e){}

        var nodes = root.querySelectorAll('[data-q-counter]');
        if(!nodes || !nodes.length) return;

        function parseTarget(text){
          // Extract first numeric chunk: supports "1,250+", "$125,000", "4.9★", "98%"
          // If no number exists, return null (no animation).
          var raw = (text || '').toString();
          var match = raw.match(/-?\d[\d,]*\.?\d*/);
          if(!match) return null;
          var num = parseFloat(match[0].replace(/,/g,''));
          if(!isFinite(num)) return null;
          return num;
        }

        function formatLikeOriginal(original, value){
          // Preserve decimals from original if present
          var hasDecimal = /\d[\d,]*\.\d+/.test(original);
          var decimals = 0;
          if(hasDecimal){
            var m = original.match(/\.(\d+)/);
            decimals = m && m[1] ? m[1].length : 1;
          }
          var out = value.toFixed(decimals);

          // Add thousands separators if original used commas
          if(/,\d{3}/.test(original)){
            out = out.replace(/\B(?=(\d{3})+(?!\d))/g, ',');
          }

          // Keep prefix/suffix by replacing the first number in original with out
          return original.replace(/-?\d[\d,]*\.?\d*/, out);
        }

        function animateNode(el){
          if(el.__qDone) return;

          var original = el.getAttribute('data-q-counter-text') || el.textContent || '';
          var target = parseTarget(original);
          if(target === null) return;

          el.__qDone = true;

          var start = 0;
          var dur = 950;

          var startTs = null;
          function step(ts){
            if(!startTs) startTs = ts;
            var t = Math.min(1, (ts - startTs) / dur);
            // easeOutCubic
            var eased = 1 - Math.pow(1 - t, 3);
            var val = start + (target - start) * eased;
            el.textContent = formatLikeOriginal(original, val);
            if(t < 1) requestAnimationFrame(step);
            else el.textContent = original; // snap to exact final (no rounding drift)
          }
          requestAnimationFrame(step);
        }

        function run(){
          nodes.forEach(function(el){ animateNode(el); });
        }

        // Trigger on view when supported
        if('IntersectionObserver' in window){
          var io = new IntersectionObserver(function(entries){
            entries.forEach(function(entry){
              if(entry.isIntersecting){
                animateNode(entry.target);
                io.unobserve(entry.target);
              }
            });
          }, { root: null, threshold: 0.35 });
          nodes.forEach(function(el){ io.observe(el); });
        } else {
          run();
        }
      })();
    </script>
  {%- endif -%}
</section>

{% schema %}
{
  "name": "Stats & Highlights Strip",
  "tag": "section",
  "class": "section",
  "settings": [
    {
      "type": "select",
      "id": "layout",
      "label": "Layout",
      "default": "inline_strip",
      "options": [
        { "value": "inline_strip", "label": "Inline Strip" },
        { "value": "block_grid", "label": "Block Grid" }
      ]
    },
    {
      "type": "select",
      "id": "alignment",
      "label": "Alignment",
      "default": "center",
      "options": [
        { "value": "left", "label": "Left" },
        { "value": "center", "label": "Center" }
      ]
    },
    {
      "type": "checkbox",
      "id": "show_dividers",
      "label": "Show dividers (inline only)",
      "default": false
    },

    { "type": "text", "id": "title", "label": "Section title" },
    { "type": "richtext", "id": "subtitle", "label": "Section subtitle" },

    {
      "type": "range",
      "id": "max_width",
      "label": "Max width",
      "min": 720,
      "max": 1600,
      "step": 20,
      "default": 1200
    },
    {
      "type": "range",
      "id": "pad_y",
      "label": "Vertical padding",
      "min": 0,
      "max": 160,
      "step": 4,
      "default": 56
    },

    { "type": "color", "id": "background", "label": "Background" },

    {
      "type": "checkbox",
      "id": "enable_counters",
      "label": "Enable counters (optional JS)",
      "default": false
    },

    {
      "type": "range",
      "id": "value_font_size",
      "label": "Value font size (rem)",
      "min": 1,
      "max": 4,
      "step": 0.1,
      "default": 2
    },
    {
      "type": "range",
      "id": "value_font_weight",
      "label": "Value font weight",
      "min": 400,
      "max": 800,
      "step": 50,
      "default": 600
    },
    {
      "type": "range",
      "id": "label_font_size",
      "label": "Label font size (rem)",
      "min": 1,
      "max": 5,
      "step": 1,
      "default": 1
    },
    {
      "type": "range",
      "id": "label_opacity",
      "label": "Label opacity",
      "min": 0,
      "max": 1,
      "step": 0.1,
      "default": 0
    },

    {
      "type": "range",
      "id": "icon_size",
      "label": "Icon size (rem)",
      "min": 0.8,
      "max": 3,
      "step": 0.1,
      "default": 1
    },

    { "type": "color", "id": "divider_color", "label": "Divider color" },
    {
      "type": "range",
      "id": "divider_thickness",
      "label": "Divider thickness (px)",
      "min": 1,
      "max": 6,
      "step": 1,
      "default": 1
    },

    { "type": "color", "id": "card_background", "label": "Card background" },
    {
      "type": "range",
      "id": "radius",
      "label": "Border radius (px)",
      "min": 0,
      "max": 40,
      "step": 1,
      "default": 16
    },
    {
      "type": "select",
      "id": "shadow_strength",
      "label": "Shadow strength",
      "default": "md",
      "options": [
        { "value": "none", "label": "None" },
        { "value": "sm", "label": "Small" },
        { "value": "md", "label": "Medium" },
        { "value": "lg", "label": "Large" }
      ]
    },

    {
      "type": "range",
      "id": "gap",
      "label": "Spacing (px)",
      "min": 8,
      "max": 60,
      "step": 2,
      "default": 24
    }
  ],
  "blocks": [
    {
      "type": "stat",
      "name": "Stat",
      "settings": [
        { "type": "text", "id": "value", "label": "Value" },
        { "type": "text", "id": "label", "label": "Label" },
        { "type": "html", "id": "icon", "label": "Icon (optional)" },
        { "type": "checkbox", "id": "animate", "label": "Animate (counter mode only)", "default": false }
      ]
    }
  ],
  "presets": [
    {
      "name": "Interactive Content Helpers - Stats & Highlights Strip",
      "category": "Interactive Content Helpers"
    }
  ]
}
{% endschema %}
