{% comment %}
  File: sections/video-hero-banner.liquid
  Video background hero with MP4 / YouTube / Vimeo support.
  - If a video is set (via "Video source"), it overrides the background image.
  - Poster image shows if no video and as MP4 poster.
  - YouTube/Vimeo play muted, looped, no UI, background.
  - Scoped styles via #section-{{ section.id }}.
{% endcomment %}

{%- assign scope_id = 'section-' | append: section.id -%}

{%- assign src_type    = section.settings.video_source -%}
{%- assign mp4_url     = section.settings.mp4_url | strip -%}
{%- assign yt_in       = section.settings.youtube_input | strip -%}
{%- assign vimeo_in    = section.settings.vimeo_input | strip -%}
{%- assign bg_image    = section.settings.bg_image -%}
{%- assign poster      = section.settings.poster_image -%}

{%- assign align_h     = section.settings.text_align_h -%}
{%- assign align_v     = section.settings.text_align_v -%}
{%- assign min_vh      = section.settings.min_height_vh -%}
{%- assign pad_t       = section.settings.pad_top -%}
{%- assign pad_b       = section.settings.pad_bottom -%}
{%- assign text_color  = section.settings.text_color -%}
{%- assign overlay_color = section.settings.overlay_color -%}
{%- assign overlay_opacity_percent = section.settings.overlay_opacity -%}
{%- assign max_w       = section.settings.container_max_w -%}

{%- assign hide_mobile  = section.settings.hide_on_mobile -%}
{%- assign hide_desktop = section.settings.hide_on_desktop -%}

{%- assign h1 = section.settings.heading -%}
{%- assign h2 = section.settings.subheading -%}
{%- assign kicker = section.settings.kicker -%}

{%- assign cta1_text = section.settings.cta1_text | strip -%}
{%- assign cta1_link = section.settings.cta1_link | strip -%}
{%- assign cta2_text = section.settings.cta2_text | strip -%}
{%- assign cta2_link = section.settings.cta2_link | strip -%}

{%- comment %} Normalize YouTube ID if a full URL was provided. {% endcomment -%}
{%- assign yt_id = yt_in -%}
{%- if yt_in contains 'youtube.com' or yt_in contains 'youtu.be' -%}
  {%- assign tmp = yt_in -%}
  {%- if tmp contains 'v=' -%}
    {%- assign after_v = tmp | split: 'v=' | last -%}
    {%- assign yt_id = after_v | split: '&' | first -%}
  {%- elsif tmp contains 'youtu.be/' -%}
    {%- assign after_host = tmp | split: 'youtu.be/' | last -%}
    {%- assign yt_id = after_host | split: '?' | first -%}
  {%- endif -%}
{%- endif -%}

{%- comment %} Normalize Vimeo ID if a full URL was provided. {% endcomment -%}
{%- assign vimeo_id = vimeo_in -%}
{%- if vimeo_in contains 'vimeo.com' -%}
  {%- assign last_part = vimeo_in | split: 'vimeo.com/' | last -%}
  {%- assign vimeo_id = last_part | split: '?' | first | split: '/' | last -%}
{%- endif -%}

{%- comment %} Determine if a valid video is present for the chosen source. {% endcomment -%}
{%- assign has_video = false -%}
{%- if src_type == 'mp4' and mp4_url != blank -%}
  {%- assign has_video = true -%}
{%- elsif src_type == 'youtube' and yt_id != blank -%}
  {%- assign has_video = true -%}
{%- elsif src_type == 'vimeo' and vimeo_id != blank -%}
  {%- assign has_video = true -%}
{%- endif -%}

{%- assign img_class = scope_id | append: '__img' -%}

<section id="{{ scope_id }}"
  class="video-hero{% if hide_mobile %} hide-mobile{% endif %}{% if hide_desktop %} hide-desktop{% endif %}"
  aria-label="{{ h1 | default: 'Video hero banner' | escape }}">
  <div class="{{ scope_id }}__media">
    {%- if has_video -%}
      {%- if src_type == 'mp4' and mp4_url != blank -%}
        <video
          class="{{ scope_id }}__video"
          autoplay
          muted
          loop
          playsinline
          preload="metadata"
          {% if poster != blank %}poster="{{ poster | image_url: width: 1920 }}"{% endif %}
        >
          <source src="{{ mp4_url | escape }}" type="video/mp4">
          {%- if poster != blank -%}
            <img src="{{ poster | image_url: width: 1920 }}" alt="" loading="lazy">
          {%- elsif bg_image != blank -%}
            <img src="{{ bg_image | image_url: width: 1920 }}" alt="" loading="lazy">
          {%- endif -%}
        </video>
      {%- elsif src_type == 'youtube' and yt_id != blank -%}
        <div class="{{ scope_id }}__iframe-wrap" data-aspect="16-9">
          <iframe
            class="{{ scope_id }}__iframe"
            src="https://www.youtube.com/embed/{{ yt_id | escape }}?autoplay=1&mute=1&controls=0&playsinline=1&loop=1&modestbranding=1&rel=0&showinfo=0&iv_load_policy=3&enablejsapi=1&playlist={{ yt_id | escape }}"
            title="YouTube video"
            allow="autoplay; fullscreen; accelerometer; encrypted-media; picture-in-picture"
            frameborder="0"
            aria-hidden="true"
            tabindex="-1"
          ></iframe>
        </div>
      {%- elsif src_type == 'vimeo' and vimeo_id != blank -%}
        <div class="{{ scope_id }}__iframe-wrap" data-aspect="16-9">
          <iframe
            class="{{ scope_id }}__iframe"
            src="https://player.vimeo.com/video/{{ vimeo_id | escape }}?background=1&autoplay=1&muted=1&loop=1&title=0&byline=0&portrait=0"
            title="Vimeo video"
            allow="autoplay; fullscreen; picture-in-picture"
            frameborder="0"
            aria-hidden="true"
            tabindex="-1"
          ></iframe>
        </div>
      {%- endif -%}
      {%- if overlay_color != blank -%}
        <div class="{{ scope_id }}__overlay" aria-hidden="true"></div>
      {%- endif -%}
    {%- else -%}
      {%- if poster != blank -%}
        <div class="{{ scope_id }}__image">
          {{ poster | image_url: width: 1920 | image_tag: alt: '', loading: 'lazy', class: img_class }}
        </div>
      {%- elsif bg_image != blank -%}
        <div class="{{ scope_id }}__image">
          {{ bg_image | image_url: width: 1920 | image_tag: alt: '', loading: 'lazy', class: img_class }}
        </div>
      {%- else -%}
        <div class="{{ scope_id }}__placeholder" role="img" aria-label="Hero background placeholder"></div>
      {%- endif -%}
      {%- if overlay_color != blank -%}
        <div class="{{ scope_id }}__overlay" aria-hidden="true"></div>
      {%- endif -%}
    {%- endif -%}
  </div>

  <div class="{{ scope_id }}__inner">
    <div class="{{ scope_id }}__content">
      {%- if kicker != blank -%}
        <p class="{{ scope_id }}__kicker">{{ kicker }}</p>
      {%- endif -%}
      {%- if h1 != blank -%}
        <h1 class="{{ scope_id }}__heading">{{ h1 }}</h1>
      {%- endif -%}
      {%- if h2 != blank -%}
        <p class="{{ scope_id }}__subheading">{{ h2 }}</p>
      {%- endif -%}
      {%- if cta1_text != blank or cta2_text != blank -%}
        <div class="{{ scope_id }}__buttons">
          {%- if cta1_text != blank -%}
            <a class="{{ scope_id }}__btn {{ scope_id }}__btn--primary" href="{{ cta1_link | default: '#' | escape }}">
              {{ cta1_text }}
            </a>
          {%- endif -%}
          {%- if cta2_text != blank -%}
            <a class="{{ scope_id }}__btn {{ scope_id }}__btn--secondary" href="{{ cta2_link | default: '#' | escape }}">
              {{ cta2_text }}
            </a>
          {%- endif -%}
        </div>
      {%- endif -%}
    </div>
  </div>
</section>

<style>
  #{{ scope_id }} {
    position: relative;
    isolation: isolate;
    color: {{ text_color }};
    min-height: {{ min_vh }}vh;
    padding-top: {{ pad_t }}px;
    padding-bottom: {{ pad_b }}px;
    overflow: clip;
  }

  #{{ scope_id }} .{{ scope_id }}__media {
    position: absolute;
    inset: 0;
    overflow: hidden;
    z-index: 0;
    background: {% if bg_image != blank or poster != blank %}transparent{% else %}#000{% endif %};
  }

  #{{ scope_id }} .{{ scope_id }}__video,
  #{{ scope_id }} .{{ scope_id }}__img,
  #{{ scope_id }} .{{ scope_id }}__placeholder {
    position: absolute;
    inset: 0;
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  #{{ scope_id }} .{{ scope_id }}__iframe-wrap {
    position: absolute;
    inset: 0;
    width: 100%;
    height: 100%;
    pointer-events: none;
    overflow: hidden;
    z-index: 0;
  }
  /* Cover behavior for iframe similar to object-fit: cover */
  #{{ scope_id }} .{{ scope_id }}__iframe {
    position: absolute;
    top: 50%;
    left: 50%;
    width: 177.78vh;
    height: 100vh;
    transform: translate(-50%, -50%);
    min-width: 100%;
    min-height: 56.25vw;
  }

  #{{ scope_id }} .{{ scope_id }}__overlay {
    position: absolute;
    inset: 0;
    background-color: {{ overlay_color }};
    opacity: {{ overlay_opacity_percent | times: 0.01 }};
    z-index: 1;
    pointer-events: none;
  }

  #{{ scope_id }} .{{ scope_id }}__inner {
    position: relative;
    z-index: 2;
    display: flex;
    align-items: {% case align_v %}{% when 'top' %}flex-start{% when 'middle' %}center{% else %}flex-end{% endcase %};
    justify-content: {% case align_h %}{% when 'left' %}flex-start{% when 'center' %}center{% else %}flex-end{% endcase %};
    min-height: {{ min_vh }}vh;
  }

  #{{ scope_id }} .{{ scope_id }}__content {
    width: 100%;
    max-width: {{ max_w }}px;
    padding-inline: 1rem;
    text-align: {% case align_h %}{% when 'left' %}left{% when 'center' %}center{% else %}right{% endcase %};
  }

  #{{ scope_id }} .{{ scope_id }}__kicker {
    margin: 0 0 .5rem 0;
    font-weight: 600;
    letter-spacing: .05em;
    text-transform: uppercase;
  }
  #{{ scope_id }} .{{ scope_id }}__heading {
    margin: 0 0 .75rem 0;
    font-size: clamp(2rem, 4vw, 3.25rem);
    line-height: 1.1;
  }
  #{{ scope_id }} .{{ scope_id }}__subheading {
    margin: 0 0 1.25rem 0;
    font-size: clamp(1rem, 1.8vw, 1.25rem);
    line-height: 1.6;
  }
  #{{ scope_id }} .{{ scope_id }}__buttons {
    display: inline-flex;
    gap: .75rem;
    flex-wrap: wrap;
  }
  #{{ scope_id }} .{{ scope_id }}__btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    padding: .75rem 1.25rem;
    border-radius: .75rem;
    font-weight: 600;
    text-decoration: none;
    border: 2px solid currentColor;
    transition: transform .15s ease, opacity .15s ease;
  }
  #{{ scope_id }} .{{ scope_id }}__btn:hover { transform: translateY(-1px); }
  #{{ scope_id }} .{{ scope_id }}__btn:active { transform: translateY(0); opacity: .9; }

  #{{ scope_id }} .{{ scope_id }}__btn--primary {
    background: currentColor;
    color: #000;
    border-color: currentColor;
  }
  #{{ scope_id }} .{{ scope_id }}__btn--secondary {
    background: transparent;
    color: {{ text_color }};
    border-color: currentColor;
  }

  #{{ scope_id }} .{{ scope_id }}__placeholder {
    background: #111;
  }

  /* Visibility toggles */
  #{{ scope_id }}.hide-mobile { display: block; }
  #{{ scope_id }}.hide-desktop { display: block; }
  @media (max-width: 749px) {
    #{{ scope_id }}.hide-mobile { display: none; }
  }
  @media (min-width: 750px) {
    #{{ scope_id }}.hide-desktop { display: none; }
  }
</style>

{% schema %}
{
  "name": "Video hero banner",
  "tag": "section",
  "class": "video-hero-banner",
  "settings": [
    {
      "type": "select",
      "id": "video_source",
      "label": "Video source",
      "default": "mp4",
      "options": [
        { "value": "mp4", "label": "MP4" },
        { "value": "youtube", "label": "YouTube" },
        { "value": "vimeo", "label": "Vimeo" }
      ]
    },
    {
      "type": "text",
      "id": "mp4_url",
      "label": "MP4 URL",
      "default": "https://example.com/video.mp4"
    },
    {
      "type": "text",
      "id": "youtube_input",
      "label": "YouTube ID or URL",
      "default": "dQw4w9WgXcQ"
    },
    {
      "type": "text",
      "id": "vimeo_input",
      "label": "Vimeo ID or URL",
      "default": "76979871"
    },
    {
      "type": "image_picker",
      "id": "poster_image",
      "label": "Poster image",
      "info": "Used if no video is set and as MP4 poster."
    },
    {
      "type": "image_picker",
      "id": "bg_image",
      "label": "Background image (fallback)"
    },
    {
      "type": "color",
      "id": "overlay_color",
      "label": "Overlay color",
      "default": "#000000"
    },
    {
      "type": "range",
      "id": "overlay_opacity",
      "label": "Overlay opacity",
      "min": 0,
      "max": 100,
      "step": 1,
      "unit": "%",
      "default": 40
    },
    {
      "type": "text",
      "id": "kicker",
      "label": "Kicker",
      "default": "Featured"
    },
    {
      "type": "text",
      "id": "heading",
      "label": "Heading",
      "default": "Bring your story to life"
    },
    {
      "type": "text",
      "id": "subheading",
      "label": "Subheading",
      "default": "Autoplaying background video with clean, bold messaging."
    },
    {
      "type": "color",
      "id": "text_color",
      "label": "Text color",
      "default": "#ffffff"
    },
    {
      "type": "select",
      "id": "text_align_h",
      "label": "Horizontal align",
      "default": "center",
      "options": [
        { "value": "left", "label": "Left" },
        { "value": "center", "label": "Center" },
        { "value": "right", "label": "Right" }
      ]
    },
    {
      "type": "select",
      "id": "text_align_v",
      "label": "Vertical align",
      "default": "middle",
      "options": [
        { "value": "top", "label": "Top" },
        { "value": "middle", "label": "Middle" },
        { "value": "bottom", "label": "Bottom" }
      ]
    },
    {
      "type": "range",
      "id": "container_max_w",
      "label": "Container max width",
      "min": 480,
      "max": 1600,
      "step": 20,
      "unit": "px",
      "default": 1200
    },
    {
      "type": "range",
      "id": "min_height_vh",
      "label": "Min height",
      "min": 30,
      "max": 100,
      "step": 1,
      "unit": "vh",
      "default": 70
    },
    {
      "type": "range",
      "id": "pad_top",
      "label": "Padding top",
      "min": 0,
      "max": 200,
      "step": 2,
      "unit": "px",
      "default": 40
    },
    {
      "type": "range",
      "id": "pad_bottom",
      "label": "Padding bottom",
      "min": 0,
      "max": 200,
      "step": 2,
      "unit": "px",
      "default": 40
    },
    {
      "type": "text",
      "id": "cta1_text",
      "label": "Primary button text",
      "default": "Shop now"
    },
    {
      "type": "text",
      "id": "cta1_link",
      "label": "Primary button link",
      "default": "https://example.com/"
    },
    {
      "type": "text",
      "id": "cta2_text",
      "label": "Secondary button text",
      "default": "Learn more"
    },
    {
      "type": "text",
      "id": "cta2_link",
      "label": "Secondary button link",
      "default": "https://example.com/"
    },
    {
      "type": "checkbox",
      "id": "hide_on_mobile",
      "label": "Hide on mobile",
      "default": false
    },
    {
      "type": "checkbox",
      "id": "hide_on_desktop",
      "label": "Hide on desktop",
      "default": false
    }
  ],
  "presets": [
    {
      "name": "Video Banner",
      "category": "Hero Banners"
    }
  ]
}
{% endschema %}

{% javascript %}{% endjavascript %}
