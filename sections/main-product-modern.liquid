{%- comment -%}
  Quadratum — Main Product Modern (Standalone / No Snippet Dependencies)
  File: sections/main-product-modern.liquid

  GOAL:
  - A working PDP section that DOES NOT depend on Dawn snippets:
    product-media-gallery, product-media-modal, product-thumbnail, price, product-variant-options, etc.

  INCLUDES:
  - Media gallery (images) + thumbs
  - Lightbox modal (X + prev/next)
  - Variant picker (buttons or dropdown) with availability disabling
  - Price / compare-at update on variant change
  - SKU update + availability message
  - Add to cart form + optional dynamic checkout button
  - Below-ATC content setting: none / description / metafield short description
  - Accordion blocks (no tabs): description / reviews app block / metafield / custom liquid

  NOTES:
  - Focuses on image media. Video/model not replicated like Dawn.
  - Does not crash if theme lacks Dawn assets/snippets.
{%- endcomment -%}

{%- liquid
  assign p = product
  if p == blank
    break
  endif

  assign s = section.settings

  assign current_variant = p.selected_or_first_available_variant
  if current_variant == blank
    assign current_variant = p.variants.first
  endif

  assign section_aria = s.section_aria_label
  if section_aria == blank
    assign section_aria = 'Product details'
  endif

  assign padding_top_mobile = s.padding_top | times: 0.75 | round: 0
  assign padding_bottom_mobile = s.padding_bottom | times: 0.75 | round: 0

  assign image_media = p.media | where: 'media_type', 'image'
  assign featured = p.selected_or_first_available_variant.featured_media | default: p.featured_media
  assign featured_src = ''
  if featured and featured.media_type == 'image'
    assign featured_src = featured | image_url: width: 1600
  elsif image_media.first
    assign featured_src = image_media.first | image_url: width: 1600
    assign featured = image_media.first
  endif

  assign money_currency = cart.currency.iso_code | default: shop.currency
-%}

<section
  id="MainProductModern-{{ section.id }}"
  class="qtm-modern section-{{ section.id }}-padding color-{{ s.color_scheme }} gradient"
  aria-label="{{ section_aria | escape }}"
  data-section-id="{{ section.id }}"
  data-product-id="{{ p.id }}"
  data-picker-type="{{ s.picker_type }}"
>
  <style>
    .section-{{ section.id }}-padding { padding-top: {{ padding_top_mobile }}px; padding-bottom: {{ padding_bottom_mobile }}px; }
    @media (min-width: 750px){
      .section-{{ section.id }}-padding { padding-top: {{ s.padding_top }}px; padding-bottom: {{ s.padding_bottom }}px; }
    }

    /* Layout */
    #MainProductModern-{{ section.id }} .qtm-modern__grid{
      display:grid;
      gap: 2.5rem;
      align-items:start;
    }
    @media (min-width: 990px){
      #MainProductModern-{{ section.id }} .qtm-modern__grid{
        grid-template-columns: 1.05fr 0.95fr;
      }
      #MainProductModern-{{ section.id }}.qtm-modern--media-right .qtm-modern__media { order: 2; }
      #MainProductModern-{{ section.id }}.qtm-modern--media-right .qtm-modern__info { order: 1; }
    }

    /* Media */
    #MainProductModern-{{ section.id }} .qtm-modern__main-media{
      position:relative;
      border-radius: 12px;
      overflow:hidden;
      background: rgba(0,0,0,0.03);
    }
    #MainProductModern-{{ section.id }} .qtm-modern__main-media img{
      display:block;
      width:100%;
      height:auto;
    }

    #MainProductModern-{{ section.id }} .qtm-modern__zoom-btn{
      position:absolute;
      inset:auto 0 0 0;
      width:100%;
      background: rgba(0,0,0,0.55);
      color:#fff;
      border:0;
      padding: .85rem 1rem;
      cursor:pointer;
      font-weight:600;
      text-align:center;
    }

    #MainProductModern-{{ section.id }} .qtm-modern__thumbs{
      display:flex;
      gap:.6rem;
      flex-wrap:wrap;
      margin-top:.75rem;
    }
    #MainProductModern-{{ section.id }} .qtm-modern__thumb{
      width:72px;
      height:72px;
      border-radius: 10px;
      overflow:hidden;
      border: 1px solid rgba(0,0,0,0.12);
      padding:0;
      background:#fff;
      cursor:pointer;
    }
    #MainProductModern-{{ section.id }} .qtm-modern__thumb[aria-current="true"]{
      outline: 2px solid currentColor;
      outline-offset: 2px;
    }
    #MainProductModern-{{ section.id }} .qtm-modern__thumb img{
      width:100%;
      height:100%;
      object-fit:cover;
      display:block;
    }

    /* Info */
    #MainProductModern-{{ section.id }} .qtm-modern__title{ margin: 0 0 .5rem; }
    #MainProductModern-{{ section.id }} .qtm-modern__price{
      display:flex;
      gap:.75rem;
      align-items:baseline;
      margin: .75rem 0 1rem;
    }
    #MainProductModern-{{ section.id }} .qtm-modern__compare{ text-decoration: line-through; opacity:.6; }
    #MainProductModern-{{ section.id }} .qtm-modern__current{ font-weight:700; font-size: 1.35rem; }
    #MainProductModern-{{ section.id }} .qtm-modern__meta{
      display:flex;
      flex-wrap:wrap;
      gap: .75rem 1.25rem;
      opacity: .85;
      font-size: .95rem;
      margin-bottom: 1rem;
    }

    #MainProductModern-{{ section.id }} .qtm-modern__form{
      display:grid;
      gap: 1rem;
      margin-top: 1rem;
    }

    #MainProductModern-{{ section.id }} .qtm-modern__option label{
      display:block;
      font-weight:600;
      margin-bottom:.35rem;
    }

    /* Buttons picker */
    #MainProductModern-{{ section.id }} .qtm-modern__radios{
      display:flex;
      flex-wrap:wrap;
      gap:.5rem;
    }
    #MainProductModern-{{ section.id }} .qtm-modern__radios input{
      position:absolute;
      opacity:0;
      pointer-events:none;
    }
    #MainProductModern-{{ section.id }} .qtm-modern__radios label{
      border: 1px solid rgba(0,0,0,0.18);
      border-radius: 999px;
      padding: .55rem .85rem;
      cursor:pointer;
      user-select:none;
      margin:0;
      font-weight:600;
      background:#fff;
    }
    #MainProductModern-{{ section.id }} .qtm-modern__radios input:checked + label{
      outline:2px solid currentColor;
      outline-offset:2px;
    }
    #MainProductModern-{{ section.id }} .qtm-modern__radios input:disabled + label{
      opacity:.45;
      cursor:not-allowed;
      text-decoration: line-through;
    }

    /* Dropdown picker */
    #MainProductModern-{{ section.id }} .qtm-modern__select{
      width:100%;
      max-width: 420px;
      padding: .65rem .75rem;
      border-radius: 12px;
      border: 1px solid rgba(0,0,0,0.18);
      background: #fff;
      font-weight:600;
    }

    #MainProductModern-{{ section.id }} .qtm-modern__qty input{
      width: 110px;
      padding: .6rem .7rem;
    }

    #MainProductModern-{{ section.id }} .qtm-modern__atc{
      padding: 1rem 1.1rem;
      font-weight: 700;
      border:0;
      border-radius: 12px;
      cursor:pointer;
    }
    #MainProductModern-{{ section.id }} .qtm-modern__atc[disabled]{ opacity:.55; cursor:not-allowed; }

    /* Below ATC */
    #MainProductModern-{{ section.id }} .qtm-modern__below-atc{
      margin-top: 1.1rem;
    }

    /* Accordions */
    #MainProductModern-{{ section.id }} .qtm-modern__accordion{
      margin-top: 1.25rem;
      display:grid;
      gap:.75rem;
    }
    #MainProductModern-{{ section.id }} .qtm-modern__accordion details{
      border: 1px solid rgba(0,0,0,0.12);
      border-radius: 12px;
      padding: .75rem 1rem;
      background: rgba(255,255,255,0.65);
    }
    #MainProductModern-{{ section.id }} .qtm-modern__accordion summary{
      cursor:pointer;
      font-weight:700;
      list-style:none;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:1rem;
    }
    #MainProductModern-{{ section.id }} .qtm-modern__accordion summary::-webkit-details-marker{ display:none; }
    #MainProductModern-{{ section.id }} .qtm-modern__accordion .qtm-modern__accordion-content{
      margin-top:.75rem;
    }

    /* Modal */
    #MainProductModern-{{ section.id }} dialog.qtm-modern__modal{
      width:min(980px, 96vw);
      border:0;
      border-radius: 14px;
      padding:0;
      overflow:hidden;
    }
    #MainProductModern-{{ section.id }} dialog.qtm-modern__modal::backdrop{
      background: rgba(0,0,0,0.7);
    }
    #MainProductModern-{{ section.id }} .qtm-modern__modal-head{
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding: .75rem 1rem;
      background: rgba(0,0,0,0.85);
      color:#fff;
    }
    #MainProductModern-{{ section.id }} .qtm-modern__modal-close{
      border:0;
      background: transparent;
      color:#fff;
      font-size: 1.15rem;
      font-weight:800;
      cursor:pointer;
    }
    #MainProductModern-{{ section.id }} .qtm-modern__modal-body{
      position:relative;
      background:#000;
    }
    #MainProductModern-{{ section.id }} .qtm-modern__modal-body img{
      display:block;
      width:100%;
      height:auto;
    }
    #MainProductModern-{{ section.id }} .qtm-modern__modal-nav{
      position:absolute;
      inset:0;
      display:flex;
      justify-content:space-between;
      align-items:center;
      pointer-events:none;
      padding: 0 .5rem;
    }
    #MainProductModern-{{ section.id }} .qtm-modern__modal-nav button{
      pointer-events:auto;
      border:0;
      width:44px;
      height:44px;
      border-radius: 999px;
      background: rgba(255,255,255,0.18);
      color:#fff;
      font-weight:900;
      cursor:pointer;
    }
  </style>

  {%- assign media_position_class = 'qtm-modern--media-left' -%}
  {%- if s.media_position == 'right' -%}
    {%- assign media_position_class = 'qtm-modern--media-right' -%}
  {%- endif -%}

  <div class="page-width {{ media_position_class }}">
    <div class="qtm-modern__grid">

      {%- comment -%} ================= MEDIA ================= {%- endcomment -%}
      <div class="qtm-modern__media">
        <div class="qtm-modern__main-media">
          <img
            id="QtmMainImage-{{ section.id }}"
            src="{{ featured_src }}"
            alt="{{ featured.alt | escape }}"
            loading="eager"
          >
          {%- if s.image_zoom == 'lightbox' -%}
            <button type="button" class="qtm-modern__zoom-btn" data-qtm-open-modal aria-haspopup="dialog">
              View larger
            </button>
          {%- endif -%}
        </div>

        {%- if image_media.size > 1 -%}
          <div class="qtm-modern__thumbs" aria-label="Product images">
            {%- for m in image_media -%}
              {%- assign thumb_src = m | image_url: width: 240 -%}
              {%- assign full_src = m | image_url: width: 1600 -%}
              <button
                type="button"
                class="qtm-modern__thumb"
                data-qtm-image="{{ full_src }}"
                data-qtm-index="{{ forloop.index0 }}"
                aria-current="{% if full_src == featured_src %}true{% else %}false{% endif %}"
              >
                <img src="{{ thumb_src }}" alt="{{ m.alt | escape }}" loading="lazy">
              </button>
            {%- endfor -%}
          </div>
        {%- endif -%}
      </div>

      {%- comment -%} ================= INFO ================= {%- endcomment -%}
      <div class="qtm-modern__info">
        <h1 class="qtm-modern__title">{{ p.title | escape }}</h1>

        <div class="qtm-modern__price" id="QtmPriceWrap-{{ section.id }}">
          <span
            class="qtm-modern__compare"
            id="QtmCompare-{{ section.id }}"
            {% unless current_variant.compare_at_price > current_variant.price %}style="display:none"{% endunless %}
          >
            {{ current_variant.compare_at_price | money }}
          </span>
          <span class="qtm-modern__current" id="QtmPrice-{{ section.id }}">
            {{ current_variant.price | money }}
          </span>
        </div>

        <div class="qtm-modern__meta">
          <span id="QtmSkuWrap-{{ section.id }}" {% if current_variant.sku == blank %}style="display:none"{% endif %}>
            <strong>SKU:</strong> <span id="QtmSku-{{ section.id }}">{{ current_variant.sku }}</span>
          </span>
          <span id="QtmAvail-{{ section.id }}">
            <strong>Status:</strong>
            <span id="QtmAvailText-{{ section.id }}">
              {% if current_variant.available %}In stock{% else %}Sold out{% endif %}
            </span>
          </span>
        </div>

        {%- assign product_form_id = 'product-form-' | append: section.id -%}

        <form
          id="{{ product_form_id }}"
          class="qtm-modern__form"
          method="post"
          action="{{ routes.cart_add_url }}"
          enctype="multipart/form-data"
          data-qtm-form
        >
          <input type="hidden" name="id" id="QtmVariantId-{{ section.id }}" value="{{ current_variant.id }}">
          <input type="hidden" name="quantity" id="QtmQtyHidden-{{ section.id }}" value="1">

          {%- unless p.has_only_default_variant -%}
            {%- for option in p.options_with_values -%}
              <div class="qtm-modern__option" data-qtm-option data-index="{{ option.position }}">
                <label>{{ option.name | escape }}</label>

                {%- if s.picker_type == 'dropdown' -%}
                  <select class="qtm-modern__select" name="qtm-option-{{ option.position }}" data-qtm-select>
                    {%- for value in option.values -%}
                      <option value="{{ value | escape }}" {% if value.selected %}selected{% endif %}>
                        {{ value }}
                      </option>
                    {%- endfor -%}
                  </select>
                {%- else -%}
                  <div class="qtm-modern__radios" role="radiogroup" aria-label="{{ option.name | escape }}">
                    {%- for value in option.values -%}
                      {%- capture input_id -%}QtmOpt-{{ section.id }}-{{ option.position }}-{{ forloop.index0 }}{%- endcapture -%}
                      <input
                        type="radio"
                        id="{{ input_id }}"
                        name="qtm-option-{{ option.position }}"
                        value="{{ value | escape }}"
                        {% if value.selected %}checked{% endif %}
                      >
                      <label for="{{ input_id }}">{{ value }}</label>
                    {%- endfor -%}
                  </div>
                {%- endif -%}
              </div>
            {%- endfor -%}
          {%- endunless -%}

          <div class="qtm-modern__qty">
            <label for="QtmQty-{{ section.id }}">Quantity</label>
            <input id="QtmQty-{{ section.id }}" type="number" min="1" value="1">
          </div>

          <button
            type="submit"
            class="qtm-modern__atc"
            id="QtmAtc-{{ section.id }}"
            {% unless current_variant.available %}disabled{% endunless %}
          >
            {% if current_variant.available %}Add to cart{% else %}Sold out{% endif %}
          </button>

          {%- if s.show_dynamic_checkout -%}
            {%- form 'product', p, id: 'QtmDyn-' | append: section.id -%}
              <input type="hidden" name="id" value="{{ current_variant.id }}">
              {{ form | payment_button }}
            {%- endform -%}
          {%- endif -%}
        </form>

        {%- comment -%} ===== Below ATC content option (none / description / metafield short) ===== {%- endcomment -%}
        {%- if s.below_atc_content != 'none' -%}
          <div class="qtm-modern__below-atc rte" data-qtm-below-atc>
            {%- if s.below_atc_content == 'description' -%}
              {%- if p.description != blank -%}{{ p.description }}{%- endif -%}
            {%- elsif s.below_atc_content == 'short' -%}
              {%- assign ns = s.short_desc_metafield_namespace | strip -%}
              {%- assign ky = s.short_desc_metafield_key | strip -%}
              {%- if ns != blank and ky != blank -%}
                {%- assign mf = p.metafields[ns][ky] -%}
                {%- if mf != blank -%}
                  {%- if mf.value != blank -%}{{ mf.value }}{%- else -%}{{ mf }}{%- endif -%}
                {%- endif -%}
              {%- endif -%}
            {%- endif -%}
          </div>
        {%- endif -%}

        {%- comment -%} ===== Accordion blocks (no tabs) ===== {%- endcomment -%}
        {%- if section.blocks.size > 0 -%}
          <div class="qtm-modern__accordion" data-qtm-accordion>
            {%- for block in section.blocks -%}
              {%- liquid
                assign is_open = false
                if s.open_first_accordion and forloop.first
                  assign is_open = true
                endif
              -%}
              <details
                {% if is_open %}open{% endif %}
                {{ block.shopify_attributes }}
              >
                <summary>
                  <span>{{ block.settings.heading | escape }}</span>
                  <span aria-hidden="true">+</span>
                </summary>

                <div class="qtm-modern__accordion-content rte">
                  {%- case block.type -%}

                    {%- when 'description' -%}
                      {%- if p.description != blank -%}{{ p.description }}{%- endif -%}

                    {%- when 'reviews' -%}
                      {%- comment -%} App block renders here {%- endcomment -%}
                      {% render block %}

                    {%- when 'metafield' -%}
                      {%- assign mns = block.settings.namespace | strip -%}
                      {%- assign mky = block.settings.key | strip -%}
                      {%- if mns != blank and mky != blank -%}
                        {%- assign mf2 = p.metafields[mns][mky] -%}
                        {%- if mf2 != blank -%}
                          {%- if block.settings.label != blank -%}
                            <p><strong>{{ block.settings.label | escape }}</strong></p>
                          {%- endif -%}
                          {%- if mf2.value != blank -%}
                            {{ mf2.value }}
                          {%- else -%}
                            {{ mf2 }}
                          {%- endif -%}
                        {%- endif -%}
                      {%- endif -%}

                    {%- when 'custom_liquid' -%}
                      {{ block.settings.custom_liquid }}

                  {%- endcase -%}
                </div>
              </details>
            {%- endfor -%}
          </div>
        {%- endif -%}

      </div>
    </div>
  </div>

  {%- comment -%} ================= LIGHTBOX MODAL ================= {%- endcomment -%}
  {%- if s.image_zoom == 'lightbox' -%}
    <dialog class="qtm-modern__modal" id="QtmModal-{{ section.id }}" aria-label="Product images">
      <div class="qtm-modern__modal-head">
        <div style="font-weight:800;">{{ p.title | escape }}</div>
        <button type="button" class="qtm-modern__modal-close" data-qtm-close-modal aria-label="Close">✕</button>
      </div>
      <div class="qtm-modern__modal-body">
        <img id="QtmModalImg-{{ section.id }}" src="{{ featured_src }}" alt="{{ featured.alt | escape }}">
        <div class="qtm-modern__modal-nav">
          <button type="button" data-qtm-prev aria-label="Previous">‹</button>
          <button type="button" data-qtm-next aria-label="Next">›</button>
        </div>
      </div>
    </dialog>
  {%- endif -%}

  {%- comment -%} ================= PRODUCT JSON ================= {%- endcomment -%}
  <script type="application/json" id="QtmProductJson-{{ section.id }}">
    {{ p | json }}
  </script>

  <script>
    (function(){
      var root = document.getElementById('MainProductModern-{{ section.id }}');
      if (!root) return;

      var productEl = document.getElementById('QtmProductJson-{{ section.id }}');
      if (!productEl) return;

      var product = JSON.parse(productEl.textContent);
      var variants = product.variants || [];
      var options = product.options || [];

      var moneyCurrency = {{ money_currency | json }};

      var mainImg = document.getElementById('QtmMainImage-{{ section.id }}');
      var thumbs = root.querySelectorAll('.qtm-modern__thumb');

      // Lightbox
      var modal = document.getElementById('QtmModal-{{ section.id }}');
      var modalImg = document.getElementById('QtmModalImg-{{ section.id }}');

      var openBtn = root.querySelector('[data-qtm-open-modal]');
      var closeBtn = root.querySelector('[data-qtm-close-modal]');
      var prevBtn = root.querySelector('[data-qtm-prev]');
      var nextBtn = root.querySelector('[data-qtm-next]');

      var currentIndex = 0;

      function setActiveThumb(idx){
        thumbs.forEach(function(t){ t.setAttribute('aria-current','false'); });
        if (thumbs[idx]) thumbs[idx].setAttribute('aria-current','true');
      }

      function setImageByIndex(idx){
        if (!thumbs.length) return;
        var btn = thumbs[idx];
        if (!btn) return;
        currentIndex = idx;
        var src = btn.getAttribute('data-qtm-image');
        if (src && mainImg) mainImg.src = src;
        if (src && modalImg) modalImg.src = src;
        setActiveThumb(idx);
      }

      // thumb click
      thumbs.forEach(function(btn){
        btn.addEventListener('click', function(){
          var idx = parseInt(btn.getAttribute('data-qtm-index'), 10) || 0;
          setImageByIndex(idx);
        });
      });

      // modal open/close
      if (openBtn && modal){
        openBtn.addEventListener('click', function(){
          if (modal.showModal) modal.showModal();
        });
      }
      if (closeBtn && modal){
        closeBtn.addEventListener('click', function(){ modal.close(); });
      }

      // prev/next
      function prev(){
        if (!thumbs.length) return;
        var idx = currentIndex - 1;
        if (idx < 0) idx = thumbs.length - 1;
        setImageByIndex(idx);
      }
      function next(){
        if (!thumbs.length) return;
        var idx = currentIndex + 1;
        if (idx >= thumbs.length) idx = 0;
        setImageByIndex(idx);
      }
      if (prevBtn) prevBtn.addEventListener('click', prev);
      if (nextBtn) nextBtn.addEventListener('click', next);

      // Variant selection -> updates price/sku/availability + hidden variant id
      var variantIdInput = document.getElementById('QtmVariantId-{{ section.id }}');
      var priceEl = document.getElementById('QtmPrice-{{ section.id }}');
      var compareEl = document.getElementById('QtmCompare-{{ section.id }}');
      var skuWrap = document.getElementById('QtmSkuWrap-{{ section.id }}');
      var skuEl = document.getElementById('QtmSku-{{ section.id }}');
      var availText = document.getElementById('QtmAvailText-{{ section.id }}');
      var atcBtn = document.getElementById('QtmAtc-{{ section.id }}');

      var qtyInput = document.getElementById('QtmQty-{{ section.id }}');
      var qtyHidden = document.getElementById('QtmQtyHidden-{{ section.id }}');

      if (qtyInput && qtyHidden){
        qtyInput.addEventListener('input', function(){
          var v = parseInt(qtyInput.value, 10);
          if (!v || v < 1) v = 1;
          qtyHidden.value = String(v);
        });
      }

      function formatMoney(cents){
        try{
          return new Intl.NumberFormat(undefined, { style: 'currency', currency: moneyCurrency }).format((cents||0)/100);
        }catch(e){
          return '$' + ((cents||0)/100).toFixed(2);
        }
      }

      function getSelectedOptions(){
        var selections = [];
        var optionGroups = root.querySelectorAll('[data-qtm-option]');
        optionGroups.forEach(function(group){
          var radios = group.querySelectorAll('input[type="radio"]');
          if (radios.length){
            var checked = group.querySelector('input[type="radio"]:checked');
            selections.push(checked ? checked.value : '');
          } else {
            var select = group.querySelector('select');
            selections.push(select ? select.value : '');
          }
        });
        return selections;
      }

      function findVariantByOptions(opts){
        return variants.find(function(v){
          if (!v || !v.options) return false;
          for (var i=0; i<opts.length; i++){
            if (v.options[i] !== opts[i]) return false;
          }
          return true;
        }) || null;
      }

      function applyVariant(v){
        if (!v) return;

        if (variantIdInput) variantIdInput.value = v.id;

        if (priceEl) priceEl.textContent = formatMoney(v.price);

        if (compareEl){
          if (v.compare_at_price && v.compare_at_price > v.price){
            compareEl.style.display = '';
            compareEl.textContent = formatMoney(v.compare_at_price);
          } else {
            compareEl.style.display = 'none';
          }
        }

        if (skuWrap && skuEl){
          if (v.sku){
            skuWrap.style.display = '';
            skuEl.textContent = v.sku;
          } else {
            skuWrap.style.display = 'none';
          }
        }

        if (availText && atcBtn){
          if (v.available){
            availText.textContent = 'In stock';
            atcBtn.disabled = false;
            atcBtn.textContent = 'Add to cart';
          } else {
            availText.textContent = 'Sold out';
            atcBtn.disabled = true;
            atcBtn.textContent = 'Sold out';
          }
        }

        // Switch image to variant featured image if present
        if (v.featured_image && v.featured_image.src && mainImg){
          mainImg.src = v.featured_image.src;
          if (modalImg) modalImg.src = v.featured_image.src;

          thumbs.forEach(function(t, idx){
            var src = t.getAttribute('data-qtm-image');
            if (src && v.featured_image.src && src.indexOf(v.featured_image.src) !== -1){
              currentIndex = idx;
              setActiveThumb(idx);
            }
          });
        }

        // Update URL with variant param
        try{
          var url = new URL(window.location.href);
          url.searchParams.set('variant', v.id);
          window.history.replaceState({}, '', url.toString());
        }catch(e){}
      }

      // Disable impossible option values (Dawn-ish UX)
      function computeAllowedValues(partial, optionIndex){
        // partial: selected values array, may contain "" for unselected
        // optionIndex: which option we're computing allowed values for
        var allowed = new Set();

        variants.forEach(function(v){
          if (!v || !v.available) return; // only allow values that lead to AVAILABLE variants
          var ok = true;

          for (var i=0; i<partial.length; i++){
            if (i === optionIndex) continue;
            if (!partial[i]) continue;
            if (v.options[i] !== partial[i]) { ok = false; break; }
          }

          if (ok) allowed.add(v.options[optionIndex]);
        });

        return allowed;
      }

      function refreshOptionAvailability(){
        var selected = getSelectedOptions();

        var groups = root.querySelectorAll('[data-qtm-option]');
        groups.forEach(function(group, idx){
          var allowed = computeAllowedValues(selected, idx);

          // radios
          var radios = group.querySelectorAll('input[type="radio"]');
          if (radios.length){
            radios.forEach(function(r){
              var val = r.value;
              r.disabled = !allowed.has(val);
            });
            return;
          }

          // select options
          var select = group.querySelector('select');
          if (select){
            Array.prototype.forEach.call(select.options, function(opt){
              opt.disabled = !allowed.has(opt.value);
            });
          }
        });
      }

      // Listen to option changes
      root.addEventListener('change', function(e){
        if (!e.target) return;

        if (e.target.name && e.target.name.indexOf('qtm-option-') === 0){
          refreshOptionAvailability();

          var opts = getSelectedOptions();
          var v = findVariantByOptions(opts);
          applyVariant(v);
        }
      });

      // Initialize thumb active index
      thumbs.forEach(function(t, idx){
        if (t.getAttribute('aria-current') === 'true') currentIndex = idx;
      });

      // Initial availability pass
      refreshOptionAvailability();

    })();
  </script>

</section>

{% schema %}
{
  "name": "Main Product — Modern",
  "tag": "section",
  "class": "section",
  "settings": [
    {
      "type": "text",
      "id": "section_aria_label",
      "label": "Section ARIA label",
      "default": "Product details"
    },
    {
      "type": "color_scheme",
      "id": "color_scheme",
      "label": "Color scheme",
      "default": "scheme-1"
    },
    {
      "type": "select",
      "id": "media_position",
      "options": [
        { "value": "left", "label": "Media left" },
        { "value": "right", "label": "Media right" }
      ],
      "default": "left",
      "label": "Media position"
    },
    {
      "type": "select",
      "id": "image_zoom",
      "options": [
        { "value": "lightbox", "label": "Lightbox" },
        { "value": "none", "label": "None" }
      ],
      "default": "lightbox",
      "label": "Image zoom"
    },
    {
      "type": "select",
      "id": "picker_type",
      "label": "Variant picker type",
      "default": "button",
      "options": [
        { "value": "button", "label": "Buttons" },
        { "value": "dropdown", "label": "Dropdown" }
      ]
    },
    {
      "type": "checkbox",
      "id": "show_dynamic_checkout",
      "default": false,
      "label": "Show dynamic checkout button"
    },
    {
      "type": "header",
      "content": "Below Add to Cart"
    },
    {
      "type": "select",
      "id": "below_atc_content",
      "label": "Content below Add to cart",
      "default": "none",
      "options": [
        { "value": "none", "label": "None" },
        { "value": "short", "label": "Short description (metafield)" },
        { "value": "description", "label": "Product description" }
      ]
    },
    {
      "type": "text",
      "id": "short_desc_metafield_namespace",
      "label": "Short description metafield namespace",
      "default": "custom"
    },
    {
      "type": "text",
      "id": "short_desc_metafield_key",
      "label": "Short description metafield key",
      "default": "short_description"
    },
    {
      "type": "header",
      "content": "Accordion"
    },
    {
      "type": "checkbox",
      "id": "open_first_accordion",
      "label": "Open first accordion item by default",
      "default": true
    },
    {
      "type": "header",
      "content": "Spacing"
    },
    {
      "type": "range",
      "id": "padding_top",
      "min": 0,
      "max": 100,
      "step": 4,
      "unit": "px",
      "label": "Padding top",
      "default": 36
    },
    {
      "type": "range",
      "id": "padding_bottom",
      "min": 0,
      "max": 100,
      "step": 4,
      "unit": "px",
      "label": "Padding bottom",
      "default": 36
    }
  ],
  "blocks": [
    {
      "type": "description",
      "name": "Accordion — Description",
      "settings": [
        {
          "type": "text",
          "id": "heading",
          "label": "Heading",
          "default": "Product description"
        }
      ]
    },
    {
      "type": "@app",
    },
    {
      "type": "metafield",
      "name": "Accordion — Metafield",
      "settings": [
        {
          "type": "text",
          "id": "heading",
          "label": "Heading",
          "default": "Details"
        },
        {
          "type": "text",
          "id": "label",
          "label": "Optional label inside content",
        },
        {
          "type": "text",
          "id": "namespace",
          "label": "Metafield namespace",
          "default": "custom"
        },
        {
          "type": "text",
          "id": "key",
          "label": "Metafield key",
          "default": "details"
        }
      ]
    },
    {
      "type": "custom_liquid",
      "name": "Accordion — Custom liquid",
      "settings": [
        {
          "type": "text",
          "id": "heading",
          "label": "Heading",
          "default": "More info"
        },
        {
          "type": "liquid",
          "id": "custom_liquid",
          "label": "Custom liquid",
          "default": "<p>Add your custom content here.</p>"
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "Main Product — Modern",
      "blocks": [
        { "type": "description" },
      ]
    }
  ]
}
{% endschema %}
