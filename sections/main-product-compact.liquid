{%- comment -%}
  Quadratum â€” Main Product (Compact)
  File: sections/main-product-compact.liquid

  Engine shell (no drift):
  - Captures theme blocks via content_for:
    _product-media-gallery, _product-details
  - Renders shared engine snippet: product-information-content
  - Optional sticky add-to-cart bar

  IMPORTANT:
  - Do NOT declare _product-media-gallery / _product-details as section schema blocks.
    Those are theme-block types used by content_for and will fail schema validation.
{%- endcomment -%}

<script type="application/ld+json">
  {{ closest.product | structured_data }}
</script>

{%- capture media_gallery -%}
  {%- content_for 'block',
    type: '_product-media-gallery',
    id: 'media-gallery',
    closest.product: closest.product
  -%}
{%- endcapture -%}

{%- capture product_details -%}
  {%- content_for 'block',
    type: '_product-details',
    id: 'product-details',
    closest.product: closest.product
  -%}
{%- endcapture -%}

{%- capture additional_blocks -%}
  {%- content_for 'blocks' -%}
{%- endcapture -%}

{% if section.settings.enable_sticky_add_to_cart %}
  {% liquid
    assign current_variant = product.selected_or_first_available_variant
    assign initial_quantity = current_variant.quantity_rule.min | default: 1

    assign image_to_show = current_variant.featured_image | default: product.featured_image

    assign has_single_option = false
    if product.has_only_default_variant != true and product.options.size == 1
      assign has_single_option = true
    endif

    assign has_image = false
    if image_to_show != blank
      assign has_image = true
    endif
  %}

  <sticky-add-to-cart
    class="sticky-add-to-cart"
    data-variant-available="{{ current_variant.available }}"
    data-product-id="{{ product.id }}"
    data-current-variant-id="{{ current_variant.id }}"
    data-initial-quantity="{{ initial_quantity }}"
    data-default-variant-title="{{ 'products.product.default_title' | t }}"
  >
    <div
      class="sticky-add-to-cart__bar color-{{ settings.popover_color_scheme }}"
      data-stuck="false"
      ref="stickyBar"
      role="region"
      aria-label="{{ 'products.product.sticky_add_to_cart' | t }}"
    >
      {% if image_to_show %}
        <div class="sticky-add-to-cart__image">
          {% assign image_alt = image_to_show.alt | default: product.title | escape %}
          {{
            image_to_show
            | image_url: width: 120
            | image_tag:
              loading: 'lazy',
              alt: image_alt,
              class: 'sticky-add-to-cart__image-img',
              data-testid: 'sticky-product-image',
              srcset: null,
              sizes: null,
              ref: 'productImage'
          }}
        </div>
      {% endif %}

      <div
        class="sticky-add-to-cart__info"
        data-has-image="{{ has_image }}"
        data-singleton="{{ product.has_only_default_variant }}"
        data-single-option="{{ has_single_option }}"
      >
        <h3 class="sticky-add-to-cart__title" data-testid="sticky-product-title">
          {{ product.title | escape }}
        </h3>

        <div
          class="sticky-add-to-cart__variant"
          data-testid="sticky-variant-title"
          {% if product.has_only_default_variant %}
            style="display: none;"
          {% endif %}
        >
          {% unless product.has_only_default_variant %}
            {% if current_variant != blank %}
              {% assign variant_title = current_variant.title | escape %}
            {% endif %}
            {{ variant_title }}
          {% endunless %}
        </div>
      </div>

      <div class="sticky-add-to-cart__price" data-testid="sticky-price-display">
        {% render 'price', product_resource: product, show_sale_price_first: true %}
      </div>

      <button
        type="button"
        class="sticky-add-to-cart__button add-to-cart-button button"
        ref="addToCartButton"
        on:click="/handleAddToCartClick"
        {% unless current_variant.available %}
          disabled
        {% endunless %}
      >
        <span class="add-to-cart-text">
          {% if current_variant.available %}
            <span class="svg-wrapper add-to-cart-icon">
              {{- 'icon-add-to-cart.svg' | inline_asset_content -}}
            </span>
          {% endif %}

          <span class="add-to-cart-text__content">
            <span>
              {%- if current_variant.available -%}
                {{- 'products.product.add_to_cart' | t -}}
              {%- elsif current_variant == blank -%}
                {{- 'products.product.unavailable' | t -}}
              {%- else -%}
                {{- 'products.product.sold_out' | t -}}
              {%- endif -%}
            </span>

            <span
              ref="quantityDisplay"
              {% if current_variant.available and initial_quantity > 1 %}
                style="display: inline;"
              {% else %}
                style="display: none;"
              {% endif %}
            >
              {{- ' (' -}}
              <span ref="quantityNumber">{{- initial_quantity -}}</span>
              {{- ')' -}}
            </span>
          </span>
        </span>

        <span class="add-to-cart__added">
          <span class="svg-wrapper add-to-cart__added-icon">
            {{- 'icon-checkmark-burst.svg' | inline_asset_content -}}
          </span>
        </span>
      </button>
    </div>
  </sticky-add-to-cart>
{% endif %}

{%- render 'product-information-content',
  product_media_size: closest.product.media.size,
  section_id: section.id,
  settings: section.settings,
  media_gallery: media_gallery,
  product_details: product_details,
  additional_blocks: additional_blocks
-%}

{% schema %}
{
  "name": "Main Product - Compact",
  "blocks": [
    { "type": "@app" }
  ],
  "disabled_on": {
    "groups": ["header", "footer"]
  },
  "settings": [
    {
      "type": "header",
      "content": "Layout"
    },
    {
      "type": "select",
      "id": "content_width",
      "label": "Content width",
      "options": [
        { "value": "content-center-aligned", "label": "Centered" },
        { "value": "content-full-width", "label": "Full width" }
      ],
      "default": "content-center-aligned"
    },
    {
      "type": "select",
      "id": "desktop_media_position",
      "label": "Desktop media position",
      "options": [
        { "value": "left", "label": "Left" },
        { "value": "right", "label": "Right" }
      ],
      "default": "left"
    },
    {
      "type": "checkbox",
      "id": "equal_columns",
      "label": "Equal width columns",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "limit_details_width",
      "label": "Limit details width",
      "default": true,
      "visible_if": "{{ section.settings.equal_columns }}"
    },
    {
      "type": "range",
      "id": "gap",
      "label": "Column gap",
      "min": 0,
      "max": 48,
      "step": 4,
      "unit": "px",
      "default": 12
    },
    {
      "type": "checkbox",
      "id": "enable_sticky_add_to_cart",
      "label": "Enable sticky add to cart",
      "default": true
    },
    {
      "type": "color_scheme",
      "id": "color_scheme",
      "label": "Color scheme",
      "default": "scheme-1"
    },
    {
      "type": "header",
      "content": "Spacing"
    },
    {
      "type": "range",
      "id": "padding-block-start",
      "label": "Padding top",
      "min": 0,
      "max": 100,
      "step": 1,
      "unit": "px",
      "default": 0
    },
    {
      "type": "range",
      "id": "padding-block-end",
      "label": "Padding bottom",
      "min": 0,
      "max": 100,
      "step": 1,
      "unit": "px",
      "default": 0
    }
  ],
  "presets": [
    {
      "name": "Main Product - Compact",
      "category": "Products"
    }
  ]
}
{% endschema %}
