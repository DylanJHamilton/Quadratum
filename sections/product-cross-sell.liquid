{%- comment -%}
  SECTION: product-cross-sell.liquid
  Role: Related / complementary products near bottom of PDP.

  Modes:
  - manual (blocks)
  - collection
  - dynamic (Shopify recommendations JSON) with fallback

  Rendering: MUST use product-card snippet. No inline card markup.
  Styling: Section-only, applied via wrapper (.q-pcs__item) so it works regardless of card classes.

  UPDATE (THIS PATCH):
  - Carousel now supports: Arrows / Dots / Both / None
  - Full styling controls for arrows + dots (size, colors, border, radius, etc.)
  - JS carousel works for manual/collection AND dynamic-loaded cards (re-init after fetch)

  NOTE:
  - Shopify range inputs max out at 101 steps. Radius sliders are capped accordingly.
{%- endcomment -%}

{%- liquid
  assign s = section.settings
  assign p = product
  if p == blank
    break
  endif

  assign mode = s.mode | default: 'dynamic'
  assign layout = s.layout | default: 'grid'
  assign max_products = s.max_products | default: 4

  assign cols_desktop = s.columns_desktop | default: 4
  assign cols_tablet  = s.columns_tablet  | default: 2
  assign cols_mobile  = s.columns_mobile | default: '1' | plus: 0

  assign current_id = p.id
  assign c = s.collection

  assign controls_mode = s.carousel_controls | default: 'arrows'
  assign show_arrows = false
  assign show_dots = false
  if controls_mode == 'arrows'
    assign show_arrows = true
  elsif controls_mode == 'dots'
    assign show_dots = true
  elsif controls_mode == 'both'
    assign show_arrows = true
    assign show_dots = true
  endif

  # determine if manual has any valid products
  assign has_manual = false
  for block in section.blocks
    if block.type == 'product_reference'
      assign bp = block.settings.product
      if bp != blank and bp.id != current_id and bp.available
        assign has_manual = true
        break
      endif
    endif
  endfor

  # determine if collection has any valid products
  assign has_collection = false
  if c != blank
    for cp in c.products
      if cp != blank and cp.id != current_id and cp.available
        assign has_collection = true
        break
      endif
    endfor
  endif

  assign should_render = false
  if mode == 'dynamic'
    assign should_render = true
  elsif mode == 'collection' and has_collection
    assign should_render = true
  elsif mode == 'manual' and has_manual
    assign should_render = true
  endif

  if should_render == false
    break
  endif

  assign grid_style = ''
  if layout == 'grid'
    assign grid_style = ' --q-cols-desktop:' | append: cols_desktop | append: '; --q-cols-tablet:' | append: cols_tablet | append: '; --q-cols-mobile:' | append: cols_mobile | append: ';'
  endif
-%}

<section
  id="product-cross-sell"
  class="q-product-cross-sell"
  data-mode="{{ mode }}"
  data-layout="{{ layout }}"
  data-carousel-controls="{{ controls_mode }}"
>
  <div class="q-product-cross-sell__inner">

    {%- if s.title != blank -%}
      <h2 class="q-product-cross-sell__title">{{ s.title }}</h2>
    {%- endif -%}

    {%- if s.subheading != blank -%}
      <div class="q-product-cross-sell__subheading rte">
        {{ s.subheading }}
      </div>
    {%- endif -%}

    {%- if layout == 'carousel' -%}
      <div class="q-pcs__carousel" data-q-carousel>
        {%- if show_arrows -%}
          <button type="button" class="q-pcs__arrow q-pcs__arrow--prev" data-q-carousel-prev aria-label="Previous products">
            <span aria-hidden="true">{{ s.carousel_arrow_prev | default: '‹' }}</span>
          </button>
        {%- endif -%}

        <div
          class="q-product-cross-sell__products q-product-cross-sell__products--carousel"
          style="{{ grid_style }}"
          data-products-container
          data-current-id="{{ current_id }}"
          data-max="{{ max_products }}"
        >
          {%- if mode != 'dynamic' -%}
            {%- liquid
              assign rendered = 0
              assign seen_ids = ''
            -%}

            {%- if mode == 'collection' and c != blank -%}
              {%- for cp in c.products -%}
                {%- if cp != blank and cp.id != current_id and cp.available -%}
                  {%- assign id_token = '|' | append: cp.id | append: '|' -%}
                  {%- unless seen_ids contains id_token -%}
                    {%- assign seen_ids = seen_ids | append: id_token -%}
                    <div class="q-pcs__item">
                      {% render 'product-card',
                        product: cp,
                        enable_quick_add: true,
                        enable_quick_view: false,
                        show_action_row: true,
                        button_full_width: true,
                        primary_cta_label: s.button_label_text
                      %}
                    </div>
                    {%- assign rendered = rendered | plus: 1 -%}
                    {%- if rendered >= max_products -%}{%- break -%}{%- endif -%}
                  {%- endunless -%}
                {%- endif -%}
              {%- endfor -%}
            {%- elsif mode == 'manual' -%}
              {%- for block in section.blocks -%}
                {%- if block.type == 'product_reference' -%}
                  {%- assign bp = block.settings.product -%}
                  {%- if bp != blank and bp.id != current_id and bp.available -%}
                    {%- assign id_token = '|' | append: bp.id | append: '|' -%}
                    {%- unless seen_ids contains id_token -%}
                      {%- assign seen_ids = seen_ids | append: id_token -%}
                      <div class="q-pcs__item">
                        {% render 'product-card',
                          product: bp,
                          enable_quick_add: true,
                          enable_quick_view: false,
                          show_action_row: true,
                          button_full_width: true,
                          primary_cta_label: s.button_label_text
                        %}
                      </div>
                      {%- assign rendered = rendered | plus: 1 -%}
                      {%- if rendered >= max_products -%}{%- break -%}{%- endif -%}
                    {%- endunless -%}
                  {%- endif -%}
                {%- endif -%}
              {%- endfor -%}
            {%- endif -%}

            {%- if rendered == 0 -%}
              {%- break -%}
            {%- endif -%}
          {%- endif -%}
        </div>

        {%- if show_arrows -%}
          <button type="button" class="q-pcs__arrow q-pcs__arrow--next" data-q-carousel-next aria-label="Next products">
            <span aria-hidden="true">{{ s.carousel_arrow_next | default: '›' }}</span>
          </button>
        {%- endif -%}
      </div>

      {%- if show_dots -%}
        <div class="q-pcs__dots" data-q-carousel-dots aria-label="Carousel pagination"></div>
      {%- endif -%}

    {%- else -%}
      <div
        class="q-product-cross-sell__products q-product-cross-sell__products--grid"
        style="{{ grid_style }}"
        data-products-container
        data-current-id="{{ current_id }}"
        data-max="{{ max_products }}"
      >
        {%- if mode != 'dynamic' -%}
          {%- liquid
            assign rendered = 0
            assign seen_ids = ''
          -%}

          {%- if mode == 'collection' and c != blank -%}
            {%- for cp in c.products -%}
              {%- if cp != blank and cp.id != current_id and cp.available -%}
                {%- assign id_token = '|' | append: cp.id | append: '|' -%}
                {%- unless seen_ids contains id_token -%}
                  {%- assign seen_ids = seen_ids | append: id_token -%}
                  <div class="q-pcs__item">
                    {% render 'product-card',
                      product: cp,
                      enable_quick_add: true,
                      enable_quick_view: false,
                      show_action_row: true,
                      button_full_width: true,
                      primary_cta_label: s.button_label_text
                    %}
                  </div>
                  {%- assign rendered = rendered | plus: 1 -%}
                  {%- if rendered >= max_products -%}{%- break -%}{%- endif -%}
                {%- endunless -%}
              {%- endif -%}
            {%- endfor -%}
          {%- elsif mode == 'manual' -%}
            {%- for block in section.blocks -%}
              {%- if block.type == 'product_reference' -%}
                {%- assign bp = block.settings.product -%}
                {%- if bp != blank and bp.id != current_id and bp.available -%}
                  {%- assign id_token = '|' | append: bp.id | append: '|' -%}
                  {%- unless seen_ids contains id_token -%}
                    {%- assign seen_ids = seen_ids | append: id_token -%}
                    <div class="q-pcs__item">
                      {% render 'product-card',
                        product: bp,
                        enable_quick_add: true,
                        enable_quick_view: false,
                        show_action_row: true,
                        button_full_width: true,
                        primary_cta_label: s.button_label_text
                      %}
                    </div>
                    {%- assign rendered = rendered | plus: 1 -%}
                    {%- if rendered >= max_products -%}{%- break -%}{%- endif -%}
                  {%- endunless -%}
                {%- endif -%}
              {%- endif -%}
            {%- endfor -%}
          {%- endif -%}

          {%- if rendered == 0 -%}
            {%- break -%}
          {%- endif -%}
        {%- endif -%}
      </div>
    {%- endif -%}

    {%- if mode == 'dynamic' -%}
      <div hidden>
        <div data-fallback-collection>
          {%- if c != blank -%}
            {%- liquid
              assign rendered_c = 0
              assign seen_c = ''
            -%}
            {%- for cp in c.products -%}
              {%- if cp != blank and cp.id != current_id and cp.available -%}
                {%- assign id_token = '|' | append: cp.id | append: '|' -%}
                {%- unless seen_c contains id_token -%}
                  {%- assign seen_c = seen_c | append: id_token -%}
                  <div class="q-pcs__item">
                    {% render 'product-card',
                      product: cp,
                      enable_quick_add: true,
                      enable_quick_view: false,
                      show_action_row: true,
                      button_full_width: true,
                      primary_cta_label: s.button_label_text
                    %}
                  </div>
                  {%- assign rendered_c = rendered_c | plus: 1 -%}
                  {%- if rendered_c >= max_products -%}{%- break -%}{%- endif -%}
                {%- endunless -%}
              {%- endif -%}
            {%- endfor -%}
          {%- endif -%}
        </div>

        <div data-fallback-manual>
          {%- liquid
            assign rendered_m = 0
            assign seen_m = ''
          -%}
          {%- for block in section.blocks -%}
            {%- if block.type == 'product_reference' -%}
              {%- assign bp = block.settings.product -%}
              {%- if bp != blank and bp.id != current_id and bp.available -%}
                {%- assign id_token = '|' | append: bp.id | append: '|' -%}
                {%- unless seen_m contains id_token -%}
                  {%- assign seen_m = seen_m | append: id_token -%}
                  <div class="q-pcs__item">
                    {% render 'product-card',
                      product: bp,
                      enable_quick_add: true,
                      enable_quick_view: false,
                      show_action_row: true,
                      button_full_width: true,
                      primary_cta_label: s.button_label_text
                    %}
                  </div>
                  {%- assign rendered_m = rendered_m | plus: 1 -%}
                  {%- if rendered_m >= max_products -%}{%- break -%}{%- endif -%}
                {%- endunless -%}
              {%- endif -%}
            {%- endif -%}
          {%- endfor -%}
        </div>
      </div>
    {%- endif -%}

  </div>

  <style>
    #product-cross-sell {
      --q-feed-gap: {{ s.grid_gap | default: 16 }}px;
      --q-carousel-min: {{ s.carousel_item_min | default: 240 }}px;

      --q-card-bg: {{ s.card_bg | default: 'transparent' }};
      --q-card-border-color: {{ s.card_border_color | default: 'rgba(0,0,0,0.12)' }};
      --q-card-border-width: {{ s.card_border_width | default: 1 }}px;
      --q-card-radius: {{ s.card_radius | default: 12 }}px;
      --q-card-padding: {{ s.card_padding | default: 0 }}px;
      --q-card-align: {{ s.card_text_align | default: 'left' }};

      --q-image-radius: {{ s.image_radius | default: 12 }}px;
      --q-image-aspect: {{ s.image_aspect | default: '1 / 1' }};

      --q-title-color: {{ s.title_color | default: 'inherit' }};
      --q-title-size: {{ s.title_size | default: 16 }}px;
      --q-title-weight: {{ s.title_weight | default: 600 }};

      --q-price-color: {{ s.price_color | default: 'inherit' }};
      --q-price-size: {{ s.price_size | default: 14 }}px;
      --q-price-weight: {{ s.price_weight | default: 600 }};

      --q-btn-radius: {{ s.button_radius | default: 12 }}px;
      --q-btn-pad-y: {{ s.button_padding_y | default: 12 }}px;
      --q-btn-pad-x: {{ s.button_padding_x | default: 16 }}px;
      --q-btn-bg: {{ s.button_bg | default: 'transparent' }};
      --q-btn-text: {{ s.button_text | default: 'inherit' }};
      --q-btn-border: {{ s.button_border_color | default: 'transparent' }};

      /* Carousel control tokens */
      --q-car-arrow-size: {{ s.carousel_arrow_size | default: 44 }}px;
      --q-car-arrow-radius: {{ s.carousel_arrow_radius | default: 60 }}px;
      --q-car-arrow-bg: {{ s.carousel_arrow_bg | default: 'rgba(0,0,0,0.06)' }};
      --q-car-arrow-color: {{ s.carousel_arrow_color | default: '#111111' }};
      --q-car-arrow-border: {{ s.carousel_arrow_border_color | default: 'rgba(0,0,0,0.12)' }};
      --q-car-arrow-border-w: {{ s.carousel_arrow_border_width | default: 1 }}px;
      --q-car-arrow-shadow: {{ s.carousel_arrow_shadow | default: 'none' }};
      --q-car-arrow-offset: {{ s.carousel_arrow_offset | default: 10 }}px;

      --q-car-dot-size: {{ s.carousel_dot_size | default: 8 }}px;
      --q-car-dot-radius: {{ s.carousel_dot_radius | default: 20 }}px;
      --q-car-dot-bg: {{ s.carousel_dot_bg | default: 'rgba(0,0,0,0.22)' }};
      --q-car-dot-active-bg: {{ s.carousel_dot_active_bg | default: '#111111' }};
      --q-car-dot-border: {{ s.carousel_dot_border_color | default: 'transparent' }};
      --q-car-dot-border-w: {{ s.carousel_dot_border_width | default: 0 }}px;
      --q-car-dot-gap: {{ s.carousel_dot_gap | default: 10 }}px;
      --q-car-dot-mt: {{ s.carousel_dot_margin_top | default: 14 }}px;
    }

    .q-product-cross-sell__inner {
      max-width: var(--page-width, 1200px);
      margin: 0 auto;
      padding: 2rem 1rem;
    }

    .q-product-cross-sell__products--grid {
      display: grid;
      gap: var(--q-feed-gap);
      grid-template-columns: repeat(var(--q-cols-desktop, 4), 1fr);
    }
    @media (max-width: 989px) {
      .q-product-cross-sell__products--grid { grid-template-columns: repeat(var(--q-cols-tablet, 2), 1fr); }
    }
    @media (max-width: 749px) {
      .q-product-cross-sell__products--grid { grid-template-columns: repeat(var(--q-cols-mobile, 1), 1fr); }
    }

    .q-pcs__carousel{
      position: relative;
      display: grid;
      align-items: center;
    }

    .q-product-cross-sell__products--carousel {
      display: grid;
      grid-auto-flow: column;
      grid-auto-columns: minmax(var(--q-carousel-min), 1fr);
      gap: var(--q-feed-gap);
      overflow-x: auto;
      scroll-snap-type: x mandatory;
      -webkit-overflow-scrolling: touch;
      padding: 0 0.25rem 0.25rem 0.25rem;
      scroll-behavior: smooth;
    }
    .q-product-cross-sell__products--carousel > * { scroll-snap-align: start; }
    .q-product-cross-sell__products--carousel::-webkit-scrollbar { height: 0; width: 0; }
    .q-product-cross-sell__products--carousel { scrollbar-width: none; }

    #product-cross-sell .q-pcs__item { text-align: var(--q-card-align); }
    #product-cross-sell .q-pcs__item > *:first-child {
      background: var(--q-card-bg);
      border: var(--q-card-border-width) solid var(--q-card-border-color);
      border-radius: var(--q-card-radius);
      padding: var(--q-card-padding);
      overflow: hidden;
    }
    {%- if s.card_shadow == 'soft' -%}
      #product-cross-sell .q-pcs__item > *:first-child { box-shadow: 0 6px 18px rgba(0,0,0,0.08); }
    {%- elsif s.card_shadow == 'medium' -%}
      #product-cross-sell .q-pcs__item > *:first-child { box-shadow: 0 10px 30px rgba(0,0,0,0.14); }
    {%- else -%}
      #product-cross-sell .q-pcs__item > *:first-child { box-shadow: none; }
    {%- endif -%}

    #product-cross-sell .q-pcs__item img {
      border-radius: var(--q-image-radius);
      display: block;
      max-width: 100%;
      height: auto;
    }
    #product-cross-sell .q-pcs__item :where(.media, .card__media, .product-card__media, .q-card__media) {
      border-radius: var(--q-image-radius);
      overflow: hidden;
      aspect-ratio: var(--q-image-aspect);
    }

    #product-cross-sell .q-pcs__item :where(h1,h2,h3,h4,h5,h6) {
      color: var(--q-title-color);
      font-size: var(--q-title-size);
      font-weight: var(--q-title-weight);
      margin: 0.5rem 0 0.25rem;
    }
    #product-cross-sell .q-pcs__item :where(.card__heading, .product-card__title, .q-card__title) {
      color: var(--q-title-color);
      font-size: var(--q-title-size);
      font-weight: var(--q-title-weight);
    }
    #product-cross-sell .q-pcs__item :where(.card__heading a, .product-card__title a, .q-card__title a) {
      color: var(--q-title-color);
      text-decoration: none;
    }

    #product-cross-sell .q-pcs__item :where(.price, .product-card__price, .q-card__price, [data-price]) {
      color: var(--q-price-color);
      font-size: var(--q-price-size);
      font-weight: var(--q-price-weight);
    }

    #product-cross-sell .q-pcs__item :where(button, .button, a.button, input[type="submit"], [type="submit"]) {
      border-radius: var(--q-btn-radius);
      padding: var(--q-btn-pad-y) var(--q-btn-pad-x);
    }
    {%- if s.enable_button_skin -%}
      #product-cross-sell .q-pcs__item :where(button, .button, a.button, input[type="submit"], [type="submit"]) {
        background: var(--q-btn-bg);
        color: var(--q-btn-text);
        border: 1px solid var(--q-btn-border);
      }
    {%- endif -%}

    {%- if s.override_button_label and s.button_label_text != blank -%}
      #product-cross-sell .q-pcs__item :where(button, input[type="submit"], [type="submit"], .button) { position: relative; }
      #product-cross-sell .q-pcs__item :where(button, .button) span { visibility: hidden; }
      #product-cross-sell .q-pcs__item :where(button, input[type="submit"], [type="submit"], .button)::after {
        content: "{{ s.button_label_text | escape }}";
        position: absolute;
        inset: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        pointer-events: none;
      }
    {%- endif -%}

    .q-pcs__arrow{
      position:absolute;
      top: 50%;
      transform: translateY(-50%);
      width: var(--q-car-arrow-size);
      height: var(--q-car-arrow-size);
      display:flex;
      align-items:center;
      justify-content:center;
      border-radius: var(--q-car-arrow-radius);
      background: var(--q-car-arrow-bg);
      color: var(--q-car-arrow-color);
      border: var(--q-car-arrow-border-w) solid var(--q-car-arrow-border);
      box-shadow: var(--q-car-arrow-shadow);
      cursor:pointer;
      z-index: 5;
      padding: 0;
      line-height: 1;
      font: inherit;
    }
    .q-pcs__arrow span{ font-size: calc(var(--q-car-arrow-size) * 0.55); }
    .q-pcs__arrow--prev{ left: var(--q-car-arrow-offset); }
    .q-pcs__arrow--next{ right: var(--q-car-arrow-offset); }
    .q-pcs__arrow[disabled]{ opacity: .35; cursor: not-allowed; }

    .q-pcs__dots{
      display:flex;
      gap: var(--q-car-dot-gap);
      justify-content:center;
      align-items:center;
      margin-top: var(--q-car-dot-mt);
      user-select:none;
    }
    .q-pcs__dot{
      width: var(--q-car-dot-size);
      height: var(--q-car-dot-size);
      border-radius: var(--q-car-dot-radius);
      background: var(--q-car-dot-bg);
      border: var(--q-car-dot-border-w) solid var(--q-car-dot-border);
      padding: 0;
      cursor: pointer;
    }
    .q-pcs__dot[aria-current="true"]{ background: var(--q-car-dot-active-bg); }
  </style>

  <script>
    (function() {
      var section = document.getElementById('product-cross-sell');
      if (!section) return;

      function initCarousel() {
        if (section.getAttribute('data-layout') !== 'carousel') return;

        var container = section.querySelector('[data-products-container]');
        if (!container) return;

        var prevBtn = section.querySelector('[data-q-carousel-prev]');
        var nextBtn = section.querySelector('[data-q-carousel-next]');
        var dotsWrap = section.querySelector('[data-q-carousel-dots]');

        var items = container.querySelectorAll('.q-pcs__item');
        if (!items.length) {
          if (prevBtn) prevBtn.disabled = true;
          if (nextBtn) nextBtn.disabled = true;
          if (dotsWrap) dotsWrap.innerHTML = '';
          return;
        }

        function getStep() { return Math.max(1, container.clientWidth); }
        function clamp(n, min, max){ return Math.max(min, Math.min(max, n)); }

        function pagesCount() {
          var total = container.scrollWidth;
          var view = container.clientWidth;
          if (!view) return 1;
          return Math.max(1, Math.ceil(total / view));
        }

        function currentPage() {
          var view = container.clientWidth || 1;
          return clamp(Math.round(container.scrollLeft / view), 0, pagesCount() - 1);
        }

        function scrollToPage(idx) {
          var view = container.clientWidth || 1;
          container.scrollTo({ left: idx * view, behavior: 'smooth' });
        }

        function rebuildDots() {
          if (!dotsWrap) return;
          dotsWrap.innerHTML = '';

          var controls = section.getAttribute('data-carousel-controls') || 'arrows';
          if (controls !== 'dots' && controls !== 'both') return;

          var count = pagesCount();
          for (var i = 0; i < count; i++) {
            var b = document.createElement('button');
            b.type = 'button';
            b.className = 'q-pcs__dot';
            b.setAttribute('aria-label', 'Go to slide ' + (i + 1));
            b.addEventListener('click', (function(n){ return function(){ scrollToPage(n); }; })(i));
            dotsWrap.appendChild(b);
          }
          updateDots();
        }

        function updateDots() {
          if (!dotsWrap) return;
          var dots = dotsWrap.querySelectorAll('.q-pcs__dot');
          if (!dots.length) return;
          var cp = currentPage();
          for (var i = 0; i < dots.length; i++) {
            dots[i].setAttribute('aria-current', i === cp ? 'true' : 'false');
          }
        }

        function updateArrows() {
          var maxScroll = container.scrollWidth - container.clientWidth;
          var atStart = container.scrollLeft <= 1;
          var atEnd = container.scrollLeft >= (maxScroll - 1);
          if (prevBtn) prevBtn.disabled = atStart;
          if (nextBtn) nextBtn.disabled = atEnd;
        }

        if (prevBtn && !prevBtn._qBound) {
          prevBtn._qBound = true;
          prevBtn.addEventListener('click', function() {
            container.scrollBy({ left: -getStep(), behavior: 'smooth' });
          });
        }
        if (nextBtn && !nextBtn._qBound) {
          nextBtn._qBound = true;
          nextBtn.addEventListener('click', function() {
            container.scrollBy({ left: getStep(), behavior: 'smooth' });
          });
        }

        if (!container._qBound) {
          container._qBound = true;
          container.addEventListener('scroll', function() {
            updateArrows();
            updateDots();
          }, { passive: true });

          window.addEventListener('resize', function() {
            rebuildDots();
            updateArrows();
            updateDots();
          });
        }

        rebuildDots();
        updateArrows();
        updateDots();
      }

      function initDynamic() {
        if (section.getAttribute('data-mode') !== 'dynamic') {
          initCarousel();
          return;
        }

        var container = section.querySelector('[data-products-container]');
        if (!container) return;

        var currentId = container.getAttribute('data-current-id');
        var max = parseInt(container.getAttribute('data-max') || '4', 10);

        var fbCollection = section.querySelector('[data-fallback-collection]');
        var fbManual = section.querySelector('[data-fallback-manual]');

        function hideSection() { section.style.display = 'none'; }

        function swapFallback() {
          if (fbCollection && fbCollection.innerHTML.trim().length) {
            container.innerHTML = fbCollection.innerHTML;
            initCarousel();
            return;
          }
          if (fbManual && fbManual.innerHTML.trim().length) {
            container.innerHTML = fbManual.innerHTML;
            initCarousel();
            return;
          }
          hideSection();
        }

        function fetchRecommendations() {
          var url = '/recommendations/products.json?product_id=' + encodeURIComponent(currentId) + '&limit=' + encodeURIComponent(max);
          return fetch(url, { credentials: 'same-origin' })
            .then(function(r){ if(!r.ok) throw new Error('recommendations failed'); return r.json(); });
        }

        function fetchCard(handle) {
          return fetch('/products/' + handle + '?view=product-card', { credentials: 'same-origin' })
            .then(function(r){ if(!r.ok) throw new Error('card fetch failed'); return r.text(); });
        }

        fetchRecommendations().then(function(data) {
          var products = (data && data.products) ? data.products : [];
          if (!products.length) { swapFallback(); return; }

          var handles = [];
          var seen = {};
          for (var i = 0; i < products.length; i++) {
            var pr = products[i];
            if (!pr || !pr.handle) continue;
            if (String(pr.id) === String(currentId)) continue;
            if (seen[pr.handle]) continue;
            seen[pr.handle] = true;
            handles.push(pr.handle);
            if (handles.length >= max) break;
          }

          if (!handles.length) { swapFallback(); return; }

          Promise.all(handles.map(fetchCard)).then(function(htmlParts) {
            var combined = htmlParts.join('');
            if (!combined.trim()) { swapFallback(); return; }

            var tmp = document.createElement('div');
            tmp.innerHTML = combined;

            var out = document.createElement('div');
            while (tmp.firstChild) {
              var wrap = document.createElement('div');
              wrap.className = 'q-pcs__item';
              wrap.appendChild(tmp.firstChild);
              out.appendChild(wrap);
            }

            container.innerHTML = out.innerHTML;
            initCarousel();
          }).catch(function(){ swapFallback(); });
        }).catch(function(){ swapFallback(); });
      }

      initDynamic();
    })();
  </script>
</section>

{% schema %}
{
  "name": "Product Cross Sell",
  "settings": [
    { "type": "text", "id": "title", "default": "You may also like", "label": "Title" },
    { "type": "richtext", "id": "subheading", "label": "Subheading" },

    {
      "type": "select",
      "id": "mode",
      "label": "Mode",
      "default": "dynamic",
      "options": [
        { "value": "manual", "label": "Manual" },
        { "value": "collection", "label": "Collection" },
        { "value": "dynamic", "label": "Dynamic" }
      ]
    },

    { "type": "collection", "id": "collection", "label": "Collection", "info": "Used for Collection mode and as fallback for Dynamic mode" },

    { "type": "range", "id": "max_products", "label": "Max products", "min": 2, "max": 12, "step": 1, "default": 4 },

    {
      "type": "select",
      "id": "layout",
      "label": "Layout",
      "default": "grid",
      "options": [
        { "value": "grid", "label": "Grid" },
        { "value": "carousel", "label": "Carousel" }
      ]
    },

    { "type": "range", "id": "columns_desktop", "label": "Columns (desktop)", "min": 2, "max": 6, "step": 1, "default": 4 },
    { "type": "range", "id": "columns_tablet", "label": "Columns (tablet)", "min": 1, "max": 4, "step": 1, "default": 2 },

    {
      "type": "select",
      "id": "columns_mobile",
      "label": "Columns (mobile)",
      "default": "1",
      "options": [
        { "value": "1", "label": "1" },
        { "value": "2", "label": "2" }
      ]
    },

    { "type": "header", "content": "Feed spacing" },
    { "type": "range", "id": "grid_gap", "label": "Gap between items (px)", "min": 8, "max": 40, "step": 1, "default": 16 },
    { "type": "range", "id": "carousel_item_min", "label": "Carousel item min width (px)", "min": 180, "max": 420, "step": 10, "default": 240 },

    { "type": "header", "content": "Carousel controls" },
    {
      "type": "select",
      "id": "carousel_controls",
      "label": "Controls",
      "default": "arrows",
      "options": [
        { "value": "none", "label": "None" },
        { "value": "arrows", "label": "Arrows" },
        { "value": "dots", "label": "Dots" },
        { "value": "both", "label": "Arrows + Dots" }
      ]
    },

    { "type": "text", "id": "carousel_arrow_prev", "label": "Prev arrow text", "default": "‹" },
    { "type": "text", "id": "carousel_arrow_next", "label": "Next arrow text", "default": "›" },

    { "type": "range", "id": "carousel_arrow_size", "label": "Arrow size (px)", "min": 28, "max": 72, "step": 2, "default": 44 },
    { "type": "range", "id": "carousel_arrow_radius", "label": "Arrow radius (px)", "min": 0, "max": 60, "step": 1, "default": 60 },
    { "type": "color", "id": "carousel_arrow_bg", "label": "Arrow background" },
    { "type": "color", "id": "carousel_arrow_color", "label": "Arrow color" },
    { "type": "color", "id": "carousel_arrow_border_color", "label": "Arrow border color" },
    { "type": "range", "id": "carousel_arrow_border_width", "label": "Arrow border width (px)", "min": 0, "max": 6, "step": 1, "default": 1 },
    { "type": "text", "id": "carousel_arrow_shadow", "label": "Arrow shadow (CSS)", "default": "none" },
    { "type": "range", "id": "carousel_arrow_offset", "label": "Arrow side offset (px)", "min": 0, "max": 32, "step": 1, "default": 10 },

    { "type": "range", "id": "carousel_dot_size", "label": "Dot size (px)", "min": 4, "max": 18, "step": 1, "default": 8 },
    { "type": "range", "id": "carousel_dot_radius", "label": "Dot radius (px)", "min": 0, "max": 20, "step": 1, "default": 20 },
    { "type": "color", "id": "carousel_dot_bg", "label": "Dot color" },
    { "type": "color", "id": "carousel_dot_active_bg", "label": "Active dot color" },
    { "type": "color", "id": "carousel_dot_border_color", "label": "Dot border color" },
    { "type": "range", "id": "carousel_dot_border_width", "label": "Dot border width (px)", "min": 0, "max": 6, "step": 1, "default": 0 },
    { "type": "range", "id": "carousel_dot_gap", "label": "Dot gap (px)", "min": 4, "max": 28, "step": 1, "default": 10 },
    { "type": "range", "id": "carousel_dot_margin_top", "label": "Dots margin top (px)", "min": 0, "max": 40, "step": 1, "default": 14 },

    { "type": "header", "content": "Card styling" },
    { "type": "color", "id": "card_bg", "label": "Card background" },
    { "type": "color", "id": "card_border_color", "label": "Card border color" },
    { "type": "range", "id": "card_border_width", "label": "Card border width (px)", "min": 0, "max": 6, "step": 1, "default": 1 },
    { "type": "range", "id": "card_radius", "label": "Card radius (px)", "min": 0, "max": 28, "step": 1, "default": 12 },
    { "type": "range", "id": "card_padding", "label": "Card padding (px)", "min": 0, "max": 28, "step": 1, "default": 0 },
    {
      "type": "select",
      "id": "card_shadow",
      "label": "Card shadow",
      "default": "none",
      "options": [
        { "value": "none", "label": "None" },
        { "value": "soft", "label": "Soft" },
        { "value": "medium", "label": "Medium" }
      ]
    },
    {
      "type": "select",
      "id": "card_text_align",
      "label": "Text alignment",
      "default": "left",
      "options": [
        { "value": "left", "label": "Left" },
        { "value": "center", "label": "Center" }
      ]
    },

    { "type": "header", "content": "Image styling" },
    {
      "type": "select",
      "id": "image_aspect",
      "label": "Image aspect ratio",
      "default": "1 / 1",
      "options": [
        { "value": "1 / 1", "label": "Square (1:1)" },
        { "value": "4 / 5", "label": "Portrait (4:5)" },
        { "value": "3 / 4", "label": "Portrait (3:4)" },
        { "value": "4 / 3", "label": "Landscape (4:3)" },
        { "value": "16 / 9", "label": "Wide (16:9)" }
      ]
    },
    { "type": "range", "id": "image_radius", "label": "Image radius (px)", "min": 0, "max": 28, "step": 1, "default": 12 },

    { "type": "header", "content": "Typography" },
    { "type": "color", "id": "title_color", "label": "Title color" },
    { "type": "range", "id": "title_size", "label": "Title size (px)", "min": 12, "max": 26, "step": 1, "default": 16 },
    { "type": "range", "id": "title_weight", "label": "Title weight", "min": 400, "max": 800, "step": 100, "default": 600 },

    { "type": "color", "id": "price_color", "label": "Price color" },
    { "type": "range", "id": "price_size", "label": "Price size (px)", "min": 12, "max": 24, "step": 1, "default": 14 },
    { "type": "range", "id": "price_weight", "label": "Price weight", "min": 400, "max": 800, "step": 100, "default": 600 },

    { "type": "header", "content": "Button styling (CSS only)" },
    { "type": "checkbox", "id": "enable_button_skin", "label": "Apply custom button colors", "default": false },
    { "type": "color", "id": "button_bg", "label": "Button background" },
    { "type": "color", "id": "button_text", "label": "Button text color" },
    { "type": "color", "id": "button_border_color", "label": "Button border color" },
    { "type": "range", "id": "button_radius", "label": "Button radius (px)", "min": 0, "max": 28, "step": 1, "default": 12 },
    { "type": "range", "id": "button_padding_y", "label": "Button padding Y (px)", "min": 6, "max": 22, "step": 1, "default": 12 },
    { "type": "range", "id": "button_padding_x", "label": "Button padding X (px)", "min": 10, "max": 30, "step": 1, "default": 16 },

    { "type": "text", "id": "button_label_text", "label": "Primary CTA label (passed to product-card)", "default": "Add to cart" },
    { "type": "checkbox", "id": "override_button_label", "label": "Override button label (CSS hack)", "default": false }
  ],
  "blocks": [
    {
      "type": "product_reference",
      "name": "Product",
      "settings": [
        { "type": "product", "id": "product", "label": "Product" }
      ]
    }
  ],
  "max_blocks": 12,
  "presets": [
    { "name": "Product Cross Sell" }
  ]
}
{% endschema %}
